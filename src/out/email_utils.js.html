<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: email_utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: email_utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**@module email_utils*/

var _ = require('lodash')
var rp = require('request-promise')

var menu_utils = require('./menu_utils')
var Menu = require('./Menu')
var mailer_transport = require('../../../mail/IF_mail.js')

var row_length = 2;
var column_length = 4;
var header = '&lt;img src="http://tidepools.co/kip/oregano/cafe.png">';
var br = '&lt;br/>'

/**@constant {string} - kip blue color used accross slack, web, and email*/
var kip_blue = '#47a2fc'

/**@constant {string} - light grey color used accross web, and email*/
var ryan_grey = '#F5F5F5'

/**@exports email_utils*/
var utils = {};

/**
* Generates HTML for quickpick emails that collect orders from email-only team members
* @param foodSession
* @param slackbot
* @param slacklink {string} - slack url for the slack team the email is sent from
* @param email {string} - the email address the order will be collected from
* @returns {string} - html for the body of the order collection email
*/
utils.quickpickHTML = function * (foodSession, slackbot, slacklink, email) {

  var user = yield db.email_users.findOne({email: email, team_id: foodSession.team_id});
  var merch_url = yield menu_utils.getUrl(foodSession, user.id)
  var resto = yield db.merchants.findOne({id: foodSession.chosen_restaurant.id});

  var sortedMenu = menu_utils.sortMenu(foodSession, user, []);
  var quickpicks = sortedMenu.slice(0, 9);

  //header
  var html = '&lt;html>&lt;body>';
  html += header + br
  html += `&lt;h1 style="font-size:2em;">${foodSession.chosen_restaurant.name}&lt;/h1>`
  html += `&lt;p>${foodSession.convo_initiater.first_name} ${foodSession.convo_initiater.last_name} from ${slackbot.team_name} is collecting food orders from ${foodSession.chosen_restaurant.name}.&amp;#010;Click here to order from the full menu:&lt;/p>`
  html += `&lt;p>&lt;a style="font-size:130%;color:${kip_blue}" href="` + merch_url + `">Click to View Full Menu`
  html += ' ' + menu_utils.cuisineEmoji(resto.data.summary.cuisines[0]) + '&lt;/a>&lt;/p>'
  html += `&lt;p>Or simply click a menu item below:&lt;/p>`

  //quickpicks
  html += '&lt;table style="width:100%;border-spacing:5.5px;" border="0">'

  for (var i = 0 ; i &lt; column_length; i++) {
    html += '&lt;tr>';
    for (var j = 0; j &lt; row_length; j++) {
      var item_url = yield menu_utils.getUrl(foodSession, user.id, [quickpicks[row_length*i+j].id])
      html += `&lt;td style="width:300px;padding:10px;position:absolute;" bgcolor=${ryan_grey}>&lt;a style="color:black;text-decoration:none;display:block;width:100%;height:100%" href="` + `${item_url}` + `">`
      html += this.formatItem(i, j, quickpicks) + '&lt;/a>' + '&lt;/td>';
    }
    html += '&lt;/tr>';
  }

  html += '&lt;/table>' + br

  //footer
  html += `&lt;p>&lt;a style="line-height:115%;font-size:130%;color:${kip_blue};" href="` + merch_url + `">Click to View Full Menu`
  html += ' ' + menu_utils.cuisineEmoji(resto.data.summary.cuisines[0]) + '&lt;/a>' + br + br

  html += `&lt;table border="0" style="padding:10px;width:100%;background-color:${kip_blue};">&lt;tr style="width:100%;">&lt;td style="width:100%;">&lt;table style="border-spacing:0 20px;border-radius:4px;width:100%">`
  html += `&lt;tr style="width:100%">&lt;td style="width:100%;text-align:center;">&lt;img height="16" width="16" src="http://tidepools.co/kip/oregano/Slack_Icon.png">`
  html += `&lt;a style="color:white;text-decoration:none;font-size:140%;text-align:center;" href="${slacklink}">&amp;nbsp;Click to join your team on Slack!&lt;/a>&lt;/td>&lt;/tr>&lt;/table>`
  html += `&lt;table style="width:100%;">&lt;tr>&lt;td style="width:300px;">&lt;p style="padding:0 20px 0 20px;font-size:85%;color:white;text-align:right;">Kip Â© 2017&lt;/p>&lt;/td>`
  html += `&lt;td style="width:300px;">&lt;a style="padding:0 20px 0 20px;color:white;text-decoration:none;font-size:85%" href="https://kipthis.com/legal.html">Terms of Use&lt;/a>&lt;/td>&lt;/tr>`
  html += `&lt;/table>&lt;/td>&lt;/tr>&lt;/table>` + br

  html += '&lt;/body>&lt;/html>'

  return html;
}

/**
* formats the html for a single table cell / menu item
* @param i {number} - the x coordinate of this table cell
* @param j {number} - the y coordinate of this table cell
* @param quickpicks {array} -
* @returns {string} - html for a single table cell / menu item
*/
utils.formatItem = function (i, j, quickpicks) {
  return `&lt;table border="0" style="position:absolute;">`
    + `&lt;tr style="position:absolute;top:30px;">&lt;td>` +
  `&lt;table>&lt;tr>&lt;td style="font-weight:bold;">${quickpicks[row_length*i+j].name}&lt;/td>&lt;/tr>` +
  `&lt;tr>&lt;td>${quickpicks[row_length*i+j].description}&lt;/td>&lt;/tr>&lt;/table>&lt;/td>&lt;/tr>` +
  `&lt;tr>&lt;td>&lt;table>&lt;tr>&lt;td style="padding:8px 0 8px 0;font-weight:bold;">$${parseFloat(quickpicks[row_length*i+j].price).toFixed(2)}&lt;/td>&lt;/tr>` +
  `&lt;tr>&lt;td>&lt;div style="display:inline-block;background-color:white;border-radius:8px;border-color:${kip_blue};border-style:solid;border-width:2px;">` +
  `&lt;p style="margin:0.575em 0 0.575em 0;font-weight:bold;color:${kip_blue}">&amp;nbsp;&amp;nbsp;&amp;nbsp;Add to Cart&amp;nbsp;&amp;nbsp;&amp;nbsp;&lt;/p>&lt;/div>&lt;/td>&lt;/tr>&lt;/table>` +
  `&lt;/td>&lt;/tr>&lt;/table>`;
}


/**
* creates and sends an email to email-only users confirming that their order has gone through
* @param foodSession
* @param email {string} - the email the order being confirmed is associated with
*/
utils.sendEmailUserConfirmations = function * (foodSession, email) {
  var menu = Menu(foodSession.menu)
  var header = '&lt;img src="http://tidepools.co/kip/oregano/cafe.png">'
  var slackbot = yield db.slackbots.findOne({team_id: foodSession.team_id}).exec()
  var date = foodSession.order.order_time;
  var user = yield db.email_users.findOne({email: email})
  var user_id = user.id

  var options = {
    uri: 'https://slack.com/api/team.info',
    json: true,
    qs: {
      token: slackbot.bot.bot_access_token
    }
  }

  var team_info = yield rp(options);
  var team_url = team_info.team.domain;

  // var slacklink = 'https://' + team_info.team.domain + '.slack.com'

  var formatDate = function (date) {
    var year = date.slice(0, 4)
    var month = date.slice(5, 7)
    var day = date.slice(8, 10)
    return month + '/' + day + '/' + year;
  }

  var merchant = yield db.merchants.findOne({id: foodSession.chosen_restaurant.id})
  var phone_number = merchant.data.summary.phone;

  //header
  var html = `&lt;html>${header}` + br;
  html += `&lt;h1>Your order from &lt;a href="${foodSession.chosen_restaurant.url}" style="text-decoration:none;color:${kip_blue}">${foodSession.chosen_restaurant.name}&lt;/a> has been successfully submitted!&lt;/h1>`
  // html += `&lt;p style="color:black;text-decoration:none;">${foodSession.convo_initiater.first_name} ${foodSession.convo_initiater.last_name} from ${slackbot.team_name} ordered from &lt;a href="${foodSession.chosen_restaurant.url}" style="text-decoration:none;color:${kip_blue}">${foodSession.chosen_restaurant.name}&lt;/a>${(phone_number ? ' (' + phone_number + ')' : '')} on ${formatDate(date)}&lt;/p>`
  // html += `\nHere is a list of items:\n`

  //column headings
  html += `&lt;table border="0" style="margin-top:4px;width:600px;border-spacing:5.5px;">&lt;thead style="color:white;background-color:${kip_blue}">&lt;tr>&lt;th>Menu Item&lt;/th>`
  html += `&lt;th>Item Options&lt;/th>`
  html += `&lt;th>Price&lt;/th>&lt;/tr>&lt;/thead>`

  //items ordered
  foodSession.cart.filter(i => i.added_to_cart).filter(i => i.user_id == user_id).map((item) => {
    var foodInfo = menu.getItemById(String(item.item.item_id))
    var descriptionString = _.keys(item.item.option_qty).map((opt) => menu.getItemById(String(opt)).name).join(', ')
    // var user = foodSession.team_members.filter(j => j.id === item.user_id)
    var td_style = 'style="background-color:' + ryan_grey + ';padding:8px;"'

    var price_expansion = ( item.item.item_qty > 1 ? `&lt;p style="text-align:center;">$${(menu.getCartItemPrice(item).toFixed(2) / item.item.item_qty).toFixed(2)} (x${item.item.item_qty})&lt;/p>&lt;hr>` : '')

    html += `&lt;tr>&lt;td ${td_style};">&lt;b>${foodInfo.name}&lt;/b>&lt;/td>`
    html += `&lt;td ${td_style}">&lt;p>${descriptionString}&lt;/p>`
    html += `${(item.item.instructions ? '&lt;p>&lt;i>' + item.item.instructions + '&lt;/i>&lt;/p>': '')}&lt;/td>`
    html += `&lt;td ${td_style}>` + price_expansion + `&lt;p style="text-align:center;">&lt;b>$${menu.getCartItemPrice(item).toFixed(2)}&lt;/b>&lt;/p>&lt;/td>`
    html +=`&lt;/tr>`
    // html += `&lt;p>&lt;a href="https://${team_url}.slack.com/messages/@${user[0]}" style="text-decoration:none;color:${kip_blue}">@${user[0].name}&lt;/a>&lt;/p>&lt;/td>&lt;/tr>`
  })
  html += `&lt;/thead>&lt;/table>` + br + br

  //footer
  html += `&lt;p>Please email ${foodSession.convo_initiater.first_name} ${foodSession.convo_initiater.last_name} at ${foodSession.convo_initiater.email} from ${slackbot.team_name} with any issues.&lt;/p>` + br
  html += `&lt;p style="font-size:90%;position:absolute;text-decoration:none;color:grey;">&lt;img style="display:inline-block;position:relative;top:12px" height="22" width="22" alt="kip head" src="http://tidepools.co/kip/head_squared.png"> Powered by Kip + delivery.&lt;span>com&lt;/p>` + br

  html += `&lt;table border="0" style="padding:10px;width:100%;background-color:${kip_blue};">&lt;tr style="width:100%;">&lt;td style="width:100%;">&lt;table style="border-spacing:0 20px;border-radius:4px;width:100%">`
  html += `&lt;tr style="width:100%">&lt;td>&lt;div style="position:absolute;width:100%;height:100%;text-align:center;">&lt;img height="26" width="26" src="http://tidepools.co/kip/oregano/Slack_Icon.png">`
  // html += `&lt;b style="color:white;text-decoration:none;font-weight:normal;font-size:160%;text-align:center;">&amp;nbsp; Enjoy your food!&lt;/b>&lt;/div>&lt;/td>&lt;/tr>&lt;/table>`
  html += `&lt;b>&lt;a href="https://${team_url}.slack.com/" style="color:white;text-decoration:none;font-size:160%;text-align:center;">&amp;nbsp;Join your team on Slack!&lt;/a>&lt;/b>&lt;/td>&lt;/tr>&lt;/table>`
  html += `&lt;table style="width:100%;">&lt;tr>&lt;td style="width:300px;">&lt;p style="padding:0 20px 0 20px;font-size:85%;color:white;text-align:right;">Kip Â© 2017&lt;/p>&lt;/td>`
  html += `&lt;td style="width:300px;">&lt;a style="padding:0 20px 0 20px;color:white;text-decoration:none;font-size:85%" href="https://kipthis.com/legal.html">Terms of Use&lt;/a>&lt;/td>&lt;/tr>`
  html += `&lt;/table>&lt;/td>&lt;/tr>&lt;/table>` + br

  var mailOptions = {
    to: `&lt;${email}>`,
    from: `Kip CafÃ© &lt;hello@kipthis.com>`,
    subject: `Your order for ${foodSession.chosen_restaurant.name} has been submitted!`,
    html: `&lt;html>${html}&lt;/html>`
  }

  try {
    mailer_transport.sendMail(mailOptions)
  } catch (e) {
    logging.error('error mailing after payment submitted', e)
  }
}

/**
* Sends a confirmation email / receipt to the team administrator once their order has gone through
* @param foodSession
*/
utils.sendConfirmationEmail = function * (foodSession) {
  var menu = Menu(foodSession.menu)
  var header = '&lt;img src="http://tidepools.co/kip/oregano/cafe.png">'
  var slackbot = yield db.slackbots.findOne({team_id: foodSession.team_id}).exec()
  var date = foodSession.order.order_time;

  var options = {
    uri: 'https://slack.com/api/team.info',
    json: true,
    qs: {
      token: slackbot.bot.bot_access_token
    }
  }

  var team_info = yield rp(options);
  var team_url = team_info.team.domain;

  // var slacklink = 'https://' + team_info.team.domain + '.slack.com'

  var formatDate = function (date) {
    var year = date.slice(0, 4)
    var month = date.slice(5, 7)
    var day = date.slice(8, 10)
    return month + '/' + day + '/' + year;
  }

  var merchant = yield db.merchants.findOne({id: foodSession.chosen_restaurant.id})
  var phone_number = merchant.data.summary.phone;

  //header

  var html = `&lt;html>${header}` + br;
  html += `&lt;h1 style="font-size:2em;">Order Receipt&lt;/h1>`
  html += `&lt;p style="color:black;text-decoration:none;">${foodSession.convo_initiater.first_name} ${foodSession.convo_initiater.last_name} from ${slackbot.team_name} ordered from &lt;a href="${foodSession.chosen_restaurant.url}" style="text-decoration:none;color:${kip_blue}">${foodSession.chosen_restaurant.name}&lt;/a>${(phone_number ? ' (' + phone_number + ')' : '')} on ${formatDate(date)}&lt;/p>`
  html += `\nHere is a list of items:\n`

  //column headings
  html += `&lt;table border="0" style="margin-top:4px;width:600px;border-spacing:5.5px;">&lt;thead style="color:white;background-color:${kip_blue}">&lt;tr>&lt;th>Menu Item&lt;/th>`
  html += `&lt;th>Item Options&lt;/th>`
  html += `&lt;th>Price&lt;/th>`
  html += `&lt;th>Recipient&lt;/th>&lt;/tr>&lt;/thead>`

  //items ordered
  foodSession.cart.filter(i => i.added_to_cart).map((item) => {
    var foodInfo = menu.getItemById(String(item.item.item_id))
    var descriptionString = _.keys(item.item.option_qty).map((opt) => menu.getItemById(String(opt)).name).join(', ')
    var user = foodSession.team_members.filter(j => j.id === item.user_id)
    var td_style = 'style="background-color:' + ryan_grey + ';padding:8px;"'

    var price_expansion = ( item.item.item_qty > 1 ? `&lt;p style="text-align:center;">$${(menu.getCartItemPrice(item).toFixed(2) / item.item.item_qty).toFixed(2)} (x${item.item.item_qty})&lt;/p>&lt;hr>` : '')

    html += `&lt;tr>&lt;td ${td_style};">&lt;b>${foodInfo.name}&lt;/b>&lt;/td>`
    html += `&lt;td ${td_style}">&lt;p>${descriptionString}&lt;/p>`
    html += `${(item.item.instructions ? '&lt;p>&lt;i>' + item.item.instructions + '&lt;/i>&lt;/p>': '')}&lt;/td>`
    html += `&lt;td ${td_style}>` + price_expansion + `&lt;p style="text-align:center;">&lt;b>$${menu.getCartItemPrice(item).toFixed(2)}&lt;/b>&lt;/p>&lt;/td>`
    // console.log('USER', user)
    if (user[0].first_name &amp;&amp; user[0].last_name) html += `&lt;td ${td_style}">&lt;p>${user[0].first_name} ${user[0].last_name}&lt;/p>`
    else html += `&lt;td ${td_style}>`
    html += `&lt;p>@${user[0].name}&lt;/p>&lt;/td>&lt;/tr>`
    // html += `&lt;p>&lt;a href="https://${team_url}.slack.com/messages/@${user[0]}" style="text-decoration:none;color:${kip_blue}">@${user[0].name}&lt;/a>&lt;/p>&lt;/td>&lt;/tr>`
  })

  html += `&lt;/thead>&lt;/table>` + br + br

  //itemized charges

  var line_item_style = `padding:0 0 0 8px;margin:2px;`

  html += `&lt;table border="0">&lt;tr>&lt;td style="width:300px;">`

  html += `&lt;div style="border-left:4px solid ${kip_blue};">`
  html += `&lt;p style="${line_item_style}">Cart Subtotal: ${foodSession.order.subtotal.$}&lt;/p>`
  html += `&lt;p style="${line_item_style}">Tax: ${foodSession.order.tax.$}&lt;/p>`
  html += `&lt;p style="${line_item_style}">Delivery Fee: ${foodSession.order.delivery_fee.$}&lt;/p>`
  html += `&lt;p style="${line_item_style}">Service Fee: ${foodSession.service_fee.$}&lt;/p>`
  if (foodSession.discount_amount) html += `ðŸŽ‰ Kip Coupon: -${foodSession.discount_amount.$}`
  html += `&lt;p style="${line_item_style}">Tip: ${(foodSession.tip.percent === 'cash') ? '$0.00 (Will tip in cash)' : foodSession.tip.amount.$}&lt;/p>`
  html += `&lt;p style="${line_item_style}">&lt;b>Order Total: ${foodSession.calculated_amount.$}&lt;/b>&lt;/p>&lt;/div>`

  //misc Information
  html += `&lt;/td style="width=300px;">&lt;td>`
  html += `&lt;p style="${line_item_style}">&lt;b>Delivery Address:&lt;/b>&lt;/p>&lt;br/>&lt;p style="${line_item_style}">${foodSession.chosen_location.address_1}&lt;/p>`
  if (foodSession.chosen_location.address_2) html += `&lt;p style="${line_item_style}">${foodSession.chosen_location.address_2}&lt;/p>`
  html += `&lt;p style="${line_item_style}">${foodSession.chosen_location.city}, ${foodSession.chosen_location.state} &lt;/p>`
  html += `&lt;p style="${line_item_style}">${foodSession.chosen_location.zip_code}&lt;/p>` + br
  if (foodSession.instructions) html += `&lt;p style="${line_item_style}">&lt;i>${foodSession.instructions}&lt;/i>&lt;/p>`
  html += `&lt;/td>&lt;/tr>&lt;/table>`

  //footer
  // html += `&lt;p style="text-decoration:none;color:grey;">&lt;img height="14" width="14" alt="delivery.com" src="http://tidepools.co/kip/dcom_footer.png"> Powered by delivery.&lt;span>com&lt;/p>` + br
  html += `&lt;p style="font-size:90%;position:absolute;text-decoration:none;color:grey;">&lt;img style="display:inline-block;position:relative;top:12px" height="22" width="22" alt="kip head" src="http://tidepools.co/kip/head_squared.png"> Powered by Kip + delivery.&lt;span>com&lt;/p>` + br

  order_users = '@' + foodSession.all_members.map(function (member) {
    return member.name
  }).join(',')

  html += `&lt;table border="0" style="padding:10px;width:100%;background-color:${kip_blue};">&lt;tr style="width:100%;">&lt;td style="width:100%;">&lt;table style="border-spacing:0 20px;border-radius:4px;width:100%">`
  html += `&lt;tr style="width:100%">&lt;td>&lt;div style="position:absolute;width:100%;height:100%;text-align:center;">&lt;img style="position:relative;down:10px;" height="28" width="28" src="http://tidepools.co/kip/head_squared.png">`
  html += `&lt;b style="color:white;text-decoration:none;font-weight:normal;font-size:160%;text-align:center;">&amp;nbsp; Enjoy your food!&lt;/b>&lt;/div>&lt;/td>&lt;/tr>&lt;/table>`
  // html += `&lt;a href="https://${team_url}.slack.com/messages/${order_users}/" style="color:white;text-decoration:none;font-size:140%;text-align:center;">&amp;nbsp;Click to chat with your food crew!&lt;/a>&lt;/td>&lt;/tr>&lt;/table>`
  html += `&lt;table style="width:100%;">&lt;tr>&lt;td style="width:300px;">&lt;p style="padding:0 20px 0 20px;font-size:85%;color:white;text-align:right;">Kip Â© 2017&lt;/p>&lt;/td>`
  html += `&lt;td style="width:300px;">&lt;a style="padding:0 20px 0 20px;color:white;text-decoration:none;font-size:85%" href="https://kipthis.com/legal.html">Terms of Use&lt;/a>&lt;/td>&lt;/tr>`
  html += `&lt;/table>&lt;/td>&lt;/tr>&lt;/table>` + br

  // send confirmation email to admin
  var mailOptions = {
    to: `${foodSession.convo_initiater.name} &lt;${foodSession.convo_initiater.email}>`,
    from: `Kip CafÃ© &lt;hello@kipthis.com>`,
    subject: `Your Order Receipt for ${foodSession.chosen_restaurant.name}`,
    html: `${html}&lt;/html>`
  }

  logging.info('mailOptions', mailOptions)

  try {
    mailer_transport.sendMail(mailOptions)
  } catch (e) {
    logging.error('error mailing after payment submitted', e)
  }
}

module.exports = utils;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-email_utils.html">email_utils</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Fri Mar 03 2017 14:32:41 GMT-0500 (EST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
