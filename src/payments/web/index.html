<!doctype html>

<!--
    Kip Pay module

      =()=
  ,/'\_||_
  ( (___  `.
  `\./  `=='
         |||
         |||
         |||                    _ ___  _               _ ___  _
       ,;'''''''';,           ,;;;;;;;;;;,           .oooooooooo.
     ,'  _o_o_o_o  ',        |';;;;;;;;;;'|         |'oooooooooo'|
    ,,,;'        ';,'        |            |         |            |
       '.________.'           '.________.'           '.________.'

           Tako                  Tobiko                  Ikura
         (Octopus)          (Flying Fish Roe)         (Salmon Roe)
-->

<html lang="en">
<head>
  <title>Kip Pay with Stripe</title>
  
  <link rel="apple-touch-icon" sizes="57x57" href="img/favicon/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="img/favicon/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="img/favicon/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="img/favicon/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="img/favicon/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="img/favicon/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="img/favicon/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="img/favicon/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="img/favicon/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="img/favicon/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="img/favicon/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="img/favicon/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="img/favicon/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="img/favicon/manifest.json">
  <link rel="mask-icon" href="img/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="img/favicon/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <meta charset="utf-8">

  <meta name="description" content="Kip Pay">
  <meta name="author" content="Kip">
</head>


<style>
  
  body {
    overflow-y:hidden;
  }

  #wrap {
    width:101%; 
    height: 500px;
    margin: -10px -10px 10px -10px;

    /* Permalink - use to edit gradient: http://colorzilla.com/gradient-editor/#58dddd+0,0c347a+74 */
    background: #0c347a; /* Old browsers */
    background: -moz-linear-gradient(45deg,  #58dddd 0%, #0c347a 93%); /* FF3.6-15 */
    background: -webkit-linear-gradient(45deg,  #58dddd 0%,#0c347a 93%); /* Chrome10-25,Safari5.1-6 */
    background: linear-gradient(45deg,  #58dddd 0%,#0c347a 93%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
    filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#58dddd', endColorstr='#0c347a',GradientType=1 ); /* IE6-9 fallback on horizontal gradient */ 
    overflow-y: hidden;
  }

  #payWrap {
    float: left;
    position: relative;
    left: 50%;
  }

  #kipPay {
    display:none; 
    margin-top: 150px;
    width:300px; 
    height:400px; 
    background-color:rgb(239,242,245);
    float: left;
    position: relative;
    left: -50%;
    border-radius: 5px;
    border: 1px white solid;
    position: relative;
  }

/*  #stripeButton {

  }*/
/*239,242,245
*/
  #stripeButton {
    width: 100%;
    height: 35px;
    float: left;
    position: relative;
    left: 80px;
    cursor:pointer;
    position: absolute;
    bottom: 11px;
    margin-left: -20px;
    
    top: 363px;
    left: 0;
    right: 0;
    display: block;
    -webkit-box-sizing: border-box;
    -moz-box-sizing: border-box;
    -ms-box-sizing: border-box;
    -o-box-sizing: border-box;
    box-sizing: border-box;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 37px;
    border: 0;
    text-decoration: none;
    background: #45b1e8;
    background-image: -webkit-linear-gradient(#45b1e8,#3097de);
    background-image: -moz-linear-gradient(#45b1e8,#3097de);
    background-image: -ms-linear-gradient(#45b1e8,#3097de);
    background-image: -o-linear-gradient(#45b1e8,#3097de);
    background-image: -webkit-linear-gradient(#45b1e8,#3097de);
    background-image: -moz-linear-gradient(#45b1e8,#3097de);
    background-image: -ms-linear-gradient(#45b1e8,#3097de);
    background-image: -o-linear-gradient(#45b1e8,#3097de);
    background-image: linear-gradient(#45b1e8,#3097de);
    -webkit-border-radius: 4px;
    -moz-border-radius: 4px;
    -ms-border-radius: 4px;
    -o-border-radius: 4px;
    border-radius: 4px;
    -webkit-font-smoothing: antialiased;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    -o-user-select: none;
    user-select: none;
    cursor: pointer;
    font-family: "Helvetica Neue","Helvetica",Arial,sans-serif;
    font-weight: bold;
    font-size: 17px;
    color: #fff;
    text-shadow: 0 -1px 0 rgba(46,86,153,0.3);
    -webkit-box-shadow: 0 1px 0 rgba(46,86,153,0.15),0 0 4px rgba(86,149,219,0),inset 0 2px 0 rgba(41,102,20,0);
    -moz-box-shadow: 0 1px 0 rgba(46,86,153,0.15),0 0 4px rgba(86,149,219,0),inset 0 2px 0 rgba(41,102,20,0);
    -ms-box-shadow: 0 1px 0 rgba(46,86,153,0.15),0 0 4px rgba(86,149,219,0),inset 0 2px 0 rgba(41,102,20,0);
    -o-box-shadow: 0 1px 0 rgba(46,86,153,0.15),0 0 4px rgba(86,149,219,0),inset 0 2px 0 rgba(41,102,20,0);
    box-shadow: 0 1px 0 rgba(46,86,153,0.15),0 0 4px rgba(86,149,219,0),inset 0 2px 0 rgba(41,102,20,0);
  }

  #topPay {
    height:50px;
    background-color: #fff;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    border-bottom: 1px #dde4eb solid;
  }

  #bodyPay {
    height:75px;
  }

  #innerButton {
    width:60%;
  }

  #headerText {
    font-family: "Helvetica Neue","Helvetica",Arial,sans-serif;
    font-size: 20px;
    color: #45b1e8;
    text-align: center;
    position: absolute;
    padding-left: 9px;
    padding-top: 13px;
  }

  #bodyTitle {
    font-family: "Helvetica Neue","Helvetica",Arial,sans-serif;
    font-size: 16px;
    color: #2d3134;
    text-align: center;
    position: absolute;
    padding-left: 20px;
    padding-top: 20px;
  }

  #bodyText {
    font-family: "Helvetica Neue","Helvetica",Arial,sans-serif;
    font-size: 13px;
    color: #2d3134;
    text-align: center;
    position: absolute;
    padding-left: 20px;
    padding-top: 100px;

  }

  #kipHead{
    padding-left: 10px;
    padding-top: 5px;
  }


  @media only screen and (max-width: 385px) {
      #wrap {
          width:110%; 
      }
  }
  @media only screen and (max-width: 500px) {
      #wrap {
          width:105%; 
      }
  }
  @media only screen and (min-width: 500px) {
      body {
          width:101%; 
      }
  }
</style>

<body>
<script src="https://checkout.stripe.com/checkout.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>



<div id="wrap">
<div id="payWrap">
  <div id="kipPay">
    <div id="topPay">
      <img id="kipHead" width="40" src="https://kipthis.com/images/kip_head.png">
      <span id="headerText"></span>
    </div>
    <div id="bodyPay">
        <span id="bodyTitle"></span>
        <span id="bodyText"></span>
    </div>
    <div id="innerButton">
      <button id="stripeButton">Click to Pay with Stripe</button>
    </div>
  </div>
</div>
<div>





<script>

// var stripeKey = 'pk_test_8bnLnE2e1Ch7pu87SmQfP8p7';
var stripeKey = 'pk_live_0LCJqLkmMCFKYDwbPCrhQknH';

function getQueryStringValue (key) {  
  return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));  
}  
//parsing query strings
var session_token = getQueryStringValue('k');
var baseURL = decodeURI(getQueryStringValue('b'));

//clear query strings in url param
history.replaceState({}, 'Kip Café with Stripe', '/'); 

//something went broken, we dont have the token from URL :(
if (!session_token){
    $("#kipPay").fadeIn(450);
    $("#headerText").text("Kip Café Error");
    $("#innerButton").hide();
}

//fetch checkout info by token
if (session_token.length == 512){
  $.ajax({
      url: '/session', 
      type: 'POST', 
      contentType: 'application/json', 
      data: JSON.stringify({
        session_token: session_token
      }),
      success: process
  })
}

//do the thing
function process(data){

    //check if the stripe popup was blocked
    setTimeout(function(){
        //no stripe didn't pop up
        if(!$('.stripe_checkout_app').is(":visible")){
            $("#kipPay").fadeIn(450);
        }
        //yes stripe popped up
        else {
            //popup not blocked, but detecting if user closes popup, so we can show kip dialog
            setInterval(function(){
                if(!$('.stripe_checkout_app').is(":visible")){
                   $("#kipPay").fadeIn(450);
                }
            },500)
        }
    },1000)

    data = JSON.parse(data)

    $("#headerText").text("Kip Café Order");
    $("#bodyTitle").html('<a href="'+data.order.chosen_restaurant.url+'">'+data.order.chosen_restaurant.name+'</a>');
    $("#bodyText").html(data.order.order.order_type+'</br>'+(data.order.order.total/100).toFixed(2));

    var handler = StripeCheckout.configure({
        key: stripeKey,
        image: 'https://kipthis.com/images/kip_head.png',
        locale: 'auto',
        token: function(token) {
          $.ajax({
              url: '/process', 
              type: 'POST', 
              contentType: 'application/json', 
              data: JSON.stringify({
                token: token.id,
                session_token: data.session_token
              }),
              success: function(){
                window.close();
              }
          })
        }
    });

    document.getElementById('stripeButton').addEventListener('click', function(e) {

      // Open Checkout with further options:
      handler.open({
        name: 'Kip Café',
        description: 'Delivery from ' + data.order.chosen_restaurant.name,
        amount: data.order.order.total,
        zipCode: true,
        email: data.order.convo_initiater.email
      });
      e.preventDefault();

      //show underneath button
    });

    // Close Checkout on page navigation:
    window.addEventListener('popstate', function() {
        handler.close();
    });

    // $('#stripeButton').click(function(e){
    //   console.log('EEEE ',e)
    // })

    // $( "#target" ).click(function() {
    //   alert( "Handler for .click() called." );
    // });

    $('#stripeButton').trigger( "click" );

}


//responsive gradient 
$('#wrap').css('height', $(window).height() + 3); 
$(window).resize(function() {      
  $('#wrap').css('height', $(window).height() + 3); 
});  

</script>

</body>
</html>