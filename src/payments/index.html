<!doctype html>

<!--
    Kip Pay module

      =()=
  ,/'\_||_
  ( (___  `.
  `\./  `=='
         |||
         |||
         |||                    _ ___  _               _ ___  _
       ,;'''''''';,           ,;;;;;;;;;;,           .oooooooooo.
     ,'  _o_o_o_o  ',        |';;;;;;;;;;'|         |'oooooooooo'|
    ,,,;'        ';,'        |            |         |            |
       '.________.'           '.________.'           '.________.'

           Tako                  Tobiko                  Ikura
         (Octopus)          (Flying Fish Roe)         (Salmon Roe)
-->

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Kip Café with Stripe</title>
  <meta name="description" content="Kip Pay">
  <meta name="author" content="Kip">
</head>

<body>
<script src="https://checkout.stripe.com/checkout.js"></script>
<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>

<button id="stripeButton">Click Here to Purchase</button>

<script>

var stripeKey = 'pk_test_8bnLnE2e1Ch7pu87SmQfP8p7'

function getQueryStringValue (key) {  
  return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(key).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));  
}  
//parsing query strings
var session_token = getQueryStringValue('k');


//GET REQUEST HERE FOR ORDER DETAILS via session token
//
//get these:
var order = {
  kipId: 'slack_TEAMID_USERID',
  description: 'Los Alamos Cantina~~~',
  amount: '5000',
  email: 'zzz@zzz.xyz'
}
//


//clear query strings in url param
history.replaceState({}, 'Kip Café with Stripe', '/'); 

//convert to int
if (!isNaN(order.amount)){
  order.amount = parseInt(order.amount)
  process(order,session_token)
}else {
  console.log('Not a number');
}

//do the thing
function process(order,session_token){

  //
  var handler = StripeCheckout.configure({
    key: stripeKey,
    image: 'https://httpsimage.com/img/kip-icon.png',
    locale: 'auto',
    token: function(token) {
      $.ajax({
          url: '/process', 
          type: 'POST', 
          contentType: 'application/json', 
          data: JSON.stringify({
            token: token.id,
            session_token: session_token
          })
      })
    }
  });

  document.getElementById('stripeButton').addEventListener('click', function(e) {
    if(order.amount && order.description){
      // Open Checkout with further options:
      handler.open({
        name: 'Kip Checkout',
        description: 'Delivery from '+order.description + 'for <Team Name>',
        amount: order.amount,
        zipCode: true,
        email: order.email
      });
      e.preventDefault();
    }else {
      console.log('error: missing amount or description')
    }
  });

  // Close Checkout on page navigation:
  window.addEventListener('popstate', function() {
    handler.close();
  });

  $("#stripeButton").click(); 

}
</script>

</body>
</html>