<<<<<<< HEAD
function LandmarkNewCtrl(a,b,c,d,e){function f(a,c){"edit"==a&&(b.landmark.newStatus=!1,b.landmark.landmarkID=c,d.landmarks.create(b.landmark,function(a){})),void 0===a&&(b.landmark.newStatus=!0,b.landmark.parentID=b.worldID,d.landmarks.create(b.landmark,function(a){b.landmarkID=a[0]._id}))}b.landmarkID,b.worldID="029345823045982345",b.landmark={stats:{avatar:"img/tidepools/default.jpg"}},b.landmark.loc=[-74.0059,40.7127],b.landmark.name="Default",f(),shelfPan("return"),e.showSwitch=!1,e.showBack=!1,e.showBackPage=!1,""==c.type||"place"==c.type||"event"==c.type||"job"==c.type||a.path("/new");var g=new Date;b.subTypes=[],"event"==c.type&&(b.subTypes=b.subTypes.concat(eventCategories)),"place"==c.type&&(b.subTypes=b.subTypes.concat(placeCategories)),b.addEndDate=function(){b.landmark.date.end=b.landmark.date.start},angular.extend(b,{center:{lat:40.7615,lng:-73.9769,zoom:17},markers2:{m:{lat:40.7615,lng:-73.9769,message:"Drag to Location on map",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),angular.element("#fileupload").fileupload({url:"/api/upload_maps",paramName:coords_text,dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,c){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+c.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+c.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),b.landmark.stats.avatar=c.result,b.mapIMG=c.result}}),b.buildMap=function(){var a={worldID:"53c4a0ab0ee5d8ccfa68a034",nw_loc_lng:-73.99749,nw_loc_lat:40.75683,sw_loc_lng:-73.99749,sw_loc_lat:40.7428,ne_loc_lng:-73.98472,ne_loc_lat:40.75683,se_loc_lng:-73.98472,se_loc_lat:40.7428},c=JSON.stringify(a),d={mapIMG:b.mapIMG,coords:c};$http.post("/api/build_map",d).success(function(a){})},b.locsearch=function(){var a=new google.maps.Geocoder;a&&a.geocode({address:b.landmark.location},function(a,c){c==google.maps.GeocoderStatus.OK&&b.$apply(function(){angular.extend(b,{center:{lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng(),zoom:global_mapCenter.zoom},markers2:{m:{lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng(),message:"Drag to Location",focus:!0,draggable:!0}}})})})},b.save=function(){function c(a){var b=a,c=b.indexOf("T");return b.substring(0,-1!=c?c:b.length)}b.landmark.date.end||(b.landmark.date.end=b.landmark.date.start),b.landmark.datetext={start:b.landmark.date.start,end:b.landmark.date.end},b.landmark.date.start=new Date(b.landmark.date.start).toISOString(),b.landmark.date.end=new Date(b.landmark.date.end).toISOString(),b.landmark.date.start=c(b.landmark.date.start),b.landmark.date.end=c(b.landmark.date.end),b.landmark.date.start=b.landmark.date.start.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),b.landmark.date.end=b.landmark.date.end.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),b.landmark.time.start||(b.landmark.time.start="00:00"),b.landmark.time.end||(b.landmark.time.end="23:59"),b.landmark.timetext={start:b.landmark.time.start,end:b.landmark.time.end},b.landmark.loc=[b.markers2.m.lat,b.markers2.m.lng],d.landmarks.create(b.landmark,function(b){a.path("/post/"+b[0].id+"/new")})},b.landmark={stats:{avatar:"img/tidepools/default.jpg"},type:c.type,date:{start:g}},b.landmark.loc=[]}function LandmarkEditCtrl(a,b,c,d,e,f,g){g.showSwitch=!1,shelfPan("return"),a.get({_id:d.landmarkId},function(a){c.landmark=a,a.loc_nicknames&&(c.landmark.location=a.loc_nicknames),c.landmark.idCheck=a.id,c.subTypes=[],"event"==a.type&&(c.subTypes=c.subTypes.concat(eventCategories)),"place"==a.type&&(c.subTypes=c.subTypes.concat(placeCategories)),"event"==a.type&&(c.landmark.date={start:a.timetext.datestart,end:a.timetext.dateend},c.landmark.time={start:a.timetext.timestart,end:a.timetext.timeend}),angular.extend(g,{markers:{}}),angular.extend(g,{center:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],zoom:17},markers:{m:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],message:"Drag to Location on map",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),$('<img src="'+c.landmark.stats.avatar+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")})});new Date;c.addEndDate=function(){c.landmark.date.end=c.landmark.date.start},angular.element("#fileupload").fileupload({url:"/api/upload",dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,b){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+b.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+b.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),c.landmark.stats.avatar=b.result}}),c.save=function(){function a(a){var b=a,c=b.indexOf("T");return b.substring(0,-1!=c?c:b.length)}"event"==c.landmark.type&&(c.landmark.date.end||(c.landmark.date.end=c.landmark.date.start),c.landmark.datetext={start:c.landmark.date.start,end:c.landmark.date.end},c.landmark.date.start=new Date(c.landmark.date.start).toISOString(),c.landmark.date.end=new Date(c.landmark.date.end).toISOString(),c.landmark.date.start=a(c.landmark.date.start),c.landmark.date.end=a(c.landmark.date.end),c.landmark.date.start=c.landmark.date.start.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),c.landmark.date.end=c.landmark.date.end.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),c.landmark.time.start||(c.landmark.time.start="00:00"),c.landmark.time.end||(c.landmark.time.end="23:59"),c.landmark.timetext={start:c.landmark.time.start,end:c.landmark.time.end}),c.landmark.loc=[g.markers.m.lat,g.markers.m.lng],e.landmarks.create(c.landmark,function(a){b.path("/post/"+a[0].id+"/new")})},c.delete=function(){var b=confirm("Are you sure you want to delete this item?");b&&a.del({_id:c.landmark._id},function(){})}}function WorldEditCtrl(){}function UserViewCtrl(){}function onDeviceReady(){angular.element(document).ready(function(){angular.bootstrap(document,["IF"])})}function WorldMakerCtrl(a,b,c,d,e,f){function g(){f.getMap("worldDetailMap").then(function(a){a.invalidateSize()})}function h(a){userLat=a.coords.latitude,userLon=a.coords.longitude,b.center={lat:userLat,lng:userLon,zoom:12},b.tiles=tilesDict.mapbox,b.markers={m:{lat:userLat,lng:userLon,message:"<p style='color:black;'>Drag to Location on map</p>",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},g()}function i(){}function j(a){b.hasTime=!1,b.world.loc=[b.markers.m.lat,b.markers.m.lng],b.world.userID=b.userID,"edit"==a?(b.world.newStatus=!1,b.world.worldID=b.worldID,d.worlds.create(b.world,function(a){})):"map"==a?(b.mapping.editMap=!0,b.mapping.worldID=b.worldID,d.worlds.create(b.mapping,function(a){})):(b.world.newStatus=!0,d.worlds.create(b.world,function(a){b.worldID=a[0].worldID,b.projectID=a[0].projectID,b.styleID=a[0].styleID,b.worldURL=a[0].worldURL}))}function k(){b.styles.styleID=b.styleID,d.styles.create(b.styles,function(a){})}f.getMap("worldDetailMap");b.userID="53ab92d2ac23550e12600011",b.username="interfoundry",b.worldID,b.worldURL,b.styleID,b.projectID,b.pageIndex=0,b.pageClass=[],b.pageClass[0]="current",b.pageClass[1]="right",b.pageClass[2]="right",b.pageClass[3]="right",b.pageClass[4]="right",b.mapConfirm="false",b.world={stats:{avatar:"img/tidepools/default.jpg"}},b.mapping={},b.styles={},b.project={},b.mapThemes=[{name:"urban"},{name:"fairy"},{name:"sunset"},{name:"arabesque"}],b.mapping.mapThemeSelect=b.mapThemes[0],b.markerOptions=[{name:"red"},{name:"orange"},{name:"yellow"},{name:"green"},{name:"blue"},{name:"purple"}],b.mapping.markerSelect=b.markerOptions[0],b.bgColor="#CCC",angular.extend(b,{worldDetailPaths:{}}),$(".color").spectrum({clickoutFiresChange:!0}),angular.element("#fileupload").fileupload({url:"/api/upload",dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,c){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+c.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+c.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),b.world.stats.avatar=c.result}}),b.nextPage=function(){b.pageIndex<b.pageClass.length-1&&(b.pageClass[b.pageIndex]="left",0==b.pageIndex&&(b.worldID?j("edit"):j()),1==b.pageIndex&&j("map"),3==b.pageIndex&&k(),b.pageIndex+=1,b.pageClass[b.pageIndex]="current")},b.prevPage=function(){b.pageIndex>0&&(b.pageClass[b.pageIndex]="right",b.pageIndex=b.pageIndex-1,b.pageClass[b.pageIndex]="current")},b.maplocsearch=function(a){if(13==a.keyCode){var c=new google.maps.Geocoder;c&&c.geocode({address:b.locsearchbar},function(a,c){c==google.maps.GeocoderStatus.OK&&(b.center.lat=a[0].geometry.location.lat(),b.center.lng=a[0].geometry.location.lng(),b.markers.m.lat=a[0].geometry.location.lat(),b.markers.m.lng=a[0].geometry.location.lng())})}},b.mapLock=function(){b.mapConfirm?(b.markers.m.draggable=!1,b.worldDetailPaths={},b.worldDetailPaths.circle={type:"circle",radius:5e3,latlngs:{lat:b.markers.m.lat,lng:b.markers.m.lng}}):b.markers.m.draggable=!0},navigator.geolocation&&(navigator.geolocation.getCurrentPosition(h,i,{timeout:5e4}),g()),b.myData={link:"http://google.com",modalShown:!1,hello:"world",foo:"bar"},b.logClose=function(){},b.toggleModal=function(){b.myData.modalShown=!b.myData.modalShown}}function UserCtrl(a,b,c,d){b.userID="53ab92d2ac23550e12600011",b.username="interfoundry",b.worlds=d.worlds.query({queryType:"all",userID:"539533e5d22c979322000001"},function(a){})}function shelfPan(a,b){"return"==a&&($("body").hasClass("lense2")&&($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"})),$("body").hasClass("lense")&&($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"}))),"full"==a&&($("body").hasClass("lense")?"navbar"==b?(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense2"),$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"})):($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"})):$("body").hasClass("lense2")?(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense2"),$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"})):(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"}))),"partial"==a&&($("body").hasClass("lense")?($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"149px"})):$("body").hasClass("lense2")?($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"149px"})):($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(149px)","-moz-transform":"translateY(149px)","-ms-transform":"translateY(149px)","-o-transform":"translateY(149px)",transform:"translateY(149px)"}),$("#leafletmap").css({height:"149px"}))),"new"==a&&($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(250px)","-moz-transform":"translateY(250px)","-ms-transform":"translateY(250px)","-o-transform":"translateY(250px)",transform:"translateY(250px)"}),$("#leafletmap").css({height:"250px"}))}function NearbyCtrl(a,b,c,d,e,f,g,h,i){function j(){b.showNoLoc=!0,angular.extend(e,{loading:!1}),b.$apply()}function k(a,c){b.worlds=d.worlds.query({localTime:new Date,userCoordinate:[c,a]},function(b){e.altBubbles=b[0].liveAndInside,e.nearbyBubbles=b[0].live,l(a,c),o.addAlert("success","Explore bubbles around you",!0)})}function l(a,c){m.setCenter([c,a],14,b.aperture.state),b.showCreateNew=!0,angular.extend(e,{loading:!1}),angular.forEach(e.nearbyBubbles,function(a){a.lat&&a.lng&&m.addMarker(a._id,{lat:a.lat,lng:a.lng,draggable:!1,message:'<a href="#/w/'+a.id+'">'+a.name+"</a>",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[13,10]}})})}var m=h;angular.extend(e,{loading:!0});var n=g;n.resetNavBG();var o=i;b.aperture=f,b.aperture.set("off"),e.initGeo=function(){function a(a){var b=a.coords.latitude,c=a.coords.longitude;k(b,c)}function b(){j()}navigator.geolocation?navigator.geolocation.getCurrentPosition(a,b,{timeout:15e3,enableHighAccuracy:!0}):o("Your browser does not support geolocation :(")},e.initGeo(),b.addWorld=function(){a.path("/profile")}}function TalktagCtrl(a,b,c,d,e){e.showSwitch=!1,b.currentTag=c.hashTag,b.globalhashtag=global_hashtag,b.time="all",b.tweets=d.tweets.query({limit:60,tag:c.hashTag,time:b.time}),b.goBack=function(){window.history.back()},b.goTalk=function(){a.path("talk")}}function MenuCtrl(a,b,c,d,e){shelfPan("return"),window.scrollTo(0,0),e.showSwitch=!1,b.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.menuType=d.type}function ListCtrl(a,b,c,d,e){function f(){b.listLimit=10,b.queryType="events",b.queryFilter=d.filter,b.queryCat=d.category,b.landmarksList=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:"noNow"},function(){})}shelfPan("return"),window.scrollTo(0,0),e.showBack=!1,e.showBackPage=!1,e.showBackMark=!1,e.showSwitch=!1,b.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.listType=d.category,"lecture"==b.listType&&(b.day="WEDNESDAY"),"award"==b.listType&&(b.day="TUESDAY"),"show"==b.listType&&(b.day="THURSDAY"),f(),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})}}function WorldViewCtrl(a,b,c,d,e,f,g,h,i){"m"==b.option||shelfPan("closed"),"new"==b.option,angular.extend(i,{markers:{}}),c.option=b.option,c.landmark=a.get({_id:b.worldID},function(a){c.mainImageUrl=a.stats.avatar,c.time="all",c.currentTag=c.landmark.tags,c.tweets=d.tweets.query({tag:c.landmark.tags,time:c.time});var e={m:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],message:'<h4><img style="width:70px;" src="'+a.stats.avatar+'"><a href=#/landmark/'+b.landmarkId+"/m> "+a.name+"</a></h4>",focus:!0,icon:local_icons.yellowIcon}};angular.extend(i,{center:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],zoom:16},markers:e})}),c.open=function(){c.etherpad=!0},c.close=function(){c.etherpad=!1},c.opts={backdropFade:!0,dialogFade:!0},c.setImage=function(a){c.mainImageUrl=a},c.goBack=function(){window.history.back(),shelfPan("return")},c.edit=function(){e.path("/landmark/"+b.landmarkId+"/edit")}}function LandmarkViewCtrl(a,b,c,d,e,f,g,h,i){function j(a){"event"==a.type&&(l[a.loc_nickname]?(angular.extend(i,{center:{lat:l[a.loc_nickname][0],lng:l[a.loc_nickname][1],zoom:m,autoDiscover:!1},markers:{m:{lat:l[a.loc_nickname][0],lng:l[a.loc_nickname][1],message:"<h4>"+a.loc_nickname+"</h4>",focus:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.mapbox}),k()):(angular.extend(i,{center:{lat:l.NYC[0],lng:l.NYC[1],zoom:m},markers:{m:{lat:l.NYC[0],lng:l.NYC[1],message:"<h4>NYC</h4>",focus:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.mapbox}),k())),"place"==a.type&&("m"==b.option?(angular.extend(i,{center:{lat:a.loc[0],lng:a.loc[1],zoom:19,autoDiscover:!1},tiles:tilesDict.aicp}),k()):(angular.extend(i,{center:{lat:a.loc[0],lng:a.loc[1],zoom:19,autoDiscover:!1},markers:{m:{lat:a.loc[0],lng:a.loc[1],message:'<h4><img style="width:70px;" src="'+a.stats.avatar+'"><a href=#/post/'+a.id+"/m> "+a.name+"</a></h4>",focus:!1,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),k()))}function k(){g.getMap().then(function(a){a.invalidateSize()})}i.showSwitch=!1,i.showBackPage=!0,i.showNavIcons=!1,window.scrollTo(0,0);var l={BASECAMP:[40.7215408,-73.9967013],SKIRBALL:[40.7297,-73.9978],MoMA:[40.7615,-73.9777],NYC:[40.7127,-74.0059]},m=16;c.showMapNav=function(){1==i.showMapNav?(i.showMapNav=!1,shelfPan("partial")):i.showMapNav=!0},"m"==b.option?(shelfPan("partial"),i.showSwitch=!1,i.showBackPage=!1,i.showBack=!1,i.showMapNav=!1,i.showBackMark=!0,i.hideIFbar=!1):(shelfPan("partial"),angular.extend(i,{markers:{}})),c.option=b.option,c.landmark=a.get({_id:b.landmarkId},function(a){a.stats.avatar&&"img/tidepools/default.jpg"!==a.stats.avatar&&(c.mainImageUrl=a.stats.avatar),c.people=a.people,c.description=a.description,j(a),c.landmark.tags&&(c.time="all",c.currentTag=c.landmark.tags,c.tweets=d.tweets.query({tag:c.landmark.tags,time:c.time}))}),c.setImage=function(a){c.mainImageUrl=a},c.goBack=function(){window.history.back(),shelfPan("return")},c.edit=function(){e.path("/landmark/"+b.landmarkId+"/edit")}}function AwardsCtrl(a,b,c,d,e,f){function g(){e.getMap().then(function(a){a.invalidateSize()})}function h(a){"noNow"==a?k==n?(b.upcomingLimit=2,b.queryType="events",b.queryFilter="upcoming",b.queryCat=p,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:"upcomingToday"},function(a){0==a.length&&i()})):i():(b.upcomingLimit=1,b.queryType="events",b.queryFilter="upcoming",b.queryCat=p,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(){}))}function i(){b.happenedLimit=10,b.queryType="events",b.queryFilter="all",b.queryCat=p,b.landmarksHappened=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){})}shelfPan("return"),window.scrollTo(0,0);var j=new Date,k=j.getDate(),l=j.getMonth()+1,m=j.getFullYear();10>k&&(k="0"+k),10>l&&(l="0"+l);var j=k+"/"+l+"/"+m,n=10;n==k&&(b.itisToday=!0),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1;var o={BASECAMP:[40.7215408,-73.9967013],SKIRBALL:[40.7297,-73.9978]};angular.extend(f,{markers:{}}),angular.extend(f,{center:{lat:40.725,lng:-73.997,zoom:14},tiles:tilesDict.mapbox,markers:{b:{lat:o.SKIRBALL[0],lng:o.SKIRBALL[1],message:"<h4>SKIRBALL</h4>",focus:!1,icon:local_icons.yellowIcon},a:{lat:o.BASECAMP[0],lng:o.BASECAMP[1],message:"<h4>BASECAMP</h4>",focus:!0,icon:local_icons.yellowIcon}}}),g(),f.showSwitch=!0,f.radioModel="Tuesday",b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showBack=!0):(f.showSwitch=!0,f.showBack=!1)},f.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.refreshMap=function(){e.getMap().then(function(a){a.invalidateSize()})};var p="award";b.queryType="events",b.queryFilter="now",b.queryCat=p,b.landmarksNow=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){h(b.landmarksNow[0]?b.landmarksNow[0].time.end:"noNow")}),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")},b.goVote=function(){a.path("poll")}}function LecturesCtrl(a,b,c,d,e,f){function g(a){"noNow"==a?j==m?(b.upcomingLimit=2,b.queryType="events",b.queryFilter="upcoming",b.queryCat=o,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(a){0==a.length&&h()})):h():(b.upcomingLimit=1,b.queryType="events",b.queryFilter="upcoming",b.queryCat=o,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(){}))}function h(){b.happenedLimit=10,b.queryType="events",b.queryFilter="all",b.queryCat=o,b.landmarksHappened=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){})}shelfPan("return"),window.scrollTo(0,0);var i=new Date,j=i.getDate(),k=i.getMonth()+1,l=i.getFullYear();10>j&&(j="0"+j),10>k&&(k="0"+k);var i=j+"/"+k+"/"+l,m=11;m==j&&(b.itisToday=!0),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1,angular.extend(f,{markers:{}});var n={BASECAMP:[40.7215408,-73.9967013],MoMA:[40.7615,-73.9777]};angular.extend(f,{center:{lat:40.7415,lng:-73.985,zoom:12},tiles:tilesDict.mapbox,markers:{b:{lat:n.MoMA[0],lng:n.MoMA[1],message:"<h4>MoMA</h4>",focus:!1,icon:local_icons.yellowIcon},a:{lat:n.BASECAMP[0],lng:n.BASECAMP[1],message:"<h4>BASECAMP</h4>",focus:!0,icon:local_icons.yellowIcon}}}),f.radioModel="Wednesday",f.showSwitch=!0,b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showBack=!0):(f.showSwitch=!0,f.showBack=!1)},f.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a};var o="lecture";b.queryType="events",b.queryFilter="now",b.queryCat=o,b.landmarksNow=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,userTime:new Date},function(){g(b.landmarksNow[0]?b.landmarksNow[0].time.end:"noNow")}),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")}}function ShowCtrl(a,b,c,d,e,f){shelfPan("return"),window.scrollTo(0,0),f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1;var g=new Date,h=new Date("Jun 12 2014 15:59:59 GMT-0400 (EDT)");g>h?(b.showBootCamp=!1,b.showMoMA=!0):(b.showBootCamp=!0,b.showMoMA=!1),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.showSwitch=!0,f.radioModel="Thursday",b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),angular.extend(f,{center:{lat:40.76147,lng:-73.9778,zoom:19},tiles:tilesDict.aicp}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showMapNav=!0,f.showBack=!0,f.showNavIcons=!0,f.hideIFbar=!0):(f.showSwitch=!0,f.showMapNav=!1,f.showBack=!1,f.showNavIcons=!1,f.hideIFbar=!1)};var i={"1F":[40.7618,-73.978],"2F":[40.7612,-73.978],"5F":[40.7607,-73.978],GARDEN:[40.7619,-73.9771],EDUCATION:[40.761999,-73.9764]};f.mapPan=function(a){angular.extend(f,{center:{lat:i[a][0],lng:i[a][1],zoom:20},tiles:tilesDict.aicp})},f.goBack=function(){f.hideIFbar=!1,window.history.back()},b.goNow=function(){a.path("landmark/Kathryn_Gordon_Show")},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")};var j="'partial'";b.queryMap=function(a,b){window.scrollTo(0,0),f.singleModel=1,f.iconModel=b,c.landmarks.query({queryType:a,queryFilter:b},function(a){for(var b={},c=0;c<a.length;c++)"img/tidepools/default.jpg"==a[c].stats.avatar&&("bars"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/bar.png"),"exhibits"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/coolsculpt.png"),"food"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/food.png"),"smoking"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/smoking.png"),"washrooms"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/washrooms.png")),b[a[c].id]={lat:a[c].loc[0],lng:a[c].loc[1],message:"<a href=#/post/"+a[c].id+'/m><h4 onclick="shelfPan('+j+');"><img style="width:70px;" src="'+a[c].stats.avatar+'"> '+a[c].name+"</h4></a>",focus:!0,icon:local_icons.yellowIcon};angular.extend(f,{center:{lat:a[0].loc[0],lng:a[0].loc[1],zoom:18},markers:b,tiles:tilesDict.aicp})},function(){})},angular.extend(f,{markers:{}})}function floorSelector(a){function b(b){function c(a){var b=a.filter(function(a){return a[0].floor_num>0});return b.length?b.slice(-1)[0][0]:a[0][0]}function d(c){a.removeOverlays(),setTimeout(function(){var d=b.floors[c];d.forEach(function(b){a.addOverlay(b.localMapID,b.localMapName,b.localMapOptions)})},100)}function e(c){c=c||b.currentFloor.floor_num,b.loadLandmarks(),setTimeout(function(){var d=_.chain(b.landmarks).filter(function(a){return a.loc_info}).filter(function(a){return a.loc_info.floor_num!==c}).value();d.forEach(function(b){a.removeMarker(b._id)}),b.$apply()},500)}b.showFloors=!1,b.floors=_.chain(b.world.style.maps.localMapArray).filter(function(a){return a.floor_num}).groupBy(function(a){return a.floor_num}).sortBy(function(a){return-a.floor_num}).value().reverse(),b.currentFloor=b.floors.slice(-1)[0][0]>0?b.floors.slice(-1)[0][0]:c(b.floors),e(1),b.selectFloor=function(a){b.currentFloor=b.floors[a][0],d(a),e()},b.openFloorMenu=function(){b.showFloors=!b.showFloors}}return{restrict:"E",scope:{world:"=world",style:"=style",landmarks:"=landmarks",loadLandmarks:"&"},templateUrl:"components/floor_selector/floor.selector.html",link:b}}function floorNumberFilter(){return function(a){return a?a.floor_num<=1?a.floor_name[0]:a.floor_num:void 0}}function CategoryController(a,b,c,d,e,f,g,h,i,j,k){function l(){m.removeAllMarkers(),e.landmarks=[],b.landmarks.query({queryType:"all",queryFilter:"all",parentID:e.world._id},function(a){angular.forEach(a,function(a){a.category==e.category&&(e.landmarks.push(a),m.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:a.name}))})})}var m=j;e.worldURL=d.worldURL,e.category=d.category,e.aperture=i,e.aperture.set("full"),e.landmarks=[];var n=c.current;e.$on("$locationChangeSuccess",function(){n.$$route.originalPath===c.current.$$route.originalPath&&(e.category=c.current.params.category,c.current=n,l())}),a.get({id:e.worldURL},function(a){e.world=a.world,e.style=a.style,m.setMaxBoundsFromPoint([e.world.loc.coordinates[1],e.world.loc.coordinates[0]],.05),m.setCenter(e.world.loc.coordinates,17),l()})}LandmarkNewCtrl.$inject=["$location","$scope","$routeParams","db","$rootScope"],LandmarkEditCtrl.$inject=["Landmark","$location","$scope","$routeParams","db","$timeout","$rootScope"],WorldEditCtrl.$inject=["$location","$scope","db"],UserViewCtrl.$inject=["$location","$scope","db"],function(){"use strict";angular.module("leaflet-directive",[]).directive("leaflet",["$q","leafletData","leafletMapDefaults","leafletHelpers","leafletEvents",function(a,b,c,d,e){var f;return{restrict:"EA",replace:!0,scope:{center:"=",defaults:"=",maxbounds:"=",bounds:"=",markers:"=",legend:"=",geojson:"=",paths:"=",tiles:"=",layers:"=",controls:"=",decorations:"=",eventBroadcast:"="},transclude:!0,template:'<div class="angular-leaflet-map"><div ng-transclude></div></div>',controller:["$scope",function(b){f=a.defer(),this.getMap=function(){return f.promise},this.getLeafletScope=function(){return b}}],link:function(a,g,h){function i(){isNaN(h.width)?g.css("width",h.width):g.css("width",h.width+"px")}function j(){isNaN(h.height)?g.css("height",h.height):g.css("height",h.height+"px")}var k=d.isDefined,l=c.setDefaults(a.defaults,h.id),m=e.genDispatchMapEvent,n=e.getAvailableMapEvents();k(h.width)&&(i(),a.$watch(function(){return g[0].getAttribute("width")},function(){i(),o.invalidateSize()})),k(h.height)&&(j(),a.$watch(function(){return g[0].getAttribute("height")},function(){j(),o.invalidateSize()}));var o=new L.Map(g[0],c.getMapCreationDefaults(h.id));if(f.resolve(o),k(h.center)||o.setView([l.center.lat,l.center.lng],l.center.zoom),!k(h.tiles)&&!k(h.layers)){var p=L.tileLayer(l.tileLayer,l.tileLayerOptions);p.addTo(o),b.setTiles(p,h.id)}if(k(o.zoomControl)&&k(l.zoomControlPosition)&&o.zoomControl.setPosition(l.zoomControlPosition),k(o.zoomControl)&&l.zoomControl===!1&&o.zoomControl.removeFrom(o),k(o.zoomsliderControl)&&k(l.zoomsliderControl)&&l.zoomsliderControl===!1&&o.zoomsliderControl.removeFrom(o),!k(h.eventBroadcast))for(var q="broadcast",r=0;r<n.length;r++){var s=n[r];o.on(s,m(a,s,q),{eventName:s})}o.whenReady(function(){b.setMap(o,h.id)}),a.$on("$destroy",function(){o.remove(),b.unresolveMap(h.id)}),a.$on("invalidateSize",function(){o.invalidateSize()})}}}]),angular.module("leaflet-directive").directive("center",["$log","$q","$location","$timeout","leafletMapDefaults","leafletHelpers","leafletBoundsHelpers","leafletEvents",function(a,b,c,d,e,f,g,h){var i,j=f.isDefined,k=f.isNumber,l=f.isSameCenterOnMap,m=f.safeApply,n=f.isValidCenter,o=g.isValidBounds,p=f.isUndefinedOrEmpty,q=function(a,b){return j(a)&&o(a)&&p(b)};return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:function(){i=b.defer(),this.getCenter=function(){return i.promise}},link:function(b,f,o,p){var r=p.getLeafletScope(),s=r.center;p.getMap().then(function(f){var p=e.getDefaults(o.id);if(-1!==o.center.search("-"))return a.error('The "center" variable can\'t use a "-" on his key name: "'+o.center+'".'),void f.setView([p.center.lat,p.center.lng],p.center.zoom);if(q(r.bounds,s))f.fitBounds(g.createLeafletBounds(r.bounds)),s=f.getCenter(),m(r,function(a){a.center={lat:f.getCenter().lat,lng:f.getCenter().lng,zoom:f.getZoom(),autoDiscover:!1}}),m(r,function(a){var b=f.getBounds();a.bounds={northEast:{lat:b._northEast.lat,lng:b._northEast.lng},southWest:{lat:b._southWest.lat,lng:b._southWest.lng}}});else{if(!j(s))return a.error('The "center" property is not defined in the main scope'),void f.setView([p.center.lat,p.center.lng],p.center.zoom);j(s.lat)&&j(s.lng)||j(s.autoDiscover)||angular.copy(p.center,s)}var t,u;if("yes"===o.urlHashCenter){var v=function(){var a,b=c.search();if(j(b.c)){var d=b.c.split(":");3===d.length&&(a={lat:parseFloat(d[0]),lng:parseFloat(d[1]),zoom:parseInt(d[2],10)})}return a};t=v(),r.$on("$locationChangeSuccess",function(a){var b=a.currentScope,c=v();j(c)&&!l(c,f)&&(b.center={lat:c.lat,lng:c.lng,zoom:c.zoom})})}r.$watch("center",function(b){return j(t)&&(angular.copy(t,b),t=void 0),n(b)||b.autoDiscover===!0?b.autoDiscover===!0?(k(b.zoom)||f.setView([p.center.lat,p.center.lng],p.center.zoom),void f.locate(k(b.zoom)&&b.zoom>p.center.zoom?{setView:!0,maxZoom:b.zoom}:j(p.maxZoom)?{setView:!0,maxZoom:p.maxZoom}:{setView:!0})):void(u&&l(b,f)||(r.settingCenterFromScope=!0,f.setView([b.lat,b.lng],b.zoom),h.notifyCenterChangedToBounds(r,f),d(function(){r.settingCenterFromScope=!1}))):void a.warn("[AngularJS - Leaflet] invalid 'center'")},!0),f.whenReady(function(){u=!0}),f.on("moveend",function(){i.resolve(),h.notifyCenterUrlHashChanged(r,f,o,c.search()),l(s,f)||b.settingCenterFromScope||m(r,function(a){r.settingCenterFromScope||(a.center={lat:f.getCenter().lat,lng:f.getCenter().lng,zoom:f.getZoom(),autoDiscover:!1}),h.notifyCenterChangedToBounds(r,f)})}),s.autoDiscover===!0&&f.on("locationerror",function(){a.warn("[AngularJS - Leaflet] The Geolocation API is unauthorized on this page."),n(s)?(f.setView([s.lat,s.lng],s.zoom),h.notifyCenterChangedToBounds(r,f)):(f.setView([p.center.lat,p.center.lng],p.center.zoom),h.notifyCenterChangedToBounds(r,f))})})}}}]),angular.module("leaflet-directive").directive("tiles",["$log","leafletData","leafletMapDefaults","leafletHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(e,f,g,h){var i=d.isDefined,j=h.getLeafletScope(),k=j.tiles;
return i(k)||i(k.url)?void h.getMap().then(function(a){var d,e=c.getDefaults(g.id);j.$watch("tiles",function(c){var f=e.tileLayerOptions,h=e.tileLayer;return!i(c.url)&&i(d)?void a.removeLayer(d):i(d)?i(c.url)&&i(c.options)&&!angular.equals(c.options,f)?(a.removeLayer(d),f=e.tileLayerOptions,angular.copy(c.options,f),h=c.url,d=L.tileLayer(h,f),d.addTo(a),void b.setTiles(d,g.id)):void(i(c.url)&&d.setUrl(c.url)):(i(c.options)&&angular.copy(c.options,f),i(c.url)&&(h=c.url),d=L.tileLayer(h,f),d.addTo(a),void b.setTiles(d,g.id))},!0)}):void a.warn("[AngularJS - Leaflet] The 'tiles' definition doesn't have the 'url' property.")}}}]),angular.module("leaflet-directive").directive("legend",["$log","$http","leafletHelpers","leafletLegendHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(e,f,g,h){var i,j,k,l,m=c.isArray,n=c.isDefined,o=c.isFunction,p=h.getLeafletScope(),q=p.legend;p.$watch("legend",function(a){n(a)&&(i=a.legendClass?a.legendClass:"legend",j=a.position||"bottomright",l=a.type||"arcgis")},!0),h.getMap().then(function(c){p.$watch("legend",function(b){return n(b)?n(b.url)||"arcgis"!==l||m(b.colors)&&m(b.labels)&&b.colors.length===b.labels.length?n(b.url)?void a.info("[AngularJS - Leaflet] loading legend service."):(n(k)&&(k.removeFrom(c),k=null),k=L.control({position:j}),"arcgis"===l&&(k.onAdd=d.getOnAddArrayLegend(b,i)),void k.addTo(c)):void a.warn("[AngularJS - Leaflet] legend.colors and legend.labels must be set."):void(n(k)&&(k.removeFrom(c),k=null))}),p.$watch("legend.url",function(e){n(e)&&b.get(e).success(function(a){n(k)?d.updateLegend(k.getContainer(),a,l,e):(k=L.control({position:j}),k.onAdd=d.getOnAddLegend(a,i,l,e),k.addTo(c)),n(q.loadedData)&&o(q.loadedData)&&q.loadedData()}).error(function(){a.warn("[AngularJS - Leaflet] legend.url not loaded.")})})})}}}]),angular.module("leaflet-directive").directive("geojson",["$log","$rootScope","leafletData","leafletHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(a,e,f,g){var h=d.safeApply,i=d.isDefined,j=g.getLeafletScope(),k={};g.getMap().then(function(a){j.$watchCollection("geojson",function(e){if(i(k)&&a.hasLayer(k)&&a.removeLayer(k),i(e)&&i(e.data)){var g,l=e.resetStyleOnMouseout;g=angular.isFunction(e.onEachFeature)?e.onEachFeature:function(a,c){d.LabelPlugin.isLoaded()&&i(e.label)&&c.bindLabel(a.properties.description),c.on({mouseover:function(c){h(j,function(){b.$broadcast("leafletDirectiveMap.geojsonMouseover",a,c)})},mouseout:function(a){l&&k.resetStyle(a.target),h(j,function(){b.$broadcast("leafletDirectiveMap.geojsonMouseout",a)})},click:function(c){h(j,function(){b.$broadcast("leafletDirectiveMap.geojsonClick",a,c)})}})},i(e.options)||(e.options={style:e.style,filter:e.filter,onEachFeature:g,pointToLayer:e.pointToLayer}),k=L.geoJson(e.data,e.options),c.setGeoJSON(k,f.id),k.addTo(a)}})})}}}]),angular.module("leaflet-directive").directive("layers",["$log","$q","leafletData","leafletHelpers","leafletLayerHelpers","leafletControlHelpers",function(a,b,c,d,e,f){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:["$scope",function(a){a._leafletLayers=b.defer(),this.getLayers=function(){return a._leafletLayers.promise}}],link:function(a,b,g,h){var i=d.isDefined,j={},k=h.getLeafletScope(),l=k.layers,m=e.createLayer,n=f.updateLayersControl,o=!1;h.getMap().then(function(b){a._leafletLayers.resolve(j),c.setLayers(j,g.id),j.baselayers={},j.overlays={};var d=g.id,e=!1;for(var f in l.baselayers){var h=m(l.baselayers[f]);i(h)?(j.baselayers[f]=h,l.baselayers[f].top===!0&&(b.addLayer(j.baselayers[f]),e=!0)):delete l.baselayers[f]}!e&&Object.keys(j.baselayers).length>0&&b.addLayer(j.baselayers[Object.keys(l.baselayers)[0]]);for(f in l.overlays){"cartodb"===l.overlays[f].type;var p=m(l.overlays[f]);i(p)?(j.overlays[f]=p,l.overlays[f].visible===!0&&b.addLayer(j.overlays[f])):delete l.overlays[f]}k.$watch("layers.baselayers",function(a){for(var c in j.baselayers)i(a[c])||(b.hasLayer(j.baselayers[c])&&b.removeLayer(j.baselayers[c]),delete j.baselayers[c]);for(var e in a)if(i(j.baselayers[e]))a[e].top!==!0||b.hasLayer(j.baselayers[e])?a[e].top===!1&&b.hasLayer(j.baselayers[e])&&b.removeLayer(j.baselayers[e]):b.addLayer(j.baselayers[e]);else{var f=m(a[e]);i(f)&&(j.baselayers[e]=f,a[e].top===!0&&b.addLayer(j.baselayers[e]))}var g=!1;for(var h in j.baselayers)if(b.hasLayer(j.baselayers[h])){g=!0;break}!g&&Object.keys(l.baselayers).length>0&&b.addLayer(j.baselayers[Object.keys(l.baselayers)[0]]),o=n(b,d,o,a,l.overlays,j)},!0),k.$watch("layers.overlays",function(a){for(var c in j.overlays)i(a[c])||(b.hasLayer(j.overlays[c])&&b.removeLayer(j.overlays[c]),delete j.overlays[c]);for(var e in a){if(!i(j.overlays[e])){var f=m(a[e]);i(f)&&(j.overlays[e]=f,a[e].visible===!0&&b.addLayer(j.overlays[e]))}a[e].visible&&!b.hasLayer(j.overlays[e])?b.addLayer(j.overlays[e]):a[e].visible===!1&&b.hasLayer(j.overlays[e])&&b.removeLayer(j.overlays[e]),a[e].visible&&b._loaded&&a[e].data&&"heatmap"===a[e].type&&(j.overlays[e].setData(a[e].data),j.overlays[e].update())}o=n(b,d,o,l.baselayers,a,j)},!0)})}}}]),angular.module("leaflet-directive").directive("bounds",["$log","$timeout","leafletHelpers","leafletBoundsHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","center"],link:function(e,f,g,h){var i=c.isDefined,j=d.createLeafletBounds,k=h[0].getLeafletScope(),l=h[0],m=function(a){return 0===a._southWest.lat&&0===a._southWest.lng&&0===a._northEast.lat&&0===a._northEast.lng};l.getMap().then(function(c){k.$on("boundsChanged",function(a){var b=a.currentScope,d=c.getBounds();if(!m(d)&&!b.settingBoundsFromScope){var e={northEast:{lat:d._northEast.lat,lng:d._northEast.lng},southWest:{lat:d._southWest.lat,lng:d._southWest.lng}};angular.equals(b.bounds,e)||(b.bounds=e)}}),k.$watch("bounds",function(d){if(!i(d))return void a.error("[AngularJS - Leaflet] Invalid bounds");var f=j(d);f&&!c.getBounds().equals(f)&&(e.settingBoundsFromScope=!0,c.fitBounds(f),b(function(){e.settingBoundsFromScope=!1}))},!0)})}}}]),angular.module("leaflet-directive").directive("markers",["$log","$rootScope","$q","leafletData","leafletHelpers","leafletMapDefaults","leafletMarkersHelpers","leafletEvents",function(a,b,c,d,e,f,g,h){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","?layers"],link:function(b,f,i,j){var k=j[0],l=e,m=e.isDefined,n=e.isString,o=k.getLeafletScope(),p=g.deleteMarker,q=g.addMarkerWatcher,r=g.listenMarkerEvents,s=g.addMarkerToGroup,t=h.bindMarkerEvents,u=g.createMarker;k.getMap().then(function(b){var e,f={};e=m(j[1])?j[1].getLayers:function(){var a=c.defer();return a.resolve(),a.promise},e().then(function(c){d.setMarkers(f,i.id),o.$watch("markers",function(d){for(var e in f)m(d)&&m(d[e])||(p(f[e],b,c),delete f[e]);var h=!m(i.watchMarkers)||"true"===i.watchMarkers;for(var j in d)if(-1===j.search("-")){if(!m(f[j])){var k=d[j],v=u(k);if(!m(v)){a.error("[AngularJS - Leaflet] Received invalid data on the marker "+j+".");continue}if(f[j]=v,m(k.message)&&v.bindPopup(k.message,k.popupOptions),m(k.group)){var w=m(k.groupOption)?k.groupOption:null;s(v,k.group,w,b)}if(l.LabelPlugin.isLoaded()&&m(k.label)&&m(k.label.message)&&v.bindLabel(k.label.message,k.label.options),m(k)&&m(k.layer)){if(!n(k.layer)){a.error("[AngularJS - Leaflet] A layername must be a string");continue}if(!m(c)){a.error("[AngularJS - Leaflet] You must add layers to the directive if the markers are going to use this functionality.");continue}if(!m(c.overlays)||!m(c.overlays[k.layer])){a.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group"');continue}var x=c.overlays[k.layer];if(!(x instanceof L.LayerGroup||x instanceof L.FeatureGroup)){a.error('[AngularJS - Leaflet] Adding a marker to an overlay needs a overlay of the type "group" or "featureGroup"');continue}x.addLayer(v),!h&&b.hasLayer(v)&&k.focus===!0&&g.manageOpenPopup(v,k)}else m(k.group)||(b.addLayer(v),h||k.focus!==!0||g.manageOpenPopup(v,k));h&&q(v,j,o,c,b),r(v,k,o,h),t(v,j,k,o)}}else a.error('The marker can\'t use a "-" on his key name: "'+j+'".')},!0)})})}}}]),angular.module("leaflet-directive").directive("paths",["$log","$q","leafletData","leafletMapDefaults","leafletHelpers","leafletPathsHelpers","leafletEvents",function(a,b,c,d,e,f,g){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","?layers"],link:function(h,i,j,k){var l=k[0],m=e.isDefined,n=e.isString,o=l.getLeafletScope(),p=o.paths,q=f.createPath,r=g.bindPathEvents,s=f.setPathOptions;l.getMap().then(function(f){var g,h=d.getDefaults(j.id);g=m(k[1])?k[1].getLayers:function(){var a=b.defer();return a.resolve(),a.promise},m(p)&&g().then(function(b){var d={};c.setPaths(d,j.id);var g=!m(j.watchPaths)||"true"===j.watchPaths,i=function(a,c){var d=o.$watch('paths["'+c+'"]',function(c,e){if(!m(c)){if(m(e.layer))for(var g in b.overlays){var h=b.overlays[g];h.removeLayer(a)}return f.removeLayer(a),void d()}s(a,c.type,c)},!0)};o.$watchCollection("paths",function(c){for(var j in d)m(c[j])||(f.removeLayer(d[j]),delete d[j]);for(var k in c)if(0!==k.search("\\$"))if(-1===k.search("-")){if(!m(d[k])){var l=c[k],p=q(k,c[k],h);if(m(p)&&m(l.message)&&p.bindPopup(l.message),e.LabelPlugin.isLoaded()&&m(l.label)&&m(l.label.message)&&p.bindLabel(l.label.message,l.label.options),m(l)&&m(l.layer)){if(!n(l.layer)){a.error("[AngularJS - Leaflet] A layername must be a string");continue}if(!m(b)){a.error("[AngularJS - Leaflet] You must add layers to the directive if the markers are going to use this functionality.");continue}if(!m(b.overlays)||!m(b.overlays[l.layer])){a.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group"');continue}var t=b.overlays[l.layer];if(!(t instanceof L.LayerGroup||t instanceof L.FeatureGroup)){a.error('[AngularJS - Leaflet] Adding a marker to an overlay needs a overlay of the type "group" or "featureGroup"');continue}d[k]=p,t.addLayer(p),g?i(p,k):s(p,l.type,l)}else m(p)&&(d[k]=p,f.addLayer(p),g?i(p,k):s(p,l.type,l));r(p,k,l,o)}}else a.error('[AngularJS - Leaflet] The path name "'+k+'" is not valid. It must not include "-" and a number.')})})})}}}]),angular.module("leaflet-directive").directive("controls",["$log","leafletHelpers",function(a,b){return{restrict:"A",scope:!1,replace:!1,require:"?^leaflet",link:function(a,c,d,e){if(e){var f=b.isDefined,g=e.getLeafletScope(),h=g.controls;e.getMap().then(function(a){if(f(L.Control.Draw)&&f(h.draw)){f(h.edit)||(h.edit={featureGroup:new L.FeatureGroup},a.addLayer(h.edit.featureGroup));var b=new L.Control.Draw(h);a.addControl(b)}if(f(h.scale)){var c=new L.control.scale;a.addControl(c)}if(f(h.custom))for(var d in h.custom)a.addControl(h.custom[d])})}}}}]),angular.module("leaflet-directive").directive("eventBroadcast",["$log","$rootScope","leafletHelpers","leafletEvents",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(b,e,f,g){var h=c.isObject,i=c.isDefined,j=g.getLeafletScope(),k=j.eventBroadcast,l=d.getAvailableMapEvents(),m=d.genDispatchMapEvent;g.getMap().then(function(b){var c,d,e=[],f="broadcast";if(i(k.map))if(h(k.map))if("emit"!==k.map.logic&&"broadcast"!==k.map.logic?a.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):f=k.map.logic,h(k.map.enable)&&k.map.enable.length>=0)for(c=0;c<k.map.enable.length;c++)d=k.map.enable[c],-1===e.indexOf(d)&&-1!==l.indexOf(d)&&e.push(d);else a.warn("[AngularJS - Leaflet] event-broadcast.map.enable must be an object check your model.");else a.warn("[AngularJS - Leaflet] event-broadcast.map must be an object check your model.");else e=l;for(c=0;c<e.length;c++)d=e[c],b.on(d,m(j,d,f),{eventName:d})})}}}]),angular.module("leaflet-directive").directive("maxbounds",["$log","leafletMapDefaults","leafletBoundsHelpers",function(a,b,c){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(a,b,d,e){var f=e.getLeafletScope(),g=c.isValidBounds;e.getMap().then(function(a){f.$watch("maxbounds",function(b){if(!g(b))return void a.setMaxBounds();var c=[[b.southWest.lat,b.southWest.lng],[b.northEast.lat,b.northEast.lng]];a.setMaxBounds(c),d.center||a.fitBounds(c)})})}}}]),angular.module("leaflet-directive").directive("decorations",["$log","leafletHelpers",function(a,b){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(c,d,e,f){function g(b){return k(b)&&k(b.coordinates)&&(j.isLoaded()||a.error("[AngularJS - Leaflet] The PolylineDecorator Plugin is not loaded.")),L.polylineDecorator(b.coordinates)}function h(a,b){return k(a)&&k(b)&&k(b.coordinates)&&k(b.patterns)?(a.setPaths(b.coordinates),a.setPatterns(b.patterns),a):void 0}var i=f.getLeafletScope(),j=b.PolylineDecoratorPlugin,k=b.isDefined,l={};f.getMap().then(function(a){i.$watch("decorations",function(b){for(var c in l)k(b)&&k(b[c])||(a.removeLayer(l[c]),delete l[c]);for(var d in b){var e=b[d],f=g(e);k(f)&&(l[d]=f,a.addLayer(f),h(f,e))}},!0)})}}}]),angular.module("leaflet-directive").directive("layercontrol",["$log","leafletData","leafletHelpers",function(a,b,c){return{restrict:"E",scope:{},replace:!0,transclude:!1,require:"^leaflet",controller:["$scope","$element","$sce",function(d,e,f){a.debug("[Angular Directive - Layers] layers",d,e);var g=c.safeApply,h=c.isDefined;angular.extend(d,{baselayer:"",icons:{uncheck:"fa fa-check-square-o",check:"fa fa-square-o",radio:"fa fa-dot-circle-o",unradio:"fa fa-circle-o",up:"fa fa-angle-up",down:"fa fa-angle-down",open:"fa fa-angle-double-down",close:"fa fa-angle-double-up"},changeBaseLayer:function(a,e){c.safeApply(d,function(c){c.baselayer=a,b.getMap().then(function(e){b.getLayers().then(function(b){if(!e.hasLayer(b.baselayers[a])){for(var f in c.layers.baselayers)c.layers.baselayers[f].icon=c.icons.unradio,e.hasLayer(b.baselayers[f])&&e.removeLayer(b.baselayers[f]);e.addLayer(b.baselayers[a]),c.layers.baselayers[a].icon=d.icons.radio}})})}),e.preventDefault()},moveLayer:function(a,b,c){var e=Object.keys(d.layers.baselayers).length;if(b>=1+e&&b<=d.overlaysArray.length+e){var f;for(var h in d.layers.overlays)if(d.layers.overlays[h].index===b){f=d.layers.overlays[h];break}f&&g(d,function(){f.index=a.index,a.index=b})}c.stopPropagation(),c.preventDefault()},initIndex:function(a,b){var c=Object.keys(d.layers.baselayers).length;a.index=h(a.index)?a.index:b+c+1},toggleOpacity:function(b,c){if(a.debug("Event",b),c.visible){var e=angular.element(b.currentTarget);e.toggleClass(d.icons.close+" "+d.icons.open),e=e.parents(".lf-row").find(".lf-opacity"),e.toggle("fast",function(){g(d,function(){c.opacityControl=!c.opacityControl})})}b.stopPropagation(),b.preventDefault()},unsafeHTML:function(a){return f.trustAsHtml(a)}});var i=e.get(0);L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(i),L.DomEvent.on(i,"mousewheel",L.DomEvent.stopPropagation))}],template:'<div class="angular-leaflet-control-layers" ng-show="overlaysArray.length"><div class="lf-baselayers"><div class="lf-row" ng-repeat="(key, layer) in layers.baselayers"><label class="lf-icon-bl" ng-click="changeBaseLayer(key, $event)"><input class="leaflet-control-layers-selector" type="radio" name="lf-radio" ng-show="false" ng-checked="baselayer === key" ng-value="key" /> <i class="lf-icon lf-icon-radio" ng-class="layer.icon"></i><div class="lf-text">{{layer.name}}</div></label></div></div><div class="lf-overlays"><div class="lf-container"><div class="lf-row" ng-repeat="layer in overlaysArray | orderBy:\'index\':order" ng-init="initIndex(layer, $index)"><label class="lf-icon-ol"><input class="lf-control-layers-selector" type="checkbox" ng-show="false" ng-model="layer.visible"/> <i class="lf-icon lf-icon-check" ng-class="layer.icon"></i><div class="lf-text">{{layer.name}}</div><div class="lf-icons"><i class="lf-icon lf-up" ng-class="icons.up" ng-click="moveLayer(layer, layer.index - orderNumber, $event)"></i> <i class="lf-icon lf-down" ng-class="icons.down" ng-click="moveLayer(layer, layer.index + orderNumber, $event)"></i> <i class="lf-icon lf-open" ng-class="layer.opacityControl? icons.close:icons.open" ng-click="toggleOpacity($event, layer)"></i></div></label><div class="lf-legend" ng-if="layer.legend" ng-bind-html="unsafeHTML(layer.legend)"></div><div class="lf-opacity" ng-show="layer.visible &amp;&amp; layer.opacityControl"><input type="text" class="lf-opacity-control" name="lf-opacity-control" data-key="{{layer.index}}" /></div></div></div></div></div>',link:function(d,e,f,g){var h=c.isDefined,i=g.getLeafletScope(),j=i.layers;f.order=!h(f.order)||"normal"!==f.order&&"reverse"!==f.order?"normal":f.order,d.order="normal"===f.order,d.orderNumber="normal"===f.order?-1:1,d.layers=j,g.getMap().then(function(c){i.$watch("layers.baselayers",function(a){b.getLayers().then(function(b){var e;for(e in a)a[e].icon=c.hasLayer(b.baselayers[e])?d.icons.radio:d.icons.unradio})}),i.$watch("layers.overlays",function(f){var g=[];b.getLayers().then(function(a){for(var b in f)f[b].icon=d.icons[f[b].visible?"uncheck":"check"],g.push(f[b]),h(f[b].index)&&a.overlays[b].setZIndex&&a.overlays[b].setZIndex(f[b].index)});var i=d.$watch(function(){return e.children().size()>1?(e.find(".lf-overlays").trigger("resize"),e.find(".lf-opacity").size()===Object.keys(j.overlays).length):void 0},function(f){f===!0&&(h(e.find(".lf-opacity-control").ionRangeSlider)?e.find(".lf-opacity-control").each(function(a,e){var f,g=Object.keys(j.baselayers).length;for(var i in d.overlaysArray)d.overlaysArray[i].index===a+g+1&&(f=d.overlaysArray[i]);var k=angular.element(e),l=h(f)&&h(f.layerOptions)?f.layerOptions.opacity:void 0;k.ionRangeSlider({min:0,from:h(l)?Math.ceil(100*l):100,step:1,max:100,prettify:!1,hasGrid:!1,hideMinMax:!0,onChange:function(a){b.getLayers().then(function(b){var d,e,f=a.input.data().key;for(var g in j.overlays)if(j.overlays[g].index===f){d=b.overlays[g],e=j.overlays[g];break}c.hasLayer(d)&&(e.layerOptions=h(e.layerOptions)?e.layerOptions:{},e.layerOptions.opacity=a.input.val()/100,d.setOpacity&&d.setOpacity(a.input.val()/100),d.getLayers&&d.eachLayer&&d.eachLayer(function(b){b.setOpacity&&b.setOpacity(a.input.val()/100)}))})}})}):a.warn("[AngularJS - Leaflet] Ion Slide Range Plugin is not loaded"),i())});d.overlaysArray=g},!0)})}}}]),angular.module("leaflet-directive").service("leafletData",["$log","$q","leafletHelpers",function(a,b,c){var d=c.getDefer,e=c.getUnresolvedDefer,f=c.setResolvedDefer,g={},h={},i={},j={},k={},l={},m={},n={};this.setMap=function(a,b){var c=e(g,b);c.resolve(a),f(g,b)},this.getMap=function(a){var b=d(g,a);return b.promise},this.unresolveMap=function(a){var b=c.obtainEffectiveMapId(g,a);g[b]=void 0,h[b]=void 0,i[b]=void 0,j[b]=void 0,k[b]=void 0,l[b]=void 0,m[b]=void 0,n[b]=void 0},this.getPaths=function(a){var b=d(j,a);return b.promise},this.setPaths=function(a,b){var c=e(j,b);c.resolve(a),f(j,b)},this.getMarkers=function(a){var b=d(k,a);return b.promise},this.setMarkers=function(a,b){var c=e(k,b);c.resolve(a),f(k,b)},this.getLayers=function(a){var b=d(i,a);return b.promise},this.setLayers=function(a,b){var c=e(i,b);c.resolve(a),f(i,b)},this.getUTFGrid=function(a){var b=d(m,a);return b.promise},this.setUTFGrid=function(a,b){var c=e(m,b);c.resolve(a),f(m,b)},this.setTiles=function(a,b){var c=e(h,b);c.resolve(a),f(h,b)},this.getTiles=function(a){var b=d(h,a);return b.promise},this.setGeoJSON=function(a,b){var c=e(l,b);c.resolve(a),f(l,b)},this.getGeoJSON=function(a){var b=d(l,a);return b.promise},this.setDecorations=function(a,b){var c=e(n,b);c.resolve(a),f(n,b)},this.getDecorations=function(a){var b=d(n,a);return b.promise}}]),angular.module("leaflet-directive").factory("leafletMapDefaults",["$q","leafletHelpers",function(a,b){function c(){return{keyboard:!0,dragging:!0,worldCopyJump:!1,doubleClickZoom:!0,scrollWheelZoom:!0,tap:!0,touchZoom:!0,zoomControl:!0,zoomsliderControl:!1,zoomControlPosition:"topleft",attributionControl:!0,controls:{layers:{visible:!0,position:"topright",collapsed:!0}},crs:L.CRS.EPSG3857,tileLayer:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",tileLayerOptions:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'},path:{weight:10,opacity:1,color:"#0000ff"},center:{lat:0,lng:0,zoom:1}}}var d=b.isDefined,e=b.isObject,f=b.obtainEffectiveMapId,g={};return{getDefaults:function(a){var b=f(g,a);return g[b]},getMapCreationDefaults:function(a){var b=f(g,a),c=g[b],e={maxZoom:c.maxZoom,keyboard:c.keyboard,dragging:c.dragging,zoomControl:c.zoomControl,doubleClickZoom:c.doubleClickZoom,scrollWheelZoom:c.scrollWheelZoom,tap:c.tap,touchZoom:c.touchZoom,attributionControl:c.attributionControl,worldCopyJump:c.worldCopyJump,crs:c.crs};if(d(c.minZoom)&&(e.minZoom=c.minZoom),d(c.zoomAnimation)&&(e.zoomAnimation=c.zoomAnimation),d(c.fadeAnimation)&&(e.fadeAnimation=c.fadeAnimation),d(c.markerZoomAnimation)&&(e.markerZoomAnimation=c.markerZoomAnimation),c.map)for(var h in c.map)e[h]=c.map[h];return e},setDefaults:function(a,b){var h=c();d(a)&&(h.doubleClickZoom=d(a.doubleClickZoom)?a.doubleClickZoom:h.doubleClickZoom,h.scrollWheelZoom=d(a.scrollWheelZoom)?a.scrollWheelZoom:h.doubleClickZoom,h.tap=d(a.tap)?a.tap:h.tap,h.touchZoom=d(a.touchZoom)?a.touchZoom:h.doubleClickZoom,h.zoomControl=d(a.zoomControl)?a.zoomControl:h.zoomControl,h.zoomsliderControl=d(a.zoomsliderControl)?a.zoomsliderControl:h.zoomsliderControl,h.attributionControl=d(a.attributionControl)?a.attributionControl:h.attributionControl,h.tileLayer=d(a.tileLayer)?a.tileLayer:h.tileLayer,h.zoomControlPosition=d(a.zoomControlPosition)?a.zoomControlPosition:h.zoomControlPosition,h.keyboard=d(a.keyboard)?a.keyboard:h.keyboard,h.dragging=d(a.dragging)?a.dragging:h.dragging,d(a.controls)&&angular.extend(h.controls,a.controls),e(a.crs)?h.crs=a.crs:d(L.CRS[a.crs])&&(h.crs=L.CRS[a.crs]),d(a.center)&&angular.copy(a.center,h.center),d(a.tileLayerOptions)&&angular.copy(a.tileLayerOptions,h.tileLayerOptions),d(a.maxZoom)&&(h.maxZoom=a.maxZoom),d(a.minZoom)&&(h.minZoom=a.minZoom),d(a.zoomAnimation)&&(h.zoomAnimation=a.zoomAnimation),d(a.fadeAnimation)&&(h.fadeAnimation=a.fadeAnimation),d(a.markerZoomAnimation)&&(h.markerZoomAnimation=a.markerZoomAnimation),d(a.worldCopyJump)&&(h.worldCopyJump=a.worldCopyJump),d(a.map)&&(h.map=a.map));var i=f(g,b);return g[i]=h,h}}}]),angular.module("leaflet-directive").factory("leafletEvents",["$rootScope","$q","$log","leafletHelpers",function(a,b,c,d){var e=d.safeApply,f=d.isDefined,g=d.isObject,h=d,i=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu"]},j=function(a,b,c,d){for(var e=i(),f="markers."+d,g=0;g<e.length;g++){var h=e[g];c.label.on(h,m(a,h,b,c.label,f))}},k=function(b,c,d,f,g,h){return function(i){var j="leafletDirectiveMarker."+b;"click"===b?e(d,function(){a.$broadcast("leafletDirectiveMarkersClick",g)}):"dragend"===b&&(e(d,function(){h.lat=f.getLatLng().lat,h.lng=f.getLatLng().lng}),h.message&&h.focus===!0&&f.openPopup()),e(d,function(b){"emit"===c?b.$emit(j,{markerName:g,leafletEvent:i}):a.$broadcast(j,{markerName:g,leafletEvent:i})})}},l=function(b,c,d,f,g){return function(f){var h="leafletDirectivePath."+b;e(d,function(b){"emit"===c?b.$emit(h,{pathName:g,leafletEvent:f}):a.$broadcast(h,{pathName:g,leafletEvent:f})})}},m=function(b,c,d,f,g){return function(h){var i="leafletDirectiveLabel."+c,j=g.replace("markers.","");e(b,function(b){"emit"===d?b.$emit(i,{leafletEvent:h,label:f,markerName:j}):"broadcast"===d&&a.$broadcast(i,{leafletEvent:h,label:f,markerName:j})})}},n=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu","dragstart","drag","dragend","move","remove","popupopen","popupclose"]},o=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu","add","remove","popupopen","popupclose"]};return{getAvailableMapEvents:function(){return["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","focus","blur","preclick","load","unload","viewreset","movestart","move","moveend","dragstart","drag","dragend","zoomstart","zoomend","zoomlevelschange","resize","autopanstart","layeradd","layerremove","baselayerchange","overlayadd","overlayremove","locationfound","locationerror","popupopen","popupclose","draw:created","draw:edited","draw:deleted","draw:drawstart","draw:drawstop","draw:editstart","draw:editstop","draw:deletestart","draw:deletestop"]},genDispatchMapEvent:function(b,c,d){return function(f){var g="leafletDirectiveMap."+c;e(b,function(b){"emit"===d?b.$emit(g,{leafletEvent:f}):"broadcast"===d&&a.$broadcast(g,{leafletEvent:f})})}},getAvailableMarkerEvents:n,getAvailablePathEvents:o,notifyCenterChangedToBounds:function(a){a.$broadcast("boundsChanged")},notifyCenterUrlHashChanged:function(a,b,c,d){if(f(c.urlHashCenter)){var e=b.getCenter(),g=e.lat.toFixed(4)+":"+e.lng.toFixed(4)+":"+b.getZoom();f(d.c)&&d.c===g||a.$emit("centerUrlHash",g)}},bindMarkerEvents:function(a,b,d,e){var i,l,m=[],o="emit";if(f(e.eventBroadcast))if(g(e.eventBroadcast))if(f(e.eventBroadcast.marker))if(g(e.eventBroadcast.marker)){void 0!==e.eventBroadcast.marker.logic&&null!==e.eventBroadcast.marker.logic&&("emit"!==e.eventBroadcast.marker.logic&&"broadcast"!==e.eventBroadcast.marker.logic?c.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):"emit"===e.eventBroadcast.marker.logic&&(o="emit"));var p=!1,q=!1;if(void 0!==e.eventBroadcast.marker.enable&&null!==e.eventBroadcast.marker.enable&&"object"==typeof e.eventBroadcast.marker.enable&&(p=!0),void 0!==e.eventBroadcast.marker.disable&&null!==e.eventBroadcast.marker.disable&&"object"==typeof e.eventBroadcast.marker.disable&&(q=!0),p&&q)c.warn("[AngularJS - Leaflet] can not enable and disable events at the same time");else if(p||q)if(p)for(i=0;i<e.eventBroadcast.marker.enable.length;i++)l=e.eventBroadcast.marker.enable[i],-1!==m.indexOf(l)?c.warn("[AngularJS - Leaflet] This event "+l+" is already enabled"):-1===n().indexOf(l)?c.warn("[AngularJS - Leaflet] This event "+l+" does not exist"):m.push(l);else for(m=n(),i=0;i<e.eventBroadcast.marker.disable.length;i++){l=e.eventBroadcast.marker.disable[i];var r=m.indexOf(l);-1===r?c.warn("[AngularJS - Leaflet] This event "+l+" does not exist or has been already disabled"):m.splice(r,1)}else c.warn("[AngularJS - Leaflet] must enable or disable events")}else c.warn("[AngularJS - Leaflet] event-broadcast.marker must be an object check your model.");else m=n();else c.error("[AngularJS - Leaflet] event-broadcast must be an object check your model.");else m=n();for(i=0;i<m.length;i++)l=m[i],a.on(l,k(l,o,e,a,b,d));h.LabelPlugin.isLoaded()&&f(a.label)&&j(e,o,a,b)},bindPathEvents:function(a,b,d,e){var i,k,m=[],n="broadcast";if(f(e.eventBroadcast))if(g(e.eventBroadcast))if(f(e.eventBroadcast.path))if(g(e.eventBroadcast.paths))c.warn("[AngularJS - Leaflet] event-broadcast.path must be an object check your model.");else{void 0!==e.eventBroadcast.path.logic&&null!==e.eventBroadcast.path.logic&&("emit"!==e.eventBroadcast.path.logic&&"broadcast"!==e.eventBroadcast.path.logic?c.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):"emit"===e.eventBroadcast.path.logic&&(n="emit"));var p=!1,q=!1;if(void 0!==e.eventBroadcast.path.enable&&null!==e.eventBroadcast.path.enable&&"object"==typeof e.eventBroadcast.path.enable&&(p=!0),void 0!==e.eventBroadcast.path.disable&&null!==e.eventBroadcast.path.disable&&"object"==typeof e.eventBroadcast.path.disable&&(q=!0),p&&q)c.warn("[AngularJS - Leaflet] can not enable and disable events at the same time");else if(p||q)if(p)for(i=0;i<e.eventBroadcast.path.enable.length;i++)k=e.eventBroadcast.path.enable[i],-1!==m.indexOf(k)?c.warn("[AngularJS - Leaflet] This event "+k+" is already enabled"):-1===o().indexOf(k)?c.warn("[AngularJS - Leaflet] This event "+k+" does not exist"):m.push(k);else for(m=o(),i=0;i<e.eventBroadcast.path.disable.length;i++){k=e.eventBroadcast.path.disable[i];var r=m.indexOf(k);-1===r?c.warn("[AngularJS - Leaflet] This event "+k+" does not exist or has been already disabled"):m.splice(r,1)}else c.warn("[AngularJS - Leaflet] must enable or disable events")}else m=o();else c.error("[AngularJS - Leaflet] event-broadcast must be an object check your model.");else m=o();for(i=0;i<m.length;i++)k=m[i],a.on(k,l(k,n,e,m,b));h.LabelPlugin.isLoaded()&&f(a.label)&&j(e,n,a,b)}}}]),angular.module("leaflet-directive").factory("leafletLayerHelpers",["$rootScope","$log","leafletHelpers",function($rootScope,$log,leafletHelpers){function isValidLayerType(a){return isString(a.type)?-1===Object.keys(layerTypes).indexOf(a.type)?($log.error("[AngularJS - Leaflet] A layer must have a valid type: "+Object.keys(layerTypes)),!1):layerTypes[a.type].mustHaveUrl&&!isString(a.url)?($log.error("[AngularJS - Leaflet] A base layer must have an url"),!1):layerTypes[a.type].mustHaveData&&!isDefined(a.data)?($log.error('[AngularJS - Leaflet] The base layer must have a "data" array attribute'),!1):layerTypes[a.type].mustHaveLayer&&!isDefined(a.layer)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have an layer defined"),!1):layerTypes[a.type].mustHaveBounds&&!isDefined(a.bounds)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have bounds defined"),!1):layerTypes[a.type].mustHaveKey&&!isDefined(a.key)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have key defined"),!1):!0:($log.error("[AngularJS - Leaflet] A layer must have a valid type defined."),!1)}function createLayer(a){if(isValidLayerType(a)){if(!isString(a.name))return void $log.error("[AngularJS - Leaflet] A base layer must have a name");isObject(a.layerParams)||(a.layerParams={}),isObject(a.layerOptions)||(a.layerOptions={});for(var b in a.layerParams)a.layerOptions[b]=a.layerParams[b];var c={url:a.url,data:a.data,options:a.layerOptions,layer:a.layer,type:a.layerType,bounds:a.bounds,key:a.key,pluginOptions:a.pluginOptions,user:a.user};return layerTypes[a.type].createLayer(c)}}var Helpers=leafletHelpers,isString=leafletHelpers.isString,isObject=leafletHelpers.isObject,isDefined=leafletHelpers.isDefined,utfGridCreateLayer=function(a){if(!Helpers.UTFGridPlugin.isLoaded())return void $log.error("[AngularJS - Leaflet] The UTFGrid plugin is not loaded.");var b=new L.UtfGrid(a.url,a.pluginOptions);return b.on("mouseover",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridMouseover",a)}),b.on("mouseout",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridMouseout",a)}),b.on("click",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridClick",a)}),b},layerTypes={xyz:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer(a.url,a.options)}},mapbox:{mustHaveKey:!0,createLayer:function(a){var b="//{s}.tiles.mapbox.com/v3/"+a.key+"/{z}/{x}/{y}.png";return L.tileLayer(b,a.options)}},geoJSON:{mustHaveUrl:!0,createLayer:function(a){return Helpers.GeoJSONPlugin.isLoaded()?new L.TileLayer.GeoJSON(a.url,a.pluginOptions,a.options):void 0}},utfGrid:{mustHaveUrl:!0,createLayer:utfGridCreateLayer},cartodbTiles:{mustHaveKey:!0,createLayer:function(a){var b="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/{z}/{x}/{y}.png";return L.tileLayer(b,a.options)}},cartodbUTFGrid:{mustHaveKey:!0,mustHaveLayer:!0,createLayer:function(a){return a.url="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/"+a.layer+"/{z}/{x}/{y}.grid.json",utfGridCreateLayer(a)}},cartodbInteractive:{mustHaveKey:!0,mustHaveLayer:!0,createLayer:function(a){var b="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/{z}/{x}/{y}.png",c=L.tileLayer(b,a.options);a.url="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/"+a.layer+"/{z}/{x}/{y}.grid.json";var d=utfGridCreateLayer(a);return L.layerGroup([c,d])}},wms:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer.wms(a.url,a.options)}},wmts:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer.wmts(a.url,a.options)}},wfs:{mustHaveUrl:!0,mustHaveLayer:!0,createLayer:function(params){if(Helpers.WFSLayerPlugin.isLoaded()){var options=angular.copy(params.options);return options.crs&&"string"==typeof options.crs&&(options.crs=eval(options.crs)),new L.GeoJSON.WFS(params.url,params.layer,options)
}}},group:{mustHaveUrl:!1,createLayer:function(a){var b=[];return angular.forEach(a.options.layers,function(a){b.push(createLayer(a))}),L.layerGroup(b)}},featureGroup:{mustHaveUrl:!1,createLayer:function(){return L.featureGroup()}},google:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"SATELLITE";if(Helpers.GoogleLayerPlugin.isLoaded())return new L.Google(b,a.options)}},china:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"";if(Helpers.ChinaLayerPlugin.isLoaded())return L.tileLayer.chinaProvider(b,a.options)}},ags:{mustHaveUrl:!0,createLayer:function(a){if(Helpers.AGSLayerPlugin.isLoaded()){var b=angular.copy(a.options);angular.extend(b,{url:a.url});var c=new lvector.AGS(b);return c.onAdd=function(a){this.setMap(a)},c.onRemove=function(){this.setMap(null)},c}}},dynamic:{mustHaveUrl:!0,createLayer:function(a){return Helpers.DynamicMapLayerPlugin.isLoaded()?L.esri.dynamicMapLayer(a.url,a.options):void 0}},markercluster:{mustHaveUrl:!1,createLayer:function(a){return Helpers.MarkerClusterPlugin.isLoaded()?new L.MarkerClusterGroup(a.options):void $log.error("[AngularJS - Leaflet] The markercluster plugin is not loaded.")}},bing:{mustHaveUrl:!1,createLayer:function(a){return Helpers.BingLayerPlugin.isLoaded()?new L.BingLayer(a.key,a.options):void 0}},heatmap:{mustHaveUrl:!1,mustHaveData:!0,createLayer:function(a){if(Helpers.HeatMapLayerPlugin.isLoaded()){var b=new L.TileLayer.WebGLHeatMap(a.options);return isDefined(a.data)&&b.setData(a.data),b}}},yandex:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"map";if(Helpers.YandexLayerPlugin.isLoaded())return new L.Yandex(b,a.options)}},imageOverlay:{mustHaveUrl:!0,mustHaveBounds:!0,createLayer:function(a){return L.imageOverlay(a.url,a.bounds,a.options)}},custom:{createLayer:function(a){return a.layer instanceof L.Class?angular.copy(a.layer):void $log.error("[AngularJS - Leaflet] A custom layer must be a leaflet Class")}},cartodb:{mustHaveUrl:!0,createLayer:function(a){return cartodb.createLayer(a.map,a.url)}}};return{createLayer:createLayer}}]),angular.module("leaflet-directive").factory("leafletControlHelpers",["$rootScope","$log","leafletHelpers","leafletMapDefaults",function(a,b,c,d){var e,f=c.isObject,g=c.isDefined,h=function(a,b,c){var e=d.getDefaults(c);if(!e.controls.layers.visible)return!1;var g=0;return f(a)&&(g+=Object.keys(a).length),f(b)&&(g+=Object.keys(b).length),g>1},i=function(a){var b=d.getDefaults(a),c={collapsed:b.controls.layers.collapsed,position:b.controls.layers.position};angular.extend(c,b.controls.layers.options);var e;return e=b.controls.layers&&g(b.controls.layers.control)?b.controls.layers.control.apply(this,[[],[],c]):new L.control.layers([],[],c)};return{layersControlMustBeVisible:h,updateLayersControl:function(a,b,c,d,f,j){var k,l=h(d,f,b);if(g(e)&&c){for(k in j.baselayers)e.removeLayer(j.baselayers[k]);for(k in j.overlays)e.removeLayer(j.overlays[k]);e.removeFrom(a)}if(l){e=i(b);for(k in d){var m=g(d[k].layerOptions)&&d[k].layerOptions.showOnSelector===!1;!m&&g(j.baselayers[k])&&e.addBaseLayer(j.baselayers[k],d[k].name)}for(k in f){var n=g(f[k].layerOptions)&&f[k].layerOptions.showOnSelector===!1;!n&&g(j.overlays[k])&&e.addOverlay(j.overlays[k],f[k].name)}e.addTo(a)}return l}}}]),angular.module("leaflet-directive").factory("leafletLegendHelpers",function(){var a=function(a,b,c,d){if(a.innerHTML="",b.error)a.innerHTML+='<div class="info-title alert alert-danger">'+b.error.message+"</div>";else if("arcgis"===c)for(var e=0;e<b.layers.length;e++){var f=b.layers[e];a.innerHTML+='<div class="info-title" data-layerid="'+f.layerId+'">'+f.layerName+"</div>";for(var g=0;g<f.legend.length;g++){var h=f.legend[g];a.innerHTML+='<div class="inline" data-layerid="'+f.layerId+'"><img src="data:'+h.contentType+";base64,"+h.imageData+'" /></div><div class="info-label" data-layerid="'+f.layerId+'">'+h.label+"</div>"}}else"image"===c&&(a.innerHTML='<img src="'+d+'"/>')},b=function(b,c,d,e){return function(){var f=L.DomUtil.create("div",c);return L.Browser.touch?L.DomEvent.on(f,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(f),L.DomEvent.on(f,"mousewheel",L.DomEvent.stopPropagation)),a(f,b,d,e),f}},c=function(a,b){return function(){for(var c=L.DomUtil.create("div",b),d=0;d<a.colors.length;d++)c.innerHTML+='<div class="outline"><i style="background:'+a.colors[d]+'"></i></div><div class="info-label">'+a.labels[d]+"</div>";return L.Browser.touch?L.DomEvent.on(c,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(c),L.DomEvent.on(c,"mousewheel",L.DomEvent.stopPropagation)),c}};return{getOnAddLegend:b,getOnAddArrayLegend:c,updateLegend:a}}),angular.module("leaflet-directive").factory("leafletPathsHelpers",["$rootScope","$log","leafletHelpers",function(a,b,c){function d(a){return a.filter(function(a){return k(a)}).map(function(a){return e(a)})}function e(a){return i(a)?new L.LatLng(a[0],a[1]):new L.LatLng(a.lat,a.lng)}function f(a){return a.map(function(a){return d(a)})}function g(a,b){for(var c={},d=0;d<l.length;d++){var e=l[d];h(a[e])?c[e]=a[e]:h(b.path[e])&&(c[e]=b.path[e])}return c}var h=c.isDefined,i=c.isArray,j=c.isNumber,k=c.isValidPoint,l=["stroke","weight","color","opacity","fill","fillColor","fillOpacity","dashArray","lineCap","lineJoin","clickable","pointerEvents","className","smoothFactor","noClip"],m=function(a,b){for(var c={},d=0;d<l.length;d++){var e=l[d];h(b[e])&&(c[e]=b[e])}a.setStyle(b)},n=function(a){if(!i(a))return!1;for(var b=0;b<a.length;b++){var c=a[b];if(!k(c))return!1}return!0},o={polyline:{isValid:function(a){var b=a.latlngs;return n(b)},createPath:function(a){return new L.Polyline([],a)},setPath:function(a,b){a.setLatLngs(d(b.latlngs)),m(a,b)}},multiPolyline:{isValid:function(a){var b=a.latlngs;if(!i(b))return!1;for(var c in b){var d=b[c];if(!n(d))return!1}return!0},createPath:function(a){return new L.multiPolyline([[[0,0],[1,1]]],a)},setPath:function(a,b){a.setLatLngs(f(b.latlngs)),m(a,b)}},polygon:{isValid:function(a){var b=a.latlngs;return n(b)},createPath:function(a){return new L.Polygon([],a)},setPath:function(a,b){a.setLatLngs(d(b.latlngs)),m(a,b)}},multiPolygon:{isValid:function(a){var b=a.latlngs;if(!i(b))return!1;for(var c in b){var d=b[c];if(!n(d))return!1}return!0},createPath:function(a){return new L.MultiPolygon([[[0,0],[1,1],[0,1]]],a)},setPath:function(a,b){a.setLatLngs(f(b.latlngs)),m(a,b)}},rectangle:{isValid:function(a){var b=a.latlngs;if(!i(b)||2!==b.length)return!1;for(var c in b){var d=b[c];if(!k(d))return!1}return!0},createPath:function(a){return new L.Rectangle([[0,0],[1,1]],a)},setPath:function(a,b){a.setBounds(new L.LatLngBounds(d(b.latlngs))),m(a,b)}},circle:{isValid:function(a){var b=a.latlngs;return k(b)&&j(a.radius)},createPath:function(a){return new L.Circle([0,0],1,a)},setPath:function(a,b){a.setLatLng(e(b.latlngs)),h(b.radius)&&a.setRadius(b.radius),m(a,b)}},circleMarker:{isValid:function(a){var b=a.latlngs;return k(b)&&j(a.radius)},createPath:function(a){return new L.CircleMarker([0,0],a)},setPath:function(a,b){a.setLatLng(e(b.latlngs)),h(b.radius)&&a.setRadius(b.radius),m(a,b)}}},p=function(a){var b={};return a.latlngs&&(b.latlngs=a.latlngs),a.radius&&(b.radius=a.radius),b};return{setPathOptions:function(a,b,c){h(b)||(b="polyline"),o[b].setPath(a,c)},createPath:function(a,c,d){h(c.type)||(c.type="polyline");var e=g(c,d),f=p(c);return o[c.type].isValid(f)?o[c.type].createPath(e):void b.error("[AngularJS - Leaflet] Invalid data passed to the "+c.type+" path")}}}]),angular.module("leaflet-directive").factory("leafletBoundsHelpers",["$log","leafletHelpers",function(a,b){function c(a){return angular.isDefined(a)&&angular.isDefined(a.southWest)&&angular.isDefined(a.northEast)&&angular.isNumber(a.southWest.lat)&&angular.isNumber(a.southWest.lng)&&angular.isNumber(a.northEast.lat)&&angular.isNumber(a.northEast.lng)}var d=b.isArray,e=b.isNumber;return{createLeafletBounds:function(a){return c(a)?L.latLngBounds([a.southWest.lat,a.southWest.lng],[a.northEast.lat,a.northEast.lng]):void 0},isValidBounds:c,createBoundsFromArray:function(b){return d(b)&&2===b.length&&d(b[0])&&d(b[1])&&2===b[0].length&&2===b[1].length&&e(b[0][0])&&e(b[0][1])&&e(b[1][0])&&e(b[1][1])?{northEast:{lat:b[0][0],lng:b[0][1]},southWest:{lat:b[1][0],lng:b[1][1]}}:void a.error("[AngularJS - Leaflet] The bounds array is not valid.")}}}]),angular.module("leaflet-directive").factory("leafletMarkersHelpers",["$rootScope","leafletHelpers","$log","$compile",function(a,b,c,d){var e=b.isDefined,f=b.MarkerClusterPlugin,g=b.AwesomeMarkersPlugin,h=b.MakiMarkersPlugin,i=b.ExtraMarkersPlugin,j=b.safeApply,k=b,l=b.isString,m=b.isNumber,n=b.isObject,o={},p=function(a){if(e(a)&&e(a.type)&&"awesomeMarker"===a.type)return g.isLoaded()||c.error("[AngularJS - Leaflet] The AwesomeMarkers Plugin is not loaded."),new L.AwesomeMarkers.icon(a);if(e(a)&&e(a.type)&&"makiMarker"===a.type)return h.isLoaded()||c.error("[AngularJS - Leaflet] The MakiMarkers Plugin is not loaded."),new L.MakiMarkers.icon(a);if(e(a)&&e(a.type)&&"extraMarker"===a.type)return i.isLoaded()||c.error("[AngularJS - Leaflet] The ExtraMarkers Plugin is not loaded."),new L.ExtraMarkers.icon(a);if(e(a)&&e(a.type)&&"div"===a.type)return new L.divIcon(a);var b="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAApCAYAAADAk4LOAAAGmklEQVRYw7VXeUyTZxjvNnfELFuyIzOabermMZEeQC/OclkO49CpOHXOLJl/CAURuYbQi3KLgEhbrhZ1aDwmaoGqKII6odATmH/scDFbdC7LvFqOCc+e95s2VG50X/LLm/f4/Z7neY/ne18aANCmAr5E/xZf1uDOkTcGcWR6hl9247tT5U7Y6SNvWsKT63P58qbfeLJG8M5qcgTknrvvrdDbsT7Ml+tv82X6vVxJE33aRmgSyYtcWVMqX97Yv2JvW39UhRE2HuyBL+t+gK1116ly06EeWFNlAmHxlQE0OMiV6mQCScusKRlhS3QLeVJdl1+23h5dY4FNB3thrbYboqptEFlphTC1hSpJnbRvxP4NWgsE5Jyz86QNNi/5qSUTGuFk1gu54tN9wuK2wc3o+Wc13RCmsoBwEqzGcZsxsvCSy/9wJKf7UWf1mEY8JWfewc67UUoDbDjQC+FqK4QqLVMGGR9d2wurKzqBk3nqIT/9zLxRRjgZ9bqQgub+DdoeCC03Q8j+0QhFhBHR/eP3U/zCln7Uu+hihJ1+bBNffLIvmkyP0gpBZWYXhKussK6mBz5HT6M1Nqpcp+mBCPXosYQfrekGvrjewd59/GvKCE7TbK/04/ZV5QZYVWmDwH1mF3xa2Q3ra3DBC5vBT1oP7PTj4C0+CcL8c7C2CtejqhuCnuIQHaKHzvcRfZpnylFfXsYJx3pNLwhKzRAwAhEqG0SpusBHfAKkxw3w4627MPhoCH798z7s0ZnBJ/MEJbZSbXPhER2ih7p2ok/zSj2cEJDd4CAe+5WYnBCgR2uruyEw6zRoW6/DWJ/OeAP8pd/BGtzOZKpG8oke0SX6GMmRk6GFlyAc59K32OTEinILRJRchah8HQwND8N435Z9Z0FY1EqtxUg+0SO6RJ/mmXz4VuS+DpxXC3gXmZwIL7dBSH4zKE50wESf8qwVgrP1EIlTO5JP9Igu0aexdh28F1lmAEGJGfh7jE6ElyM5Rw/FDcYJjWhbeiBYoYNIpc2FT/SILivp0F1ipDWk4BIEo2VuodEJUifhbiltnNBIXPUFCMpthtAyqws/BPlEF/VbaIxErdxPphsU7rcCp8DohC+GvBIPJS/tW2jtvTmmAeuNO8BNOYQeG8G/2OzCJ3q+soYB5i6NhMaKr17FSal7GIHheuV3uSCY8qYVuEm1cOzqdWr7ku/R0BDoTT+DT+ohCM6/CCvKLKO4RI+dXPeAuaMqksaKrZ7L3FE5FIFbkIceeOZ2OcHO6wIhTkNo0ffgjRGxEqogXHYUPHfWAC/lADpwGcLRY3aeK4/oRGCKYcZXPVoeX/kelVYY8dUGf8V5EBRbgJXT5QIPhP9ePJi428JKOiEYhYXFBqou2Guh+p/mEB1/RfMw6rY7cxcjTrneI1FrDyuzUSRm9miwEJx8E/gUmqlyvHGkneiwErR21F3tNOK5Tf0yXaT+O7DgCvALTUBXdM4YhC/IawPU+2PduqMvuaR6eoxSwUk75ggqsYJ7VicsnwGIkZBSXKOUww73WGXyqP+J2/b9c+gi1YAg/xpwck3gJuucNrh5JvDPvQr0WFXf0piyt8f8/WI0hV4pRxxkQZdJDfDJNOAmM0Ag8jyT6hz0WGXWuP94Yh2jcfjmXAGvHCMslRimDHYuHuDsy2QtHuIavznhbYURq5R57KpzBBRZKPJi8eQg48h4j8SDdowifdIrEVdU+gbO6QNvRRt4ZBthUaZhUnjlYObNagV3keoeru3rU7rcuceqU1mJBxy+BWZYlNEBH+0eH4vRiB+OYybU2hnblYlTvkHinM4m54YnxSyaZYSF6R3jwgP7udKLGIX6r/lbNa9N6y5MFynjWDtrHd75ZvTYAPO/6RgF0k76mQla3FGq7dO+cH8sKn0Vo7nDllwAhqwLPkxrHwWmHJOo+AKJ4rab5OgrM7rVu8eWb2Pu0Dh4eDgXoOfvp7Y7QeqknRmvcTBEyq9m/HQQSCSz6LHq3z0yzsNySRfMS253wl2KyRDbcZPcfJKjZmSEOjcxyi+Y8dUOtsIEH6R2wNykdqrkYJ0RV92H0W58pkfQk7cKevsLK10Py8SdMGfXNXATY+pPbyJR/ET6n9nIfztNtZYRV9XniQu9IA2vOVgy4ir7GCLVmmd+zjkH0eAF9Po6K61pmCXHxU5rHMYd1ftc3owjwRSVRzLjKvqZEty6cRUD7jGqiOdu5HG6MdHjNcNYGqfDm5YRzLBBCCDl/2bk8a8gdbqcfwECu62Fg/HrggAAAABJRU5ErkJggg==",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAApCAYAAACoYAD2AAAC5ElEQVRYw+2YW4/TMBCF45S0S1luXZCABy5CgLQgwf//S4BYBLTdJLax0fFqmB07nnQfEGqkIydpVH85M+NLjPe++dcPc4Q8Qh4hj5D/AaQJx6H/4TMwB0PeBNwU7EGQAmAtsNfAzoZkgIa0ZgLMa4Aj6CxIAsjhjOCoL5z7Glg1JAOkaicgvQBXuncwJAWjksLtBTWZe04CnYRktUGdilALppZBOgHGZcBzL6OClABvMSVIzyBjazOgrvACf1ydC5mguqAVg6RhdkSWQFj2uxfaq/BrIZOLEWgZdALIDvcMcZLD8ZbLC9de4yR1sYMi4G20S4Q/PWeJYxTOZn5zJXANZHIxAd4JWhPIloTJZhzMQduM89WQ3MUVAE/RnhAXpTycqys3NZALOBbB7kFrgLesQl2h45Fcj8L1tTSohUwuxhy8H/Qg6K7gIs+3kkaigQCOcyEXCHN07wyQazhrmIulvKMQAwMcmLNqyCVyMAI+BuxSMeTk3OPikLY2J1uE+VHQk6ANrhds+tNARqBeaGc72cK550FP4WhXmFmcMGhTwAR1ifOe3EvPqIegFmF+C8gVy0OfAaWQPMR7gF1OQKqGoBjq90HPMP01BUjPOqGFksC4emE48tWQAH0YmvOgF3DST6xieJgHAWxPAHMuNhrImIdvoNOKNWIOcE+UXE0pYAnkX6uhWsgVXDxHdTfCmrEEmMB2zMFimLVOtiiajxiGWrbU52EeCdyOwPEQD8LqyPH9Ti2kgYMf4OhSKB7qYILbBv3CuVTJ11Y80oaseiMWOONc/Y7kJYe0xL2f0BaiFTxknHO5HaMGMublKwxFGzYdWsBF174H/QDknhTHmHHN39iWFnkZx8lPyM8WHfYELmlLKtgWNmFNzQcC1b47gJ4hL19i7o65dhH0Negbca8vONZoP7doIeOC9zXm8RjuL0Gf4d4OYaU5ljo3GYiqzrWQHfJxA6ALhDpVKv9qYeZA8eM3EhfPSCmpuD0AAAAASUVORK5CYII=";return e(a)&&e(a.iconUrl)?new L.Icon(a):new L.Icon.Default({iconUrl:b,shadowUrl:d,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]})},q=function(a){e(o[a])&&o.splice(a,1)},r=function(){o={}},s=function(a,b,c){if(a.closePopup(),e(c)&&e(c.overlays))for(var d in c.overlays)if((c.overlays[d]instanceof L.LayerGroup||c.overlays[d]instanceof L.FeatureGroup)&&c.overlays[d].hasLayer(a))return void c.overlays[d].removeLayer(a);if(e(o))for(var f in o)o[f].hasLayer(a)&&o[f].removeLayer(a);b.hasLayer(a)&&b.removeLayer(a)},t=function(b,c){b.openPopup();var f=b.getPopup(),g=angular.isFunction(c.getMessageScope)?c.getMessageScope():a,h=e(c.compileMessage)?c.compileMessage:!0;if(e(f)){var i=function(a){a._updateLayout(),a._updatePosition()};if(h)if(d(f._contentNode)(g),e(f._contentNode)&&f._contentNode.innerHTML.indexOf("ngInclude")>-1)var j=g.$on("$includeContentLoaded",function(){i(f),j()});else i(f)}k.LabelPlugin.isLoaded()&&e(c.label)&&e(c.label.options)&&c.label.options.noHide===!0&&(h&&d(b.label._container)(g),b.showLabel())};return{resetMarkerGroup:q,resetMarkerGroups:r,deleteMarker:s,manageOpenPopup:t,createMarker:function(a){if(!e(a))return void c.error("[AngularJS - Leaflet] The marker definition is not valid.");var b={icon:p(a.icon),title:e(a.title)?a.title:"",draggable:e(a.draggable)?a.draggable:!1,clickable:e(a.clickable)?a.clickable:!0,riseOnHover:e(a.riseOnHover)?a.riseOnHover:!1,zIndexOffset:e(a.zIndexOffset)?a.zIndexOffset:0,iconAngle:e(a.iconAngle)?a.iconAngle:0};for(var d in a)a.hasOwnProperty(d)&&!b.hasOwnProperty(d)&&(b[d]=a[d]);var f=new L.marker(a,b);return l(a.message)||f.unbindPopup(),f},addMarkerToGroup:function(a,b,d,g){return l(b)?f.isLoaded()?(e(o[b])||(o[b]=new L.MarkerClusterGroup(d),g.addLayer(o[b])),void o[b].addLayer(a)):void c.error("[AngularJS - Leaflet] The MarkerCluster plugin is not loaded."):void c.error("[AngularJS - Leaflet] The marker group you have specified is invalid.")},listenMarkerEvents:function(a,b,c,d){a.on("popupopen",function(){d?j(c,function(){b.focus=!0}):t(a,b)}),a.on("popupclose",function(){d&&j(c,function(){b.focus=!1})})},addMarkerWatcher:function(a,b,d,f,g){var h=d.$watch('markers["'+b+'"]',function(b,d){if(!e(b))return s(a,g,f),void h();if(e(d)){if(!m(b.lat)||!m(b.lng))return c.warn("There are problems with lat-lng data, please verify your marker model"),void s(a,g,f);var i=b===d;if(e(b.iconAngle)&&d.iconAngle!==b.iconAngle&&a.setIconAngle(b.iconAngle),l(b.layer)||l(d.layer)&&(e(f.overlays[d.layer])&&f.overlays[d.layer].hasLayer(a)&&(f.overlays[d.layer].removeLayer(a),a.closePopup()),g.hasLayer(a)||g.addLayer(a)),(m(b.opacity)||m(parseFloat(b.opacity)))&&b.opacity!==d.opacity&&a.setOpacity(b.opacity),l(b.layer)&&d.layer!==b.layer){if(l(d.layer)&&e(f.overlays[d.layer])&&f.overlays[d.layer].hasLayer(a)&&f.overlays[d.layer].removeLayer(a),a.closePopup(),g.hasLayer(a)&&g.removeLayer(a),!e(f.overlays[b.layer]))return void c.error("[AngularJS - Leaflet] You must use a name of an existing layer");var j=f.overlays[b.layer];if(!(j instanceof L.LayerGroup||j instanceof L.FeatureGroup))return void c.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group" or "featureGroup"');j.addLayer(a),g.hasLayer(a)&&b.focus===!0&&t(a,b)}if(b.draggable!==!0&&d.draggable===!0&&e(a.dragging)&&a.dragging.disable(),b.draggable===!0&&d.draggable!==!0&&(a.dragging?a.dragging.enable():L.Handler.MarkerDrag&&(a.dragging=new L.Handler.MarkerDrag(a),a.options.draggable=!0,a.dragging.enable())),n(b.icon)||n(d.icon)&&(a.setIcon(p()),a.closePopup(),a.unbindPopup(),l(b.message)&&a.bindPopup(b.message,b.popupOptions)),n(b.icon)&&n(d.icon)&&!angular.equals(b.icon,d.icon)){var o=!1;a.dragging&&(o=a.dragging.enabled()),a.setIcon(p(b.icon)),o&&a.dragging.enable(),a.closePopup(),a.unbindPopup(),l(b.message)&&a.bindPopup(b.message,b.popupOptions)}!l(b.message)&&l(d.message)&&(a.closePopup(),a.unbindPopup()),k.LabelPlugin.isLoaded()&&e(b.label)&&e(b.label.message)&&!angular.equals(b.label.message,d.label.message)&&a.updateLabelContent(b.label.message),l(b.message)&&!l(d.message)&&a.bindPopup(b.message,b.popupOptions),l(b.message)&&l(d.message)&&b.message!==d.message&&a.setPopupContent(b.message);var q=!1;b.focus!==!0&&d.focus===!0&&(a.closePopup(),q=!0),(b.focus===!0&&(!e(d.focus)||d.focus===!1)||i&&b.focus===!0)&&(t(a,b),q=!0),d.zIndexOffset!==b.zIndexOffset&&a.setZIndexOffset(b.zIndexOffset);var r=a.getLatLng(),u=l(b.layer)&&k.MarkerClusterPlugin.is(f.overlays[b.layer]);u?q?(b.lat!==d.lat||b.lng!==d.lng)&&(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):r.lat!==b.lat||r.lng!==b.lng?(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):b.lat!==d.lat||b.lng!==d.lng?(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):n(b.icon)&&n(d.icon)&&!angular.equals(b.icon,d.icon)&&(f.overlays[b.layer].removeLayer(a),f.overlays[b.layer].addLayer(a)):(r.lat!==b.lat||r.lng!==b.lng)&&a.setLatLng([b.lat,b.lng])}},!0)}}}]),angular.module("leaflet-directive").factory("leafletHelpers",["$q","$log",function(a,b){function c(a,c){var d,e;if(angular.isDefined(c))d=c;else if(0===Object.keys(a).length)d="main";else if(Object.keys(a).length>=1)for(e in a)a.hasOwnProperty(e)&&(d=e);else 0===Object.keys(a).length?d="main":b.error("[AngularJS - Leaflet] - You have more than 1 map on the DOM, you must provide the map ID to the leafletData.getXXX call");return d}function d(b,d){var e,f=c(b,d);return angular.isDefined(b[f])&&b[f].resolvedDefer!==!0?e=b[f].defer:(e=a.defer(),b[f]={defer:e,resolvedDefer:!1}),e}return{isEmpty:function(a){return 0===Object.keys(a).length},isUndefinedOrEmpty:function(a){return angular.isUndefined(a)||null===a||0===Object.keys(a).length},isDefined:function(a){return angular.isDefined(a)&&null!==a},isNumber:function(a){return angular.isNumber(a)},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},isFunction:function(a){return angular.isFunction(a)},equals:function(a,b){return angular.equals(a,b)},isValidCenter:function(a){return angular.isDefined(a)&&angular.isNumber(a.lat)&&angular.isNumber(a.lng)&&angular.isNumber(a.zoom)},isValidPoint:function(a){return angular.isDefined(a)?angular.isArray(a)?2===a.length&&angular.isNumber(a[0])&&angular.isNumber(a[1]):angular.isNumber(a.lat)&&angular.isNumber(a.lng):!1},isSameCenterOnMap:function(a,b){var c=b.getCenter(),d=b.getZoom();return a.lat&&a.lng&&c.lat.toFixed(4)===a.lat.toFixed(4)&&c.lng.toFixed(4)===a.lng.toFixed(4)&&d===a.zoom?!0:!1},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},obtainEffectiveMapId:c,getDefer:function(a,b){var e,f=c(a,b);return e=angular.isDefined(a[f])&&a[f].resolvedDefer!==!1?a[f].defer:d(a,b)},getUnresolvedDefer:d,setResolvedDefer:function(a,b){var d=c(a,b);a[d].resolvedDefer=!0},AwesomeMarkersPlugin:{isLoaded:function(){return angular.isDefined(L.AwesomeMarkers)&&angular.isDefined(L.AwesomeMarkers.Icon)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.AwesomeMarkers.Icon:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},PolylineDecoratorPlugin:{isLoaded:function(){return angular.isDefined(L.PolylineDecorator)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.PolylineDecorator:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},MakiMarkersPlugin:{isLoaded:function(){return angular.isDefined(L.MakiMarkers)&&angular.isDefined(L.MakiMarkers.Icon)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.MakiMarkers.Icon:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},ExtraMarkersPlugin:{isLoaded:function(){return angular.isDefined(L.ExtraMarkers)&&angular.isDefined(L.ExtraMarkers.Icon)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.ExtraMarkers.Icon:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},LabelPlugin:{isLoaded:function(){return angular.isDefined(L.Label)},is:function(a){return this.isLoaded()?a instanceof L.MarkerClusterGroup:!1}},MarkerClusterPlugin:{isLoaded:function(){return angular.isDefined(L.MarkerClusterGroup)},is:function(a){return this.isLoaded()?a instanceof L.MarkerClusterGroup:!1}},GoogleLayerPlugin:{isLoaded:function(){return angular.isDefined(L.Google)},is:function(a){return this.isLoaded()?a instanceof L.Google:!1}},ChinaLayerPlugin:{isLoaded:function(){return angular.isDefined(L.tileLayer.chinaProvider)}},HeatMapLayerPlugin:{isLoaded:function(){return angular.isDefined(L.TileLayer.WebGLHeatMap)}},BingLayerPlugin:{isLoaded:function(){return angular.isDefined(L.BingLayer)},is:function(a){return this.isLoaded()?a instanceof L.BingLayer:!1}},WFSLayerPlugin:{isLoaded:function(){return void 0!==L.GeoJSON.WFS},is:function(a){return this.isLoaded()?a instanceof L.GeoJSON.WFS:!1}},AGSLayerPlugin:{isLoaded:function(){return void 0!==lvector&&void 0!==lvector.AGS},is:function(a){return this.isLoaded()?a instanceof lvector.AGS:!1}},YandexLayerPlugin:{isLoaded:function(){return angular.isDefined(L.Yandex)},is:function(a){return this.isLoaded()?a instanceof L.Yandex:!1}},DynamicMapLayerPlugin:{isLoaded:function(){return void 0!==L.esri&&void 0!==L.esri.dynamicMapLayer},is:function(a){return this.isLoaded()?a instanceof L.esri.dynamicMapLayer:!1}},GeoJSONPlugin:{isLoaded:function(){return angular.isDefined(L.TileLayer.GeoJSON)},is:function(a){return this.isLoaded()?a instanceof L.TileLayer.GeoJSON:!1}},UTFGridPlugin:{isLoaded:function(){return angular.isDefined(L.UtfGrid)},is:function(a){return this.isLoaded()?a instanceof L.UtfGrid:(b.error("[AngularJS - Leaflet] No UtfGrid plugin found."),!1)}},CartoDB:{isLoaded:function(){return cartodb},is:function(){return!0}},Leaflet:{DivIcon:{is:function(a){return a instanceof L.DivIcon},equal:function(a,b){return this.is(a)?angular.equals(a,b):!1}},Icon:{is:function(a){return a instanceof L.Icon},equal:function(a,b){return this.is(a)?angular.equals(a,b):!1}}}}}])}();var app=angular.module("IF",["ngRoute","ngSanitize","ngAnimate","ngTouch","ngMessages","tidepoolsFilters","tidepoolsServices","leaflet-directive","angularFileUpload","IF-directives","mgcrea.ngStrap","angularSpectrumColorpicker","ui.slider","swipe","monospaced.elastic","ui.calendar","textAngular","ui.bootstrap"]).config(function(a,b,c,d,e){var f=(d.classNameFilter(/if-animate/i),function(a){return a.checkLogin()});c.interceptors.push(function(a,b,c,d){return{request:function(a){return a.server&&(a.url="https://bubbl.li"+a.url,d.username&&d.password?a.headers.Authorization=d.getBasicHeader():d.fbToken&&(a.headers.Authorization="Bearer "+d.fbToken)),a},response:function(a){return a},responseError:function(b){return 401===b.status,a.reject(b)}}}),a.when("/",{templateUrl:"components/home/home.html",controller:"HomeController"}).when("/nearby",{templateUrl:"components/nearby/nearby.html",controller:"NearbyCtrl"}).when("home",{templateUrl:"components/home/home.html",controller:"HomeController"}).when("/nearby",{templateUrl:"components/nearby/nearby.html",controller:"WorldRouteCtrl"}).when("/login",{templateUrl:"components/user/login.html",controller:"LoginCtrl"}).when("/forgot",{templateUrl:"components/user/forgot.html",controller:"ForgotCtrl"}).when("/reset/:token",{templateUrl:"components/user/change-password.html",controller:"ResetCtrl"}).when("/signup",{templateUrl:"components/user/signup.html",controller:"SignupCtrl"}).when("/signup/:incoming",{templateUrl:"components/user/signup.html",controller:"SignupCtrl"}).when("/auth/:type",{templateUrl:"components/user/loading.html",controller:"resolveAuth"}).when("/auth/:type/:callback",{templateUrl:"components/user/loading.html",controller:"resolveAuth"}).when("/profile",{redirectTo:"/profile/worlds"}).when("/profile/:tab",{templateUrl:"components/user/user.html",controller:"UserController"}).when("/profile/:tab/:incoming",{templateUrl:"components/user/user.html",controller:"UserController"}).when("/w/:worldURL",{templateUrl:"components/world/world.html",controller:"WorldController"}).when("/w/:worldURL/upcoming",{templateUrl:"components/world/upcoming.html",controller:"WorldController"}).when("/w/:worldURL/messages",{templateUrl:"components/world/messages/messages.html",controller:"MessagesController"}).when("/w/:worldURL/schedule",{templateUrl:"components/world/subviews/schedule.html",controller:"ScheduleController"}).when("/w/:worldURL/instagram",{templateUrl:"components/world/subviews/instagram.html",controller:"InstagramListController"}).when("/w/:worldURL/twitter",{templateUrl:"components/world/subviews/twitter.html",controller:"TwitterListController"}).when("/w/:worldURL/:landmarkURL",{templateUrl:"components/world/landmark.html",controller:"LandmarkController"}).when("/w/:worldURL/category/:category",{templateUrl:"components/world/category.html",controller:"CategoryController"}).when("/edit/w/:worldURL/landmarks",{templateUrl:"components/edit/landmark-editor.html",controller:"LandmarkEditorController",resolve:{loggedin:f}}).when("/edit/w/:worldURL/",{templateUrl:"components/edit/edit_world.html",controller:"EditController",resolve:{loggedin:f}}).when("/edit/w/:worldURL/:view",{templateUrl:"components/edit/edit_world.html",controller:"EditController",resolve:{loggedin:f}}).when("/edit/walkthrough/:_id",{templateUrl:"components/edit/walkthrough/walkthrough.html",controller:"WalkthroughController",resolve:{loggedin:f}}).when("/meetup",{templateUrl:"components/tour/meetup.html",controller:"MeetupController"}).when("/welcome",{templateUrl:"components/tour/welcome.html",controller:"WelcomeController"}).when("/search/:searchQuery",{templateUrl:"components/search/search.html",controller:"SearchController"}).when("/twitter/:hashTag",{templateUrl:"partials/tweet-list.html",controller:"TweetlistCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode({enabled:!0}),angular.extend(e.defaults,{animation:"am-fade",placement:"right",delay:{show:"0",hide:"250"}})}).run(function(a,b,c,d){d.checkLogin(),navigator.splashscreen.hide()});document.addEventListener("deviceready",onDeviceReady,!0),angular.element(document).ready(function(){angular.bootstrap(document,["IF"])}),angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(a,b,c){var d=1,e=1,f=a.eventSources,g=a.calendarWatchEvent?a.calendarWatchEvent:angular.noop,h=function(a){var c;return a&&(c=function(){var c=arguments,d=this;b(function(){a.apply(d,c)})}),c};this.eventsFingerprint=function(a){return a._id||(a._id=e++),""+a._id+(a.id||"")+(a.title||"")+(a.url||"")+(+a.start||"")+(+a.end||"")+(a.allDay||"")+(a.className||"")+g(a)||""},this.sourcesFingerprint=function(a){return a.__id||(a.__id=d++)},this.allEvents=function(){for(var a=[],b=0,c=f.length;c>b;b++){var d=f[b];if(angular.isArray(d))a.push(d);else if(angular.isObject(d)&&angular.isArray(d.events)){var e={};for(var g in d)"_uiCalId"!==g&&"events"!==g&&(e[g]=d[g]);for(var h=0;h<d.events.length;h++)angular.extend(d.events[h],e);a.push(d.events)}}return Array.prototype.concat.apply([],a)},this.changeWatcher=function(a,b){var c,d=function(){for(var c,d,e=angular.isFunction(a)?a():a,g=[],h=0,i=e.length;i>h;h++)d=e[h],c=b(d),f[c]=d,g.push(c);return g},e=function(a,b){var c,d,e=[],f={};for(c=0,d=b.length;d>c;c++)f[b[c]]=!0;for(c=0,d=a.length;d>c;c++)f[a[c]]||e.push(a[c]);return e},f={},g=function(a,d){var g,h,i,j,k={},l=e(d,a);for(g=0,h=l.length;h>g;g++){var m=l[g];i=f[m],delete f[m];var n=b(i);n===m?c.onRemoved(i):(k[n]=m,c.onChanged(i))}var o=e(a,d);for(g=0,h=o.length;h>g;g++)j=o[g],i=f[j],k[j]||c.onAdded(i)};return c={subscribe:function(a,b){a.$watch(d,function(a,c){b&&b(a,c)===!1||g(a,c)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(a,b){var c={};return angular.extend(c,b),angular.extend(c,a),angular.forEach(c,function(a,b){"function"==typeof a&&(c[b]=h(c[b]))}),c},this.getLocaleConfig=function(a){if(!a.lang||a.useNgLocale){var b=function(a){var b,c;b=[];for(c in a)b[c]=a[c];return b},d=c.DATETIME_FORMATS;return{monthNames:b(d.MONTH),monthNamesShort:b(d.SHORTMONTH),dayNames:b(d.DAY),dayNamesShort:b(d.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(a){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(b,c,d,e){function f(){var c,f=d.uiCalendar?b.$parent.$eval(d.uiCalendar):{};c=e.getFullCalendarConfig(f,a);var g=e.getLocaleConfig(c);angular.extend(g,c),l={eventSources:h},angular.extend(l,g),l.calendars=null;var i={};for(var j in l)"eventSources"!==j&&(i[j]=l[j]);return JSON.stringify(i)}var g,h=b.eventSources,i=!1,j=e.changeWatcher(h,e.sourcesFingerprint),k=e.changeWatcher(e.allEvents,e.eventsFingerprint),l=null;b.destroy=function(){g&&g.fullCalendar&&g.fullCalendar("destroy"),g=d.calendar?a.calendars[d.calendar]=$(c).html(""):$(c).html("")},b.init=function(){g.fullCalendar(l)},j.onAdded=function(a){g.fullCalendar("addEventSource",a),i=!0},j.onRemoved=function(a){g.fullCalendar("removeEventSource",a),i=!0},k.onAdded=function(a){g.fullCalendar("renderEvent",a)},k.onRemoved=function(a){g.fullCalendar("removeEvents",function(b){return b._id===a._id})},k.onChanged=function(a){a._start=$.fullCalendar.moment(a.start),a._end=$.fullCalendar.moment(a.end),g.fullCalendar("updateEvent",a)},j.subscribe(b),k.subscribe(b,function(){return i===!0?(i=!1,!1):void 0}),b.$watch(f,function(){b.destroy(),b.init()})}}}]),angular.module("IF-directives",[]).directive("myPostRepeatDirective",function(){return function(a){if(a.$last){var b=$("#card-container");b.isotope({itemSelector:".iso-card"})}}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),app.directive("bubbleBody",function(a){return{restrict:"A",scope:!0,link:function(b,c){var d=_.throttle(function(){var b=c.scrollTop();0===b&&"aperture-third"!=a.state?a.set("third"):"aperture-off"!=a.state&&a.set("off")},100);c.on("scroll",d),b.$on("$destroy",function(){c.off("scroll")})}}}),app.directive("compassButton",function(a,b,c,d,e){return{restrict:"EA",scope:!0,link:function(f,g){function h(){if(1==f.compassState){var a=g.offset(),b=4,b=19,c={top:b,left:a.left-i.width()+40};i.offset(c)}}var i;b("templates/compassButton.html").then(function(a){c(a)(f,function(a){i=$(a).appendTo(document.body),h(),f.$watch(function(){return d.getDisplayName()},function(){h()}),$(window).resize(_.debounce(h,200))})}),f.compassOn=function(a,b){void 0!=b&&(f.compassState=b),1==b&&e(h,0),a&&(a.stopPropagation(),$(document.body).on("click",function(){f.compassState=!1,f.$digest(),$(document.body).off("click")}))},a.getNearby().then(function(a){f.nearbyBubbles=a["150m"]},function(a){})}}}),angular.module("monospaced.elastic",[]).constant("msdElasticConfig",{append:""}).directive("msdElastic",["$timeout","$window","msdElasticConfig",function(a,b,c){"use strict";return{require:"ngModel",restrict:"A, C",link:function(d,e,f,g){function h(){var a=r;n=k,u=getComputedStyle(k),angular.forEach(C,function(b){a+=b+":"+u.getPropertyValue(b)+";"
}),t.setAttribute("style",a)}function i(){var b,c,e,f,g;n!==k&&h(),o||(o=!0,t.value=k.value+p,t.style.overflowY=k.style.overflowY,b=""===k.style.height?"auto":parseInt(k.style.height,10),c=getComputedStyle(k).getPropertyValue("width"),"px"===c.substr(c.length-2,2)&&(f=parseInt(c,10)-x.width,t.style.width=f+"px"),e=t.scrollHeight,e>B?(e=B,g="scroll"):A>e&&(e=A),e+=x.height,k.style.overflowY=g||"hidden",b!==e&&(k.style.height=e+"px",d.$emit("elastic:resize",l)),a(function(){o=!1},1))}function j(){o=!1,i()}var k=e[0],l=e;if("TEXTAREA"===k.nodeName&&b.getComputedStyle){l.css({overflow:"hidden","overflow-y":"hidden","word-wrap":"break-word"});var m=k.value;k.value="",k.value=m;var n,o,p=f.msdElastic?f.msdElastic.replace(/\\n/g,"\n"):c.append,q=angular.element(b),r="position: absolute; top: -999px; right: auto; bottom: auto;left: 0; overflow: hidden; -webkit-box-sizing: content-box;-moz-box-sizing: content-box; box-sizing: content-box;min-height: 0 !important; height: 0 !important; padding: 0;word-wrap: break-word; border: 0;",s=angular.element('<textarea tabindex="-1" style="'+r+'"/>').data("elastic",!0),t=s[0],u=getComputedStyle(k),v=u.getPropertyValue("resize"),w="border-box"===u.getPropertyValue("box-sizing")||"border-box"===u.getPropertyValue("-moz-box-sizing")||"border-box"===u.getPropertyValue("-webkit-box-sizing"),x=w?{width:parseInt(u.getPropertyValue("border-right-width"),10)+parseInt(u.getPropertyValue("padding-right"),10)+parseInt(u.getPropertyValue("padding-left"),10)+parseInt(u.getPropertyValue("border-left-width"),10),height:parseInt(u.getPropertyValue("border-top-width"),10)+parseInt(u.getPropertyValue("padding-top"),10)+parseInt(u.getPropertyValue("padding-bottom"),10)+parseInt(u.getPropertyValue("border-bottom-width"),10)}:{width:0,height:0},y=parseInt(u.getPropertyValue("min-height"),10),z=parseInt(u.getPropertyValue("height"),10),A=Math.max(y,z)-x.height,B=parseInt(u.getPropertyValue("max-height"),10),C=["font-family","font-size","font-weight","font-style","letter-spacing","line-height","text-transform","word-spacing","text-indent"];l.data("elastic")||(B=B&&B>0?B:9e4,t.parentNode!==document.body&&angular.element(document.body).append(t),l.css({resize:"none"===v||"vertical"===v?"none":"horizontal"}).data("elastic",!0),k.oninput="onpropertychange"in k&&"oninput"in k?k.onkeyup=i:i,q.bind("resize",j),d.$watch(function(){return g.$modelValue},function(){j()}),d.$on("elastic:adjust",function(){h(),j()}),a(i),d.$on("$destroy",function(){s.remove(),q.unbind("resize",j)}))}}}}]),app.directive("fitFont",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(a){return a.offsetHeight<a.scrollHeight||a.offsetWidth<a.scrollWidth?!0:!1}function d(){for(;c(h)&&g>12;)g--,b.css("font-size",g+"px")}function e(){for(;!c(h)&&40>g;)g++,b.css("font-size",g+"px");d()}function f(a,b){b>a?d():e()}var g=parseInt(b.css("font-size")),h=b[0],i=[];i.push(a.$watch(function(){return h.clientWidth},function(a,b){a!=b&&f(a,b)})),i.push(a.$watch(function(){return h.innerText},function(){e()})),a.$on("$destroy",function(){for(var a=0,b=i.length;b>a;a++)i[a]()})}}}),app.directive("ifHref",function(){return{restrict:"A",priority:99,link:function(a,b,c){c.$observe("ifHref",function(a){if(!a)return void c.$set("href",null);var b=a.indexOf("#");b>-1&&(a=a.slice(0,b)+a.slice(b+1)),c.$set("href",a)})}}}),app.directive("ifSrc",function(){return{restrict:"A",priority:99,link:function(a,b,c){c.$observe("ifSrc",function(a){return a?(a.indexOf("http")<0&&(a="https://bubbl.li/"+a),void c.$set("src",a)):void c.$set("src",null)})}}}),app.directive("progressCircle",function(){return{restrict:"EA",scope:{top:"=",left:"=",fullWidth:"=",spinLeft:"=",spinLeftLong:"="},templateUrl:"templates/progressCircle.html",controller:function(a){a.style=function(){return{top:a.top+"px",left:a.left+"px",width:a.fullWidth+"px",height:a.fullWidth+"px",clip:b(a.spinLeft,a.spinLeftLong,a.fullWidth)}},a.styleClip={clip:"rect(0px,"+a.fullWidth/2+"px,"+a.fullWidth+"px,0px)"};var b=function(a,b,c){var d="rect(auto, auto, auto, auto)",e="rect(0px, 0px, 0px, 0px)",f="rect(0px,"+c+"px,"+c+"px,"+c/2+"px)";return a&&b?d:a||b?f:e}}}}),app.directive("ryFocus",function(){return{restrict:"A",scope:{shouldFocus:"=ryFocus"},link:function(a,b){a.$watch("shouldFocus",function(a,c){1!=a||c?0==a&&c&&b[0].blur():b[0].focus()})}}}),app.directive("stickers",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(a,b){return/touch/.test(a.type)?(a.originalEvent||a).changedTouches[0]["page"+b]:a["page"+b]}function d(a){n=c(a,"X"),o=c(a,"Y"),g=0,h=0,m=setTimeout(function(){l=!0},200)}function e(a){i=c(a,"X"),j=c(a,"Y"),g=i-n,h=j-o,l||Math.abs(h)>10&&(k=!0),l&&(a.preventDefault(),p.style.top=j+"px",p.style.left=i+"px"),(Math.abs(g)>5||Math.abs(h)>5)&&clearTimeout(m)}function f(a){l||!k&Math.abs(g)<5&&Math.abs(h)<5&&"touchend"===a.type&&a.preventDefault(),swipe=!1,l=!1,k=!1,clearTimeout(m)}var g,h,i,j,k,l,m,n,o,p=document.createElement("div");p.className="floating-sticker",document.body.appendChild(p),b.on("touchstart",d).on("touchmove",e).on("touchend",f)}}}),app.directive("stickerCrosshair",["$window",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(){var a=Math.max(document.documentElement.clientHeight,window.innerHeight||0),c=Math.max(document.documentElement.clientWidth,window.innerWidth||0),d=0,e=0,f=c/2-d,g=(a-220-48)/2+48-e;b[0].style.left=f+"px",b[0].style.top=g+"px"}$(window).on("resize",c),c()}}}]),angular.module("IF-directives",[]).directive("ifTooltip",function(){return{restrict:"A",link:function(a,b){new Drop({target:b[0],content:"testing 123",position:"bottom right",openOn:"click"})}}}),angular.module("IF-directives",[]).directive("userChip",["dialogs",function(a){return{restrict:"A",scope:!0,link:function(b){b.openDrawer=function(){b.$emit("toggleDrawer")},b.login=function(){a.showDialog("authDialog.html")}},templateUrl:"templates/userChip.html"}}]),app.directive("worldShelf",["$document","apertureService","$rootScope","$location",function(){return{restrict:"A",link:function(){}}}]),angular.module("tidepoolsFilters",[]).filter("hashtag",function(){return function(a){return a.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){var b=a.replace("#","");return a.link("#/talk/"+b)})}}).filter("youtubestrip",function(){return function(a){if(a){var b=a.replace(/^[^_]*=/,"");return b}}}).filter("url",function(){return function(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return a.replace(b,function(a){return'<a href="'+a+'">'+a+"</a>"})}}).filter("unsafe",function(a){return function(b){return a.trustAsHtml(b)}}).filter("httpsify",function(){return function(a){return a.replace(/^http:\/\//i,"https://")}}).filter("userName",function(){return function(a){var b;return"string"==typeof a?(b=a.indexOf("@"),-1!=b?a.substr(0,b):a):a}}).filter("datetime",function(a){return function(b){if(null==b)return"";var c=a("date")(new Date(b),"hh:mm a - MMM dd, yyyy");return c.toUpperCase()}}),function(a){"function"==typeof define&&define.amd?define(["jquery","moment"],a):a(jQuery,moment)}(function(a,b){function c(a,b){return b.longDateFormat("LT").replace(":mm","(:mm)").replace(/(\Wmm)$/,"($1)").replace(/\s*a$/i,"t")}function d(a,b){var c=b.longDateFormat("L");return c=c.replace(/^Y+[^\w\s]*|[^\w\s]*Y+$/g,""),a.isRTL?c+=" ddd":c="ddd "+c,c}function e(a){f(Gb,a)}function f(b){function c(c,d){a.isPlainObject(d)&&a.isPlainObject(b[c])&&!g(c)?b[c]=f({},b[c],d):void 0!==d&&(b[c]=d)}for(var d=1;d<arguments.length;d++)a.each(arguments[d],c);return b}function g(a){return/(Time|Duration)$/.test(a)}function h(c,d){function e(a){var c=b.localeData||b.langData;return c.call(b,a)||c.call(b,"en")}function g(a){cb?l()&&(p(),n(a)):h()}function h(){db=Z.theme?"ui":"fc",c.addClass("fc"),c.addClass(Z.isRTL?"fc-rtl":"fc-ltr"),c.addClass(Z.theme?"ui-widget":"fc-unthemed"),cb=a("<div class='fc-view-container'/>").prependTo(c),ab=new i(X,Z),bb=ab.render(),bb&&c.prepend(bb),m(Z.defaultView),Z.handleWindowResize&&(gb=J(r,Z.windowResizeDelay),a(window).resize(gb))}function k(){eb&&eb.destroy(),ab.destroy(),cb.remove(),c.removeClass("fc fc-ltr fc-rtl fc-unthemed ui-widget"),a(window).unbind("resize",gb)}function l(){return c.is(":visible")}function m(a){n(0,a)}function n(b,c){lb++,eb&&c&&eb.name!==c&&(ab.deactivateButton(eb.name),Q(),eb.start&&eb.destroy(),eb.el.remove(),eb=null),!eb&&c&&(eb=new Kb[c](X),eb.el=a("<div class='fc-view fc-"+c+"-view' />").appendTo(cb),ab.activateButton(c)),eb&&(b&&(hb=eb.incrementDate(hb,b)),eb.start&&!b&&hb.isWithin(eb.intervalStart,eb.intervalEnd)||l()&&(Q(),eb.start&&eb.destroy(),eb.render(hb),R(),z(),A(),v())),R(),lb--}function o(a){return l()?(a&&q(),lb++,eb.updateSize(!0),lb--,!0):void 0}function p(){l()&&q()}function q(){fb="number"==typeof Z.contentHeight?Z.contentHeight:"number"==typeof Z.height?Z.height-(bb?bb.outerHeight(!0):0):Math.round(cb.width()/Math.max(Z.aspectRatio,.5))}function r(a){!lb&&a.target===window&&eb.start&&o(!0)&&eb.trigger("windowResize",kb)}function s(){u(),w()}function t(){l()&&(Q(),eb.destroyEvents(),eb.renderEvents(mb),R())}function u(){Q(),eb.destroyEvents(),R()}function v(){!Z.lazyFetching||ib(eb.start,eb.end)?w():t()}function w(){jb(eb.start,eb.end)}function x(a){mb=a,t()}function y(){t()}function z(){ab.updateTitle(eb.title)}function A(){var a=X.getNow();a.isWithin(eb.intervalStart,eb.intervalEnd)?ab.disableButton("today"):ab.enableButton("today")}function B(a,b){a=X.moment(a),b=b?X.moment(b):a.clone().add(a.hasTime()?X.defaultTimedEventDuration:X.defaultAllDayEventDuration),eb.select(a,b)}function C(){eb&&eb.unselect()}function E(){n(-1)}function F(){n(1)}function G(){hb.add(-1,"years"),n()}function H(){hb.add(1,"years"),n()}function K(){hb=X.getNow(),n()}function L(a){hb=X.moment(a),n()}function M(a){hb.add(b.duration(a)),n()}function N(a,b){var c,d;b&&void 0!==Kb[b]||(b=b||"day",c=ab.getViewsWithButtons().join(" "),d=c.match(new RegExp("\\w+"+I(b))),d||(d=c.match(/\w+Day/)),b=d?d[0]:"agendaDay"),hb=a,m(b)}function O(){return hb.clone()}function Q(){cb.css({width:"100%",height:cb.height(),overflow:"hidden"})}function R(){cb.css({width:"",height:"",overflow:""})}function T(){return X}function U(){return eb}function V(a,b){return void 0===b?Z[a]:void(("height"==a||"contentHeight"==a||"aspectRatio"==a)&&(Z[a]=b,o(!0)))}function W(a,b){return Z[a]?Z[a].apply(b||kb,Array.prototype.slice.call(arguments,2)):void 0}var X=this;d=d||{};var Y,Z=f({},Gb,d);Y=Z.lang in Hb?Hb[Z.lang]:Hb[Gb.lang],Y&&(Z=f({},Gb,Y,d)),Z.isRTL&&(Z=f({},Gb,Ib,Y||{},d)),X.options=Z,X.render=g,X.destroy=k,X.refetchEvents=s,X.reportEvents=x,X.reportEventChange=y,X.rerenderEvents=t,X.changeView=m,X.select=B,X.unselect=C,X.prev=E,X.next=F,X.prevYear=G,X.nextYear=H,X.today=K,X.gotoDate=L,X.incrementDate=M,X.zoomTo=N,X.getDate=O,X.getCalendar=T,X.getView=U,X.option=V,X.trigger=W;var $=D(e(Z.lang));if(Z.monthNames&&($._months=Z.monthNames),Z.monthNamesShort&&($._monthsShort=Z.monthNamesShort),Z.dayNames&&($._weekdays=Z.dayNames),Z.dayNamesShort&&($._weekdaysShort=Z.dayNamesShort),null!=Z.firstDay){var _=D($._week);_.dow=Z.firstDay,$._week=_}X.defaultAllDayEventDuration=b.duration(Z.defaultAllDayEventDuration),X.defaultTimedEventDuration=b.duration(Z.defaultTimedEventDuration),X.moment=function(){var a;return"local"===Z.timezone?(a=Jb.moment.apply(null,arguments),a.hasTime()&&a.local()):a="UTC"===Z.timezone?Jb.moment.utc.apply(null,arguments):Jb.moment.parseZone.apply(null,arguments),"_locale"in a?a._locale=$:a._lang=$,a},X.getIsAmbigTimezone=function(){return"local"!==Z.timezone&&"UTC"!==Z.timezone},X.rezoneDate=function(a){return X.moment(a.toArray())},X.getNow=function(){var a=Z.now;return"function"==typeof a&&(a=a()),X.moment(a)},X.calculateWeekNumber=function(a){var b=Z.weekNumberCalculation;return"function"==typeof b?b(a):"local"===b?a.week():"ISO"===b.toUpperCase()?a.isoWeek():void 0},X.getEventEnd=function(a){return a.end?a.end.clone():X.getDefaultEventEnd(a.allDay,a.start)},X.getDefaultEventEnd=function(a,b){var c=b.clone();return a?c.stripTime().add(X.defaultAllDayEventDuration):c.add(X.defaultTimedEventDuration),X.getIsAmbigTimezone()&&c.stripZone(),c},X.formatRange=function(a,b,c){return"function"==typeof c&&(c=c.call(X,Z,$)),S(a,b,c,null,Z.isRTL)},X.formatDate=function(a,b){return"function"==typeof b&&(b=b.call(X,Z,$)),P(a,b)},j.call(X,Z);var ab,bb,cb,db,eb,fb,gb,hb,ib=X.isFetchNeeded,jb=X.fetchEvents,kb=c[0],lb=0,mb=[];hb=null!=Z.defaultDate?X.moment(Z.defaultDate):X.getNow(),X.getSuggestedViewHeight=function(){return void 0===fb&&p(),fb},X.isHeightAuto=function(){return"auto"===Z.contentHeight||"auto"===Z.height}}function i(b,c){function d(){var b=c.header;return n=c.theme?"ui":"fc",b?o=a("<div class='fc-toolbar'/>").append(f("left")).append(f("right")).append(f("center")).append('<div class="fc-clear"/>'):void 0}function e(){o.remove()}function f(d){var e=a('<div class="fc-'+d+'"/>'),f=c.header[d];return f&&a.each(f.split(" "),function(){var d,f=a(),g=!0;a.each(this.split(","),function(d,e){var h,i,j,k,l,m,o,q;"title"==e?(f=f.add(a("<h2>&nbsp;</h2>")),g=!1):(b[e]?h=function(){b[e]()}:Kb[e]&&(h=function(){b.changeView(e)},p.push(e)),h&&(i=y(c.themeButtonIcons,e),j=y(c.buttonIcons,e),k=y(c.defaultButtonText,e),l=y(c.buttonText,e),m=l?G(l):i&&c.theme?"<span class='ui-icon ui-icon-"+i+"'></span>":j&&!c.theme?"<span class='fc-icon fc-icon-"+j+"'></span>":G(k||e),o=["fc-"+e+"-button",n+"-button",n+"-state-default"],q=a('<button type="button" class="'+o.join(" ")+'">'+m+"</button>").click(function(){q.hasClass(n+"-state-disabled")||(h(),(q.hasClass(n+"-state-active")||q.hasClass(n+"-state-disabled"))&&q.removeClass(n+"-state-hover"))}).mousedown(function(){q.not("."+n+"-state-active").not("."+n+"-state-disabled").addClass(n+"-state-down")}).mouseup(function(){q.removeClass(n+"-state-down")}).hover(function(){q.not("."+n+"-state-active").not("."+n+"-state-disabled").addClass(n+"-state-hover")},function(){q.removeClass(n+"-state-hover").removeClass(n+"-state-down")}),f=f.add(q)))}),g&&f.first().addClass(n+"-corner-left").end().last().addClass(n+"-corner-right").end(),f.length>1?(d=a("<div/>"),g&&d.addClass("fc-button-group"),d.append(f),e.append(d)):e.append(f)}),e}function g(a){o.find("h2").text(a)}function h(a){o.find(".fc-"+a+"-button").addClass(n+"-state-active")}function i(a){o.find(".fc-"+a+"-button").removeClass(n+"-state-active")}function j(a){o.find(".fc-"+a+"-button").attr("disabled","disabled").addClass(n+"-state-disabled")}function k(a){o.find(".fc-"+a+"-button").removeAttr("disabled").removeClass(n+"-state-disabled")}function l(){return p}var m=this;m.render=d,m.destroy=e,m.updateTitle=g,m.activateButton=h,m.deactivateButton=i,m.disableButton=j,m.enableButton=k,m.getViewsWithButtons=l;var n,o=a(),p=[]}function j(c){function d(a,b){return!M||a.clone().stripZone()<M.clone().stripZone()||b.clone().stripZone()>N.clone().stripZone()}function e(a,b){M=a,N=b,X=[];var c=++U,d=T.length;V=d;for(var e=0;d>e;e++)f(T[e],c)}function f(b,c){g(b,function(d){var e,f,g,h=a.isArray(b.events);if(c==U){if(d)for(e=0;e<d.length;e++)f=d[e],g=h?f:u(f,b),g&&X.push.apply(X,w(g));V--,V||Q(X)}})}function g(b,d){var e,f,h=Jb.sourceFetchers;for(e=0;e<h.length;e++){if(f=h[e].call(L,b,M.clone(),N.clone(),c.timezone,d),f===!0)return;if("object"==typeof f)return void g(f,d)}var i=b.events;if(i)a.isFunction(i)?(s(),i.call(L,M.clone(),N.clone(),c.timezone,function(a){d(a),t()})):a.isArray(i)?d(i):d();else{var j=b.url;if(j){var k,l=b.success,m=b.error,n=b.complete;k=a.isFunction(b.data)?b.data():b.data;var o=a.extend({},k||{}),p=F(b.startParam,c.startParam),q=F(b.endParam,c.endParam),r=F(b.timezoneParam,c.timezoneParam);p&&(o[p]=M.format()),q&&(o[q]=N.format()),c.timezone&&"local"!=c.timezone&&(o[r]=c.timezone),s(),a.ajax(a.extend({},Lb,b,{data:o,success:function(b){b=b||[];var c=E(l,this,arguments);a.isArray(c)&&(b=c),d(b)},error:function(){E(m,this,arguments),d()},complete:function(){E(n,this,arguments),t()}}))}else d()}}function h(a){var b=i(a);b&&(T.push(b),V++,f(b,U))}function i(b){var c,d,e=Jb.sourceNormalizers;if(a.isFunction(b)||a.isArray(b)?c={events:b}:"string"==typeof b?c={url:b}:"object"==typeof b&&(c=a.extend({},b)),c){for(c.className?"string"==typeof c.className&&(c.className=c.className.split(/\s+/)):c.className=[],a.isArray(c.events)&&(c.origArray=c.events,c.events=a.map(c.events,function(a){return u(a,c)})),d=0;d<e.length;d++)e[d].call(L,c);return c}}function j(b){T=a.grep(T,function(a){return!l(a,b)}),X=a.grep(X,function(a){return!l(a.source,b)}),Q(X)}function l(a,b){return a&&b&&m(a)==m(b)}function m(a){return("object"==typeof a?a.origArray||a.url||a.events:null)||a}function n(a){a.start=L.moment(a.start),a.end&&(a.end=L.moment(a.end)),x(a),o(a),Q(X)}function o(a){var b,c,d,e;for(b=0;b<X.length;b++)if(c=X[b],c._id==a._id&&c!==a)for(d=0;d<Y.length;d++)e=Y[d],void 0!==a[e]&&(c[e]=a[e])}function p(a,b){var c,d,e,f=u(a);if(f){for(c=w(f),d=0;d<c.length;d++)e=c[d],e.source||(b&&(S.events.push(e),e.source=S),X.push(e));return Q(X),c}return[]}function q(b){var c,d;for(null==b?b=function(){return!0}:a.isFunction(b)||(c=b+"",b=function(a){return a._id==c}),X=a.grep(X,b,!0),d=0;d<T.length;d++)a.isArray(T[d].events)&&(T[d].events=a.grep(T[d].events,b,!0));Q(X)}function r(b){return a.isFunction(b)?a.grep(X,b):null!=b?(b+="",a.grep(X,function(a){return a._id==b})):X}function s(){W++||O("loading",null,!0,P())}function t(){--W||O("loading",null,!1,P())}function u(d,e){var f,g,h,i,j={};if(c.eventDataTransform&&(d=c.eventDataTransform(d)),e&&e.eventDataTransform&&(d=e.eventDataTransform(d)),a.extend(j,d),e&&(j.source=e),j._id=d._id||(void 0===d.id?"_fc"+Mb++:d.id+""),j.className=d.className?"string"==typeof d.className?d.className.split(/\s+/):d.className:[],f=d.start||d.date,g=d.end,C(f)&&(f=b.duration(f)),C(g)&&(g=b.duration(g)),d.dow||b.isDuration(f)||b.isDuration(g))j.start=f?b.duration(f):null,j.end=g?b.duration(g):null,j._recurring=!0;else{if(f&&(f=L.moment(f),!f.isValid()))return!1;if(g&&(g=L.moment(g),!g.isValid()))return!1;h=d.allDay,void 0===h&&(i=F(e?e.allDayDefault:void 0,c.allDayDefault),h=void 0!==i?i:!(f.hasTime()||g&&g.hasTime())),v(f,g,h,j)}return j}function v(a,b,d,e){d?(a.hasTime()&&a.stripTime(),b&&b.hasTime()&&b.stripTime()):(a.hasTime()||(a=L.rezoneDate(a)),b&&!b.hasTime()&&(b=L.rezoneDate(b))),e.allDay=d,e.start=a,e.end=b||null,c.forceEventDuration&&!e.end&&(e.end=R(e)),k(e)}function w(b){var c,d,e,f,g,h,i,j,k,l,m=[],n=M,o=N;if(n&&o||(c=L.getView(),n=c.start,o=c.end),b)if(b._recurring){if(e=b.dow)for(d={},f=0;f<e.length;f++)d[e[f]]=!0;for(g=n.clone().stripTime();g.isBefore(o);)(!d||d[g.day()])&&(h=b.start,i=b.end,j=g.clone(),k=null,h&&(j=j.time(h)),i&&(k=g.clone().time(i)),l=a.extend({},b),v(j,k,!h&&!i,l),m.push(l)),g.add(1,"days")}else m.push(b);return m}function x(a,b,c){var d,e,f,g,h=a._allDay,i=a._start,j=a._end,k=!1;return b||c||(b=a.start,c=a.end),d=a.allDay!=h?a.allDay:!(b||c).hasTime(),d&&(b&&(b=b.clone().stripTime()),c&&(c=c.clone().stripTime())),b&&(e=d?z(b,i.clone().stripTime()):z(b,i)),d!=h?k=!0:c&&(f=z(c||L.getDefaultEventEnd(d,b||i),b||i).subtract(z(j||L.getDefaultEventEnd(h,i),i))),g=y(r(a._id),k,d,e,f),{dateDelta:e,durationDelta:f,undo:g}}function y(b,d,e,f,g){var h=L.getIsAmbigTimezone(),i=[];return a.each(b,function(a,b){var j=b._allDay,l=b._start,m=b._end,n=null!=e?e:j,o=l.clone(),p=!d&&m?m.clone():null;n?(o.stripTime(),p&&p.stripTime()):(o.hasTime()||(o=L.rezoneDate(o)),p&&!p.hasTime()&&(p=L.rezoneDate(p))),p||!c.forceEventDuration&&!+g||(p=L.getDefaultEventEnd(n,o)),o.add(f),p&&p.add(f).add(g),h&&(+f||+g)&&(o.stripZone(),p&&p.stripZone()),b.allDay=n,b.start=o,b.end=p,k(b),i.push(function(){b.allDay=j,b.start=l,b.end=m,k(b)})}),function(){for(var a=0;a<i.length;a++)i[a]()}}function A(){var b,d=c.businessHours,e={className:"fc-nonbusiness",start:"09:00",end:"17:00",dow:[1,2,3,4,5],rendering:"inverse-background"};return d&&(b="object"==typeof d?a.extend({},e,d):e),b?w(u(b)):[]}function B(a,b,d){var e=a.source||{},f=F(a.constraint,e.constraint,c.eventConstraint),g=F(a.overlap,e.overlap,c.eventOverlap);return H(b,d,f,g,a)}function D(a,b){return H(a,b,c.selectConstraint,c.selectOverlap)}function G(a,b,c){var d;return c&&(d=w(u(c))[0])?B(d,a,b):D(a,b)}function H(a,b,c,d,e){var f,g,h,i,j;if(a=a.clone().stripZone(),b=b.clone().stripZone(),null!=c){for(f=I(c),g=!1,h=0;h<f.length;h++)if(J(f[h],a,b)){g=!0;break}if(!g)return!1}for(h=0;h<X.length;h++)if(i=X[h],(!e||e._id!==i._id)&&K(i,a,b)){if(d===!1)return!1;if("function"==typeof d&&!d(i,e))return!1;if(e){if(j=F(i.overlap,(i.source||{}).overlap),j===!1)return!1;if("function"==typeof j&&!j(e,i))return!1}}return!0}function I(a){return"businessHours"===a?A():"object"==typeof a?w(u(a)):r(a)}function J(a,b,c){var d=a.start.clone().stripZone(),e=L.getEventEnd(a).stripZone();return b>=d&&e>=c}function K(a,b,c){var d=a.start.clone().stripZone(),e=L.getEventEnd(a).stripZone();return e>b&&c>d}var L=this;L.isFetchNeeded=d,L.fetchEvents=e,L.addEventSource=h,L.removeEventSource=j,L.updateEvent=n,L.renderEvent=p,L.removeEvents=q,L.clientEvents=r,L.mutateEvent=x;var M,N,O=L.trigger,P=L.getView,Q=L.reportEvents,R=L.getEventEnd,S={events:[]},T=[S],U=0,V=0,W=0,X=[];a.each((c.events?[c.events]:[]).concat(c.eventSources||[]),function(a,b){var c=i(b);c&&T.push(c)});var Y=["title","url","allDay","className","editable","color","backgroundColor","borderColor","textColor"];L.getBusinessHoursEvents=A,L.isEventAllowedInRange=B,L.isSelectionAllowedInRange=D,L.isExternalDragAllowedInRange=G}function k(a){a._allDay=a.allDay,a._start=a.start.clone(),a._end=a.end?a.end.clone():null}function l(a,b){b.left&&a.css({"border-left-width":1,"margin-left":b.left-1}),b.right&&a.css({"border-right-width":1,"margin-right":b.right-1})}function m(a){a.css({"margin-left":"","margin-right":"","border-left-width":"","border-right-width":""})}function n(){a("body").addClass("fc-not-allowed")}function o(){a("body").removeClass("fc-not-allowed")}function p(b,c,d){var e=Math.floor(c/b.length),f=Math.floor(c-e*(b.length-1)),g=[],h=[],i=[],j=0;q(b),b.each(function(c,d){var k=c===b.length-1?f:e,l=a(d).outerHeight(!0);k>l?(g.push(d),h.push(l),i.push(a(d).height())):j+=l}),d&&(c-=j,e=Math.floor(c/g.length),f=Math.floor(c-e*(g.length-1))),a(g).each(function(b,c){var d=b===g.length-1?f:e,j=h[b],k=i[b],l=d-(j-k);d>j&&a(c).height(l)})}function q(a){a.height("")}function r(b){var c=0;return b.find("> *").each(function(b,d){var e=a(d).outerWidth();e>c&&(c=e)}),c++,b.width(c),c}function s(a,b){return a.height(b).addClass("fc-scroller"),a[0].scrollHeight-1>a[0].clientHeight?!0:(t(a),!1)}function t(a){a.height("").removeClass("fc-scroller")}function u(b){var c=b.css("position"),d=b.parents().filter(function(){var b=a(this);return/(auto|scroll)/.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x"))}).eq(0);return"fixed"!==c&&d.length?d:a(b[0].ownerDocument||document)}function v(a){var b=a.offset().left,c=b+a.width(),d=a.children(),e=d.offset().left,f=e+d.outerWidth();return{left:e-b,right:c-f}}function w(a){return 1==a.which&&!a.ctrlKey}function x(a,b,c,d){var e,f,g,h;return b>c&&d>a?(a>=c?(e=a.clone(),g=!0):(e=c.clone(),g=!1),d>=b?(f=b.clone(),h=!0):(f=d.clone(),h=!1),{start:e,end:f,isStart:g,isEnd:h}):void 0}function y(a,b){if(a=a||{},void 0!==a[b])return a[b];for(var c,d=b.split(/(?=[A-Z])/),e=d.length-1;e>=0;e--)if(c=a[d[e].toLowerCase()],void 0!==c)return c;return a["default"]}function z(a,c){return b.duration({days:a.clone().stripTime().diff(c.clone().stripTime(),"days"),ms:a.time()-c.time()})}function A(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function B(a,b){return a-b}function C(a){return/^\d+\:\d+(?:\:\d+\.?(?:\d{3})?)?$/.test(a)}function D(a){var b=function(){};return b.prototype=a,new b}function E(b,c,d){if(a.isFunction(b)&&(b=[b]),b){var e,f;for(e=0;e<b.length;e++)f=b[e].apply(c,d)||f;return f}}function F(){for(var a=0;a<arguments.length;a++)if(void 0!==arguments[a])return arguments[a]}function G(a){return(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;").replace(/\n/g,"<br />")}function H(a){return a.replace(/&.*?;/g,"")}function I(a){return a.charAt(0).toUpperCase()+a.slice(1)}function J(a,b){var c,d,e,f,g=function(){var h=+new Date-f;b>h&&h>0?c=setTimeout(g,b-h):(c=null,a.apply(e,d),c||(e=d=null))};return function(){e=this,d=arguments,f=+new Date,c||(c=setTimeout(g,b))}}function K(c,d,e){var f,g,h,i,j=c[0],k=1==c.length&&"string"==typeof j;return b.isMoment(j)?(i=b.apply(null,c),M(j,i)):A(j)||void 0===j?i=b.apply(null,c):(f=!1,g=!1,k?Rb.test(j)?(j+="-01",c=[j],f=!0,g=!0):(h=Sb.exec(j))&&(f=!h[5],g=!0):a.isArray(j)&&(g=!0),i=d?b.utc.apply(b,c):b.apply(null,c),f?(i._ambigTime=!0,i._ambigZone=!0):e&&(g?i._ambigZone=!0:k&&i.zone(j))),i._fullCalendar=!0,i}function L(a,b){var c,d=[],e=!1,f=!1;for(c=0;c<a.length;c++)d.push(Jb.moment.parseZone(a[c])),e=e||d[c]._ambigTime,f=f||d[c]._ambigZone;for(c=0;c<d.length;c++)e&&!b?d[c].stripTime():f&&d[c].stripZone();return d}function M(a,b){a._ambigTime?b._ambigTime=!0:b._ambigTime&&(b._ambigTime=!1),a._ambigZone?b._ambigZone=!0:b._ambigZone&&(b._ambigZone=!1)}function N(a,b){a.year(b[0]||0).month(b[1]||0).date(b[2]||0).hours(b[3]||0).minutes(b[4]||0).seconds(b[5]||0).milliseconds(b[6]||0)}function O(a,b){return Ub.format.call(a,b)}function P(a,b){return Q(a,V(b))}function Q(a,b){var c,d="";for(c=0;c<b.length;c++)d+=R(a,b[c]);return d}function R(a,b){var c,d;return"string"==typeof b?b:(c=b.token)?Vb[c]?Vb[c](a):O(a,c):b.maybe&&(d=Q(a,b.maybe),d.match(/[1-9]/))?d:""}function S(a,b,c,d,e){var f;return a=Jb.moment.parseZone(a),b=Jb.moment.parseZone(b),f=(a.localeData||a.lang).call(a),c=f.longDateFormat(c)||c,d=d||" - ",T(a,b,V(c),d,e)}function T(a,b,c,d,e){var f,g,h,i,j="",k="",l="",m="",n="";for(g=0;g<c.length&&(f=U(a,b,c[g]),f!==!1);g++)j+=f;for(h=c.length-1;h>g&&(f=U(a,b,c[h]),f!==!1);h--)k=f+k;for(i=g;h>=i;i++)l+=R(a,c[i]),m+=R(b,c[i]);return(l||m)&&(n=e?m+d+l:l+d+m),j+n+k}function U(a,b,c){var d,e;return"string"==typeof c?c:(d=c.token)&&(e=Wb[d.charAt(0)],e&&a.isSame(b,e))?O(a,d):!1}function V(a){return a in Xb?Xb[a]:Xb[a]=W(a)}function W(a){for(var b,c=[],d=/\[([^\]]*)\]|\(([^\)]*)\)|(LT|(\w)\4*o?)|([^\w\[\(]+)/g;b=d.exec(a);)b[1]?c.push(b[1]):b[2]?c.push({maybe:W(b[2])}):b[3]?c.push({token:b[3]}):b[5]&&c.push(b[5]);return c}function X(a){this.options=a||{}}function Y(a){this.grid=a}function Z(a){this.coordMaps=a}function $(a,b){this.coordMap=a,this.options=b||{}}function _(a,b){return a||b?a&&b?a.grid===b.grid&&a.row===b.row&&a.col===b.col:!1:!0}function ab(b,c){this.options=c=c||{},this.sourceEl=b,this.parentEl=c.parentEl?a(c.parentEl):b.parent()}function bb(a){this.view=a}function cb(a){bb.call(this,a),this.coordMap=new Y(this),this.elsByFill={}}function db(a){var b=fb(a);return"background"===b||"inverse-background"===b}function eb(a){return"inverse-background"===fb(a)}function fb(a){return F((a.source||{}).rendering,a.rendering)}function gb(a){var b,c,d={};for(b=0;b<a.length;b++)c=a[b],(d[c._id]||(d[c._id]=[])).push(c);return d}function hb(a,b){return a.eventStartMS-b.eventStartMS}function ib(a,b){return a.eventStartMS-b.eventStartMS||b.eventDurationMS-a.eventDurationMS||b.event.allDay-a.event.allDay||(a.event.title||"").localeCompare(b.event.title)}function jb(a){cb.call(this,a)}function kb(a,b){var c,d;for(c=0;c<b.length;c++)if(d=b[c],d.leftCol<=a.rightCol&&d.rightCol>=a.leftCol)return!0;return!1}function lb(a,b){return a.leftCol-b.leftCol}function mb(a){cb.call(this,a)}function nb(a){var b,c,d;if(a.sort(ib),b=ob(a),pb(b),c=b[0]){for(d=0;d<c.length;d++)qb(c[d]);for(d=0;d<c.length;d++)rb(c[d],0,0)}}function ob(a){var b,c,d,e=[];for(b=0;b<a.length;b++){for(c=a[b],d=0;d<e.length&&sb(c,e[d]).length;d++);c.level=d,(e[d]||(e[d]=[])).push(c)}return e}function pb(a){var b,c,d,e,f;for(b=0;b<a.length;b++)for(c=a[b],d=0;d<c.length;d++)for(e=c[d],e.forwardSegs=[],f=b+1;f<a.length;f++)sb(e,a[f],e.forwardSegs)}function qb(a){var b,c,d=a.forwardSegs,e=0;if(void 0===a.forwardPressure){for(b=0;b<d.length;b++)c=d[b],qb(c),e=Math.max(e,1+c.forwardPressure);a.forwardPressure=e}}function rb(a,b,c){var d,e=a.forwardSegs;if(void 0===a.forwardCoord)for(e.length?(e.sort(ub),rb(e[0],b+1,c),a.forwardCoord=e[0].backwardCoord):a.forwardCoord=1,a.backwardCoord=a.forwardCoord-(a.forwardCoord-c)/(b+1),d=0;d<e.length;d++)rb(e[d],0,a.forwardCoord)}function sb(a,b,c){c=c||[];for(var d=0;d<b.length;d++)tb(a,b[d])&&c.push(b[d]);return c}function tb(a,b){return a.bottom>b.top&&a.top<b.bottom}function ub(a,b){return b.forwardPressure-a.forwardPressure||(a.backwardCoord||0)-(b.backwardCoord||0)||ib(a,b)}function vb(c){function d(b){var c=B[b];return a.isPlainObject(c)&&!g(b)?y(c,z.name):c}function e(a,b){return c.trigger.apply(c,[a,b||z].concat(Array.prototype.slice.call(arguments,2),[z]))}function f(a){var b=a.source||{};return F(a.startEditable,b.startEditable,d("eventStartEditable"),a.editable,b.editable,d("editable"))}function h(a){var b=a.source||{};return F(a.durationEditable,b.durationEditable,d("eventDurationEditable"),a.editable,b.editable,d("editable"))}function i(a,b,d,f){var g=c.mutateEvent(b,d,null);e("eventDrop",a,b,g.dateDelta,function(){g.undo(),A()},f,{}),A()}function j(a,b,d,f){var g=c.mutateEvent(b,null,d);e("eventResize",a,b,g.durationDelta,function(){g.undo(),A()},f,{}),A()}function k(a){return b.isMoment(a)&&(a=a.day()),G[a]}function l(){return D}function m(a,b,c){var d=a.clone();for(b=b||1;G[(d.day()+(c?b:0)+7)%7];)d.add(b,"days");return d}function n(){var a=o.apply(null,arguments),b=p(a),c=q(b);return c}function o(a,b){var c=z.colCnt,d=J?-1:1,e=J?c-1:0;"object"==typeof a&&(b=a.col,a=a.row);var f=a*c+(b*d+e);return f}function p(a){var b=z.start.day();return a+=H[b],7*Math.floor(a/D)+I[(a%D+D)%D]-b}function q(a){return z.start.clone().add(a,"days")}function r(a){var b=s(a),c=t(b),d=u(c);return d}function s(a){return a.clone().stripTime().diff(z.start,"days")}function t(a){var b=z.start.day();return a+=b,Math.floor(a/7)*D+H[(a%7+7)%7]-H[b]}function u(a){var b=z.colCnt,c=J?-1:1,d=J?b-1:0,e=Math.floor(a/b),f=(a%b+b)%b*c+d;return{row:e,col:f}}function v(a,b){for(var c=z.rowCnt,d=z.colCnt,e=[],f=w(a,b),g=s(f.start),h=s(f.end),i=t(g),j=t(h)-1,k=0;c>k;k++){var l=k*d,m=l+d-1,n=Math.max(i,l),o=Math.min(j,m);if(o>=n){var q=u(n),r=u(o),v=[q.col,r.col].sort(),x=p(n)==g,y=p(o)+1==h;e.push({row:k,leftCol:v[0],rightCol:v[1],isStart:x,isEnd:y})}}return e}function w(a,b){var c,d,e=a.clone().stripTime();return b&&(c=b.clone().stripTime(),d=+b.time(),d&&d>=C&&c.add(1,"days")),(!b||e>=c)&&(c=e.clone().add(1,"days")),{start:e,end:c}}function x(a){var b=w(a.start,a.end);return b.end.diff(b.start,"days")>1}var z=this;z.calendar=c,z.opt=d,z.trigger=e,z.isEventDraggable=f,z.isEventResizable=h,z.eventDrop=i,z.eventResize=j;var A=c.reportEventChange,B=c.options,C=b.duration(B.nextDayThreshold);z.init(),z.getEventTimeText=function(a,b){var e,f;return"object"==typeof a&&"object"==typeof b?(e=a,f=b,b=arguments[2]):(e=a.start,f=a.end),b=b||d("timeFormat"),f&&d("displayEventEnd")?c.formatRange(e,f,b):c.formatDate(e,b)},z.isHiddenDay=k,z.skipHiddenDays=m,z.getCellsPerWeek=l,z.dateToCell=r,z.dateToDayOffset=s,z.dayOffsetToCellOffset=t,z.cellOffsetToCell=u,z.cellToDate=n,z.cellToCellOffset=o,z.cellOffsetToDayOffset=p,z.dayOffsetToDate=q,z.rangeToSegments=v,z.isMultiDayEvent=x;var D,E=d("hiddenDays")||[],G=[],H=[],I=[],J=d("isRTL");!function(){d("weekends")===!1&&E.push(0,6);for(var b=0,c=0;7>b;b++)H[b]=c,G[b]=-1!=a.inArray(b,E),G[b]||(I[c]=b,c++);if(D=c,!D)throw"invalid hiddenDays"}()}function wb(c){var d,e,f,g,h=Jb.dataAttrPrefix;return h&&(h+="-"),d=c.data(h+"event")||null,d&&(d="object"==typeof d?a.extend({},d):{},e=d.start,null==e&&(e=d.time),f=d.duration,g=d.stick,delete d.start,delete d.time,delete d.duration,delete d.stick),null==e&&(e=c.data(h+"start")),null==e&&(e=c.data(h+"time")),null==f&&(f=c.data(h+"duration")),null==g&&(g=c.data(h+"stick")),e=null!=e?b.duration(e):null,f=null!=f?b.duration(f):null,g=Boolean(g),{eventProps:d,startTime:e,duration:f,stick:g}
}function xb(a){vb.call(this,a),this.dayGrid=new jb(this),this.coordMap=this.dayGrid.coordMap}function yb(a){xb.call(this,a)}function zb(a){xb.call(this,a)}function Ab(a){xb.call(this,a)}function Bb(a,b){return b.longDateFormat("LT").replace(":mm","(:mm)").replace(/(\Wmm)$/,"($1)").replace(/\s*a$/i,"a")}function Cb(a,b){return b.longDateFormat("LT").replace(/\s*a$/i,"")}function Db(a){vb.call(this,a),this.timeGrid=new mb(this),this.opt("allDaySlot")?(this.dayGrid=new jb(this),this.coordMap=new Z([this.dayGrid.coordMap,this.timeGrid.coordMap])):this.coordMap=this.timeGrid.coordMap}function Eb(a){Db.call(this,a)}function Fb(a){Db.call(this,a)}var Gb={lang:"en",defaultTimedEventDuration:"02:00:00",defaultAllDayEventDuration:{days:1},forceEventDuration:!1,nextDayThreshold:"09:00:00",defaultView:"month",aspectRatio:1.35,header:{left:"title",center:"",right:"today prev,next"},weekends:!0,weekNumbers:!1,weekNumberTitle:"W",weekNumberCalculation:"local",lazyFetching:!0,startParam:"start",endParam:"end",timezoneParam:"timezone",timezone:!1,titleFormat:{month:"MMMM YYYY",week:"ll",day:"LL"},columnFormat:{month:"ddd",week:d,day:"dddd"},timeFormat:{"default":c},displayEventEnd:{month:!1,basicWeek:!1,"default":!0},isRTL:!1,defaultButtonText:{prev:"prev",next:"next",prevYear:"prev year",nextYear:"next year",today:"today",month:"month",week:"week",day:"day"},buttonIcons:{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"},theme:!1,themeButtonIcons:{prev:"circle-triangle-w",next:"circle-triangle-e",prevYear:"seek-prev",nextYear:"seek-next"},dragOpacity:.75,dragRevertDuration:500,dragScroll:!0,unselectAuto:!0,dropAccept:"*",eventLimit:!1,eventLimitText:"more",eventLimitClick:"popover",dayPopoverFormat:"LL",handleWindowResize:!0,windowResizeDelay:200},Hb={en:{columnFormat:{week:"ddd M/D"},dayPopoverFormat:"dddd, MMMM D"}},Ib={header:{left:"next,prev today",center:"",right:"title"},buttonIcons:{prev:"right-single-arrow",next:"left-single-arrow",prevYear:"right-double-arrow",nextYear:"left-double-arrow"},themeButtonIcons:{prev:"circle-triangle-e",next:"circle-triangle-w",nextYear:"seek-prev",prevYear:"seek-next"}},Jb=a.fullCalendar={version:"2.2.2"},Kb=Jb.views={};a.fn.fullCalendar=function(b){var c=Array.prototype.slice.call(arguments,1),d=this;return this.each(function(e,f){var g,i=a(f),j=i.data("fullCalendar");"string"==typeof b?j&&a.isFunction(j[b])&&(g=j[b].apply(j,c),e||(d=g),"destroy"===b&&i.removeData("fullCalendar")):j||(j=new h(i,b),i.data("fullCalendar",j),j.render())}),d},Jb.langs=Hb,Jb.datepickerLang=function(b,c,d){var e=Hb[b];e||(e=Hb[b]={}),f(e,{isRTL:d.isRTL,weekNumberTitle:d.weekHeader,titleFormat:{month:d.showMonthAfterYear?"YYYY["+d.yearSuffix+"] MMMM":"MMMM YYYY["+d.yearSuffix+"]"},defaultButtonText:{prev:H(d.prevText),next:H(d.nextText),today:H(d.currentText)}}),a.datepicker&&(a.datepicker.regional[c]=a.datepicker.regional[b]=d,a.datepicker.regional.en=a.datepicker.regional[""],a.datepicker.setDefaults(d))},Jb.lang=function(a,b){var c;b&&(c=Hb[a],c||(c=Hb[a]={}),f(c,b||{})),Gb.lang=a},Jb.sourceNormalizers=[],Jb.sourceFetchers=[];var Lb={dataType:"json",cache:!1},Mb=1,Nb=["sun","mon","tue","wed","thu","fri","sat"];Jb.applyAll=E;var Ob,Pb,Qb,Rb=/^\s*\d{4}-\d\d$/,Sb=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?)?$/,Tb=b.fn,Ub=a.extend({},Tb);Jb.moment=function(){return K(arguments)},Jb.moment.utc=function(){var a=K(arguments,!0);return a.hasTime()&&a.utc(),a},Jb.moment.parseZone=function(){return K(arguments,!0,!0)},Tb.clone=function(){var a=Ub.clone.apply(this,arguments);return M(this,a),this._fullCalendar&&(a._fullCalendar=!0),a},Tb.time=function(a){if(!this._fullCalendar)return Ub.time.apply(this,arguments);if(null==a)return b.duration({hours:this.hours(),minutes:this.minutes(),seconds:this.seconds(),milliseconds:this.milliseconds()});this._ambigTime=!1,b.isDuration(a)||b.isMoment(a)||(a=b.duration(a));var c=0;return b.isDuration(a)&&(c=24*Math.floor(a.asDays())),this.hours(c+a.hours()).minutes(a.minutes()).seconds(a.seconds()).milliseconds(a.milliseconds())},Tb.stripTime=function(){var a=this.toArray();return this.utc(),Pb(this,a.slice(0,3)),this._ambigTime=!0,this._ambigZone=!0,this},Tb.hasTime=function(){return!this._ambigTime},Tb.stripZone=function(){var a=this.toArray(),b=this._ambigTime;return this.utc(),Pb(this,a),b&&(this._ambigTime=!0),this._ambigZone=!0,this},Tb.hasZone=function(){return!this._ambigZone},Tb.zone=function(a){return null!=a&&(this._ambigTime=!1,this._ambigZone=!1),Ub.zone.apply(this,arguments)},Tb.local=function(){var a=this.toArray(),b=this._ambigZone;return Ub.local.apply(this,arguments),b&&Qb(this,a),this},Tb.format=function(){return this._fullCalendar&&arguments[0]?P(this,arguments[0]):this._ambigTime?O(this,"YYYY-MM-DD"):this._ambigZone?O(this,"YYYY-MM-DD[T]HH:mm:ss"):Ub.format.apply(this,arguments)},Tb.toISOString=function(){return this._ambigTime?O(this,"YYYY-MM-DD"):this._ambigZone?O(this,"YYYY-MM-DD[T]HH:mm:ss"):Ub.toISOString.apply(this,arguments)},Tb.isWithin=function(a,b){var c=L([this,a,b]);return c[0]>=c[1]&&c[0]<c[2]},Tb.isSame=function(a,b){var c;return this._fullCalendar?b?(c=L([this,a],!0),Ub.isSame.call(c[0],c[1],b)):(a=Jb.moment.parseZone(a),Ub.isSame.call(this,a)&&Boolean(this._ambigTime)===Boolean(a._ambigTime)&&Boolean(this._ambigZone)===Boolean(a._ambigZone)):Ub.isSame.apply(this,arguments)},a.each(["isBefore","isAfter"],function(a,b){Tb[b]=function(a,c){var d;return this._fullCalendar?(d=L([this,a]),Ub[b].call(d[0],d[1],c)):Ub[b].apply(this,arguments)}}),Ob="_d"in b()&&"updateOffset"in b,Pb=Ob?function(a,c){a._d.setTime(Date.UTC.apply(Date,c)),b.updateOffset(a,!1)}:N,Qb=Ob?function(a,c){a._d.setTime(+new Date(c[0]||0,c[1]||0,c[2]||0,c[3]||0,c[4]||0,c[5]||0,c[6]||0)),b.updateOffset(a,!1)}:N;var Vb={t:function(a){return O(a,"a").charAt(0)},T:function(a){return O(a,"A").charAt(0)}};Jb.formatRange=S;var Wb={Y:"year",M:"month",D:"day",d:"day",A:"second",a:"second",T:"second",t:"second",H:"second",h:"second",m:"second",s:"second"},Xb={};X.prototype={isHidden:!0,options:null,el:null,documentMousedownProxy:null,margin:10,show:function(){this.isHidden&&(this.el||this.render(),this.el.show(),this.position(),this.isHidden=!1,this.trigger("show"))},hide:function(){this.isHidden||(this.el.hide(),this.isHidden=!0,this.trigger("hide"))},render:function(){var b=this,c=this.options;this.el=a('<div class="fc-popover"/>').addClass(c.className||"").css({top:0,left:0}).append(c.content).appendTo(c.parentEl),this.el.on("click",".fc-close",function(){b.hide()}),c.autoHide&&a(document).on("mousedown",this.documentMousedownProxy=a.proxy(this,"documentMousedown"))},documentMousedown:function(b){this.el&&!a(b.target).closest(this.el).length&&this.hide()},destroy:function(){this.hide(),this.el&&(this.el.remove(),this.el=null),a(document).off("mousedown",this.documentMousedownProxy)},position:function(){var b,c,d,e,f,g=this.options,h=this.el.offsetParent().offset(),i=this.el.outerWidth(),j=this.el.outerHeight(),k=a(window),l=u(this.el);e=g.top||0,f=void 0!==g.left?g.left:void 0!==g.right?g.right-i:0,l.is(window)||l.is(document)?(l=k,b=0,c=0):(d=l.offset(),b=d.top,c=d.left),b+=k.scrollTop(),c+=k.scrollLeft(),g.viewportConstrain!==!1&&(e=Math.min(e,b+l.outerHeight()-j-this.margin),e=Math.max(e,b+this.margin),f=Math.min(f,c+l.outerWidth()-i-this.margin),f=Math.max(f,c+this.margin)),this.el.css({top:e-h.top,left:f-h.left})},trigger:function(a){this.options[a]&&this.options[a].apply(this,Array.prototype.slice.call(arguments,1))}},Y.prototype={grid:null,rows:null,cols:null,containerEl:null,minX:null,maxX:null,minY:null,maxY:null,build:function(){this.grid.buildCoords(this.rows=[],this.cols=[]),this.computeBounds()},getCell:function(a,b){var c,d=null,e=this.rows,f=this.cols,g=-1,h=-1;if(this.inBounds(a,b)){for(c=0;c<e.length;c++)if(b>=e[c][0]&&b<e[c][1]){g=c;break}for(c=0;c<f.length;c++)if(a>=f[c][0]&&a<f[c][1]){h=c;break}g>=0&&h>=0&&(d={row:g,col:h},d.grid=this.grid,d.date=this.grid.getCellDate(d))}return d},computeBounds:function(){var a;this.containerEl&&(a=this.containerEl.offset(),this.minX=a.left,this.maxX=a.left+this.containerEl.outerWidth(),this.minY=a.top,this.maxY=a.top+this.containerEl.outerHeight())},inBounds:function(a,b){return this.containerEl?a>=this.minX&&a<this.maxX&&b>=this.minY&&b<this.maxY:!0}},Z.prototype={coordMaps:null,build:function(){var a,b=this.coordMaps;for(a=0;a<b.length;a++)b[a].build()},getCell:function(a,b){var c,d=this.coordMaps,e=null;for(c=0;c<d.length&&!e;c++)e=d[c].getCell(a,b);return e}},$.prototype={coordMap:null,options:null,isListening:!1,isDragging:!1,origCell:null,origDate:null,cell:null,date:null,mouseX0:null,mouseY0:null,mousemoveProxy:null,mouseupProxy:null,scrollEl:null,scrollBounds:null,scrollTopVel:null,scrollLeftVel:null,scrollIntervalId:null,scrollHandlerProxy:null,scrollSensitivity:30,scrollSpeed:200,scrollIntervalMs:50,mousedown:function(a){w(a)&&(a.preventDefault(),this.startListening(a),this.options.distance||this.startDrag(a))},startListening:function(b){var c,d;this.isListening||(b&&this.options.scroll&&(c=u(a(b.target)),c.is(window)||c.is(document)||(this.scrollEl=c,this.scrollHandlerProxy=J(a.proxy(this,"scrollHandler"),100),this.scrollEl.on("scroll",this.scrollHandlerProxy))),this.computeCoords(),b&&(d=this.getCell(b),this.origCell=d,this.origDate=d?d.date:null,this.mouseX0=b.pageX,this.mouseY0=b.pageY),a(document).on("mousemove",this.mousemoveProxy=a.proxy(this,"mousemove")).on("mouseup",this.mouseupProxy=a.proxy(this,"mouseup")).on("selectstart",this.preventDefault),this.isListening=!0,this.trigger("listenStart",b))},computeCoords:function(){this.coordMap.build(),this.computeScrollBounds()},mousemove:function(a){var b,c;this.isDragging||(b=this.options.distance||1,c=Math.pow(a.pageX-this.mouseX0,2)+Math.pow(a.pageY-this.mouseY0,2),c>=b*b&&this.startDrag(a)),this.isDragging&&this.drag(a)},startDrag:function(a){var b;this.isListening||this.startListening(),this.isDragging||(this.isDragging=!0,this.trigger("dragStart",a),b=this.getCell(a),b&&this.cellOver(b,!0))},drag:function(a){var b;this.isDragging&&(b=this.getCell(a),_(b,this.cell)||(this.cell&&this.cellOut(),b&&this.cellOver(b)),this.dragScroll(a))},cellOver:function(a){this.cell=a,this.date=a.date,this.trigger("cellOver",a,a.date)},cellOut:function(){this.cell&&(this.trigger("cellOut",this.cell),this.cell=null,this.date=null)},mouseup:function(a){this.stopDrag(a),this.stopListening(a)},stopDrag:function(a){this.isDragging&&(this.stopScrolling(),this.trigger("dragStop",a),this.isDragging=!1)},stopListening:function(b){this.isListening&&(this.scrollEl&&(this.scrollEl.off("scroll",this.scrollHandlerProxy),this.scrollHandlerProxy=null),a(document).off("mousemove",this.mousemoveProxy).off("mouseup",this.mouseupProxy).off("selectstart",this.preventDefault),this.mousemoveProxy=null,this.mouseupProxy=null,this.isListening=!1,this.trigger("listenStop",b),this.origCell=this.cell=null,this.origDate=this.date=null)},getCell:function(a){return this.coordMap.getCell(a.pageX,a.pageY)},trigger:function(a){this.options[a]&&this.options[a].apply(this,Array.prototype.slice.call(arguments,1))},preventDefault:function(a){a.preventDefault()},computeScrollBounds:function(){var a,b=this.scrollEl;b&&(a=b.offset(),this.scrollBounds={top:a.top,left:a.left,bottom:a.top+b.outerHeight(),right:a.left+b.outerWidth()})},dragScroll:function(a){var b,c,d,e,f=this.scrollSensitivity,g=this.scrollBounds,h=0,i=0;g&&(b=(f-(a.pageY-g.top))/f,c=(f-(g.bottom-a.pageY))/f,d=(f-(a.pageX-g.left))/f,e=(f-(g.right-a.pageX))/f,b>=0&&1>=b?h=b*this.scrollSpeed*-1:c>=0&&1>=c&&(h=c*this.scrollSpeed),d>=0&&1>=d?i=d*this.scrollSpeed*-1:e>=0&&1>=e&&(i=e*this.scrollSpeed)),this.setScrollVel(h,i)},setScrollVel:function(b,c){this.scrollTopVel=b,this.scrollLeftVel=c,this.constrainScrollVel(),!this.scrollTopVel&&!this.scrollLeftVel||this.scrollIntervalId||(this.scrollIntervalId=setInterval(a.proxy(this,"scrollIntervalFunc"),this.scrollIntervalMs))},constrainScrollVel:function(){var a=this.scrollEl;this.scrollTopVel<0?a.scrollTop()<=0&&(this.scrollTopVel=0):this.scrollTopVel>0&&a.scrollTop()+a[0].clientHeight>=a[0].scrollHeight&&(this.scrollTopVel=0),this.scrollLeftVel<0?a.scrollLeft()<=0&&(this.scrollLeftVel=0):this.scrollLeftVel>0&&a.scrollLeft()+a[0].clientWidth>=a[0].scrollWidth&&(this.scrollLeftVel=0)},scrollIntervalFunc:function(){var a=this.scrollEl,b=this.scrollIntervalMs/1e3;this.scrollTopVel&&a.scrollTop(a.scrollTop()+this.scrollTopVel*b),this.scrollLeftVel&&a.scrollLeft(a.scrollLeft()+this.scrollLeftVel*b),this.constrainScrollVel(),this.scrollTopVel||this.scrollLeftVel||this.stopScrolling()},stopScrolling:function(){this.scrollIntervalId&&(clearInterval(this.scrollIntervalId),this.scrollIntervalId=null,this.computeCoords())},scrollHandler:function(){this.scrollIntervalId||this.computeCoords()}},ab.prototype={options:null,sourceEl:null,el:null,parentEl:null,top0:null,left0:null,mouseY0:null,mouseX0:null,topDelta:null,leftDelta:null,mousemoveProxy:null,isFollowing:!1,isHidden:!1,isAnimating:!1,start:function(b){this.isFollowing||(this.isFollowing=!0,this.mouseY0=b.pageY,this.mouseX0=b.pageX,this.topDelta=0,this.leftDelta=0,this.isHidden||this.updatePosition(),a(document).on("mousemove",this.mousemoveProxy=a.proxy(this,"mousemove")))},stop:function(b,c){function d(){this.isAnimating=!1,e.destroyEl(),this.top0=this.left0=null,c&&c()}var e=this,f=this.options.revertDuration;this.isFollowing&&!this.isAnimating&&(this.isFollowing=!1,a(document).off("mousemove",this.mousemoveProxy),b&&f&&!this.isHidden?(this.isAnimating=!0,this.el.animate({top:this.top0,left:this.left0},{duration:f,complete:d})):d())},getEl:function(){var a=this.el;return a||(this.sourceEl.width(),a=this.el=this.sourceEl.clone().css({position:"absolute",visibility:"",display:this.isHidden?"none":"",margin:0,right:"auto",bottom:"auto",width:this.sourceEl.width(),height:this.sourceEl.height(),opacity:this.options.opacity||"",zIndex:this.options.zIndex}).appendTo(this.parentEl)),a},destroyEl:function(){this.el&&(this.el.remove(),this.el=null)},updatePosition:function(){var a,b;this.getEl(),null===this.top0&&(this.sourceEl.width(),a=this.sourceEl.offset(),b=this.el.offsetParent().offset(),this.top0=a.top-b.top,this.left0=a.left-b.left),this.el.css({top:this.top0+this.topDelta,left:this.left0+this.leftDelta})},mousemove:function(a){this.topDelta=a.pageY-this.mouseY0,this.leftDelta=a.pageX-this.mouseX0,this.isHidden||this.updatePosition()},hide:function(){this.isHidden||(this.isHidden=!0,this.el&&this.el.hide())},show:function(){this.isHidden&&(this.isHidden=!1,this.updatePosition(),this.getEl().show())}},bb.prototype={view:null,cellHtml:"<td/>",rowHtml:function(a,b){var c,d,e=this.view,f=this.getHtmlRenderer("cell",a),g="";for(b=b||0,c=0;c<e.colCnt;c++)d=e.cellToDate(b,c),g+=f(b,c,d);return g=this.bookendCells(g,a,b),"<tr>"+g+"</tr>"},bookendCells:function(a,b,c){var d=this.view,e=this.getHtmlRenderer("intro",b)(c||0),f=this.getHtmlRenderer("outro",b)(c||0),g=d.opt("isRTL"),h=g?f:e,i=g?e:f;return"string"==typeof a?h+a+i:a.prepend(h).append(i)},getHtmlRenderer:function(a,b){var c,d,e,f,g=this.view;return c=a+"Html",b&&(d=b+I(a)+"Html"),d&&(f=g[d])?e=g:d&&(f=this[d])?e=this:(f=g[c])?e=g:(f=this[c])&&(e=this),"function"==typeof f?function(){return f.apply(e,arguments)||""}:function(){return f||""}}},cb.prototype=D(bb.prototype),a.extend(cb.prototype,{el:null,coordMap:null,cellDuration:null,elsByFill:null,render:function(){this.bindHandlers()},destroy:function(){},buildCoords:function(){},getCellDate:function(){},getCellDayEl:function(){},rangeToSegs:function(){},bindHandlers:function(){var b=this;this.el.on("mousedown",function(c){a(c.target).is(".fc-event-container *, .fc-more")||a(c.target).closest(".fc-popover").length||b.dayMousedown(c)}),this.bindSegHandlers()},dayMousedown:function(a){var b,c,d,e=this,f=this.view,g=f.calendar,h=f.opt("selectable"),i=null,j=new $(this.coordMap,{scroll:f.opt("dragScroll"),dragStart:function(){f.unselect()},cellOver:function(a,f){j.origDate&&(d=e.getCellDayEl(a),i=[f,j.origDate].sort(B),b=i[0],c=i[1].clone().add(e.cellDuration),h&&(g.isSelectionAllowedInRange(b,c)?e.renderSelection(b,c):(i=null,n())))},cellOut:function(){i=null,e.destroySelection(),o()},listenStop:function(a){i&&(i[0].isSame(i[1])&&f.trigger("dayClick",d[0],b,a),h&&f.reportSelection(b,c,a)),o()}});j.mousedown(a)},renderDrag:function(){},destroyDrag:function(){},renderResize:function(){},destroyResize:function(){},renderRangeHelper:function(a,b,c){var d,e=this.view;!b&&e.opt("forceEventDuration")&&(b=e.calendar.getDefaultEventEnd(!a.hasTime(),a)),d=c?D(c.event):{},d.start=a,d.end=b,d.allDay=!(a.hasTime()||b&&b.hasTime()),d.className=(d.className||[]).concat("fc-helper"),c||(d.editable=!1),this.renderHelper(d,c)},renderHelper:function(){},destroyHelper:function(){},renderSelection:function(a,b){this.renderHighlight(a,b)},destroySelection:function(){this.destroyHighlight()},renderHighlight:function(a,b){this.renderFill("highlight",this.rangeToSegs(a,b))},destroyHighlight:function(){this.destroyFill("highlight")},highlightSegClasses:function(){return["fc-highlight"]},renderFill:function(){},destroyFill:function(a){var b=this.elsByFill[a];b&&(b.remove(),delete this.elsByFill[a])},renderFillSegEls:function(b,c){var d,e=this,f=this[b+"SegEl"],g="",h=[];if(c.length){for(d=0;d<c.length;d++)g+=this.fillSegHtml(b,c[d]);a(g).each(function(b,d){var g=c[b],i=a(d);f&&(i=f.call(e,g,i)),i&&(i=a(i),i.is(e.fillSegTag)&&(g.el=i,h.push(g)))})}return h},fillSegTag:"div",fillSegHtml:function(a,b){var c=this[a+"SegClasses"],d=this[a+"SegStyles"],e=c?c.call(this,b):[],f=d?d.call(this,b):"";return"<"+this.fillSegTag+(e.length?' class="'+e.join(" ")+'"':"")+(f?' style="'+f+'"':"")+" />"},headHtml:function(){return'<div class="fc-row '+this.view.widgetHeaderClass+'"><table><thead>'+this.rowHtml("head")+"</thead></table></div>"},headCellHtml:function(a,b,c){var d=this.view,e=d.calendar,f=d.opt("columnFormat");return'<th class="fc-day-header '+d.widgetHeaderClass+" fc-"+Nb[c.day()]+'">'+G(e.formatDate(c,f))+"</th>"},bgCellHtml:function(a,b,c){var d=this.view,e=this.getDayClasses(c);return e.unshift("fc-day",d.widgetContentClass),'<td class="'+e.join(" ")+'" data-date="'+c.format()+'"></td>'},getDayClasses:function(a){var b=this.view,c=b.calendar.getNow().stripTime(),d=["fc-"+Nb[a.day()]];return"month"===b.name&&a.month()!=b.intervalStart.month()&&d.push("fc-other-month"),a.isSame(c,"day")?d.push("fc-today",b.highlightStateClass):d.push(c>a?"fc-past":"fc-future"),d}}),a.extend(cb.prototype,{mousedOverSeg:null,isDraggingSeg:!1,isResizingSeg:!1,segs:null,renderEvents:function(a){var b,c,d=this.eventsToSegs(a),e=[],f=[];for(b=0;b<d.length;b++)c=d[b],db(c.event)?e.push(c):f.push(c);e=this.renderBgSegs(e)||e,f=this.renderFgSegs(f)||f,this.segs=e.concat(f)},destroyEvents:function(){this.triggerSegMouseout(),this.destroyFgSegs(),this.destroyBgSegs(),this.segs=null},getSegs:function(){return this.segs||[]},renderFgSegs:function(){},destroyFgSegs:function(){},renderFgSegEls:function(b,c){var d,e=this.view,f="",g=[];if(b.length){for(d=0;d<b.length;d++)f+=this.fgSegHtml(b[d],c);a(f).each(function(c,d){var f=b[c],h=e.resolveEventEl(f.event,a(d));h&&(h.data("fc-seg",f),f.el=h,g.push(f))})}return g},fgSegHtml:function(){},renderBgSegs:function(a){return this.renderFill("bgEvent",a)},destroyBgSegs:function(){this.destroyFill("bgEvent")},bgEventSegEl:function(a,b){return this.view.resolveEventEl(a.event,b)},bgEventSegClasses:function(a){var b=a.event,c=b.source||{};return["fc-bgevent"].concat(b.className,c.className||[])},bgEventSegStyles:function(a){var b=this.view,c=a.event,d=c.source||{},e=c.color,f=d.color,g=b.opt("eventColor"),h=c.backgroundColor||e||d.backgroundColor||f||b.opt("eventBackgroundColor")||g;return h?"background-color:"+h:""},businessHoursSegClasses:function(){return["fc-nonbusiness","fc-bgevent"]},bindSegHandlers:function(){var b=this,c=this.view;a.each({mouseenter:function(a,c){b.triggerSegMouseover(a,c)},mouseleave:function(a,c){b.triggerSegMouseout(a,c)},click:function(a,b){return c.trigger("eventClick",this,a.event,b)},mousedown:function(d,e){a(e.target).is(".fc-resizer")&&c.isEventResizable(d.event)?b.segResizeMousedown(d,e):c.isEventDraggable(d.event)&&b.segDragMousedown(d,e)}},function(c,d){b.el.on(c,".fc-event-container > *",function(c){var e=a(this).data("fc-seg");return!e||b.isDraggingSeg||b.isResizingSeg?void 0:d.call(this,e,c)})})},triggerSegMouseover:function(a,b){this.mousedOverSeg||(this.mousedOverSeg=a,this.view.trigger("eventMouseover",a.el[0],a.event,b))},triggerSegMouseout:function(a,b){b=b||{},this.mousedOverSeg&&(a=a||this.mousedOverSeg,this.mousedOverSeg=null,this.view.trigger("eventMouseout",a.el[0],a.event,b))},segDragMousedown:function(a,b){var c,d,e=this,f=this.view,g=f.calendar,h=a.el,i=a.event,j=new ab(a.el,{parentEl:f.el,opacity:f.opt("dragOpacity"),revertDuration:f.opt("dragRevertDuration"),zIndex:2}),k=new $(f.coordMap,{distance:5,scroll:f.opt("dragScroll"),listenStart:function(a){j.hide(),j.start(a)},dragStart:function(b){e.triggerSegMouseout(a,b),e.isDraggingSeg=!0,f.hideEvent(i),f.trigger("eventDragStart",h[0],i,b,{})},cellOver:function(b,h){var l=a.cellDate||k.origDate,m=e.computeDraggedEventDates(a,l,h);c=m.start,d=m.end,g.isEventAllowedInRange(i,c,m.visibleEnd)?f.renderDrag(c,d,a)?j.hide():j.show():(c=null,j.show(),n())},cellOut:function(){c=null,f.destroyDrag(),j.show(),o()},dragStop:function(a){var b=c&&!c.isSame(i.start);j.stop(!b,function(){e.isDraggingSeg=!1,f.destroyDrag(),f.showEvent(i),f.trigger("eventDragStop",h[0],i,a,{}),b&&f.eventDrop(h[0],i,c,a)}),o()},listenStop:function(){j.stop()}});k.mousedown(b)},computeDraggedEventDates:function(a,b,c){var d,e,f,g,h,i=this.view,j=a.event,k=j.start,l=i.calendar.getEventEnd(j);return c.hasTime()===b.hasTime()?(d=z(c,b),e=k.clone().add(d),f=null===j.end?null:l.clone().add(d),g=j.allDay):(e=c,f=null,g=!c.hasTime()),h=f||i.calendar.getDefaultEventEnd(g,e),{start:e,end:f,visibleEnd:h}},segResizeMousedown:function(a,b){function c(){e.destroyResize(),f.showEvent(i)}var d,e=this,f=this.view,g=f.calendar,h=a.el,i=a.event,j=i.start,k=f.calendar.getEventEnd(i),l=null;d=new $(this.coordMap,{distance:5,scroll:f.opt("dragScroll"),dragStart:function(b){e.triggerSegMouseout(a,b),e.isResizingSeg=!0,f.trigger("eventResizeStart",h[0],i,b,{})},cellOver:function(b,d){d.isBefore(j)&&(d=j),l=d.clone().add(e.cellDuration),g.isEventAllowedInRange(i,j,l)?l.isSame(k)?(l=null,c()):(e.renderResize(j,l,a),f.hideEvent(i)):(l=null,c(),n())},cellOut:function(){l=null,c(),o()},dragStop:function(a){e.isResizingSeg=!1,c(),o(),f.trigger("eventResizeStop",h[0],i,a,{}),l&&f.eventResize(h[0],i,l,a)}}),d.mousedown(b)},getSegClasses:function(a,b,c){var d=a.event,e=["fc-event",a.isStart?"fc-start":"fc-not-start",a.isEnd?"fc-end":"fc-not-end"].concat(d.className,d.source?d.source.className:[]);return b&&e.push("fc-draggable"),c&&e.push("fc-resizable"),e},getEventSkinCss:function(a){var b=this.view,c=a.source||{},d=a.color,e=c.color,f=b.opt("eventColor"),g=a.backgroundColor||d||c.backgroundColor||e||b.opt("eventBackgroundColor")||f,h=a.borderColor||d||c.borderColor||e||b.opt("eventBorderColor")||f,i=a.textColor||c.textColor||b.opt("eventTextColor"),j=[];return g&&j.push("background-color:"+g),h&&j.push("border-color:"+h),i&&j.push("color:"+i),j.join(";")},eventsToSegs:function(a,b){var c,d=this.eventsToRanges(a),e=[];for(c=0;c<d.length;c++)e.push.apply(e,this.eventRangeToSegs(d[c],b));return e},eventsToRanges:function(b){var c=this,d=gb(b),e=[];return a.each(d,function(a,b){b.length&&e.push.apply(e,eb(b[0])?c.eventsToInverseRanges(b):c.eventsToNormalRanges(b))}),e},eventsToNormalRanges:function(a){var b,c,d,e,f=this.view.calendar,g=[];for(b=0;b<a.length;b++)c=a[b],d=c.start.clone().stripZone(),e=f.getEventEnd(c).stripZone(),g.push({event:c,start:d,end:e,eventStartMS:+d,eventDurationMS:e-d});return g},eventsToInverseRanges:function(a){var b,c,d=this.view,e=d.start.clone().stripZone(),f=d.end.clone().stripZone(),g=this.eventsToNormalRanges(a),h=[],i=a[0],j=e;for(g.sort(hb),b=0;b<g.length;b++)c=g[b],c.start>j&&h.push({event:i,start:j,end:c.start}),j=c.end;return f>j&&h.push({event:i,start:j,end:f}),h},eventRangeToSegs:function(a,b){var c,d,e;for(c=b?b(a.start,a.end):this.rangeToSegs(a.start,a.end),d=0;d<c.length;d++)e=c[d],e.event=a.event,e.eventStartMS=a.eventStartMS,e.eventDurationMS=a.eventDurationMS;return c}}),jb.prototype=D(cb.prototype),a.extend(jb.prototype,{numbersVisible:!1,cellDuration:b.duration({days:1}),bottomCoordPadding:0,rowEls:null,dayEls:null,helperEls:null,render:function(b){var c,d=this.view,e="";for(c=0;c<d.rowCnt;c++)e+=this.dayRowHtml(c,b);this.el.html(e),this.rowEls=this.el.find(".fc-row"),this.dayEls=this.el.find(".fc-day"),this.dayEls.each(function(b,c){var e=d.cellToDate(Math.floor(b/d.colCnt),b%d.colCnt);d.trigger("dayRender",null,e,a(c))}),cb.prototype.render.call(this)},destroy:function(){this.destroySegPopover()},dayRowHtml:function(a,b){var c=this.view,d=["fc-row","fc-week",c.widgetContentClass];return b&&d.push("fc-rigid"),'<div class="'+d.join(" ")+'"><div class="fc-bg"><table>'+this.rowHtml("day",a)+'</table></div><div class="fc-content-skeleton"><table>'+(this.numbersVisible?"<thead>"+this.rowHtml("number",a)+"</thead>":"")+"</table></div></div>"},dayCellHtml:function(a,b,c){return this.bgCellHtml(a,b,c)},buildCoords:function(b,c){var d,e,f,g=this.view.colCnt;this.dayEls.slice(0,g).each(function(b,g){d=a(g),e=d.offset().left,b&&(f[1]=e),f=[e],c[b]=f}),f[1]=e+d.outerWidth(),this.rowEls.each(function(c,g){d=a(g),e=d.offset().top,c&&(f[1]=e),f=[e],b[c]=f}),f[1]=e+d.outerHeight()+this.bottomCoordPadding},getCellDate:function(a){return this.view.cellToDate(a)},getCellDayEl:function(a){return this.dayEls.eq(a.row*this.view.colCnt+a.col)},rangeToSegs:function(a,b){return this.view.rangeToSegments(a,b)},renderDrag:function(a,b,c){var d;return this.renderHighlight(a,b||this.view.calendar.getDefaultEventEnd(!0,a)),c&&!c.el.closest(this.el).length?(this.renderRangeHelper(a,b,c),d=this.view.opt("dragOpacity"),void 0!==d&&this.helperEls.css("opacity",d),!0):void 0},destroyDrag:function(){this.destroyHighlight(),this.destroyHelper()},renderResize:function(a,b,c){this.renderHighlight(a,b),this.renderRangeHelper(a,b,c)},destroyResize:function(){this.destroyHighlight(),this.destroyHelper()},renderHelper:function(b,c){var d,e=[],f=this.eventsToSegs([b]);f=this.renderFgSegEls(f),d=this.renderSegRows(f),this.rowEls.each(function(b,f){var g,h=a(f),i=a('<div class="fc-helper-skeleton"><table/></div>');g=c&&c.row===b?c.el.position().top:h.find(".fc-content-skeleton tbody").position().top,i.css("top",g).find("table").append(d[b].tbodyEl),h.append(i),e.push(i[0])}),this.helperEls=a(e)},destroyHelper:function(){this.helperEls&&(this.helperEls.remove(),this.helperEls=null)},fillSegTag:"td",renderFill:function(b,c){var d,e,f,g=[];for(c=this.renderFillSegEls(b,c),d=0;d<c.length;d++)e=c[d],f=this.renderFillRow(b,e),this.rowEls.eq(e.row).append(f),g.push(f[0]);return this.elsByFill[b]=a(g),c},renderFillRow:function(b,c){var d,e,f=this.view.colCnt,g=c.leftCol,h=c.rightCol+1;return d=a('<div class="fc-'+b.toLowerCase()+'-skeleton"><table><tr/></table></div>'),e=d.find("tr"),g>0&&e.append('<td colspan="'+g+'"/>'),e.append(c.el.attr("colspan",h-g)),f>h&&e.append('<td colspan="'+(f-h)+'"/>'),this.bookendCells(e,b),d}}),a.extend(jb.prototype,{rowStructs:null,destroyEvents:function(){this.destroySegPopover(),cb.prototype.destroyEvents.apply(this,arguments)},getSegs:function(){return cb.prototype.getSegs.call(this).concat(this.popoverSegs||[])},renderBgSegs:function(b){var c=a.grep(b,function(a){return a.event.allDay});return cb.prototype.renderBgSegs.call(this,c)},renderFgSegs:function(b){var c;return b=this.renderFgSegEls(b),c=this.rowStructs=this.renderSegRows(b),this.rowEls.each(function(b,d){a(d).find(".fc-content-skeleton > table").append(c[b].tbodyEl)}),b},destroyFgSegs:function(){for(var a,b=this.rowStructs||[];a=b.pop();)a.tbodyEl.remove();this.rowStructs=null},renderSegRows:function(a){var b,c,d=[];for(b=this.groupSegRows(a),c=0;c<b.length;c++)d.push(this.renderSegRow(c,b[c]));return d},fgSegHtml:function(a,b){var c,d=this.view,e=d.opt("isRTL"),f=a.event,g=d.isEventDraggable(f),h=!b&&f.allDay&&a.isEnd&&d.isEventResizable(f),i=this.getSegClasses(a,g,h),j=this.getEventSkinCss(f),k="";return i.unshift("fc-day-grid-event"),!f.allDay&&a.isStart&&(k='<span class="fc-time">'+G(d.getEventTimeText(f))+"</span>"),c='<span class="fc-title">'+(G(f.title||"")||"&nbsp;")+"</span>",'<a class="'+i.join(" ")+'"'+(f.url?' href="'+G(f.url)+'"':"")+(j?' style="'+j+'"':"")+'><div class="fc-content">'+(e?c+" "+k:k+" "+c)+"</div>"+(h?'<div class="fc-resizer"/>':"")+"</a>"},renderSegRow:function(b,c){function d(b){for(;b>g;)k=(s[e-1]||[])[g],k?k.attr("rowspan",parseInt(k.attr("rowspan")||1,10)+1):(k=a("<td/>"),h.append(k)),r[e][g]=k,s[e][g]=k,g++}var e,f,g,h,i,j,k,l=this.view,m=l.colCnt,n=this.buildSegLevels(c),o=Math.max(1,n.length),p=a("<tbody/>"),q=[],r=[],s=[];for(e=0;o>e;e++){if(f=n[e],g=0,h=a("<tr/>"),q.push([]),r.push([]),s.push([]),f)for(i=0;i<f.length;i++){for(j=f[i],d(j.leftCol),k=a('<td class="fc-event-container"/>').append(j.el),j.leftCol!=j.rightCol?k.attr("colspan",j.rightCol-j.leftCol+1):s[e][g]=k;g<=j.rightCol;)r[e][g]=k,q[e][g]=j,g++;h.append(k)}d(m),this.bookendCells(h,"eventSkeleton"),p.append(h)}return{row:b,tbodyEl:p,cellMatrix:r,segMatrix:q,segLevels:n,segs:c}},buildSegLevels:function(a){var b,c,d,e=[];for(a.sort(ib),b=0;b<a.length;b++){for(c=a[b],d=0;d<e.length&&kb(c,e[d]);d++);c.level=d,(e[d]||(e[d]=[])).push(c)}for(d=0;d<e.length;d++)e[d].sort(lb);return e},groupSegRows:function(a){var b,c=this.view,d=[];for(b=0;b<c.rowCnt;b++)d.push([]);for(b=0;b<a.length;b++)d[a[b].row].push(a[b]);return d}}),a.extend(jb.prototype,{segPopover:null,popoverSegs:null,destroySegPopover:function(){this.segPopover&&this.segPopover.hide()},limitRows:function(a){var b,c,d=this.rowStructs||[];for(b=0;b<d.length;b++)this.unlimitRow(b),c=a?"number"==typeof a?a:this.computeRowLevelLimit(b):!1,c!==!1&&this.limitRow(b,c)},computeRowLevelLimit:function(a){var b,c,d=this.rowEls.eq(a),e=d.height(),f=this.rowStructs[a].tbodyEl.children();for(b=0;b<f.length;b++)if(c=f.eq(b).removeClass("fc-limited"),c.position().top+c.outerHeight()>e)return b;return!1},limitRow:function(b,c){function d(d){for(;d>y;)e={row:b,col:y},k=u.getCellSegs(e,c),k.length&&(n=g[c-1][y],t=u.renderMoreLink(e,k),s=a("<div/>").append(t),n.append(s),x.push(s[0])),y++}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this,v=this.view,w=this.rowStructs[b],x=[],y=0;if(c&&c<w.segLevels.length){for(f=w.segLevels[c-1],g=w.cellMatrix,h=w.tbodyEl.children().slice(c).addClass("fc-limited").get(),i=0;i<f.length;i++){for(j=f[i],d(j.leftCol),m=[],l=0;y<=j.rightCol;)e={row:b,col:y},k=this.getCellSegs(e,c),m.push(k),l+=k.length,y++;if(l){for(n=g[c-1][j.leftCol],o=n.attr("rowspan")||1,p=[],q=0;q<m.length;q++)r=a('<td class="fc-more-cell"/>').attr("rowspan",o),k=m[q],e={row:b,col:j.leftCol+q},t=this.renderMoreLink(e,[j].concat(k)),s=a("<div/>").append(t),r.append(s),p.push(r[0]),x.push(r[0]);n.addClass("fc-limited").after(a(p)),h.push(n[0])}}d(v.colCnt),w.moreEls=a(x),w.limitedEls=a(h)}},unlimitRow:function(a){var b=this.rowStructs[a];b.moreEls&&(b.moreEls.remove(),b.moreEls=null),b.limitedEls&&(b.limitedEls.removeClass("fc-limited"),b.limitedEls=null)},renderMoreLink:function(b,c){var d=this,e=this.view;return a('<a class="fc-more"/>').text(this.getMoreLinkText(c.length)).on("click",function(f){var g=e.opt("eventLimitClick"),h=e.cellToDate(b),i=a(this),j=d.getCellDayEl(b),k=d.getCellSegs(b),l=d.resliceDaySegs(k,h),m=d.resliceDaySegs(c,h);"function"==typeof g&&(g=e.trigger("eventLimitClick",null,{date:h,dayEl:j,moreEl:i,segs:l,hiddenSegs:m},f)),"popover"===g?d.showSegPopover(h,b,i,l):"string"==typeof g&&e.calendar.zoomTo(h,g)
})},showSegPopover:function(a,b,c,d){var e,f,g=this,h=this.view,i=c.parent();e=1==h.rowCnt?this.view.el:this.rowEls.eq(b.row),f={className:"fc-more-popover",content:this.renderSegPopoverContent(a,d),parentEl:this.el,top:e.offset().top,autoHide:!0,viewportConstrain:h.opt("popoverViewportConstrain"),hide:function(){g.segPopover.destroy(),g.segPopover=null,g.popoverSegs=null}},h.opt("isRTL")?f.right=i.offset().left+i.outerWidth()+1:f.left=i.offset().left-1,this.segPopover=new X(f),this.segPopover.show()},renderSegPopoverContent:function(b,c){var d,e=this.view,f=e.opt("theme"),g=b.format(e.opt("dayPopoverFormat")),h=a('<div class="fc-header '+e.widgetHeaderClass+'"><span class="fc-close '+(f?"ui-icon ui-icon-closethick":"fc-icon fc-icon-x")+'"></span><span class="fc-title">'+G(g)+'</span><div class="fc-clear"/></div><div class="fc-body '+e.widgetContentClass+'"><div class="fc-event-container"></div></div>'),i=h.find(".fc-event-container");for(c=this.renderFgSegEls(c,!0),this.popoverSegs=c,d=0;d<c.length;d++)c[d].cellDate=b,i.append(c[d].el);return h},resliceDaySegs:function(b,c){var d=a.map(b,function(a){return a.event}),e=c.clone().stripTime(),f=e.clone().add(1,"days");return this.eventsToSegs(d,function(a,b){var c=x(a,b,e,f);return c?[c]:[]})},getMoreLinkText:function(a){var b=this.view,c=b.opt("eventLimitText");return"function"==typeof c?c(a):"+"+a+" "+c},getCellSegs:function(a,b){for(var c,d=this.rowStructs[a.row].segMatrix,e=b||0,f=[];e<d.length;)c=d[e][a.col],c&&f.push(c),e++;return f}}),mb.prototype=D(cb.prototype),a.extend(mb.prototype,{slotDuration:null,snapDuration:null,minTime:null,maxTime:null,dayEls:null,slatEls:null,slatTops:null,helperEl:null,businessHourSegs:null,render:function(){this.processOptions(),this.el.html(this.renderHtml()),this.dayEls=this.el.find(".fc-day"),this.slatEls=this.el.find(".fc-slats tr"),this.computeSlatTops(),this.renderBusinessHours(),cb.prototype.render.call(this)},renderBusinessHours:function(){var a=this.view.calendar.getBusinessHoursEvents();this.businessHourSegs=this.renderFill("businessHours",this.eventsToSegs(a),"bgevent")},renderHtml:function(){return'<div class="fc-bg"><table>'+this.rowHtml("slotBg")+'</table></div><div class="fc-slats"><table>'+this.slatRowHtml()+"</table></div>"},slotBgCellHtml:function(a,b,c){return this.bgCellHtml(a,b,c)},slatRowHtml:function(){for(var a,c,d,e=this.view,f=e.calendar,g=e.opt("isRTL"),h="",i=this.slotDuration.asMinutes()%15===0,j=b.duration(+this.minTime);j<this.maxTime;)a=e.start.clone().time(j),c=a.minutes(),d='<td class="fc-axis fc-time '+e.widgetContentClass+'" '+e.axisStyleAttr()+">"+(i&&c?"":"<span>"+G(f.formatDate(a,e.opt("axisFormat")))+"</span>")+"</td>",h+="<tr "+(c?'class="fc-minor"':"")+">"+(g?"":d)+'<td class="'+e.widgetContentClass+'"/>'+(g?d:"")+"</tr>",j.add(this.slotDuration);return h},processOptions:function(){var a=this.view,c=a.opt("slotDuration"),d=a.opt("snapDuration");c=b.duration(c),d=d?b.duration(d):c,this.slotDuration=c,this.snapDuration=d,this.cellDuration=d,this.minTime=b.duration(a.opt("minTime")),this.maxTime=b.duration(a.opt("maxTime"))},rangeToSegs:function(a,b){var c,d,e,f,g,h=this.view,i=[];for(a=a.clone().stripZone(),b=b.clone().stripZone(),d=0;d<h.colCnt;d++)e=h.cellToDate(0,d),f=e.clone().time(this.minTime),g=e.clone().time(this.maxTime),c=x(a,b,f,g),c&&(c.col=d,i.push(c));return i},resize:function(){this.computeSlatTops(),this.updateSegVerticals()},buildCoords:function(c,d){var e,f,g=this.view.colCnt,h=this.el.offset().top,i=b.duration(+this.minTime),j=null;for(this.dayEls.slice(0,g).each(function(b,c){e=a(c),f=e.offset().left,j&&(j[1]=f),j=[f],d[b]=j}),j[1]=f+e.outerWidth(),j=null;i<this.maxTime;)f=h+this.computeTimeTop(i),j&&(j[1]=f),j=[f],c.push(j),i.add(this.snapDuration);j[1]=h+this.computeTimeTop(i)},getCellDate:function(a){var b=this.view,c=b.calendar;return c.rezoneDate(b.cellToDate(0,a.col).time(this.minTime+this.snapDuration*a.row))},getCellDayEl:function(a){return this.dayEls.eq(a.col)},computeDateTop:function(a,c){return this.computeTimeTop(b.duration(a.clone().stripZone()-c.clone().stripTime()))},computeTimeTop:function(a){var b,c,d,e,f=(a-this.minTime)/this.slotDuration;return f=Math.max(0,f),f=Math.min(this.slatEls.length,f),b=Math.floor(f),c=f-b,d=this.slatTops[b],c?(e=this.slatTops[b+1],d+(e-d)*c):d},computeSlatTops:function(){var b,c=[];this.slatEls.each(function(d,e){b=a(e).position().top,c.push(b)}),c.push(b+this.slatEls.last().outerHeight()),this.slatTops=c},renderDrag:function(a,b,c){var d;return c?(this.renderRangeHelper(a,b,c),d=this.view.opt("dragOpacity"),void 0!==d&&this.helperEl.css("opacity",d),!0):void this.renderHighlight(a,b||this.view.calendar.getDefaultEventEnd(!1,a))},destroyDrag:function(){this.destroyHelper(),this.destroyHighlight()},renderResize:function(a,b,c){this.renderRangeHelper(a,b,c)},destroyResize:function(){this.destroyHelper()},renderHelper:function(b,c){var d,e,f,g,h=this.eventsToSegs([b]);for(h=this.renderFgSegEls(h),d=this.renderSegTable(h),e=0;e<h.length;e++)f=h[e],c&&c.col===f.col&&(g=c.el,f.el.css({left:g.css("left"),right:g.css("right"),"margin-left":g.css("margin-left"),"margin-right":g.css("margin-right")}));this.helperEl=a('<div class="fc-helper-skeleton"/>').append(d).appendTo(this.el)},destroyHelper:function(){this.helperEl&&(this.helperEl.remove(),this.helperEl=null)},renderSelection:function(a,b){this.view.opt("selectHelper")?this.renderRangeHelper(a,b):this.renderHighlight(a,b)},destroySelection:function(){this.destroyHelper(),this.destroyHighlight()},renderFill:function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o=this.view;if(c.length){for(c=this.renderFillSegEls(b,c),e=this.groupSegCols(c),d=d||b.toLowerCase(),f=a('<div class="fc-'+d+'-skeleton"><table><tr/></table></div>'),g=f.find("tr"),h=0;h<e.length;h++)if(i=e[h],j=a("<td/>").appendTo(g),i.length)for(k=a('<div class="fc-'+d+'-container"/>').appendTo(j),l=o.cellToDate(0,h),m=0;m<i.length;m++)n=i[m],k.append(n.el.css({top:this.computeDateTop(n.start,l),bottom:-this.computeDateTop(n.end,l)}));this.bookendCells(g,b),this.el.append(f),this.elsByFill[b]=f}return c}}),a.extend(mb.prototype,{eventSkeletonEl:null,renderFgSegs:function(b){return b=this.renderFgSegEls(b),this.el.append(this.eventSkeletonEl=a('<div class="fc-content-skeleton"/>').append(this.renderSegTable(b))),b},destroyFgSegs:function(){this.eventSkeletonEl&&(this.eventSkeletonEl.remove(),this.eventSkeletonEl=null)},renderSegTable:function(b){var c,d,e,f,g,h,i=a("<table><tr/></table>"),j=i.find("tr");for(c=this.groupSegCols(b),this.computeSegVerticals(b),f=0;f<c.length;f++){for(g=c[f],nb(g),h=a('<div class="fc-event-container"/>'),d=0;d<g.length;d++)e=g[d],e.el.css(this.generateSegPositionCss(e)),e.bottom-e.top<30&&e.el.addClass("fc-short"),h.append(e.el);j.append(a("<td/>").append(h))}return this.bookendCells(j,"eventSkeleton"),i},updateSegVerticals:function(){var a,b=(this.segs||[]).concat(this.businessHourSegs||[]);for(this.computeSegVerticals(b),a=0;a<b.length;a++)b[a].el.css(this.generateSegVerticalCss(b[a]))},computeSegVerticals:function(a){var b,c;for(b=0;b<a.length;b++)c=a[b],c.top=this.computeDateTop(c.start,c.start),c.bottom=this.computeDateTop(c.end,c.start)},fgSegHtml:function(a,b){var c,d,e,f=this.view,g=a.event,h=f.isEventDraggable(g),i=!b&&a.isEnd&&f.isEventResizable(g),j=this.getSegClasses(a,h,i),k=this.getEventSkinCss(g);return j.unshift("fc-time-grid-event"),f.isMultiDayEvent(g)?(a.isStart||a.isEnd)&&(c=f.getEventTimeText(a.start,a.end),d=f.getEventTimeText(a.start,a.end,"LT"),e=f.getEventTimeText(a.start,null)):(c=f.getEventTimeText(g),d=f.getEventTimeText(g,"LT"),e=f.getEventTimeText(g.start,null)),'<a class="'+j.join(" ")+'"'+(g.url?' href="'+G(g.url)+'"':"")+(k?' style="'+k+'"':"")+'><div class="fc-content">'+(c?'<div class="fc-time" data-start="'+G(e)+'" data-full="'+G(d)+'"><span>'+G(c)+"</span></div>":"")+(g.title?'<div class="fc-title">'+G(g.title)+"</div>":"")+'</div><div class="fc-bg"/>'+(i?'<div class="fc-resizer"/>':"")+"</a>"},generateSegPositionCss:function(a){var b,c,d=this.view,e=d.opt("isRTL"),f=d.opt("slotEventOverlap"),g=a.backwardCoord,h=a.forwardCoord,i=this.generateSegVerticalCss(a);return f&&(h=Math.min(1,g+2*(h-g))),e?(b=1-h,c=g):(b=g,c=1-h),i.zIndex=a.level+1,i.left=100*b+"%",i.right=100*c+"%",f&&a.forwardPressure&&(i[e?"marginLeft":"marginRight"]=20),i},generateSegVerticalCss:function(a){return{top:a.top,bottom:-a.bottom}},groupSegCols:function(a){var b,c=this.view,d=[];for(b=0;b<c.colCnt;b++)d.push([]);for(b=0;b<a.length;b++)d[a[b].col].push(a[b]);return d}}),vb.prototype={calendar:null,coordMap:null,el:null,start:null,end:null,intervalStart:null,intervalEnd:null,rowCnt:null,colCnt:null,isSelected:!1,scrollerEl:null,scrollTop:null,widgetHeaderClass:null,widgetContentClass:null,highlightStateClass:null,documentMousedownProxy:null,documentDragStartProxy:null,init:function(){var b=this.opt("theme")?"ui":"fc";this.widgetHeaderClass=b+"-widget-header",this.widgetContentClass=b+"-widget-content",this.highlightStateClass=b+"-state-highlight",this.documentMousedownProxy=a.proxy(this,"documentMousedown"),this.documentDragStartProxy=a.proxy(this,"documentDragStart")},render:function(){this.updateSize(),this.trigger("viewRender",this,this,this.el),a(document).on("mousedown",this.documentMousedownProxy).on("dragstart",this.documentDragStartProxy)},destroy:function(){this.unselect(),this.trigger("viewDestroy",this,this,this.el),this.destroyEvents(),this.el.empty(),a(document).off("mousedown",this.documentMousedownProxy).off("dragstart",this.documentDragStartProxy)},incrementDate:function(){},updateSize:function(a){a&&this.recordScroll(),this.updateHeight(),this.updateWidth()},updateWidth:function(){},updateHeight:function(){var a=this.calendar;this.setHeight(a.getSuggestedViewHeight(),a.isHeightAuto())},setHeight:function(){},computeScrollerHeight:function(a){var b,c=this.el.add(this.scrollerEl);return c.css({position:"relative",left:-1}),b=this.el.outerHeight()-this.scrollerEl.height(),c.css({position:"",left:""}),a-b},recordScroll:function(){this.scrollerEl&&(this.scrollTop=this.scrollerEl.scrollTop())},restoreScroll:function(){null!==this.scrollTop&&this.scrollerEl.scrollTop(this.scrollTop)},renderEvents:function(){this.segEach(function(a){this.trigger("eventAfterRender",a.event,a.event,a.el)}),this.trigger("eventAfterAllRender")},destroyEvents:function(){this.segEach(function(a){this.trigger("eventDestroy",a.event,a.event,a.el)})},resolveEventEl:function(b,c){var d=this.trigger("eventRender",b,b,c);return d===!1?c=null:d&&d!==!0&&(c=a(d)),c},showEvent:function(a){this.segEach(function(a){a.el.css("visibility","")},a)},hideEvent:function(a){this.segEach(function(a){a.el.css("visibility","hidden")},a)},segEach:function(a,b){var c,d=this.getSegs();for(c=0;c<d.length;c++)b&&d[c].event._id!==b._id||a.call(this,d[c])},getSegs:function(){},renderDrag:function(){},destroyDrag:function(){},documentDragStart:function(b){var c,d,e,f,g,h=this,i=this.calendar,j=null,k=null,l=null;this.opt("droppable")&&(c=a(b.target),d=this.opt("dropAccept"),(a.isFunction(d)?d.call(c[0],c):c.is(d))&&(e=wb(c),f=e.eventProps,g=new $(this.coordMap,{cellOver:function(b,c){j=c,k=e.duration?j.clone().add(e.duration):null,l=k||i.getDefaultEventEnd(!j.hasTime(),j),f&&a.extend(f,{start:j,end:k}),i.isExternalDragAllowedInRange(j,l,f)?h.renderDrag(j,l):(j=null,n())},cellOut:function(){j=null,h.destroyDrag(),o()}}),a(document).one("dragstop",function(a,b){var d;h.destroyDrag(),o(),j&&(e.startTime&&!j.hasTime()&&j.time(e.startTime),h.trigger("drop",c[0],j,a,b),f&&(d=i.renderEvent(f,e.stick),h.trigger("eventReceive",null,d[0])))}),g.startDrag(b)))},select:function(a,b,c){this.unselect(c),this.renderSelection(a,b),this.reportSelection(a,b,c)},renderSelection:function(){},reportSelection:function(a,b,c){this.isSelected=!0,this.trigger("select",null,a,b,c)},unselect:function(a){this.isSelected&&(this.isSelected=!1,this.destroySelection(),this.trigger("unselect",null,a))},destroySelection:function(){},documentMousedown:function(b){var c;this.isSelected&&this.opt("unselectAuto")&&w(b)&&(c=this.opt("unselectCancel"),c&&a(b.target).closest(c).length||this.unselect(b))}},Jb.dataAttrPrefix="",xb.prototype=D(vb.prototype),a.extend(xb.prototype,{dayGrid:null,dayNumbersVisible:!1,weekNumbersVisible:!1,weekNumberWidth:null,headRowEl:null,render:function(a,b,c){this.rowCnt=a,this.colCnt=b,this.dayNumbersVisible=c,this.weekNumbersVisible=this.opt("weekNumbers"),this.dayGrid.numbersVisible=this.dayNumbersVisible||this.weekNumbersVisible,this.el.addClass("fc-basic-view").html(this.renderHtml()),this.headRowEl=this.el.find("thead .fc-row"),this.scrollerEl=this.el.find(".fc-day-grid-container"),this.dayGrid.coordMap.containerEl=this.scrollerEl,this.dayGrid.el=this.el.find(".fc-day-grid"),this.dayGrid.render(this.hasRigidRows()),vb.prototype.render.call(this)},destroy:function(){this.dayGrid.destroy(),vb.prototype.destroy.call(this)},renderHtml:function(){return'<table><thead><tr><td class="'+this.widgetHeaderClass+'">'+this.dayGrid.headHtml()+'</td></tr></thead><tbody><tr><td class="'+this.widgetContentClass+'"><div class="fc-day-grid-container"><div class="fc-day-grid"/></div></td></tr></tbody></table>'},headIntroHtml:function(){return this.weekNumbersVisible?'<th class="fc-week-number '+this.widgetHeaderClass+'" '+this.weekNumberStyleAttr()+"><span>"+G(this.opt("weekNumberTitle"))+"</span></th>":void 0},numberIntroHtml:function(a){return this.weekNumbersVisible?'<td class="fc-week-number" '+this.weekNumberStyleAttr()+"><span>"+this.calendar.calculateWeekNumber(this.cellToDate(a,0))+"</span></td>":void 0},dayIntroHtml:function(){return this.weekNumbersVisible?'<td class="fc-week-number '+this.widgetContentClass+'" '+this.weekNumberStyleAttr()+"></td>":void 0},introHtml:function(){return this.weekNumbersVisible?'<td class="fc-week-number" '+this.weekNumberStyleAttr()+"></td>":void 0},numberCellHtml:function(a,b,c){var d;return this.dayNumbersVisible?(d=this.dayGrid.getDayClasses(c),d.unshift("fc-day-number"),'<td class="'+d.join(" ")+'" data-date="'+c.format()+'">'+c.date()+"</td>"):"<td/>"},weekNumberStyleAttr:function(){return null!==this.weekNumberWidth?'style="width:'+this.weekNumberWidth+'px"':""},hasRigidRows:function(){var a=this.opt("eventLimit");return a&&"number"!=typeof a},updateWidth:function(){this.weekNumbersVisible&&(this.weekNumberWidth=r(this.el.find(".fc-week-number")))},setHeight:function(a,b){var c,d=this.opt("eventLimit");t(this.scrollerEl),m(this.headRowEl),this.dayGrid.destroySegPopover(),d&&"number"==typeof d&&this.dayGrid.limitRows(d),c=this.computeScrollerHeight(a),this.setGridHeight(c,b),d&&"number"!=typeof d&&this.dayGrid.limitRows(d),!b&&s(this.scrollerEl,c)&&(l(this.headRowEl,v(this.scrollerEl)),c=this.computeScrollerHeight(a),this.scrollerEl.height(c),this.restoreScroll())},setGridHeight:function(a,b){b?q(this.dayGrid.rowEls):p(this.dayGrid.rowEls,a,!0)},renderEvents:function(a){this.dayGrid.renderEvents(a),this.updateHeight(),vb.prototype.renderEvents.call(this,a)},getSegs:function(){return this.dayGrid.getSegs()},destroyEvents:function(){vb.prototype.destroyEvents.call(this),this.recordScroll(),this.dayGrid.destroyEvents()},renderDrag:function(a,b,c){return this.dayGrid.renderDrag(a,b,c)},destroyDrag:function(){this.dayGrid.destroyDrag()},renderSelection:function(a,b){this.dayGrid.renderSelection(a,b)},destroySelection:function(){this.dayGrid.destroySelection()}}),e({fixedWeekCount:!0}),Kb.month=yb,yb.prototype=D(xb.prototype),a.extend(yb.prototype,{name:"month",incrementDate:function(a,b){return a.clone().stripTime().add(b,"months").startOf("month")},render:function(a){var b;this.intervalStart=a.clone().stripTime().startOf("month"),this.intervalEnd=this.intervalStart.clone().add(1,"months"),this.start=this.intervalStart.clone(),this.start=this.skipHiddenDays(this.start),this.start.startOf("week"),this.start=this.skipHiddenDays(this.start),this.end=this.intervalEnd.clone(),this.end=this.skipHiddenDays(this.end,-1,!0),this.end.add((7-this.end.weekday())%7,"days"),this.end=this.skipHiddenDays(this.end,-1,!0),b=Math.ceil(this.end.diff(this.start,"weeks",!0)),this.isFixedWeeks()&&(this.end.add(6-b,"weeks"),b=6),this.title=this.calendar.formatDate(this.intervalStart,this.opt("titleFormat")),xb.prototype.render.call(this,b,this.getCellsPerWeek(),!0)},setGridHeight:function(a,b){b=b||"variable"===this.opt("weekMode"),b&&(a*=this.rowCnt/6),p(this.dayGrid.rowEls,a,!b)},isFixedWeeks:function(){var a=this.opt("weekMode");return a?"fixed"===a:this.opt("fixedWeekCount")}}),Kb.basicWeek=zb,zb.prototype=D(xb.prototype),a.extend(zb.prototype,{name:"basicWeek",incrementDate:function(a,b){return a.clone().stripTime().add(b,"weeks").startOf("week")},render:function(a){this.intervalStart=a.clone().stripTime().startOf("week"),this.intervalEnd=this.intervalStart.clone().add(1,"weeks"),this.start=this.skipHiddenDays(this.intervalStart),this.end=this.skipHiddenDays(this.intervalEnd,-1,!0),this.title=this.calendar.formatRange(this.start,this.end.clone().subtract(1),this.opt("titleFormat")," — "),xb.prototype.render.call(this,1,this.getCellsPerWeek(),!1)}}),Kb.basicDay=Ab,Ab.prototype=D(xb.prototype),a.extend(Ab.prototype,{name:"basicDay",incrementDate:function(a,b){var c=a.clone().stripTime().add(b,"days");return c=this.skipHiddenDays(c,0>b?-1:1)},render:function(a){this.start=this.intervalStart=a.clone().stripTime(),this.end=this.intervalEnd=this.start.clone().add(1,"days"),this.title=this.calendar.formatDate(this.start,this.opt("titleFormat")),xb.prototype.render.call(this,1,1,!1)}}),e({allDaySlot:!0,allDayText:"all-day",scrollTime:"06:00:00",slotDuration:"00:30:00",axisFormat:Bb,timeFormat:{agenda:Cb},minTime:"00:00:00",maxTime:"24:00:00",slotEventOverlap:!0});var Yb=5;Db.prototype=D(vb.prototype),a.extend(Db.prototype,{timeGrid:null,dayGrid:null,axisWidth:null,noScrollRowEls:null,bottomRuleEl:null,bottomRuleHeight:null,render:function(b){this.rowCnt=1,this.colCnt=b,this.el.addClass("fc-agenda-view").html(this.renderHtml()),this.scrollerEl=this.el.find(".fc-time-grid-container"),this.timeGrid.coordMap.containerEl=this.scrollerEl,this.timeGrid.el=this.el.find(".fc-time-grid"),this.timeGrid.render(),this.bottomRuleEl=a('<hr class="'+this.widgetHeaderClass+'"/>').appendTo(this.timeGrid.el),this.dayGrid&&(this.dayGrid.el=this.el.find(".fc-day-grid"),this.dayGrid.render(),this.dayGrid.bottomCoordPadding=this.dayGrid.el.next("hr").outerHeight()),this.noScrollRowEls=this.el.find(".fc-row:not(.fc-scroller *)"),vb.prototype.render.call(this),this.resetScroll()},destroy:function(){this.timeGrid.destroy(),this.dayGrid&&this.dayGrid.destroy(),vb.prototype.destroy.call(this)},renderHtml:function(){return'<table><thead><tr><td class="'+this.widgetHeaderClass+'">'+this.timeGrid.headHtml()+'</td></tr></thead><tbody><tr><td class="'+this.widgetContentClass+'">'+(this.dayGrid?'<div class="fc-day-grid"/><hr class="'+this.widgetHeaderClass+'"/>':"")+'<div class="fc-time-grid-container"><div class="fc-time-grid"/></div></td></tr></tbody></table>'},headIntroHtml:function(){var a,b,c,d;return this.opt("weekNumbers")?(a=this.cellToDate(0,0),b=this.calendar.calculateWeekNumber(a),c=this.opt("weekNumberTitle"),d=this.opt("isRTL")?b+c:c+b,'<th class="fc-axis fc-week-number '+this.widgetHeaderClass+'" '+this.axisStyleAttr()+"><span>"+G(d)+"</span></th>"):'<th class="fc-axis '+this.widgetHeaderClass+'" '+this.axisStyleAttr()+"></th>"},dayIntroHtml:function(){return'<td class="fc-axis '+this.widgetContentClass+'" '+this.axisStyleAttr()+"><span>"+(this.opt("allDayHtml")||G(this.opt("allDayText")))+"</span></td>"},slotBgIntroHtml:function(){return'<td class="fc-axis '+this.widgetContentClass+'" '+this.axisStyleAttr()+"></td>"},introHtml:function(){return'<td class="fc-axis" '+this.axisStyleAttr()+"></td>"},axisStyleAttr:function(){return null!==this.axisWidth?'style="width:'+this.axisWidth+'px"':""},updateSize:function(a){a&&this.timeGrid.resize(),vb.prototype.updateSize.call(this,a)},updateWidth:function(){this.axisWidth=r(this.el.find(".fc-axis"))},setHeight:function(a,b){var c,d;null===this.bottomRuleHeight&&(this.bottomRuleHeight=this.bottomRuleEl.outerHeight()),this.bottomRuleEl.hide(),this.scrollerEl.css("overflow",""),t(this.scrollerEl),m(this.noScrollRowEls),this.dayGrid&&(this.dayGrid.destroySegPopover(),c=this.opt("eventLimit"),c&&"number"!=typeof c&&(c=Yb),c&&this.dayGrid.limitRows(c)),b||(d=this.computeScrollerHeight(a),s(this.scrollerEl,d)?(l(this.noScrollRowEls,v(this.scrollerEl)),d=this.computeScrollerHeight(a),this.scrollerEl.height(d),this.restoreScroll()):(this.scrollerEl.height(d).css("overflow","hidden"),this.bottomRuleEl.show()))},resetScroll:function(){function a(){c.scrollerEl.scrollTop(e)}var c=this,d=b.duration(this.opt("scrollTime")),e=this.timeGrid.computeTimeTop(d);e=Math.ceil(e),e&&e++,a(),setTimeout(a,0)},renderEvents:function(a){var b,c,d=[],e=[],f=[];for(c=0;c<a.length;c++)a[c].allDay?d.push(a[c]):e.push(a[c]);b=this.timeGrid.renderEvents(e),this.dayGrid&&(f=this.dayGrid.renderEvents(d)),this.updateHeight(),vb.prototype.renderEvents.call(this,a)},getSegs:function(){return this.timeGrid.getSegs().concat(this.dayGrid?this.dayGrid.getSegs():[])},destroyEvents:function(){vb.prototype.destroyEvents.call(this),this.recordScroll(),this.timeGrid.destroyEvents(),this.dayGrid&&this.dayGrid.destroyEvents()},renderDrag:function(a,b,c){return a.hasTime()?this.timeGrid.renderDrag(a,b,c):this.dayGrid?this.dayGrid.renderDrag(a,b,c):void 0},destroyDrag:function(){this.timeGrid.destroyDrag(),this.dayGrid&&this.dayGrid.destroyDrag()},renderSelection:function(a,b){a.hasTime()||b.hasTime()?this.timeGrid.renderSelection(a,b):this.dayGrid&&this.dayGrid.renderSelection(a,b)},destroySelection:function(){this.timeGrid.destroySelection(),this.dayGrid&&this.dayGrid.destroySelection()}}),Kb.agendaWeek=Eb,Eb.prototype=D(Db.prototype),a.extend(Eb.prototype,{name:"agendaWeek",incrementDate:function(a,b){return a.clone().stripTime().add(b,"weeks").startOf("week")},render:function(a){this.intervalStart=a.clone().stripTime().startOf("week"),this.intervalEnd=this.intervalStart.clone().add(1,"weeks"),this.start=this.skipHiddenDays(this.intervalStart),this.end=this.skipHiddenDays(this.intervalEnd,-1,!0),this.title=this.calendar.formatRange(this.start,this.end.clone().subtract(1),this.opt("titleFormat")," — "),Db.prototype.render.call(this,this.getCellsPerWeek())}}),Kb.agendaDay=Fb,Fb.prototype=D(Db.prototype),a.extend(Fb.prototype,{name:"agendaDay",incrementDate:function(a,b){var c=a.clone().stripTime().add(b,"days");return c=this.skipHiddenDays(c,0>b?-1:1)},render:function(a){this.start=this.intervalStart=a.clone().stripTime(),this.end=this.intervalEnd=this.start.clone().add(1,"days"),this.title=this.calendar.formatDate(this.start,this.opt("titleFormat")),Db.prototype.render.call(this,1)}})});var userLat,userLon,global_mapCenter,local_icons={defaultIcon:{},yellowIcon:{iconUrl:"img/marker-icon.png",shadowUrl:"img/marker-shadow.png",iconSize:[25,41],shadowSize:[41,41],iconAnchor:[12,40],shadowAnchor:[12,40],popupAnchor:[0,-40]},leafIcon:{iconUrl:"img/leaf-green.png",shadowUrl:"img/leaf-shadow.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},orangeLeafIcon:{iconUrl:"img/leaf-orange.png",shadowUrl:"img/leaf-shadow.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},divIcon:{type:"div",iconSize:[200,0],popupAnchor:[0,0],html:"Using <strong>Bold text as an icon</strong>:"}},tilesDict={openstreetmap:{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}},mapbox:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig1oichl/{z}/{x}/{y}.png",options:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},aicp:{url:"1.0.0/aicpweek/{z}/{x}/{y}.png",options:{minZoom:16,maxZoom:23,reuseTiles:!0}},urban:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6a7dkn/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:19,reuseTiles:!0}},fairy:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig9jd86b/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},sunset:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6f6j6e/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},arabesque:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig67e7eb/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}}},mapSelect="cloud",global_hashtag="#HappyHourShowcase",eventCategories=["lecture","show","award"],placeCategories=["food","bars","sponsors","washrooms","exhibits","smoking"],globalEditLoc={};"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports.hashtag=global_hashtag);var mainWindow,he;app.controller("WorldRouteCtrl",["$location","$scope","$routeParams","db","$rootScope","styleManager","mapManager","alertManager",function(a,b,c,d,e,f,g,h){function i(c,f){b.worlds=d.worlds.query({localTime:new Date,userCoordinate:[f,c]},function(b){e.altBubbles=b[0].liveAndInside,e.nearbyBubbles=b[0].live,null!=b[0].liveAndInside[0]?b[0].liveAndInside[0].id?(a.path("w/"+b[0].liveAndInside[0].id),m.addAlert("success","You found a bubble! Explore it below",!0)):j(c,f):(j(c,f),m.addAlert("info","No Bubbles here, but there are some nearby!",!0))})}function j(a,c){k.setCenter([c,a+.012],14,b.aperture.state),b.showCreateNew=!0,angular.forEach(e.nearbyBubbles,function(a){a.lat&&a.lng&&k.addMarker(a._id,{lat:a.lat,lng:a.lng,draggable:!1,message:'<a href="#/w/'+a.id+'">'+a.name+"</a>",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[13,10]}})})}var k=g;angular.extend(e,{loading:!0});var l=f;l.resetNavBG();var m=h;b.aperture=apertureService,b.aperture.set("off"),b.initGeo=function(){function a(a){var b=a.coords.latitude,c=a.coords.longitude;i(b,c)}function b(){}navigator.geolocation?navigator.geolocation.getCurrentPosition(a,b,{timeout:15e3,enableHighAccuracy:!0}):m("Your browser does not support geolocation :(")},b.initGeo(),b.addWorld=function(){a.path("/profile")}}]),L.AreaSelect=L.Class.extend({includes:L.Mixin.Events,options:{width:200,height:300,keepAspectRatio:!1},initialize:function(a){L.Util.setOptions(this,a),this.options.width>1e3||this.options.height>1e3?(this._width=this.options.width/8,this._height=this.options.height/8):(this._width=this.options.width,this._height=this.options.height)},addTo:function(a){return this.map=a,this._createElements(),this._render(),this},getBounds:function(){var a=this.map.getSize(),b=new L.Point,c=new L.Point;c.x=Math.round((a.x-this._width)/2),b.y=Math.round((a.y-this._height)/2),b.x=a.x-c.x,c.y=a.y-b.y;var d=this.map.containerPointToLatLng(c),e=this.map.containerPointToLatLng(b);return new L.LatLngBounds(d,e)},remove:function(){this.map.off("moveend",this._onMapChange),this.map.off("zoomend",this._onMapChange),this.map.off("resize",this._onMapResize),this._container.remove()},_createElements:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-areaselect-container",this.map._controlContainer),this._topShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._bottomShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._leftShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._rightShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._nwHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._swHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._neHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._seHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._setUpHandlerEvents(this._nwHandle),this._setUpHandlerEvents(this._neHandle,-1,1),this._setUpHandlerEvents(this._swHandle,1,-1),this._setUpHandlerEvents(this._seHandle,-1,-1),this.map.on("moveend",this._onMapChange,this),this.map.on("zoomend",this._onMapChange,this),this.map.on("resize",this._onMapResize,this),this.fire("change"))},_setUpHandlerEvents:function(a,b,c){function d(f){function g(a){if(e.options.keepAspectRatio){var d=(e._height>=e._width?l.y:l.y*(1/k))-30;e._height+=2*(j-a.originalEvent.y)*c,e._height=Math.max(30,e._height),e._height=Math.min(d,e._height),e._width=e._height*k}else e._width+=2*(i-a.originalEvent.x)*b,e._height+=2*(j-a.originalEvent.y)*c,e._width=Math.max(30,e._width),e._height=Math.max(30,e._height),e._width=Math.min(l.x-30,e._width),e._height=Math.min(l.y-30,e._height);i=a.originalEvent.x,j=a.originalEvent.y,e._render()}function h(){L.DomEvent.removeListener(e.map,"mouseup",h),L.DomEvent.removeListener(e.map,"mousemove",g),L.DomEvent.addListener(a,"mousedown",d),e.fire("change")}f.stopPropagation(),L.DomEvent.removeListener(this,"mousedown",d);var i=f.x,j=f.y,k=e._width/e._height,l=e.map.getSize();L.DomEvent.addListener(e.map,"mousemove",g),L.DomEvent.addListener(e.map,"mouseup",h)}b=b||1,c=c||1;var e=this;L.DomEvent.addListener(a,"mousedown",d)},_onMapResize:function(){this._render()},_onMapChange:function(){this.fire("change")},_render:function(){function a(a,b){a.style.width=b.width+"px",a.style.height=b.height+"px",a.style.top=b.top+"px",a.style.left=b.left+"px",a.style.bottom=b.bottom+"px",a.style.right=b.right+"px"}var b=this.map.getSize(),c=Math.round(this._nwHandle.offsetWidth/2),d=Math.round((b.y-this._height)/2),e=Math.round((b.x-this._width)/2);a(this._topShade,{width:b.x,height:d,top:0,left:0}),a(this._bottomShade,{width:b.x,height:d,bottom:0,left:0}),a(this._leftShade,{width:e,height:b.y-2*d,top:d,left:0}),a(this._rightShade,{width:e,height:b.y-2*d,top:d,right:0}),a(this._nwHandle,{left:e-c,top:d-7}),a(this._neHandle,{right:e-c,top:d-7}),a(this._swHandle,{left:e-c,bottom:d-7}),a(this._seHandle,{right:e-c,bottom:d-7})}}),L.areaSelect=function(a){return new L.AreaSelect(a)};var res;angular.module("tidepoolsServices",["ngResource"]).factory("Landmark",["$resource","$http",function(a){var b={count:{method:"PUT",params:{_id:"count"},server:!0},distinct:{method:"PUT",params:{_id:"distinct"},server:!0},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},del:{method:"DELETE",params:{_id:"del"},isArray:!1,server:!0},get:{method:"GET",server:!0}};return res=a("/api/landmarks/:_id:id",{},b)}]).factory("World",["$resource","$http","leafletData",function(a){var b={count:{method:"PUT",params:{_id:"count"},server:!0},distinct:{method:"PUT",params:{_id:"distinct"},server:!0},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},del:{method:"DELETE",params:{_id:"del"},isArray:!0,server:!0},get:{method:"GET",server:!0}};return res=a("/api/worlds/:_id:id",{},b)}]).factory("db",["$resource","$http",function(a){var b={count:{method:"PUT",params:{_id:"count",server:!0}},distinct:{method:"PUT",params:{_id:"distinct",server:!0}},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},create:{method:"POST",params:{_id:"create"},isArray:!0,server:!0},locsearch:{method:"GET",params:{_id:"locsearch"},isArray:!0,server:!0},query:{method:"GET",isArray:!0,server:!0}},c={};return c.worlds=a("/api/worlds/:_id",{},b),c.landmarks=a("/api/landmarks/:_id:id",{},b),c.styles=a("/api/styles/:_id",{},b),c.projects=a("/api/projects/:_id",{},b),c.tweets=a("/api/tweets/:_id",{},b),c.instagrams=a("/api/instagrams/:_id",{},b),c.messages=a("/api/worldchat/:_id",{},b),c.visit=a("/api/visit/:_id",{},b),c
}]).factory("apertureService",["leafletData","mapManager",function(a,b){var c={off:!0,state:"aperture-off",navfix:"navfix"},d=b;return c.toggle=function(a){"aperture-full"!=c.state?(c.off=!1,c.navfix="","half"==a&&c.set("half"),"full"==a&&c.set("full")):(c.off=!0,c.state="aperture-off",c.navfix="navfix")},c.set=function(a){switch(a){case"off":"aperture-off"!=c.state&&(c.off=!0,c.state="aperture-off",c.navfix="navfix",d.apertureUpdate("aperture-off"));break;case"third":"aperture-third"!=c.state&&(c.off=!1,c.state="aperture-third",c.navfix="",d.apertureUpdate("aperture-third"));break;case"half":"aperture-half"!=c.state&&(c.off=!1,c.state="aperture-half",c.navfix="",d.apertureUpdate("aperture-half"));break;case"full":"aperture-full"!=c.state&&(c.off=!1,c.state="aperture-full",c.navfix="",d.apertureUpdate("aperture-full"))}},c}]).factory("socket",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}),app.factory("alertManager",["$timeout",function(a){var b={list:[]};return b.addAlert=function(c,d,e){var f;switch(c){case"success":f="alert-success";break;case"info":f="alert-info";break;case"warning":f="alert-warning";break;case"danger":f="alert-danger"}var g=b.list.push({"class":f,msg:d,id:d});e&&a(function(){b.list.splice(g-1,1)},1500)},b.closeAlert=function(a){b.list.splice(a,1)},b.notify=function(a){b.list.push(a)},b}]),app.factory("bubbleTypeService",[function(){function a(a){c=a}function b(){return c}var c;return{set:a,get:b}}]),angular.module("tidepoolsServices").factory("dialogs",["$rootScope","$compile",function(){var a={dialogTemplate:null};return a.showDialog=function(b){a.template="templates/"+b,a.show=!0},a.close=function(b){(b.target.className.indexOf("dialog-bg")>-1||b.target.className.indexOf("closeElement")>-1)&&(a.show=!1)},a}]),angular.module("tidepoolsServices").factory("geoService",["$q","alertManager",function(a){var b={location:{},inProgress:!1,requestQueue:[]};return b.getLocation=function(){function c(a){b.location.lat=a.coords.latitude,b.location.lng=a.coords.longitude,b.location.timestamp=Date.now(),b.resolveQueue({lat:a.coords.latitude,lng:a.coords.longitude})}function d(a){b.resolveQueue({err:a.code})}var e=a.defer();return b.requestQueue.push(e),b.inProgress||(navigator.geolocation?(b.inProgress=!0,navigator.geolocation.getCurrentPosition(c,d)):alerts.addAlert("warning","Your browser does not support location services.")),e.promise},b.resolveQueue=function(a){for(;b.requestQueue.length>0;){var c=b.requestQueue.pop();a.err?c.reject(a.err):c.resolve(a)}b.inProgress=!1},b}]),angular.module("tidepoolsServices").factory("ifGlobals",[function(){var a={kinds:{Convention:{name:"Convention",hasTime:!0,img:"convention.png",icon:"convention.svg"},Event:{name:"Event",hasTime:!0,img:"event.png",icon:"event.svg"},Neighborhood:{name:"Neighborhood",hasTime:!1,img:"neighborhood.png",icon:"neighborhood.svg"},Venue:{name:"Venue",hasTime:!1,img:"venue.png",icon:"venue.svg"},Park:{name:"Park",hasTime:!1,img:"park.png",icon:"park.svg"},Retail:{name:"Retail",hasTime:!1,img:"retail.png",icon:"retail.svg"},Campus:{name:"Campus",hasTime:!1,img:"campus.png",icon:"campus.svg"},Home:{name:"Home",hasTime:!1,img:"home.png",icon:"home.svg"},Other:{name:"Other",hasTime:!0,img:"other.png"}},stickers:{Favorite:{name:"Favorite",img:"img/stickers/favorite.png",iconInfo:{iconUrl:"img/stickers/favorite.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},FixThis:{name:"Fix This",img:"img/stickers/fixthis.png",iconInfo:{iconUrl:"img/stickers/fixthis.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},Food:{name:"Food",img:"img/stickers/food.png",iconInfo:{iconUrl:"img/stickers/food.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},ImHere:{name:"I'm Here",img:"img/stickers/im_here.png",iconInfo:{iconUrl:"img/stickers/im_here.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},Interesting:{name:"Interesting",img:"img/stickers/interesting.png",iconInfo:{iconUrl:"img/stickers/interesting.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},WereHere:{name:"We're Here",img:"img/stickers/were_here.png",iconInfo:{iconUrl:"img/stickers/were_here.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}}},mapThemes:{arabesque:{name:"Arabesque",cloudMapName:"arabesque",cloudMapID:"interfacefoundry.ig67e7eb",img:"img/mapbox/arabesque_small.png"},fairy:{name:"Fairy",cloudMapName:"fairy",cloudMapID:"interfacefoundry.ig9jd86b",img:"img/mapbox/fairy_small.png"},sunset:{name:"Sunset",cloudMapName:"sunset",cloudMapID:"interfacefoundry.ig6f6j6e",img:"img/mapbox/sunset_small.png"},urban:{name:"Urban",cloudMapName:"urban",cloudMapID:"interfacefoundry.ig6a7dkn",img:"img/mapbox/urban_small.png"},haze:{name:"Haze",cloudMapName:"purple haze",cloudMapID:"interfacefoundry.ig1oichl",img:"img/mapbox/haze_small.png"},mimis:{name:"Mimis",cloudMapName:"mimis",cloudMapID:"interfacefoundry.b28f1c55",img:"img/mapbox/mimis_small.png"}}};return a.getBasicHeader=function(){var b=a.username+":"+a.password,c=window.btoa(b);return"Basic "+c},a}]),angular.module("tidepoolsServices").factory("mapManager",["leafletData","$rootScope","bubbleTypeService",function(a,b,c){function d(){a.getMap().then(function(a){setTimeout(function(){a.invalidateSize()},400)})}var e={center:{lat:42,lng:-83,zoom:14},markers:{},layers:{baselayers:{baseMap:{name:"Urban",url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6a7dkn/{z}/{x}/{y}.png",type:"xyz",top:!0,maxZoom:23,maxNativeZoom:23}},overlays:{}},paths:{},maxbounds:{},defaults:{controls:{layers:{visible:!1,position:"bottomright",collapsed:!0}},zoomControlPosition:"bottomleft"}};return e.setCenter=function(a,b,c){switch(e._actualCenter=a,e._z=b,c){case"aperture-half":e.setCenterWithAperture(a,b,0,.25);break;case"aperture-third":e.setCenterWithAperture(a,b,0,.35);break;case"editor":e.setCenterWithAperture(a,b,-.2,0);break;default:angular.extend(e.center,{lat:a[1],lng:a[0],zoom:b}),e.refresh()}},e.setCenterWithAperture=function(b,c,d,f){var g,h,i=Math.max(document.documentElement.clientHeight,window.innerHeight||0),j=Math.max(document.documentElement.clientWidth,window.innerWidth||0);a.getMap().then(function(a){g=a.project([b[1],b[0]],c).add([j*d,i*f-34]),h=a.unproject(g,c),angular.extend(e.center,{lat:h.lat,lng:h.lng,zoom:c}),e.refresh()})},e.setCenterWithFixedAperture=function(b,c,d,f){var g,h,i,j,k=Math.max(document.documentElement.clientHeight,window.innerHeight||0),l=Math.max(document.documentElement.clientWidth,window.innerWidth||0);i=d?l/2-d/2:0,j=f?k/2-f/2-30:-30,a.getMap().then(function(a){g=a.project([b[1],b[0]],c).add([i,j]),h=a.unproject(g,c),angular.extend(e.center,{lat:h.lat,lng:h.lng,zoom:c}),e.refresh()})},e.apertureUpdate=function(a){e._actualCenter&&e._z&&e.setCenter(e._actualCenter,e._z,a)},e.setCenterFromMarkers=function(b){function c(a){return[a.lat,a.lng]}a.getMap().then(function(a){a.fitBounds(L.latLngBounds(b.map(c)),{maxZoom:20})})},e.resetMap=function(){e.removeAllMarkers(),e.removeAllPaths(),e.removeOverlays(),e.removeCircleMask(),e.removePlaceImage(),e.refresh()},e.addMarker=function(a,b,c){if(e.markers.hasOwnProperty(a)){if(1==c)return!1;e.markers[a]=b}else e.markers[a]=b;return!0},e.addMarkers=function(a){_.isArray(a)?angular.extend(e.markers,_.indexBy(a,function(a){return a._id})):angular.extend(e.markers,a)},e.getMarker=function(a){return e.markers.hasOwnProperty(a)?e.markers[a]:!1},e.removeMarker=function(a){return e.markers.hasOwnProperty(a)?(delete e.markers[a],!0):!1},e.removeAllMarkers=function(){e.markers={}},e.setMarkers=function(a){e.markers=_.isArray(a)?_.indexBy(a,function(a){return a._id}):a},e.setMarkerMessage=function(a,b){return e.markers.hasOwnProperty(a)?(angular.extend(e.markers[a],{message:b}),!0):!1},e.setMarkerFocus=function(a){return e.markers.hasOwnProperty(a)?(angular.forEach(e.markers,function(a){a.focus=!1}),e.markers[a].focus=!0,!0):!1},e.setMarkerSelected=function(a){return angular.forEach(e.markers,function(a){"Retail"!==c.get()&&(a.icon.iconUrl="img/marker/bubble-marker-50.png")}),e.markers.hasOwnProperty(a)?(("Retail"!==c.get()||"img/marker/bubble-marker-50.png"===e.markers[a].icon.iconUrl)&&(e.markers[a].icon.iconUrl="img/marker/bubble-marker-50_selected.png"),!0):!1},e.setNewIcon=function(a){e.markers[a._id].icon.iconUrl=a.avatar,e.markers[a._id].icon.iconAnchor=[25,25],e.markers[a._id].icon.iconSize=[50,50]},e.bringMarkerToFront=function(a){return angular.forEach(e.markers,function(a){a.zIndexOffset=0}),e.markers.hasOwnProperty(a)?(e.markers[a].zIndexOffset=1e3,!0):!1},e.addPath=function(a,b,c){return e.paths.hasOwnProperty(a)&&1==c?!1:(e.paths[a]=b,e.paths[a])},e.removeAllPaths=function(){e.paths={}},e.setTiles=function(a){angular.extend(e.tiles,tilesDict[a]),d()},e.setMaxBounds=function(b,c){a.getMap().then(function(a){a.setMaxBounds([[b[0],b[1]],[c[0],c[1]]]),e.refresh()})},e.setMaxBoundsFromPoint=function(b,c){return a.getMap().then(function(a){setTimeout(function(){a.setMaxBounds([[b[0]-c,b[1]-c],[b[0]+c,b[1]+c]])},400),e.refresh()}),!0},e.refresh=function(){d()},e.setBaseLayer=function(a){e.layers.baselayers={},e.layers.baselayers[a]={name:"newBaseMap",url:a,type:"xyz",layerParams:{},layerOptions:{minZoom:1,maxZoom:23}}},e.findZoomLevel=function(a){if(a){var b=_.chain(a).map(function(a){return a.localMapOptions?a.localMapOptions.minZoom:void 0}).filter(function(a){return a}).value(),c=_.isEmpty(b)?null:_.min(b);return c}},e.setBaseLayerFromID=function(a){e.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+a+"/{z}/{x}/{y}.png")},e.findMapFromArray=function(a){var b=_.chain(a).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).value();return b=b.filter(function(a){return a.floor_num===b[0].floor_num})},e.addOverlay=function(a,b,c){c.zIndex=10,e.layers.overlays[b]={name:b,type:"xyz",url:"https://bubbl.io/maps/"+a+"/{z}/{x}/{y}.png",layerOptions:c,visible:!0,opacity:.8},e.refresh()},e.removeOverlays=function(){e.layers.overlays={},e.refresh()},e.addCircleMaskToMarker=function(c,d,f){e.circleMaskLayer=new L.IFCircleMask(e.markers[c],120,f),a.getMap().then(function(a){a.addLayer(e.circleMaskLayer),e._cMLdereg=b.$on("leafletDirectiveMarker.dragend",function(){e.circleMaskLayer._draw()})})},e.localMapArrayExists=function(a){return a&&a.style&&a.style.maps&&a.style.maps.localMapArray&&a.style.maps.localMapArray.length>0},e.filterToCurrentFloor=function(a,b){return a.filter(function(a){return a.floor_num===b})},e.sortFloors=function(a){return _.chain(a).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).value()},e.setCircleMaskState=function(a){e.circleMaskLayer&&e.circleMaskLayer._setState(a)},e.setCircleMaskMarker=function(a){e.circleMaskLayer&&e.circleMaskLayer._setMarker(e.markers[a])},e.removeCircleMask=function(){var b=e.circleMaskLayer;e.circleMaskLayer&&a.getMap().then(function(a){a.removeLayer(b),e._cMLdereg()})},e.placeImage=function(b,c){return e.placeImageLayer=new L.IFPlaceImage(c,e.markers[b]),a.getMap().then(function(a){a.addLayer(e.placeImageLayer)}),function(a){e.placeImageLayer.setScale(a)}},e.setPlaceImageScale=function(a){e.placeImageLayer.setScale(a)},e.removePlaceImage=function(){e.placeImageLayer&&a.getMap().then(function(a){a.removeLayer(e.placeImageLayer)})},e.getPlaceImageBounds=function(){return e.placeImageLayer?e.placeImageLayer.getBounds():void 0},e.fadeMarkers=function(b){a.getMap().then(function(a){var c=a.getContainer();b===!0?c.classList.add("fadeMarkers"):c.classList.remove("fadeMarkers")})},e.hasMarker=function(a){return e.markers.hasOwnProperty(a)},e.loadBubble=function(a,b){var c=18,b=b||{};a.hasOwnProperty("loc")&&a.loc.hasOwnProperty("coordinates")&&(b.center&&e.setCenter([a.loc.coordinates[0],a.loc.coordinates[1]],c,apertureService.state),b.marker&&e.addMarker("c",{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+a.id+'/">'+a.name+"</a>"})),a.style.hasOwnProperty("maps")&&(a.style.maps.localMapID&&e.addOverlay(a.style.maps.localMapID,a.style.maps.localMapName,a.style.maps.localMapOptions),a.style.maps.hasOwnProperty("localMapOptions")&&(c=a.style.maps.localMapOptions.maxZoom||19),e.setBaseLayer(tilesDict.hasOwnProperty(a.style.maps.cloudMapName)?tilesDict[a.style.maps.cloudMapName].url:a.style.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+a.style.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"))},e}]),angular.module("tidepoolsServices").factory("beaconManager",["alertManager","$interval","$timeout","beaconData",function(a,b,c,d){var e={supported:!1};return e;var e}]),angular.module("tidepoolsServices").factory("beaconData",[function(){var a={beaconTree:{"E3CA511F-B1F1-4AA6-A0F4-32081FBDD40D":{28040:{title:"Main Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Body"},28041:{title:"Main Room B",href:"w/Creative_Technologies_2014/BubblBot_s_Antenna"},28042:{title:"Workshop Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Legs/"},28043:{title:"Workshop Room B",href:"w/Creative_Technologies_2014/BubblBot_s_Arms/"},14163:{title:"Main Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Body/"}},"B9407F30-F5F8-466E-AFF9-25556B57FE6D":{62861:{title:"Ross's Random Beacon"}}}};return a.fromBeacon=function(b){return a.beaconTree[b.proximityUUID][b.major]},a}]),angular.module("tidepoolsServices").factory("lockerManager",["$q",function(a){var b={supported:!1},b={supported:!0,keychain:new Keychain};return b.getCredentials=function(){var c=a.defer(),d=a.defer(),e=a.defer();return b.keychain.getForKey(function(a){c.resolve(a)},function(a){c.resolve(void 0)},"username","Bubbl.li"),b.keychain.getForKey(function(a){d.resolve(a)},function(a){d.resolve(void 0)},"password","Bubbl.li"),b.keychain.getForKey(function(a){e.resolve(a)},function(a){e.resolve(void 0)},"fbToken","Bubbl.li"),a.all({username:c.promise,password:d.promise,fbToken:e.promise})},b.saveCredentials=function(c,d){var e=a.defer(),f=a.defer();return b.keychain.setForKey(function(a){e.resolve(a)},function(a){e.reject(a)},"username","Bubbl.li",c),b.keychain.setForKey(function(a){f.resolve(a)},function(a){f.reject(a)},"password","Bubbl.li",d),a.all([e,f])},b.saveFBToken=function(c){var d=a.defer();return b.keychain.setForKey(function(a){d.resolve(a)},function(a){d.reject(a)},"fbToken","Bubbl.li",c),d},b}]),app.factory("stickerManager",["$http","$q",function(a,b){var c={};return c.postSticker=function(c){var d=b.defer();return a.post("/api/stickers/create",c,{server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c.getStickers=function(c){var d=b.defer();return a.get("/api/stickers/",{params:{worldID:c._id},server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c.getSticker=function(c){var d=b.defer();return a.get("/api/stickers/"+c,{server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c}]),angular.module("tidepoolsServices").factory("styleManager",[function(){var a={navBG_color:"rgba(62, 82, 181, 0.96)"};return a.resetNavBG=function(){a.navBG_color="rgba(62, 82, 181, 0.96)"},a}]),angular.module("tidepoolsServices").factory("userGrouping",[function(){var a={};return a.groupByTime=function(a){for(var b,c={places:{label:"Places",bubbles:[],order:10},today:{label:"Today",bubbles:[],order:6},thisWeek:{label:"This Week",bubbles:[],order:5},thisMonth:{label:"This Month",bubbles:[],order:4},nextMonths:{label:"Next Few Months",bubbles:[],order:3},thisYear:{label:"This Year",bubbles:[],order:2},future:{label:"Future",bubbles:[],order:1},lastWeek:{label:"Last Week",bubbles:[],order:7},lastMonth:{label:"Last Month",bubbles:[],order:8},past:{label:"Past",bubbles:[],order:9}},d=moment(),e=0;e<a.length;e++){var f,b=a[e];if(b.time.start)var f=moment(b.time.start);else f=void 0;f?f.isSame(d,"day")?c.today.bubbles.push(b):f.isAfter(d)?f.isSame(d,"week")?c.thisWeek.bubbles.push(b):f.isSame(d,"month")?c.thisMonth.bubbles.push(b):f.isBefore(d.add(3,"months"))?c.nextMonths.bubbles.push(b):f.isSame(d,"year")?c.thisYear.bubbles.push(b):c.future.bubbles.push(b):f.isBefore(d)&&(f.isAfter(d.subtract(1,"week"))?c.lastWeek.bubbles.push(b):f.isAfter(d.subtract(1,"month"))?c.lastMonth.bubbles.push(b):c.past.bubbles.push(b)):c.places.bubbles.push(b)}angular.forEach(c,function(a,b){"places"==b||a.bubbles.length>1&&a.bubbles.sort(function(a,b){return moment(a.time.start).isBefore(b.time.start)?-1:1})});var g=Object.keys(c).map(function(a){return c[a]}).filter(function(a){return a.bubbles.length>0}).sort(function(a,b){return a.order-b.order});return g},a.groupForCalendar=function(a){return a.filter(function(a){return a.time.start}).map(function(a){return{id:a._id,title:a.name,start:a.time.start,end:a.time.end,bubble:a}})},a}]),angular.module("tidepoolsServices").factory("userManager",["$rootScope","$http","$resource","$q","$location","dialogs","alertManager","lockerManager","ifGlobals","worldTree",function(a,b,c,d,e,f,g,h,i,j){var k=g,l={userRes:c("/api/updateuser"),userRes:c("https://bubbl.li/api/updateuser"),loginStatus:!1,login:{},signup:{}};return l.getUser=function(){var a=d.defer(),c=l._user;return c?a.resolve(c):b.get("/api/user/loggedin",{server:!0}).success(function(b){b&&0!=b?(l._user=b,a.resolve(b)):a.reject(0)}).error(function(b){a.reject(b)}),a.promise},l.saveUser=function(a){l.userRes.save(a,function(){l._user=a})},l.getDisplayName=function(){if(l._user){var a=l._user;displayName=a.name?a.name:a.facebook&&a.facebook.name?a.facebook.name:a.twitter&&a.twitter.displayName?a.twitter.displayName:a.meetup&&a.meetup.displayName?a.meetup.displayName:a.local&&a.local.email?a.local.email.substring(0,a.local.email.indexOf("@")):"Me";var b=displayName.indexOf(" ");if(b>-1)var c=displayName.substring(0,b);else var c=displayName;return c}return void 0},l.checkLogin=function(){var b=d.defer();return l.getUser().then(function(c){l.loginStatus=!0,a.user=c,c._id&&(a.userID=c._id,l._user=c),j.getUserWorlds(),b.resolve(1)},function(a){l.loginStatus=!1,b.reject(0)}),a.$broadcast("loginSuccess"),b.promise},l.signin=function(a,c){var e=d.defer(),f={email:a,password:c};return b.post("/api/user/login",f,{server:!0}).success(function(a){l.loginStatus=!0,e.resolve(a)}).error(function(a,b,c,d){e.reject(a)}),i.username=a,i.password=c,b.post("/api/user/login-basic",f,{server:!0}).success(function(a){l.loginStatus=!0,i.loginStatus=!0,e.resolve(a)}).error(function(a,b,c,d){e.reject(a)}),e.promise},l.fbLogin=function(){var a=d.defer();return facebookConnectPlugin.login(["public_profile","email"],function(c){var d=c.authResponse.accessToken,e="Bearer "+d;b.get("/auth/bearer",{server:!0,headers:{Authorization:e}}).then(function(b){h.saveFBToken(d),i.fbToken=d,a.resolve(b)},function(b){a.reject(b)})},function(b){k.addAlert("warning","Please allow access to Facebook!",!0),a.reject(b)}),a.promise},l.logout=function(){b.get("/api/user/logout",{server:!0}),l.loginStatus=!1,e.path("/"),k.addAlert("success","You're signed out!",!0)},l.login.login=function(){var a={email:l.login.email,password:l.login.password};l.signin(a.email,a.password).then(function(a){l.checkLogin(),k.addAlert("success","You're signed in!",!0),l.login.error=!1,f.show=!1,f.showDialog("keychainDialog.html")},function(a){l.login.error=!0})},l.signup.signup=function(){var a={email:l.signup.email,password:l.signup.password};b.post("/api/user/signup",a,{server:!0}).success(function(){f.show=!1,l.checkLogin(),g.addAlert("success","You're logged in!",!0),l.signup.error=void 0}).error(function(a){a&&(l.signup.error="Error signing up!",g.addAlert("danger",a,!0))})},l.saveToKeychain=function(){h.saveCredentials(l.login.email,l.login.password)},l}]),angular.module("tidepoolsServices").factory("worldTree",["$cacheFactory","$q","World","db","geoService","$http","$location","alertManager","bubbleTypeService",function(a,b,c,d,e,f,g,h,i){var j={worldCache:a("worlds"),styleCache:a("styles"),landmarkCache:a("landmarks")},k=h;return j.getWorld=function(a){function d(){c.get({id:a},function(a){a.err?e.reject(a.err):(j.worldCache.put(a.world.id,a.world),j.styleCache.put(a.style._id,a.style),e.resolve(a),i.set(a.world.category))})}var e=b.defer(),f=j.worldCache.get(a);if(f&&f.style){i.set(f.category);var g=j.styleCache.get(f.style.styleID);g?e.resolve({world:f,style:g}):d()}else d();return e.promise},j.getLandmarks=function(a){var c=b.defer(),d=j.landmarkCache.get(a);return d?c.resolve(d):f.get("/api/landmarks",{params:{parentID:a},server:!0}).success(function(a){c.resolve(a.landmarks)}).error(function(a){c.resolve(a)}),c.promise},j.getLandmark=function(a,c){var d,e=b.defer();return j.getLandmarks(a).then(function(a){d=a.find(function(a){return a.id===c}),d?e.resolve(d):e.reject("Landmark not found")}),e.promise},j.getUpcoming=function(a){var c=new Date,e={},f=b.defer();return d.landmarks.query({queryFilter:"upcoming",parentID:a,userTime:c},function(b){e.upcomingIDs=b,d.landmarks.query({queryFilter:"now",parentID:a,userTime:c},function(a){e.nowID=a[0],f.resolve(e)},function(a){f.reject(a)})},function(a){f.reject(a)}),f.promise},j.getNearby=function(){var a=b.defer(),c=Date.now()/1e3;return j._nearby&&j._nearby.timestamp+30>c?a.resolve(j._nearby):e.getLocation().then(function(b){d.worlds.query({localTime:new Date,userCoordinate:[b.lng,b.lat]},function(b){j._nearby=b[0],j._nearby.timestamp=c,a.resolve(b[0]),j.cacheWorlds(b[0]["150m"]),j.cacheWorlds(b[0]["2.5km"])})},function(b){a.reject(b)}),a.promise},j.cacheWorlds=function(a){a&&a.forEach(function(a){j.worldCache.put(a.id,a)})},j.getUserWorlds=function(a){var c=Date.now()/1e3;return a?void 0:j._userWorlds&&j._userWorlds.timestamp+60>c?b.when(j._userWorlds):f.get("/api/user/profile",{server:!0}).success(function(a){j._userWorlds=a,j._userWorlds.timestamp=c,j.cacheWorlds(a)})},j.createWorld=function(){return void k.addAlert("warning","Creating New Bubbles coming soon to the iOS app. For now, login to build through https://bubbl.li",!0)},j}]);var themeDict={urban:{name:"urban",bodyBG_color:"#80DEEA",cardBG_color:"#FFFFFF",titleBG_color:"#00BCD4",navBG_color:"rgba(0, 172, 193, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#304FFE",categoryTitle_color:"#536DFE"},sunset:{name:"sunset",bodyBG_color:"#FFE0B2",cardBG_color:"#FFFFFF",titleBG_color:"#FF9800",navBG_color:"rgba(245, 124, 0, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF4081",categoryTitle_color:"#F48FB1"},fairy:{name:"fairy",bodyBG_color:"#7E57C2",cardBG_color:"#FFFFFF",titleBG_color:"#673AB7",navBG_color:"rgba(81, 45, 168, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF5722",categoryTitle_color:"#D1C4E9"},arabesque:{name:"arabesque",bodyBG_color:"#C5CAE9",cardBG_color:"#FFFFFF",titleBG_color:"#3F51B5",navBG_color:"rgba(57, 73, 171, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF4081",categoryTitle_color:"#F48FB1"},haze:{name:"haze",bodyBG_color:"#000830",cardBG_color:"#FFFFFF",titleBG_color:"#2c22cf",navBG_color:"#2c22cf",worldTitle_color:"#FFF",landmarkTitle_color:"#6ff4ff",categoryTitle_color:"#6ff4ff"}};app.controller("TweetlistCtrl",["$location","$scope","db","$rootScope","$routeParams","apertureService",function(a,b,c,d,e,f){d.showSwitch=!1;var g=f;g.set("off"),b.currentTag=e.hashTag,b.tweets=c.tweets.query({limit:60,tag:b.currentTag}),b.tagSearch=function(){var a=b.searchText.replace("#","");b.tweets=c.tweets.query({tag:a})},b.goBack=function(){window.history.back()}}]),app.controller("InstalistCtrl",["$location","$scope","db","$rootScope","$routeParams","apertureService",function(a,b,c,d,e,f){var g=f;g.set("off"),d.showSwitch=!1,b.currentTag=e.hashTag,b.instagrams=c.instagrams.query({limit:30,tag:b.currentTag}),b.goBack=function(){window.history.back()}}]),TalktagCtrl.$inject=["$location","$scope","$routeParams","db","$rootScope"],MenuCtrl.$inject=["$location","$scope","db","$routeParams","$rootScope"],ListCtrl.$inject=["$location","$scope","db","$routeParams","$rootScope"],WorldViewCtrl.$inject=["World","$routeParams","$scope","db","$location","$timeout","leafletData","$route","$rootScope"],LandmarkViewCtrl.$inject=["Landmark","$routeParams","$scope","db","$location","$timeout","leafletData","$route","$rootScope","$sce"],AwardsCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],LecturesCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],ShowCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],app.directive("drawer",["worldTree","$rootScope","$routeParams","userManager","dialogs",function(a,b,c,d,e){return{restrict:"EA",scope:!0,link:function(f,g){f._currentBubble=!1,b.$on("toggleDrawer",function(){f.drawerOn=!f.drawerOn}),f.$on("$routeChangeSuccess",function(){f._currentBubble=!1,f.shareAvailable=c.worldURL?!0:!1}),f.$watch("drawerOn",function(a){a===!0?g.addClass("drawer"):g.removeClass("drawer")}),f.currentBubble=function(){return!f._currentBubble&&c.worldURL&&(f._currentBubble=a.worldCache.get(c.worldURL)),f._currentBubble},f.avatar=function(){try{return d._user.avatar}catch(a){return void 0}},f.username=function(){return d.getDisplayName()},f.userBubbles=function(){return a._userWorlds},f.editAvailable=function(){try{return f.currentBubble().permissions.ownerID===d._user._id}catch(a){return!1}},f.closeDrawer=function(){f.drawerOn=!1},f.shareDialog=function(){e.showDialog("shareDialog.html")},f.create=a.createWorld,f.feedback=function(){e.showDialog("feedbackDialog.html")},f.logout=d.logout},templateUrl:"components/drawer/drawer.html"}}]),app.controller("EditController",["$scope","db","World","$rootScope","$route","$routeParams","apertureService","mapManager","styleManager","alertManager","$upload","$http","$timeout","$interval","dialogs","$window","$location","$anchorScroll","ifGlobals",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){function t(){return Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,12)}function u(b){var c={worldID:a.world._id,map_marker_viewID:b.map_marker_viewID};l.post("/api/delete_map",c).success(function(b){a.world=b}).error(function(){})}function v(a){if(q.hash("scrollToBottom"),a){m(function(){r()},a)}}function w(){navigator.geolocation&&!a.world.hasLoc&&navigator.geolocation.getCurrentPosition(x,y,{timeout:15e3})}function x(b){userLat=b.coords.latitude,userLng=b.coords.longitude,A.setCenter([userLng,userLat],18,"editor"),F=t(),A.removeAllMarkers(),A.addMarker(F,{lat:userLat,lng:userLng,message:"<p style='color:black;'>Drag to Bubble Location</p>",focus:!0,draggable:!0,icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17.5,55],popupAnchor:[0,-40]}});var c;switch(a.view){case"details":c="mask";break;case"maps":c="mask";break;case"styles":c="cover"}A.circleMaskLayer?A.setCircleMaskMarker(F):A.addCircleMaskToMarker(F,100,c)}function y(){}o.showDialog("mobileDialog.html"),p.history.back();var z=g,A=h,B=i,C=j,D=angular.element(".leaflet-bottom.leaflet-left")[0];D.style.top="50px",D.style.left="40%";var E=e.current;a.worldURL=f.worldURL,z.set("full"),a.mapThemeSelect="arabesque",a.kinds=[{name:"Convention"},{name:"Park"},{name:"Retail"},{name:"Venue"},{name:"Event"},{name:"Venue"},{name:"Campus"},{name:"Home"},{name:"Neighborhood"}],a.mapThemes=s.mapThemes;var F=t();a.temp={scale:1},l.get("/components/edit/edit.locale-en-us.json").success(function(b){a.locale=angular.fromJson(b),a.tooltips=a.locale.tooltips}),a.view=f.view?f.view:"details",a.initView=function(){switch(a.view){case"details":A.setCircleMaskState("mask");break;case"maps":A.setCircleMaskState("mask");break;case"styles":A.setCircleMaskState("cover")}},a.onWorldIconSelect=function(b){var c=b[0];a.upload=k.upload({url:"/api/upload/",file:c}).progress(function(){}).success(function(b){a.world.avatar=b,a.uploadFinished=!0})},a.onLandmarkCategoryIconSelect=function(b){var c=b[0];a.upload=k.upload({url:"/api/upload/",file:c}).progress(function(){}).success(function(b){a.temp.LandmarkCatAvatar=b,a.uploadFinishedLandmark=!0})},a.setUploadFinished=function(b,c){"world"==c&&(b?a.uploadFinished=!0:(a.uploadFinished=!1,a.world.avatar=null)),"landmark"==c&&(b?a.uploadFinishedLandmark=!0:(a.uploadFinishedLandmark=!1,a.temp.LandmarkCatAvatar=null))},a.onLocalMapSelect=function(b,c,d){if(0===c||"0"===c)C.addAlert("info","The floor number can't be 0",!0);else if(""==c)C.addAlert("info","Please enter a floor number",!0);else{var e=b[0];a.upload=k.upload({url:"/api/upload_maps",file:e}).progress(function(b){a.temp||(a.temp={}),a.temp.picProgress=parseInt(100*b.loaded/b.total)+"%"}).success(function(b){a.mapImage=b,A.placeImage(F,b);var e={worldID:a.world._id,map_marker_viewID:F,temp_upload_path:b,floor_num:c,floor_name:d};l.post("/api/temp_map_upload",e).success(function(b){a.world=b,a.selectLastMap()}).error(function(){})}),v(300)}},a.selectMapTheme=function(b){"string"==typeof name&&(a.mapThemeSelect=b,A.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+a.mapThemes[b].cloudMapID+"/{z}/{x}/{y}.png"),a.world.style.maps.cloudMapName=a.mapThemes[b].cloudMapName,a.world.style.maps.cloudMapID=a.mapThemes[b].cloudMapID,0==a.style.hasOwnProperty("navBG_color")&&a.setThemeFromMap())},a.setThemeFromMap=function(){switch(a.world.style.maps.cloudMapName){case"urban":angular.extend(a.style,themeDict.urban);break;case"sunset":angular.extend(a.style,themeDict.sunset);break;case"fairy":angular.extend(a.style,themeDict.fairy);break;case"arabesque":angular.extend(a.style,themeDict.arabesque);break;case"purple haze":angular.extend(a.style,themeDict.haze)}},a.addLandmarkCategory=function(){a.temp&&(a.world.landmarkCategories.unshift({name:a.temp.LandmarkCategory,avatar:a.temp.LandmarkCatAvatar,present:a.temp.landmarkPresent}),delete a.temp.LandmarkCatAvatar,delete a.temp.LandmarkCategory,a.temp.landmarkPresent=!1,a.uploadFinishedLandmark=!1)},a.removeLandmarkCategory=function(b){a.world.landmarkCategories.splice(b,1)},a.removeAllMaps=function(){A.removePlaceImage(),A.removeOverlays()},a.getHighestFloor=function(){var b=a.world.style.maps.localMapArray;return b=$.map(b,function(a){return a.floor_num}),Math.max.apply(this,b)},a.increaseFloor=function(b){a.mapIsUploaded(b)||b.floor_num++},a.decreaseFloor=function(b){a.mapIsUploaded(b)||b.floor_num--},a.mapIsUploaded=function(a){return a.temp_upload_path||a.localMapName},a.mapIsBuilt=function(b){if(b)return b.localMapName;if(a.world&&a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0){var c=a.world.style.maps.localMapArray.length;return a.world.style.maps.localMapArray[c-1].hasOwnProperty("localMapName")}return!0},a.selectMap=function(b){if(a.selectedMap=b,a.removeAllMaps(),""==b.temp_upload_path){m(function(){A.addOverlay(b.localMapID,b.localMapName,b.localMapOptions)},100)}else{m(function(){A.placeImage(b.map_marker_viewID,b.temp_upload_path)},100)}},a.selectLastMap=function(){var b=a.world.style.maps.localMapArray.length;a.selectMap(a.world.style.maps.localMapArray[b-1])},a.addMapPlaceholder=function(){a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0?a.world.style.maps.localMapArray.push({floor_num:a.getHighestFloor()+1,floor_name:"Floor "+(a.getHighestFloor()+1)}):a.world.style.maps.localMapArray=[{floor_num:1,floor_name:"Lobby"}],v(100),a.selectLastMap()},a.removeMap=function(b){window.confirm("Are you sure you want to delete this local map?")&&(a.mapIsUploaded(b)?u(b):a.world.style.maps.localMapArray.pop())},a.loadWorld=function(b){if(a.world=b.world,a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0){var c=a.world.style.maps.localMapArray.length;""!=a.world.style.maps.localMapArray[c-1].temp_upload_path&&u(a.world.style.maps.localMapArray[c-1])}a.style=b.style,B.navBG_color=a.style.navBG_color,a.world.hasLoc?x({coords:{latitude:a.world.loc.coordinates[1],longitude:a.world.loc.coordinates[0]}}):w(),0==a.world.hasOwnProperty("style")&&(a.world.style={}),0==a.world.style.hasOwnProperty("maps")&&(a.world.style.maps={}),0==a.world.hasOwnProperty("landmarkCategories")&&(a.world.landmarkCategories=[]),a.world.style.maps.cloudMapName?(A.setBaseLayerFromID(a.world.style.maps.cloudMapID),a.mapThemeSelect=a.world.style.maps.cloudMapName):a.selectMapTheme("arabesque");
var d=[a.world.style.maps];d[0].localMapArray&&d[0].localMapArray.length>0&&(d=A.findMapFromArray(d[0].localMapArray)),d.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&A.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)}),a.style.bodyBG_color||(a.style.bodyBG_color="#FFFFFF",a.style.cardBG_color="#FFFFFF")},a.saveWorld=function(){a.whenSaving=!0,a.world.newStatus=!1,a.world.hasLoc=!0,tempMarker=A.getMarker(F),a.world.loc.coordinates[0]=tempMarker.lng,a.world.loc.coordinates[1]=tempMarker.lat,void 0==typeof a.world.style.maps&&(a.world.style.maps={}),b.worlds.create(a.world,function(b){a.world.id=b[0].id,a.whenSaving=!1,C.addAlert("success",'Save successful! Go to <a class="alert-link" target="_blank" href="#/w/'+a.world.id+'">'+a.world.name+"</a>",!0),m.cancel(G)}),a.world.resources&&a.world.resources.hashtag&&(a.style.hashtag=a.world.resources.hashtag),a.world._id&&(a.style.world_id=a.world._id),b.styles.create(a.style,function(a){})},a.search=function(){var b=new google.maps.Geocoder;b&&b.geocode({address:a.searchText},function(a,b){b==google.maps.GeocoderStatus.OK&&x({coords:{latitude:a[0].geometry.location.lat(),longitude:a[0].geometry.location.lng()}})})},a.setStartTime=function(){var b=new Date;a.world.time.start=b.toISO8601String()},a.setEndTime=function(){var b=new Date;"string"==typeof a.world.time.start&&b.setISO8601(a.world.time.start),a.world.time.start instanceof Date&&(b=a.world.time.start),b.setUTCHours(b.getUTCHours()+3);var c=b;a.world.time.end=c.toISO8601String()},a.removePlaceImage=function(){a.mapImage=null,A.removePlaceImage()},a.buildLocalMap=function(){a.building=!0;var b=A.getPlaceImageBounds(),c=b.getSouthEast(),d=b.getNorthWest(),f=b.getSouthWest(),g=b.getNorthEast(),h={worldID:a.world._id,localMapID:a.world._id+"_"+F,nw_loc_lng:d.lng,nw_loc_lat:d.lat,sw_loc_lng:f.lng,sw_loc_lat:f.lat,ne_loc_lng:g.lng,ne_loc_lat:g.lat,se_loc_lng:c.lng,se_loc_lat:c.lat},i=JSON.stringify(h),j={mapIMG:a.mapImage,coords:i,map_marker_viewID:F};C.addAlert("warning","Building local map, this may take some time!",!0),l.post("/api/build_map",j).success(function(b){C.addAlert("success","Map built!",!0),a.world.hasOwnProperty("style")||(a.world.style={}),a.world.style.hasOwnProperty("maps")||(a.world.style.maps={}),a.world=b[0]?b[0]:b,a.building=!1,e.reload(),v(1e3)}).error(function(){a.building=!1})},a.$on("$locationChangeSuccess",function(){E.$$route.originalPath===e.current.$$route.originalPath&&(a.view=e.current.params.view,e.current=E),a.initView()}),a.$on("$destroy",function(b){b.targetScope===a&&(A.removeCircleMask(),A.removePlaceImage(),D.style&&(D.style.top="",D.style.left="")),angular.extend(d,{navTitle:"Bubbl.li"})}),a.$watch("style.navBG_color",function(a){B.navBG_color=a}),a.$watch("temp.scale",function(a,b){a!=b&&A.setPlaceImageScale(a)});var G=null;a.$watchCollection("world",function(b,c){void 0!=c&&(G&&m.cancel(G),G=m(a.saveWorld,1500))}),c.get({id:f.worldURL},function(b){b.err||a.loadWorld(b),A.refresh()})}]),app.controller("LandmarkEditorController",["$scope","$rootScope","$location","$route","$routeParams","db","World","leafletData","apertureService","mapManager","Landmark","alertManager","$upload","$http","$window","dialogs","worldTree","bubbleTypeService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(){var b={name:"Landmark "+(a.landmarks.length+1),_id:0,world:!1,newStatus:!0,parentID:0,loc:{type:"Point",coordinates:[-74.0059,40.7127]},avatar:"img/tidepools/default.jpg",time:{}};return y&&(b.parentID=a.world._id,b.loc.coordinates=a.world.loc.coordinates),b}function t(){var b;b=a.landmarks.length&&a.landmarks[0].loc_info?a.landmarks[0].loc_info.floor_num:1;var c=[a.world.style.maps];c[0].localMapArray&&c[0].localMapArray.length>0&&(c=v(c[0].localMapArray,b)),c.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&w.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)})}function u(b){var c;c=a.landmarks.length&&b[0].loc_info?b[0].loc_info.floor_num:1;var d;return d=1===c?a.landmarks.filter(function(a){return!a.loc_info||a.loc_info.floor_num===c}):_.chain(b).filter(function(a){return a.loc_info}).filter(function(a){return a.loc_info.floor_num===c}).value()}function v(a,b){return a.filter(function(a){return a.floor_num===b})}p.showDialog("mobileDialog.html"),o.history.back();var w=j,x=angular.element(".leaflet-bottom.leaflet-left")[0];x.style.top="50px",x.style.left="40%";var y=!1,z=!1;a.landmarks=[],a.selectedIndex=0,a.alerts=l,a.addLandmark=function(){if(y&&z){var b=s();f.landmarks.create(b,function(c){b._id=c[0]._id,a.landmarks.unshift(b);var d="img/marker/bubble-marker-50.png",e=[0,-50],f="";w.addMarker(b._id,{lat:b.loc.coordinates[1],lng:b.loc.coordinates[0],icon:{iconUrl:d,shadowUrl:f,iconSize:[50,95],iconAnchor:[25,100],popupAnchor:e},draggable:!0,message:"Drag to location on map",focus:!0})})}else;},a.removeItem=function(b){var c=confirm("Are you sure you want to delete this item?");c&&(w.removeMarker(a.landmarks[b]._id),k.del({_id:a.landmarks[b]._id},function(){a.landmarks.splice(b,1)}))},a.saveItem=function(b){a.landmarks[b].newStatus=!1;var c=w.getMarker(a.landmarks[b]._id);return 0==c?!1:(a.landmarks[b].loc.coordinates=[c.lng,c.lat],f.landmarks.create(a.landmarks[b],function(a){}),void a.alerts.addAlert("success","Landmark Saved",!0))},a.selectItem=function(b){a.selectedIndex!=b&&(a.selectedIndex=b,w.setCenter(a.landmarks[b].loc.coordinates,18),w.setMarkerMessage(a.landmarks[b]._id,a.landmarks[b].name),w.bringMarkerToFront(a.landmarks[b]._id),w.setMarkerSelected(a.landmarks[b]._id),w.setMarkerFocus(a.landmarks[b]._id))},a.addLandmarkMarker=function(a){var b="img/marker/bubble-marker-50.png",c=[0,-40],d="",e=[17,67],f=[35,67];"Retail"===r.get()&&"img/tidepools/default.jpg"!==a.avatar&&(b=a.avatar,c=[0,-14],e=[25,25],f=[50,50]),w.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:b,shadowUrl:d,iconSize:f,iconAnchor:e,popupAnchor:c},draggable:!0,message:a.name||"Drag to location on map",focus:!0})},a.$on("$destroy",function(b){b.targetScope===a&&(w.removeCircleMask(),x.style&&(x.style.top="",x.style.left=""))}),q.getWorld(e.worldURL).then(function(b){a.world=b.world,a.style=b.style,a.worldURL=e.worldURL,w.setCenter(a.world.loc.coordinates,18,"editor"),a.world.style&&a.world.style.maps&&w.setBaseLayerFromID(a.world.style.maps.cloudMapID),w.removeAllMarkers(),w.addMarker("m",{lat:a.world.loc.coordinates[1],lng:a.world.loc.coordinates[0],focus:!1,draggable:!1,icon:{iconUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=",shadowUrl:"",iconSize:[0,0],shadowSize:[0,0],iconAnchor:[0,0],shadowAnchor:[0,0]}}),w.removeCircleMask(),w.addCircleMaskToMarker("m",150,"mask"),w.setMaxBoundsFromPoint([a.world.loc.coordinates[1],a.world.loc.coordinates[0]],.05),a.world.style.maps.hasOwnProperty("localMapOptions")&&(zoomLevel=a.world.style.maps.localMapOptions.maxZoom||19),w.refresh(),y=!0,q.getLandmarks(b.world._id).then(function(b){a.landmarks=b;var c=u(a.landmarks);angular.forEach(c,function(b){a.addLandmarkMarker(b)}),c.length&&(w.setMarkerFocus(c[0]._id),w.setMarkerSelected(c[0]._id)),z=!0,t()})})}]),app.controller("LandmarkEditorItemController",["$scope","db","Landmark","mapManager","$upload","bubbleTypeService","worldTree","$q","$log",function(a,b,c,d,e,f,g,h){function i(a){var b={};return b.val=a.floor_num,b.label=a.floor_name,b}function j(){if(d.localMapArrayExists(a.world)){var b=[],c=_.chain(a.world.style.maps.localMapArray).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).uniq(function(a){return a.floor_num}).value();c.forEach(function(a){b.push(i(a))}),a.$parent.floors=b}else a.$parent.floors=[{val:1,label:"1st Floor"}];if(a.$parent.landmark.loc_info&&null!==a.$parent.landmark.loc_info.floor_num){var e=_.pluck(a.$parent.floors,"val").indexOf(a.$parent.landmark.loc_info.floor_num);a.floorNumber=a.$parent.floors[e]?a.$parent.floors[e].label:a.$parent.floors[0].label}else a.floorNumber=a.$parent.floors[0].label;a.$parent.landmark.loc_info||(a.$parent.landmark.loc_info={floor_num:1})}function k(b){var c=h.defer();return m(l(a.$parent.landmarks,b)).then(function(){c.resolve(!0)}),c.promise}function l(a,b){var c=_.chain(a).filter(function(a){return a.loc_info}).filter(function(a){return a.loc_info.floor_num===b}).value();return 1===b&&(c=c.concat(a.filter(function(a){return!a.loc_info}))),c}function m(b){var c=h.defer();return d.removeAllMarkers(),angular.forEach(b,function(b){a.$parent.addLandmarkMarker(b)}),d.setMarkerFocus(a.$parent.landmark._id),d.setMarkerSelected(a.$parent.landmark._id),c.resolve(!0),c.promise}a.time=!1,a.deleteLandmark=function(){a.$parent.removeItem(a.$index)},a.saveLandmark=function(){a.$parent.saveItem(a.$index)},a.selectLandmark=function(b){b!==a.$parent.selectedIndex&&a.updateFloor().then(function(){a.$parent.selectItem(a.$index)})},a.setStartTime=function(){var b=new Date;a.$parent.landmark.time.start=b.toISO8601String()},a.setEndTime=function(){var b=new Date;"string"==typeof a.$parent.landmark.time.start&&b.setISO8601(a.$parent.landmark.time.start),a.$parent.landmark.time.start instanceof Date&&(b=a.$parent.landmark.time.start),b.setUTCHours(b.getUTCHours()+3);var c=b;a.$parent.landmark.time.end=c.toISO8601String()},a.setLocation=function(){a.$parent.landmark.loc_info&&null==a.$parent.landmark.loc_info.floor_num&&(a.$parent.landmark.loc_info.floor_num=1),j()},a.$parent.landmark.loc_info&&j(),a.$on("leafletDirectiveMarker.dragend",function(a,b){d.markers[b.markerName].lat=b.leafletEvent.target._latlng.lat,d.markers[b.markerName].lng=b.leafletEvent.target._latlng.lng}),a.clearLoc=function(){a.$parent.landmark.loc_info.floor_num=null,a.$parent.landmark.loc_info.room_name=null},a.chooseNewFloor=function(b){a.floorNumber=a.$parent.floors[b].label,a.$parent.landmark.loc_info.floor_num=a.$parent.floors[b].val,a.updateFloor()},a.updateFloor=function(){if(a.$parent.landmark.loc_info&&null!==a.$parent.landmark.loc_info.floor_num){var b=_.pluck(a.$parent.floors,"val").indexOf(a.$parent.landmark.loc_info.floor_num);a.floorNumber=a.$parent.floors[b]?a.$parent.floors[b].label:a.$parent.floors[0].label}else j(),a.floorNumber=a.$parent.floors[0].label;var c=h.defer(),e=a.landmark.loc_info&&null!==a.landmark.loc_info.floor_num?a.landmark.loc_info.floor_num:1;if(d.localMapArrayExists(a.world)){var f=a.world.style.maps.localMapArray,g=d.filterToCurrentFloor(d.sortFloors(f),e);d.removeOverlays(),setTimeout(function(){g.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length&&d.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)})},100)}return k(e).then(function(){c.resolve(!0)}),c.promise},a.onUploadAvatar=function(b){var c=b[0];a.upload=e.upload({url:"/api/upload/",file:c}).progress(function(a){}).success(function(b){a.$parent.landmark.avatar=b,"Retail"===f.get()&&d.setNewIcon(a.$parent.landmark),a.uploadFinished=!0})},a.$parent.landmark.landmarkTagsRemoved=[],a.tagDetect=function(b){13===b.which&&a.addTag()},a.addTag=function(){""!==a.addTagName&&(a.$parent.landmark.tags||(a.$parent.landmark.tags=[]),a.addTagName=a.addTagName.replace(/[^\w\s]/gi,""),a.addTagName=a.addTagName.toLowerCase(),a.$parent.landmark.tags.indexOf(a.addTagName)>-1||a.$parent.landmark.tags.push(a.addTagName),a.addTagName="")},a.closeTag=function(b){a.$parent.landmark.landmarkTagsRemoved.push(a.$parent.landmark.tags[b]),a.$parent.landmark.tags.splice(b,1)}}]),app.controller("WalkthroughController",["$scope","$location","$route","$routeParams","$timeout","ifGlobals","leafletData","$upload","mapManager","World","db","$window","dialogs",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){a.progress=[];var b=0;if(a.walk)for(;b<a.walk.length;)a.progress[b]={status:""},b++;a.progress[a.position].status="active"}m.showDialog("mobileDialog.html"),l.history.back(),a.global=f,a.position=0,a.world={},a.world.time={},a.world.time.start=new Date,a.world.time.end=new Date,a.world.style={},a.world.style.maps={},a.temp={};var o=i,p=angular.element(".leaflet-bottom.leaflet-left")[0];p.style.display="none",a.world.name="bubble",o.setCenter([-83,42],15),a.next=function(){a.position<a.walk.length-1&&(a.position++,a.walk[a.position].hasOwnProperty("jump")&&a.walk[a.position].jump()&&a.next()),a.save()},a.prev=function(){a.position>0&&(a.position--,a.walk[a.position].hasOwnProperty("jump")&&a.walk[a.position].jump()&&a.prev()),a.save()},a.slowNext=function(){e(function(){a.next()},200),a.save()},a.pictureSelect=function(b){var c=b[0];a.upload=h.upload({url:"/api/upload/",file:c}).progress(function(b){a.picProgress=parseInt(100*b.loaded/b.total)+"%"}).success(function(b){a.world.avatar=b})},a.selectMapTheme=function(b){var c=a.global.mapThemes;"string"==typeof b&&(a.mapThemeSelect=b,o.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+c[b].cloudMapID+"/{z}/{x}/{y}.png"),a.world.style.maps.cloudMapName=c[b].cloudMapName,a.world.style.maps.cloudMapID=c[b].cloudMapID,a.setThemeFromMap(b))},a.setThemeFromMap=function(b){switch(b){case"urban":angular.extend(a.style,themeDict.urban);break;case"sunset":angular.extend(a.style,themeDict.sunset);break;case"fairy":angular.extend(a.style,themeDict.fairy);break;case"arabesque":angular.extend(a.style,themeDict.arabesque);break;case"haze":angular.extend(a.style,themeDict.haze);break;case"mimis":angular.extend(a.style,themeDict.mimis)}k.styles.create(a.style,function(a){})},a.saveAndExit=function(){a.world.name||(a.world.name="bubble"),a.save(),a.world.id&&(b.path("/w/"+a.world.id),l.location.reload(),o.refresh())},a.save=function(){a.world.newStatus=!1,k.worlds.create(a.world,function(b){a.world.id=b[0].id}),a.style&&(a.world.resources&&a.world.resources.hashtag&&(a.style.hashtag=a.world.resources.hashtag),a.world._id&&(a.style.world_id=a.world._id),k.styles.create(a.style,function(a){}))};var q=[{title:"Need a hand?",caption:"If you haven’t built a bubble before, we can walk you through it.",height:0,view:"0.html",valid:function(){return!0},skip:!1},{title:"Kind",caption:"What kind of bubble is it?",view:"kind.html",height:220,valid:function(){return"string"==typeof a.world.category},skip:!0},{title:"Location",caption:"Find its location",view:"location.html",height:290,valid:function(){return a.world.hasLoc},skip:!1},{title:"Name",caption:"What's your bubble named?",view:"name.html",height:62,valid:function(){return a.form.worldName.$valid},skip:!1},{title:"Time",caption:"Give it a start and end time",view:"time.html",height:288,valid:function(){return a.form.time.$valid},jump:function(){return!a.global.kinds[a.world.category].hasTime},skip:!0},{title:"Picture",caption:"Upload a picture for your bubble",view:"picture.html",height:194,valid:function(){return!0},skip:!0},{title:"Maps",caption:"Choose a map",view:"maptheme.html",height:426,valid:function(){return!0},skip:!0},{title:"Hashtag",caption:"Connect your bubble's social media",view:"hashtag.html",height:132,valid:function(){return!0},skip:!0},{title:"Done!",caption:"Now spread the word :)",view:"done.html",height:200,skip:!1}],r=[{title:"Claim your Meetup",caption:"We'll use your Meetup group to create a bubble.",view:"0.html",height:0,valid:function(){return!0},skip:!1},{title:"Confirm",caption:"Make sure this information from Meetup.com is correct",view:"meetup_confirm.html",height:300,valid:function(){return!0},skip:!1},{title:"Kind",caption:"What kind of bubble is it?",view:"kind.html",height:220,valid:function(){return"string"==typeof a.world.category},skip:!1},{title:"Hashtag",caption:"Connect your bubble's social media",view:"hashtag.html",height:132,valid:function(){return!0},skip:!0},{title:"Picture",caption:"Upload a picture",view:"picture.html",height:194,valid:function(){return!0},skip:!0},{title:"Maps",caption:"Choose a map",view:"maptheme.html",height:426,valid:function(){return!0},skip:!0},{title:"Done!",caption:"Now spread the word :)",view:"done_meetup.html",height:200,skip:!1}];a.walk=q,a.getProgress=function(){return{width:100*a.position/(a.walk.length-1)+"%"}},j.get({id:d._id,m:!0},function(b){b.err||(angular.extend(a.world,b.world),angular.extend(a.style,b.style),a.world.source_meetup&&a.world.source_meetup.id&&(a.walk=r),o.setBaseLayer("https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"),n())})}]),app.controller("WalkLocationController",["$scope","$rootScope","$timeout","leafletData",function(a,b,c,d){angular.extend(a,{tiles:tilesDict.arabesque}),angular.extend(a,{center:{lat:42,lng:-83,zoom:15}}),angular.extend(a,{markers:{}}),a.$watch("temp.MapActive",function(a,b){1==a&&d.getMap("locMap").then(function(a){a.invalidateSize()})}),a.showPosition=function(b,c){var e=b.valueOf(),f=c.valueOf();angular.extend(a,{markers:{m:{lat:e,lng:f,icon:{iconUrl:"img/marker/bubble-marker-50.png",iconSize:[35,67]},draggable:!0}}}),a.center.lat=e,a.center.lng=f,a.world.loc={coordinates:[f,e]},a.world.hasLoc=!0,a.$apply(function(){a.locLoading=!1}),d.getMap("locMap").then(function(a){a.invalidateSize()})},a.searchByAddress=function(){var b=new google.maps.Geocoder;b&&(a.locLoading=!0,b.geocode({address:a.temp.address},function(b,c){c==google.maps.GeocoderStatus.OK&&a.showPosition(b[0].geometry.location.lat(),b[0].geometry.location.lng())}))},a.searchByLocation=function(){navigator.geolocation&&(a.locLoading=!0,navigator.geolocation.getCurrentPosition(function(b){a.showPosition(b.coords.latitude,b.coords.longitude)},function(){},{timeout:5e3}))}}]),app.directive("floorSelector",floorSelector),floorSelector.$inject=["mapManager"],app.filter("floorNumberFilter",floorNumberFilter),app.controller("HomeController",["$scope","$rootScope","$location","worldTree","styleManager","mapManager","geoService","ifGlobals",function(a,b,c,d,e,f,g,h){function i(){var b=a.bubbles;b.forEach(function(a){a&&j.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:'<a if-href="#w/'+a.id+'">'+a.name+"</a>",enable:"leafletDirectiveMarker.click",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-30]},_id:a._id})}),j.setCenterWithFixedAperture([g.location.lng,g.location.lat],18,0,240)}var j=f,k=e;k.resetNavBG(),j.resetMap(),a.temp={},a.loadState="loading",a.kinds=h.kinds,a.select=function(b){a.temp.mapOn?a.selected==b?c.path("w/"+b.id):(a.selected=b,j.setMarkerFocus(b._id),j.setCenterWithFixedAperture(b.loc.coordinates,18,0,240)):c.path("w/"+b.id)},a.$watch("temp.mapOn",function(a){switch(a){case!0:k.navBG_color="rgba(245, 67, 54, 0.96)";break;case!1:k.resetNavBG()}}),b.$on("leafletDirectiveMarker.click",function(b,c){var d=a.bubbles.find(function(a){return a._id==c.markerName?!0:!1});a.select(d)}),d.getNearby().then(function(b){a.$evalAsync(function(a){a.homeBubbles=b["150m"]||[],a.nearbyBubbles=b["2.5km"]||[],a.bubbles=a.nearbyBubbles.length>0&&a.homeBubbles.length>0?a.homeBubbles.concat(a.nearbyBubbles):a.nearbyBubbles.length>0?a.nearbyBubbles:a.homeBubbles.length>0?a.homeBubbles:[],a.loadState="success",i()})},function(b){a.loadState="failure"})}]),app.controller("indexIF",["$location","$scope","db","leafletData","$rootScope","apertureService","mapManager","styleManager","alertManager","userManager","$route","$routeParams","$location","$timeout","$http","$q","$sanitize","$anchorScroll","$window","dialogs","worldTree","beaconManager","lockerManager",function(a,b,c,d,e,f,g,h,i,j,k,l,a,m,n,o,p,q,r,s,t,u,v){b.aperture=f,b.map=g,b.style=h,b.alerts=i,b.userManager=j,b.dialog=s,angular.extend(e,{globalTitle:"Bubbl.li"}),e.hideBack=!0;var w=b.$on("$routeChangeSuccess",_.after(2,function(){e.hideBack=!1,w()}));b.$on("viewTabSwitch",function(a,c){b.viewTab=c}),b.newWorld=function(){b.world={},b.world.newStatus=!0,c.worlds.create(b.world,function(b){a.path("/edit/walkthrough/"+b[0].worldID)})},b.search=function(){1==b.searchOn?(a.path("/search/"+b.searchText),b.searchOn=!1):b.searchOn=!0},b.go=function(b){a.path(b)},b.goBack=function(){r.history.back(),b.$emit("viewTabSwitch","home")},b.logout=function(){n.get("/api/user/logout",{server:!0}),j.loginStatus=!1},b.sendFeedback=function(a){var b={emailText:"FEEDBACK:\n"+p(a)+"\n===\n===\n"+e.userName};n.post("feedback",b).success(function(){alert("Feedback sent, thanks!")}).error(function(){})},b.getNearby=function(a){b.nearbyLoading=!0,t.getNearby().then(function(a){b.altBubbles=a["150m"],b.nearbyBubbles=a["2.5km"],b.nearbyLoading=!1},function(a){b.nearbyLoading=!1}),a.stopPropagation()},b.share=function(b){var c,d=450,e=560,f=(screen.width-e)/2,g=(screen.height-d)/2;"facebook"==b?c="https://www.facebook.com/sharer/sharer.php?u=https://bubbl.li"+a.url():"twitter"==b&&(c="https://twitter.com/intent/tweet?url=https://bubbl.li"+a.url()),window.open(c,"Bubbl.li","height=450,width=558,top="+g+",left="+f+"scrollbars")},b.fbLogin=function(){j.fbLogin().then(function(a){j.checkLogin()},function(a){})},1==u.supported&&u.startListening(),v.getCredentials().then(function(a){a.username,a.password?j.signin(a.username,a.password).then(function(){j.checkLogin().then(function(a){})},function(a){}):a.fbToken&&(ifGlobals.fbToken=a.fbToken,j.checkLogin().then(function(a){}))},function(){})}]),app.directive("exploreView",["worldTree","$rootScope","ifGlobals",function(a,b,c){return{restrict:"EA",scope:!0,link:function(d){d.loadState="loading",d.kinds=c.kinds,b.$on("viewTabSwitch",function(b,c){"explore"===c&&(d.loadState="loading",a.getNearby().then(function(a){d.homeBubbles=a["150m"]||[],d.nearbyBubbles=a["2.5km"]||[],d.loadState="success"},function(){d.loadState="failure"}))})},templateUrl:"components/nav/exploreView.html"}}]),app.directive("navTabs",["$rootScope","$routeParams","$location","worldTree","$document",function(a,b,c,d){return{restrict:"EA",scope:!0,link:function(e){e.selected="home",e.select=function(a){if(e.selected===a&&"home"===a)if(b.worldURL){var d="/w/"+b.worldURL;c.path(c.path()===d?"/":d)}else c.path("/");e.$emit("viewTabSwitch",a)},e.$on("$locationChangeSuccess",function(){e.$emit("viewTabSwitch","home")}),a.$on("viewTabSwitch",function(a,b){e.selected=b}),e.nearbiesLength=function(){return d._nearby?_.reduce(d._nearby,function(a,b){return a+_.size(b)},0):0}},template:'<button class="view-tab home-tab" ng-class="{selected: selected==\'home\'}" ng-click="select(\'home\')"></button><button class="view-tab explore-tab" ng-class="{selected: selected==\'explore\'}" ng-click="select(\'explore\')"><span ng-show="nearbiesLength()>0" class="compass-badge badge" ng-cloak>{{nearbiesLength()}}</span></button><button class="view-tab search-tab" ng-class="{selected: selected==\'search\'}" ng-click="select(\'search\')"></button>'}}]),app.directive("searchView",["$http","geoService",function(a,b){return{restrict:"EA",scope:!0,link:function(c){c.search=function(d){c.lastSearch=d,b.getLocation().then(function(b){c.searching=a.get("/api/textsearch",{server:!0,params:{textQuery:d,userLat:b.lat,userLng:b.lng,localTime:new Date}}).success(function(a){c.searchResult=a.err?[]:a}).error(function(a){})})},c.searchOnEnter=function(a,b){13===a.keyCode&&c.search(b)}},templateUrl:"components/nav/searchView.html"}}]),app.controller("MeetupController",["$scope","$window","$location","styleManager","$rootScope","dialogs",function(a,b,c,d,e,f){var g=d;g.navBG_color="#3d66ca",angular.element("#view").bind("scroll",function(){}),angular.element("#wrap").scroll(_.debounce(function(){a.scroll=this.scrollTop,a.$apply()},20)),a.openSignup=function(){f.showDialog("authDialog.html")}}]),app.controller("WelcomeController",["$scope","$window","$location","styleManager","$rootScope","dialogs",function(a,b,c,d,e,f){var g=d;g.navBG_color="#3d66ca",angular.element("#view").bind("scroll",function(){}),angular.element("#wrap").scroll(_.debounce(function(){a.scroll=this.scrollTop,a.$apply()},20)),a.openSignup=function(){f.showDialog("authDialog.html")}}]),app.controller("LoginCtrl",["$scope","$rootScope","$http","$location","apertureService","alertManager",function(a,b,c,d,e,f){b.showLogout&&d.url("/profile"),a.alerts=f,a.aperture=e,a.aperture.set("off"),a.user={},a.socialLogin=function(b){d.url("/auth/"+b),c.post("/auth/"+b).success(function(){}).error(function(b){b&&a.alerts.addAlert("danger",b)})},a.login=function(){var b={email:a.user.email,password:a.user.password};c.post("/api/user/login",b).success(function(a){a&&d.url("/profile")}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("SignupCtrl",["$scope","$rootScope","$http","$location","apertureService","alertManager",function(a,b,c,d,e,f){a.alerts=f,a.aperture=e,a.aperture.set("off"),a.user={},"messages"==$routeParams.incoming&&(a.showMessages=!0),a.signup=function(){var b={email:a.user.email,password:a.user.password};c.post("/api/user/signup",b).success(function(a){a&&("messages"==$routeParams.incoming?window.history.back():d.url("/profile"))}).error(function(b){b&&a.alerts.addAlert("danger",b)})},a.goBack=function(){window.history.back()}}]),app.controller("ForgotCtrl",["$scope","$http","$location","apertureService","alertManager",function(a,b,c,d,e){a.alerts=e,a.aperture=d,a.aperture.set("off"),a.user={},a.sendForgot=function(){var c={email:a.user.email};b.post("/forgot",c).success(function(){a.alerts.addAlert("success","Instructions for resetting your password were emailed to you"),a.user.email=""}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("ResetCtrl",["$scope","$http","$location","apertureService","alertManager","$routeParams",function(a,b,c,d,e,f){a.alerts=e,a.aperture=d,a.aperture.set("off"),b.post("/resetConfirm/"+f.token).success(function(){}).error(function(a){a&&c.path("/forgot")}),a.sendUpdatePassword=function(){var d={password:a.user.password};b.post("/reset/"+f.token,d).success(function(){c.path("/profile")}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("resolveAuth",["$scope","$rootScope",function(a,b){angular.extend(b,{loading:!0}),location.reload(!0)}]),app.controller("UserController",["$scope","$rootScope","$http","$location","$route","$routeParams","userManager","$q","$timeout","$upload","Landmark","db","alertManager","$interval","ifGlobals","userGrouping",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){a.user&&(g.saveUser(a.user),t.addAlert("success","Your contact info has been successfully saved!",!0))}function r(){function d(){c.get("/api/user/profile",{server:!0}).success(function(b){a.groups=p.groupByTime(b),a.bubbles=b,a.waitingforMeetup=!1})}a.stop=n(d,2e3);var e=b.$on("$locationChangeSuccess",function(){n.cancel(a.stop),e()})}angular.extend(b,{loading:!1}),a.fromMessages=!1,a.state={},a.subnav={profile:["me","contacts","history"],worlds:["worlds","drafts","filter"]},a.files={avatar:void 0},a.kinds=o.kinds,a.spinLeft=!1,a.spinLeftLong=!1;var s=null,t=m;a.$watch("files.avatar",function(c,d){if(void 0!==c){var e=c[0];a.upload=j.upload({url:"/api/upload",method:"POST",file:e,server:!0}).progress(function(b){a.spinLeft=!0}).success(function(c){a.user.avatar=c,b.avatar=c,a.uploadFinished=!0,a.spinLeftLong=!0,i(function(){a.spinLeft=!1,a.spinLeftLong=!1},1e3)})}}),a.update=function(b){a.state.myProfile=a.subnav.profile.indexOf(b)>-1||!b,a.state.myWorlds=a.subnav.worlds.indexOf(b)>-1,a.state.profile="me"==b,a.state.contacts="contacts"==b,a.state.history="history"==b,a.state.worlds="worlds"==b,a.state.drafts="drafts"==b,a.state.template="components/user/templates/"+b+".html",a.state.myProfile&&(a.menuLink="/profile/me"),a.state.myWorlds&&(a.menuLink="/profile/worlds")},a.inspect=function(b){a.selected=b?b:!1},a.inspectEvent=function(b){a.inspect(b.bubble)},a.showCalendar=function(){a.calendarActive?a.calendarActive=!1:a.calendarLoaded?a.calendarActive=!0:(a.calendar={events:p.groupForCalendar(a.bubbles)},a.calendarLoaded=!0,a.calendarActive=!0)},a.calConfig={eventClick:a.inspectEvent};var u=e.current;a.$on("$locationChangeSuccess",function(){u.$$route.originalPath===e.current.$$route.originalPath&&(a.update(e.current.params.tab),e.current=u)}),a.$watchCollection("user",function(a,b){a!=b&&void 0!=b&&(s&&i.cancel(s),s=i(q,1e3))}),a.update(e.current.params.tab),a.waitingforMeetup=!1,"meetup"==f.incoming?(a.fromMeetup=!0,a.waitingforMeetup=!0,c.post("/api/process_meetups").success(function(){r()}).error(function(){angular.extend(b,{loading:!1}),c.get("/api/user/profile",{server:!0}).success(function(b){a.worlds=b,a.waitingforMeetup=!1})})):"messages"==f.incoming?a.fromMessages=!0:c.get("/api/user/profile",{server:!0}).success(function(b){a.groups=p.groupByTime(b),a.bubbles=b}),a.deleteWorld=function(b){var c=confirm("Are you sure you want to delete this?");c&&k.del({_id:a.worlds[b]._id},function(c){a.worlds.splice(b,1)})},a.deleteBubble=function(a){var b=confirm("Are you sure you want to delete this?");b&&k.del({_id:a},function(a){e.reload()})},a.newWorld=function(){t.addAlert("warning","Creating New Bubbles coming soon to the iOS app. For now, login to build through https://bubbl.li",!0)},a.go=function(a){d.path(a)},g.getUser().then(function(b){a.user=b},function(a){d.path("/"),t.addAlert("warning","You're not logged in!",!0)})}]),app.controller("LandmarkController",["World","Landmark","db","$routeParams","$scope","$location","$window","leafletData","$rootScope","apertureService","mapManager","styleManager","userManager","alertManager","$http","worldTree","bubbleTypeService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){function r(a){v.setCenter(e.landmark.loc.coordinates,a,"aperture-half"),y.set("half"),v.removeAllMarkers();var b="img/marker/bubble-marker-50.png",c=[0,-40],d=[17.5,60],f=[35,67];"Retail"===q.get()&&"img/tidepools/default.jpg"!==e.landmark.avatar&&(b=e.landmark.avatar,c=[0,-14],d=[25,25],f=[50,50]),v.addMarker(e.landmark._id,{lat:e.landmark.loc.coordinates[1],lng:e.landmark.loc.coordinates[0],draggable:!1,message:e.landmark.name,icon:{iconUrl:b,shadowUrl:"",iconSize:f,iconAnchor:d,popupAnchor:c},_id:e.landmark._id}),v.setMarkerFocus(e.landmark._id),v.refresh()}function s(a,b){v.localMapArrayExists(a)&&(v.removeOverlays(),setTimeout(function(){t(a,b).forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&v.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)})},200))}function t(a,b){if(v.localMapArrayExists(a)){var c,d=e.world.style.maps.localMapArray;b.loc_info&&b.loc_info.floor_num?c=b.loc_info.floor_num:(lowestFloor=_.chain(d).map(function(a){return a.floor_num}).sortBy(function(a){return a}).filter(function(a){return a}).value(),c=lowestFloor[0]||1);var f=d.filter(function(a){return a.floor_num===c});return f}}var u=angular.element(".leaflet-bottom.leaflet-left")[0];u.style.top="100px",u.style.left="1%";var v=k,w=l,x=n,y=j;e.worldURL=d.worldURL,e.landmarkURL=d.landmarkURL,e.collectedPresents=[],p.getWorld(d.worldURL).then(function(a){e.world=a.world,e.style=a.style,w.navBG_color=e.style.navBG_color,v.loadBubble(a.world),p.getLandmark(e.world._id,d.landmarkURL).then(function(a){e.landmark=a;var b=18,c=t(e.world,a);c&&(b=Number(k.findZoomLevel(t(e.world,a)))),r(b),s(e.world,a),e.style.widgets.presents&&e.landmark.category&&e.landmark.category.hiddenPresent&&e.landmark.category.name&&(e.temp={showInitialPresent:!0,presentCollected:!1,presentAlreadyCollected:!1,showPresentCard:!0},o.get("/api/user/loggedin",{server:!0}).success(function(a){"0"!==a?m.getUser().then(function(a){function b(){e.user.presents.collected.unshift({avatar:e.landmark.category.avatar,landmarkID:e.landmark._id,landmarkName:e.landmark.name,worldID:e.world._id,worldName:e.world.name,categoryname:e.landmark.category.name}),m.saveUser(e.user),e.temp.presentCollected=!0,e.temp.showIntialPresent=!1,x.addAlert("success","You found a present!",!0),c()}function c(){var a=e.world.landmarkCategories.filter(function(a){return 1==a.present}).length,b=e.user.presents.collected.filter(function(a){return a.worldID==e.world._id}).length;a==b?(e.temp.finalPresent=!0,e.temp.showInitialPresent=!1,e.temp.presentCollected=!1,e.temp.presentAlreadyCollected=!1):e.presentsLeft=a-b}e.user=a,e.user.presents||(e.user.presents={collected:[]});
for(var d=!1,f=0;f<e.user.presents.collected.length;f++)if((e.user.presents.collected[f].landmarkID==e.landmark._id||e.user.presents.collected[f].categoryname==e.landmark.category.name)&&e.user.presents.collected[f].worldID==e.world._id){d=!0,e.temp.presentAlreadyCollected=!0,e.temp.showInitialPresent=!1;break}d?c():b();for(var f=0;f<e.user.presents.collected.length;f++)e.user.presents.collected[f].worldID==e.world._id&&e.collectedPresents.push(e.user.presents.collected[f].categoryname)}):e.temp.signupCollect=!0}))})})}]),app.directive("messageView",function(){return{restrict:"E",link:function(a,b){function c(b){return m("li.message",{key:b._id,"class":b.userID===a.userID?"message-self":"",onclick:function(){a.messageLink(b)}},[m("picture.message-avatar",m("img.small-avatar",{src:e(b.avatar)||"img/icons/profile.png"})),m("h6.message-heading",b.nick||"Visitor"),d(b)])}function d(b){var c,d=b.kind||"text";switch(d){case"text":c=m(".message-body",b.msg);break;case"pic":c=[m("img.img-responsive",{src:b.pic,onload:f}),m(".message-body")];break;case"sticker":c=[m(".message-sticker-background",[m("img.message-sticker-img",{src:b.sticker.img}),m("img.message-sticker-link",{src:"img/icons/ic_map_48px.svg"})]),m(".message-body",b.msg)];break;case"editUser":c=[m(".message-body",b.msg),m("hr.divider"),m("img.msg-chip-img",{src:e(a.user.avatar)}),m(".msg-chip-label",a.nick),m("img.msg-chip-edit",{src:"img/icons/ic_edit_grey600.png"})]}return m(".message-content",c)}function e(a){return void 0===a?"":a.indexOf("http")>-1?a:"https://bubbl.li/"+a}function f(){b[0].scrollTop=b[0].scrollTop+this.offsetHeight}a.$watchCollection("messages",function(a){m.render(b[0],a.map(c))})}}}),app.controller("MessagesController",["$location","$scope","$sce","db","$rootScope","$routeParams","apertureService","$http","$timeout","worldTree","$upload","styleManager","alertManager","dialogs","userManager","mapManager","ifGlobals","leafletData","stickerManager",function(a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t){function u(){j(function(){J.animate({scrollTop:2*J[0].scrollHeight},300)},0),1==L&&(L=!1,z())}function v(){var a=L;d.messages.query({roomID:b.world._id,sinceID:K},function(c){if(J[0].scrollHeight-J.scrollTop()-J.outerHeight()<50&&(a=!0),c.length>0){for(i=0;i<c.length;i++)-1==b.localMessages.indexOf(c[i]._id)&&c[i]._id&&b.messages.push(c[i]);K=c[c.length-1]._id,v()}else E=j(v,3e3),a&&u()})}function w(a){h.post("/api/worldchat/create",a,{server:!0}).success(function(c){K=c[0]._id,a._id=c[0]._id,b.messages.push(a),b.localMessages.push(c[0]._id),u()}).error(function(){})}function x(){return b.user.avatar||"img/icons/profile.png"}function y(){var a={roomID:b.world._id,nick:"BubblyBot",msg:"Hey there, this is a Bubble chat created just for "+b.world.name+". Chat, share pictures & leave notes with others here!",avatar:b.world.avatar||"img/tidepools/default.png",userID:"chatbot",_id:"welcomeMessage"};b.messages.push(a)}function z(){var a={roomID:b.world._id,nick:"BubblyBot",kind:"editUser",msg:"You are currently using the name "+b.nick+". Click here to edit it.",avatar:b.world.avatar||"img/tidepools/default.png",userID:"chatbot",_id:"profileEditMessage",href:"profile/me/messages"};b.messages.push(a)}function A(){b.world.hasOwnProperty("loc")&&b.world.loc.hasOwnProperty("coordinates")&&(I.setCenter([b.world.loc.coordinates[0],b.world.loc.coordinates[1]],18,b.aperture.state),I.addMarker("c",{lat:b.world.loc.coordinates[1],lng:b.world.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+b.world.id+'/">'+b.world.name+"</a>"})),b.world.style.hasOwnProperty("maps")&&(b.world.style.maps.localMapID&&I.addOverlay(b.world.style.maps.localMapID,b.world.style.maps.localMapName,b.world.style.maps.localMapOptions),b.world.style.maps.hasOwnProperty("localMapOptions")&&(zoomLevel=b.world.style.maps.localMapOptions.maxZoom||19),I.setBaseLayer(tilesDict.hasOwnProperty(b.world.style.maps.cloudMapName)?tilesDict[b.world.style.maps.cloudMapName].url:b.world.style.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+b.world.style.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"))}function B(){t.getStickers({_id:b.world._id}).then(function(a){C(a)})}function C(a){a.forEach(function(a){D(a)})}function D(a){q.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:a.iconInfo.iconUrl,shadowUrl:"",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]},message:'<div class="avatarWrapper"><img class="user-chip-img user-map-img" src="'+x()+'"/><strong>'+b.nick+'</strong></div><p class="user-map-text">'+a.message+"</p>"})}var E,F=n,G=m,H=g,I=q;H.set("off");var J=$(".message-list");b.loggedIn=!1,b.nick="Visitor",b.msg={},b.messages=[],b.localMessages=[],b.stickers=r.stickers,b.editing=!1;var K="none",L=!0;b.toggleMap=function(){b.editing&&(b.editing=!1),H.toggle("full")},b.sendMsg=function(a){if(b.editing)return void b.pinSticker();if(a&&a.preventDefault(),null!=b.msg.text&&p.loginStatus){var c={roomID:b.world._id,nick:b.nick,msg:b.msg.text,avatar:b.user.avatar||"img/icons/profile.png",userID:b.userID};w(c),b.msg.text=""}},b.alert=function(a){F.addAlert("warning",a,!0)},b.onImageSelect=function(a){b.uploading=!0,b.uploadProgress=0,b.upload=l.upload({url:"/api/uploadPicture",file:a[0]}).progress(function(a){b.uploadProgress=parseInt(100*a.loaded/a.total)}).success(function(a){w({roomID:b.world._id,userID:b.userID,nick:b.nick,avatar:b.user.avatar||"img/icons/profile.png",msg:"",pic:a,kind:"pic"}),b.uploading=!1})},b.showStickers=function(){b.editing=!0,H.set("full")},b.selectSticker=function(a){b.selected=a,b.stickerChange=!0,b.msg.text=a.name,j(function(){b.stickerChange=!1},500)},b.messageLink=function(c){c.sticker?(H.set("full"),t.getSticker(c.sticker._id).then(function(a){I.setCenter(a.loc.coordinates,18,b.aperture.state),I.hasMarker(a._id)?I.setMarkerFocus(a._id):D(a)})):c.href&&a.path(c.href)},b.pinSticker=function(){var a=angular.copy(b.selected),c=Math.max(document.documentElement.clientHeight,window.innerHeight||0),d=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e=d/2,f=(c-220-40)/2+40;s.getMap().then(function(c){var d=c.containerPointToLatLng([e,f]);a.loc={coordinates:[d.lng,d.lat]},a.time=Date.now(),a.roomID=b.world._id,a.message=b.msg.text||a.name,a.avatar=b.user.avatar,t.postSticker(a).then(function(c){D(c),j(function(){w({roomID:b.world._id,userID:b.userID,nick:b.nick,avatar:b.user.avatar||"img/icons/profile.png",msg:b.msg.text||a.name,sticker:{img:a.img,_id:c._id},kind:"sticker"}),b.msg.text=""},500)},function(a){})}),b.selected=void 0,b.editing=!1,H.set("off")};var M=e.$on("$locationChangeSuccess",function(){j.cancel(E),M()});b.$watch("editing",function(a){a===!0?I.fadeMarkers(!0):a===!1&&I.fadeMarkers(!1)}),k.getWorld(f.worldURL).then(function(a){b.style=a.style,G.navBG_color=b.style.navBG_color,b.world=a.world,A(),y(),B(),v()}),p.getUser().then(function(a){b.user=a,b.nick=p.getDisplayName()},function(){o.showDialog("messageAuthDialog.html")})}]),app.controller("InstagramListController",["$scope","$routeParams","styleManager","worldTree","db",function(a,b,c,d,e){d.getWorld(b.worldURL).then(function(b){a.world=b.world,a.style=b.style,c.navBG_color=a.style.navBG_color,a.instagrams=e.instagrams.query({limit:30,tag:a.world.resources.hashtag})})}]),app.directive("scheduleView",function(){return{restrict:"E",link:function(a,b){function c(a){a?(m.render(b[0],d(a)),l=a):l&&m.render(b[0],d(l))}function d(a){var b=_.map(a,e);return b}function e(a){var b=_.pairs(a)[0],c=b[0],d=b[1];return _.isEmpty(d)?void 0:m("section.bubble-supergroup",{className:n[c]?"closed":""},[m("button.bubble-supergroup-label",{onclick:f.bind(void 0,c)},c)].concat(_.map(d,g)))}function f(a){n[a]=!n[a],c()}function g(a){var b=_.pairs(a)[0],c=b[0],d=b[1];return m("div.bubble-group",[m("header.bubble-group-label",c),m("ul.bubble-list",_.map(d,h))])}function h(b){return m("li.bubble-list-item",m("a.bubble-list-item-link",{href:k("#w/"+a.world.id+"/"+b.id)},[m("img.bubble-list-item-img",{src:b.avatar}),m("span.bubble-list-item-label",[b.name,m("small",b.category)]),m("footer.bubble-list-item-detail",i(b)),m("footer.bubble-list-item-room-info",j(b))]))}function i(a){return[m("span",a.time.start&&"Starts "+moment(a.time.start).format("ddd, MMM Do, hA")),m("span",a.time.end&&"Ends "+moment(a.time.end).format("ddd, MMM Do, hA"))]}function j(a){return a.loc_info?[m("span","Floor: "+a.loc_info.floor_num),m("span","Room: "+a.loc_info.room_name)]:[]}function k(a){var b=a.indexOf("#");return b>-1?a.slice(0,b)+a.slice(b+1):a}a.$watchCollection("schedule",function(a){c(a)});var l,n={Upcoming:!0,Places:!0,Previous:!0}}}}),app.controller("ScheduleController",["$scope","worldTree","$routeParams","styleManager","$window","$location",function(a,b,c,d,e,f){function g(b){a.calendar={events:b.filter(function(a){return a.time.start}).map(function(a){return{id:a._id,title:a.name,start:moment(a.time.start),end:moment(a.time.end),landmark:a}})}}function h(b){function c(a){var b;return a.time.start?(b=moment(a.time.start),b.isBefore(f)?"Previous":b.isSame(f,"day")?"Today":b.isBefore(moment().add(7,"days"))?"This Week":"Upcoming"):"Places"}function d(a,b){var c;switch(b){case"This Week":if(c=moment(a.time.start),c.isSame(f))return 0;if(c.isSame(moment().add(1,"day"),"day"))return 1;if(c.isSame(moment().add(2,"day"),"day"))return 2;if(c.isSame(moment().add(3,"day"),"day"))return 3;if(c.isSame(moment().add(4,"day"),"day"))return 4;if(c.isSame(moment().add(5,"day"),"day"))return 5;if(c.isSame(moment().add(6,"day"),"day"))return 6;break;case"Today":return"Today";case"Upcoming":return c=moment(a.time.start),c.isBefore(moment().add(2,"week"))?"Next Week":c.isSame(f,"month")?"This Month":c.isBefore(moment().add(2,"month"))?"Next Month":c.isSame(f,"year")?"This Year":"Upcoming";case"Previous":return c=moment(a.time.start),c.isAfter(moment().subtract(2,"day"))?"Yesterday":c.isAfter(moment().subtract(1,"week"))?"Last Week":c.isAfter(moment().subtract(1,"month"))?"Last Month":c.isAfter(moment().subtract(1,"year"))?"Last Year":"Past";case"Places":return"Places"}}function e(a){return 1==a?"Tomorrow":2==a?moment().add(2,"day").format("dddd, MMMM Do"):3==a?moment().add(3,"day").format("dddd, MMMM Do"):4==a?moment().add(4,"day").format("dddd, MMMM Do"):5==a?moment().add(5,"day").format("dddd, MMMM Do"):6==a?moment().add(6,"day").format("dddd, MMMM Do"):void 0}var f=moment(),g={Upcoming:{},"This Week":{},Today:{},Previous:{},Places:{}},h={Upcoming:0,"This Year":10,"Next Month":20,"This Month":30,"Next Week":40,"This Week":50,6:55,5:56,4:57,3:58,2:59,1:60,Today:70,Yesterday:80,"Last Week":90,"Last Month":100,"Last Year":110,Past:120,Places:130};_.each(b,function(a){var b=c(a),e=d(a,b);g[b][e]?g[b][e].push(a):g[b][e]=[a]}),_.each(g,function(a,b,c){"Places"!==b&&_.each(a,function(a,b,c){c[b]=_.sortBy(a,function(a){moment(a.time.start).unix()})}),c[b]=_.sortBy(_.map(a,function(a,b){var c={};return c[b]=a,c}),function(a){var b=_.keys(a)[0];return h[b]})}),g["This Week"].length>0&&(g["This Week"]=_.map(g["This Week"],function(a){var b=_.pairs(a)[0],c=e(b[0]),a=b[1],d={};return d[c]=a,d})),a.schedule=[{Upcoming:g.Upcoming},{"This Week":g["This Week"]},{Today:g.Today},{Places:g.Places},{Previous:g.Previous}]}a.schedule=[];a.showCalendar=function(){a.calendarActive?a.calendarActive=!1:(a.calendarActive=!0,i())},a.inspectLandmark=function(b){f.path("w/"+a.world.id+"/"+b.landmark.id)},a.calConfig={height:360,eventClick:a.inspectLandmark,defaultView:"agendaWeek"};var i=_.throttle(function(){a.calConfig.height=j.height()-116,a.calConfig.defaultView=j.width()<600?"agendaDay":"agendaWeek"},100),j=$(e);j.on("resize",i),b.getWorld(c.worldURL).then(function(b){return a.world=b.world,a.style=b.style,d.navBG_color=a.style.navBG_color,a.world._id}).then(function(a){return b.getLandmarks(a)}).then(function(b){a.landmarks=b,g(b),h(b)})}]),app.filter("httpsify",function(){return function(a){return a=a||"",a.replace(/^http:\/\//i,"https://")}}),app.controller("TwitterListController",["$scope","$routeParams","styleManager","worldTree","db",function(a,b,c,d,e){d.getWorld(b.worldURL).then(function(b){a.world=b.world,a.style=b.style,c.navBG_color=a.style.navBG_color,a.tweets=e.tweets.query({limit:50,tag:a.world.resources.hashtag})})}]),app.directive("categoryWidget",[function(){return{restrict:"E",link:function(a,b){function c(a){return m(".category-widget",d(a))}function d(a){return a.length<4?e(a):4===a.length?[e(a.slice(0,2)),e(a.slice(2))]:[e(a.slice(0,3)),e(a.slice(3))]}function e(a){return m(".category-btn-group",a.map(f))}function f(b,c,d){return m(".category-btn",{style:{width:100/d.length+"%"},colspan:6/d.length,onclick:g(b.name),"class":a.selectedCategory===b.name?"selected-category":null},[b.avatar?m("img.category-btn-img",{src:b.avatar}):null,b.name])}function g(b){return function(c){c.stopPropagation(),a.$emit("landmarkCategoryChange",b)}}a.$watchGroup(["world.landmarkCategories","selectedCategory"],function(){m.render(b[0],c(a.world.landmarkCategories))})}}}]),app.controller("WorldController",["World","db","$routeParams","$scope","$location","leafletData","$rootScope","apertureService","mapManager","styleManager","$sce","worldTree","$q","$http","userManager","stickerManager","geoService","bubbleTypeService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(){function a(){d.world.loc&&d.world.loc.coordinates&&d.world.loc.coordinates.length&&(d.streetviewLoc=d.world.loc.coordinates[1]+","+d.world.loc.coordinates[0]+c)}if(d.style.widgets){if(1==d.style.widgets.twitter&&(d.twitter=!0),1==d.style.widgets.instagram&&(d.instagrams=b.instagrams.query({limit:1,tag:d.world.resources.hashtag}),d.instagram=!0),1==d.style.widgets.streetview){var c="&key=AIzaSyDbEMuXZS67cFLAaTtmrKjFNlrdNm1H-KE";if(d.streetview=!0,d.world.source_meetup)if(d.world.source_meetup.venue)if(d.world.source_meetup.venue.address_1){var f=[];typeof d.world.source_meetup.venue.address_1&&f.push(d.world.source_meetup.venue.address_1),typeof d.world.source_meetup.venue.address_2&&f.push(d.world.source_meetup.venue.address_2),typeof d.world.source_meetup.venue.city&&f.push(d.world.source_meetup.venue.city),typeof d.world.source_meetup.venue.state&&f.push(d.world.source_meetup.venue.state),typeof d.world.source_meetup.venue.zip&&f.push(d.world.source_meetup.venue.zip),typeof d.world.source_meetup.venue.country&&f.push(d.world.source_meetup.venue.country),f=f.join("+").replace(/ /g,"+"),d.streetviewLoc=f+c}else a();else a();else if(d.world.source_yelp)if(d.world.source_yelp.locationInfo)if(d.world.source_yelp.locationInfo)if(d.world.source_yelp.locationInfo.address){var f=[];typeof d.world.source_yelp.locationInfo.address&&f.push(d.world.source_yelp.locationInfo.address),typeof d.world.source_yelp.locationInfo.city&&f.push(d.world.source_yelp.locationInfo.city),typeof d.world.source_yelp.locationInfo.state_code&&f.push(d.world.source_yelp.locationInfo.state_code),typeof d.world.source_yelp.locationInfo.postal_code&&f.push(d.world.source_yelp.locationInfo.postal_code),typeof d.world.source_yelp.locationInfo.country_code&&f.push(d.world.source_yelp.locationInfo.country_code),f=f.join("+").replace(/ /g,"+"),d.streetviewLoc=f+c}else a();else a();else a();else a()}d.style.widgets.presents&&d.world.landmarkCategories&&(d.temp={showInitialPresent:!0,presentCollected:!1,presentAlreadyCollected:!1,presents:!0},n.get("/api/user/loggedin",{server:!0}).success(function(a){"0"!==a?o.getUser().then(function(a){function b(){var a=d.world.landmarkCategories.filter(function(a){return 1==a.present}).length,b=d.user.presents.collected.filter(function(a){return a.worldID==d.world._id}).length;a==b?(d.temp.finalPresent=!0,d.temp.showInitialPresent=!1,d.temp.presentCollected=!1,d.temp.presentAlreadyCollected=!1):d.presentsLeft=a-b}if(d.user=a,d.user.presents.collected){for(var c=0;c<d.user.presents.collected.length;c++)d.user.presents.collected[c].worldID==d.world._id&&d.collectedPresents.push(d.user.presents.collected[c].categoryname);b()}}):d.temp.signupCollect=!0})),(1==d.style.widgets.messages||1==d.style.widgets.chat)&&(d.messages=!0,b.messages.query({limit:1,roomID:d.world._id},function(a){a.length>0&&(d.msg=a[0])})),d.style.widgets.category&&(d.category=!0)}d.world.resources&&(d.tweets=b.tweets.query({limit:1,tag:d.world.resources.hashtag})),1==d.style.widgets.nearby&&(d.nearby=!0,d.loadState="loading",l.getNearby().then(function(a){if(a||(d.loadState="failure"),a["150m"].length>0||a["2.5km"].length>0){a["150m"].length>0&&a["2.5km"].length>0?d.nearbyBubbles=a["150m"].concat(a["2.5km"]):a["150m"].length>0&&a["2.5km"].length<0?d.nearbyBubbles=a["150m"]:a["150m"].length<0&&a["2.5km"].length>0?d.nearbyBubbles=a["2.5km"]:d.loadState="failure";for(var b=0;b<d.nearbyBubbles.length;b++)d.nearbyBubbles[b]._id==d.world._id&&d.nearbyBubbles.splice(b,1);d.nearbyBubbles.length>3&&(d.nearbyBubbles.length=3)}d.loadState="success"}),d.findRandom=function(){d.loadState="loading",q.getLocation().then(function(a){n.get("/api/find/random",{params:{userCoordinate:[a.lng,a.lat],localTime:new Date},server:!0}).success(function(a){a.length>0?a[0].id&&e.path("/w/"+a[0].id):d.loadState="success"})})})}function t(a){var b=moment(),c=_.groupBy(a.landmarks,function(a){if(!a.time.start)return"Places";var c=moment(a.time.start),d=moment(a.time.end)||moment(c).add(1,"hour");return b.isAfter(c)&&b.isBefore(d)?"Now":b.isBefore(c)?b.isSame(c,"day")?"Today":"Upcoming":b.isAfter(c)?"Past":void 0});if(d.places=c.Places||[],d.upcoming=_.compact([].concat(c.Upcoming,c.Today)),d.past=c.Past||[],d.now=c.Now||[],d.landmarks=a.landmarks||[],d.today=c.Today||[],d.now.length>0)var e=[].concat(d.places,d.now);else if(d.today.length>0)var e=[].concat(d.places,d.today);else var e=[].concat(d.places);i.addMarkers(e.map(u))}function u(a){var b="img/marker/bubble-marker-50.png",c=[0,-40],e="",f=[4,-3],g=[17,67],h=[35,67];return"Retail"===r.get()&&"img/tidepools/default.jpg"!==a.avatar&&(b=a.avatar,c=[0,-14],g=[25,25],h=[50,50]),{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:'<a if-href="#w/'+d.world.id+"/"+a.id+'">'+a.name+"</a>",icon:{iconUrl:b,shadowUrl:e,shadowAnchor:f,iconSize:h,iconAnchor:g,popupAnchor:c},_id:a._id}}var v=angular.element(".leaflet-bottom.leaflet-left")[0];v.style.top="60px",v.style.left="1%",v.style.display="none";var w=i;w.resetMap();var x=j;d.worldURL=c.worldURL,d.aperture=h,d.aperture.set("third"),d.world={},d.landmarks=[],d.lookup={},d.collectedPresents=[],d.selectedIndex=0;d.zoomOn=function(){v.style.display="block"},d.loadWorld=function(a){d.world=a.world,d.style=a.style,x.navBG_color=d.style.navBG_color,g.userID&&d.world.permissions&&(d.showEdit=g.userID==d.world.permissions.ownerID?!0:!1),d.world.name&&angular.extend(g,{globalTitle:d.world.name}),(d.world.description||d.world.summary)&&(d.description=!0,d.descriptionType=d.world.description?"description":"summary");var b=18;d.world.style.hasOwnProperty("maps")&&d.world.style.maps.hasOwnProperty("localMapOptions")&&(d.world.style.maps.localMapArray?d.world.style.maps.localMapArray.length>0&&(b=i.findZoomLevel(d.world.style.maps.localMapArray)):b=d.world.style.maps.localMapOptions.minZoom||18),d.world.hasOwnProperty("loc")&&d.world.loc.hasOwnProperty("coordinates")&&(w.setCenter([d.world.loc.coordinates[0],d.world.loc.coordinates[1]],b,d.aperture.state),w.addMarker("c",{lat:d.world.loc.coordinates[1],lng:d.world.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+d.world.id+'/">'+d.world.name+"</a>"}));var c=d.world.style;if(c.hasOwnProperty("maps")){var e=[c.maps];c.maps.localMapArray&&c.maps.localMapArray.length>0&&(e=w.findMapFromArray(c.maps.localMapArray)),w.removeOverlays(),setTimeout(function(){e.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&w.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)})},100),c.maps.hasOwnProperty("localMapOptions")&&(b=Number(c.maps.localMapOptions.maxZoom)||22),w.setBaseLayer(tilesDict.hasOwnProperty(c.maps.cloudMapName)?tilesDict[c.maps.cloudMapName].url:c.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+c.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png")}d.loadLandmarks()},d.loadLandmarks=function(){l.getLandmarks(d.world._id).then(function(a){t({landmarks:a}),s()})},d.$on("landmarkCategoryChange",function(a,b){function c(a){return a.category===b}var e=d.landmarks.filter(c).map(u);e.length>0&&(w.setCenterFromMarkers(e),w.setMarkers(e),d.aperture.set("full"),d.selectedCategory=b)}),l.getWorld(c.worldURL).then(function(a){d.loadWorld(a)},function(a){})}]);
=======
function LandmarkNewCtrl(a,b,c,d,e){function f(a,c){"edit"==a&&(b.landmark.newStatus=!1,b.landmark.landmarkID=c,d.landmarks.create(b.landmark,function(a){})),void 0===a&&(b.landmark.newStatus=!0,b.landmark.parentID=b.worldID,d.landmarks.create(b.landmark,function(a){b.landmarkID=a[0]._id}))}b.landmarkID,b.worldID="029345823045982345",b.landmark={stats:{avatar:"img/tidepools/default.jpg"}},b.landmark.loc=[-74.0059,40.7127],b.landmark.name="Default",f(),shelfPan("return"),e.showSwitch=!1,e.showBack=!1,e.showBackPage=!1,""==c.type||"place"==c.type||"event"==c.type||"job"==c.type||a.path("/new");var g=new Date;b.subTypes=[],"event"==c.type&&(b.subTypes=b.subTypes.concat(eventCategories)),"place"==c.type&&(b.subTypes=b.subTypes.concat(placeCategories)),b.addEndDate=function(){b.landmark.date.end=b.landmark.date.start},angular.extend(b,{center:{lat:40.7615,lng:-73.9769,zoom:17},markers2:{m:{lat:40.7615,lng:-73.9769,message:"Drag to Location on map",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),angular.element("#fileupload").fileupload({url:"/api/upload_maps",paramName:coords_text,dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,c){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+c.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+c.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),b.landmark.stats.avatar=c.result,b.mapIMG=c.result}}),b.buildMap=function(){var a={worldID:"53c4a0ab0ee5d8ccfa68a034",nw_loc_lng:-73.99749,nw_loc_lat:40.75683,sw_loc_lng:-73.99749,sw_loc_lat:40.7428,ne_loc_lng:-73.98472,ne_loc_lat:40.75683,se_loc_lng:-73.98472,se_loc_lat:40.7428},c=JSON.stringify(a),d={mapIMG:b.mapIMG,coords:c};$http.post("/api/build_map",d).success(function(a){})},b.locsearch=function(){var a=new google.maps.Geocoder;a&&a.geocode({address:b.landmark.location},function(a,c){c==google.maps.GeocoderStatus.OK&&b.$apply(function(){angular.extend(b,{center:{lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng(),zoom:global_mapCenter.zoom},markers2:{m:{lat:a[0].geometry.location.lat(),lng:a[0].geometry.location.lng(),message:"Drag to Location",focus:!0,draggable:!0}}})})})},b.save=function(){function c(a){var b=a,c=b.indexOf("T");return b.substring(0,-1!=c?c:b.length)}b.landmark.date.end||(b.landmark.date.end=b.landmark.date.start),b.landmark.datetext={start:b.landmark.date.start,end:b.landmark.date.end},b.landmark.date.start=new Date(b.landmark.date.start).toISOString(),b.landmark.date.end=new Date(b.landmark.date.end).toISOString(),b.landmark.date.start=c(b.landmark.date.start),b.landmark.date.end=c(b.landmark.date.end),b.landmark.date.start=b.landmark.date.start.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),b.landmark.date.end=b.landmark.date.end.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),b.landmark.time.start||(b.landmark.time.start="00:00"),b.landmark.time.end||(b.landmark.time.end="23:59"),b.landmark.timetext={start:b.landmark.time.start,end:b.landmark.time.end},b.landmark.loc=[b.markers2.m.lat,b.markers2.m.lng],d.landmarks.create(b.landmark,function(b){a.path("/post/"+b[0].id+"/new")})},b.landmark={stats:{avatar:"img/tidepools/default.jpg"},type:c.type,date:{start:g}},b.landmark.loc=[]}function LandmarkEditCtrl(a,b,c,d,e,f,g){g.showSwitch=!1,shelfPan("return"),a.get({_id:d.landmarkId},function(a){c.landmark=a,a.loc_nicknames&&(c.landmark.location=a.loc_nicknames),c.landmark.idCheck=a.id,c.subTypes=[],"event"==a.type&&(c.subTypes=c.subTypes.concat(eventCategories)),"place"==a.type&&(c.subTypes=c.subTypes.concat(placeCategories)),"event"==a.type&&(c.landmark.date={start:a.timetext.datestart,end:a.timetext.dateend},c.landmark.time={start:a.timetext.timestart,end:a.timetext.timeend}),angular.extend(g,{markers:{}}),angular.extend(g,{center:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],zoom:17},markers:{m:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],message:"Drag to Location on map",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),$('<img src="'+c.landmark.stats.avatar+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")})});new Date;c.addEndDate=function(){c.landmark.date.end=c.landmark.date.start},angular.element("#fileupload").fileupload({url:"/api/upload",dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,b){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+b.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+b.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),c.landmark.stats.avatar=b.result}}),c.save=function(){function a(a){var b=a,c=b.indexOf("T");return b.substring(0,-1!=c?c:b.length)}"event"==c.landmark.type&&(c.landmark.date.end||(c.landmark.date.end=c.landmark.date.start),c.landmark.datetext={start:c.landmark.date.start,end:c.landmark.date.end},c.landmark.date.start=new Date(c.landmark.date.start).toISOString(),c.landmark.date.end=new Date(c.landmark.date.end).toISOString(),c.landmark.date.start=a(c.landmark.date.start),c.landmark.date.end=a(c.landmark.date.end),c.landmark.date.start=c.landmark.date.start.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),c.landmark.date.end=c.landmark.date.end.replace(/(\d+)-(\d+)-(\d+)/,"$2-$3-$1"),c.landmark.time.start||(c.landmark.time.start="00:00"),c.landmark.time.end||(c.landmark.time.end="23:59"),c.landmark.timetext={start:c.landmark.time.start,end:c.landmark.time.end}),c.landmark.loc=[g.markers.m.lat,g.markers.m.lng],e.landmarks.create(c.landmark,function(a){b.path("/post/"+a[0].id+"/new")})},c.delete=function(){var b=confirm("Are you sure you want to delete this item?");b&&a.del({_id:c.landmark._id},function(){})}}function WorldEditCtrl(){}function UserViewCtrl(){}function WorldMakerCtrl(a,b,c,d,e,f){function g(){f.getMap("worldDetailMap").then(function(a){a.invalidateSize()})}function h(a){userLat=a.coords.latitude,userLon=a.coords.longitude,b.center={lat:userLat,lng:userLon,zoom:12},b.tiles=tilesDict.mapbox,b.markers={m:{lat:userLat,lng:userLon,message:"<p style='color:black;'>Drag to Location on map</p>",focus:!0,draggable:!0,icon:local_icons.yellowIcon}},g()}function i(){}function j(a){b.hasTime=!1,b.world.loc=[b.markers.m.lat,b.markers.m.lng],b.world.userID=b.userID,"edit"==a?(b.world.newStatus=!1,b.world.worldID=b.worldID,d.worlds.create(b.world,function(a){})):"map"==a?(b.mapping.editMap=!0,b.mapping.worldID=b.worldID,d.worlds.create(b.mapping,function(a){})):(b.world.newStatus=!0,d.worlds.create(b.world,function(a){b.worldID=a[0].worldID,b.projectID=a[0].projectID,b.styleID=a[0].styleID,b.worldURL=a[0].worldURL}))}function k(){b.styles.styleID=b.styleID,d.styles.create(b.styles,function(a){})}f.getMap("worldDetailMap");b.userID="53ab92d2ac23550e12600011",b.username="interfoundry",b.worldID,b.worldURL,b.styleID,b.projectID,b.pageIndex=0,b.pageClass=[],b.pageClass[0]="current",b.pageClass[1]="right",b.pageClass[2]="right",b.pageClass[3]="right",b.pageClass[4]="right",b.mapConfirm="false",b.world={stats:{avatar:"img/tidepools/default.jpg"}},b.mapping={},b.styles={},b.project={},b.mapThemes=[{name:"urban"},{name:"fairy"},{name:"sunset"},{name:"arabesque"}],b.mapping.mapThemeSelect=b.mapThemes[0],b.markerOptions=[{name:"red"},{name:"orange"},{name:"yellow"},{name:"green"},{name:"blue"},{name:"purple"}],b.mapping.markerSelect=b.markerOptions[0],b.bgColor="#CCC",angular.extend(b,{worldDetailPaths:{}}),$(".color").spectrum({clickoutFiresChange:!0}),angular.element("#fileupload").fileupload({url:"/api/upload",dataType:"text",progressall:function(a,b){$("#progress .bar").css("width","0%");var c=parseInt(b.loaded/b.total*100,10);$("#progress .bar").css("width",c+"%")},done:function(a,c){$("#uploadedpic").html(""),$("#preview").html(""),$("<p/>").text("Saved: "+c.originalFiles[0].name).appendTo("#uploadedpic"),$('<img src="'+c.result+'">').load(function(){$(this).width(150).height(150).appendTo("#preview")}),b.world.stats.avatar=c.result}}),b.nextPage=function(){b.pageIndex<b.pageClass.length-1&&(b.pageClass[b.pageIndex]="left",0==b.pageIndex&&(b.worldID?j("edit"):j()),1==b.pageIndex&&j("map"),3==b.pageIndex&&k(),b.pageIndex+=1,b.pageClass[b.pageIndex]="current")},b.prevPage=function(){b.pageIndex>0&&(b.pageClass[b.pageIndex]="right",b.pageIndex=b.pageIndex-1,b.pageClass[b.pageIndex]="current")},b.maplocsearch=function(a){if(13==a.keyCode){var c=new google.maps.Geocoder;c&&c.geocode({address:b.locsearchbar},function(a,c){c==google.maps.GeocoderStatus.OK&&(b.center.lat=a[0].geometry.location.lat(),b.center.lng=a[0].geometry.location.lng(),b.markers.m.lat=a[0].geometry.location.lat(),b.markers.m.lng=a[0].geometry.location.lng())})}},b.mapLock=function(){b.mapConfirm?(b.markers.m.draggable=!1,b.worldDetailPaths={},b.worldDetailPaths.circle={type:"circle",radius:5e3,latlngs:{lat:b.markers.m.lat,lng:b.markers.m.lng}}):b.markers.m.draggable=!0},navigator.geolocation&&(navigator.geolocation.getCurrentPosition(h,i,{timeout:5e4}),g()),b.myData={link:"http://google.com",modalShown:!1,hello:"world",foo:"bar"},b.logClose=function(){},b.toggleModal=function(){b.myData.modalShown=!b.myData.modalShown}}function UserCtrl(a,b,c,d){b.userID="53ab92d2ac23550e12600011",b.username="interfoundry",b.worlds=d.worlds.query({queryType:"all",userID:"539533e5d22c979322000001"},function(a){})}function shelfPan(a,b){"return"==a&&($("body").hasClass("lense2")&&($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"})),$("body").hasClass("lense")&&($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"}))),"full"==a&&($("body").hasClass("lense")?"navbar"==b?(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense2"),$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"})):($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"183px"})):$("body").hasClass("lense2")?(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense2"),$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"})):(he=$(window).height(),he-="navbar"==b?72:172,$("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY("+he+"px)","-moz-transform":"translateY("+he+"px)","-ms-transform":"translateY("+he+"px)","-o-transform":"translateY("+he+"px)",transform:"translateY("+he+"px)"}),$("#leafletmap").css({height:he+"px"}))),"partial"==a&&($("body").hasClass("lense")?($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"149px"})):$("body").hasClass("lense2")?($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(0px)","-moz-transform":"translateY(0px)","-ms-transform":"translateY(0px)","-o-transform":"translateY(0px)",transform:"translateY(0px)"}),$("#leafletmap").css({height:"149px"})):($("body").toggleClass("lense2"),$("#shelf").css({"-webkit-transform":"translateY(149px)","-moz-transform":"translateY(149px)","-ms-transform":"translateY(149px)","-o-transform":"translateY(149px)",transform:"translateY(149px)"}),$("#leafletmap").css({height:"149px"}))),"new"==a&&($("body").toggleClass("lense"),$("#shelf").css({"-webkit-transform":"translateY(250px)","-moz-transform":"translateY(250px)","-ms-transform":"translateY(250px)","-o-transform":"translateY(250px)",transform:"translateY(250px)"}),$("#leafletmap").css({height:"250px"}))}function NearbyCtrl(a,b,c,d,e,f,g,h,i){function j(){b.showNoLoc=!0,angular.extend(e,{loading:!1}),b.$apply()}function k(a,c){b.worlds=d.worlds.query({localTime:new Date,userCoordinate:[c,a]},function(b){e.altBubbles=b[0].liveAndInside,e.nearbyBubbles=b[0].live,l(a,c),o.addAlert("success","Explore bubbles around you",!0)})}function l(a,c){m.setCenter([c,a],14,b.aperture.state),b.showCreateNew=!0,angular.extend(e,{loading:!1}),angular.forEach(e.nearbyBubbles,function(a){a.lat&&a.lng&&m.addMarker(a._id,{lat:a.lat,lng:a.lng,draggable:!1,message:'<a href="#/w/'+a.id+'">'+a.name+"</a>",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[13,10]}})})}var m=h;angular.extend(e,{loading:!0});var n=g;n.resetNavBG();var o=i;b.aperture=f,b.aperture.set("off"),e.initGeo=function(){function a(a){var b=a.coords.latitude,c=a.coords.longitude;k(b,c)}function b(){j()}navigator.geolocation?navigator.geolocation.getCurrentPosition(a,b,{timeout:15e3,enableHighAccuracy:!0}):o("Your browser does not support geolocation :(")},e.initGeo(),b.addWorld=function(){a.path("/profile")}}function TalktagCtrl(a,b,c,d,e){e.showSwitch=!1,b.currentTag=c.hashTag,b.globalhashtag=global_hashtag,b.time="all",b.tweets=d.tweets.query({limit:60,tag:c.hashTag,time:b.time}),b.goBack=function(){window.history.back()},b.goTalk=function(){a.path("talk")}}function MenuCtrl(a,b,c,d,e){shelfPan("return"),window.scrollTo(0,0),e.showSwitch=!1,b.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.menuType=d.type}function ListCtrl(a,b,c,d,e){function f(){b.listLimit=10,b.queryType="events",b.queryFilter=d.filter,b.queryCat=d.category,b.landmarksList=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:"noNow"},function(){})}shelfPan("return"),window.scrollTo(0,0),e.showBack=!1,e.showBackPage=!1,e.showBackMark=!1,e.showSwitch=!1,b.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.listType=d.category,"lecture"==b.listType&&(b.day="WEDNESDAY"),"award"==b.listType&&(b.day="TUESDAY"),"show"==b.listType&&(b.day="THURSDAY"),f(),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})}}function WorldViewCtrl(a,b,c,d,e,f,g,h,i){"m"==b.option||shelfPan("closed"),"new"==b.option,angular.extend(i,{markers:{}}),c.option=b.option,c.landmark=a.get({_id:b.worldID},function(a){c.mainImageUrl=a.stats.avatar,c.time="all",c.currentTag=c.landmark.tags,c.tweets=d.tweets.query({tag:c.landmark.tags,time:c.time});var e={m:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],message:'<h4><img style="width:70px;" src="'+a.stats.avatar+'"><a href=#/landmark/'+b.landmarkId+"/m> "+a.name+"</a></h4>",focus:!0,icon:local_icons.yellowIcon}};angular.extend(i,{center:{lat:c.landmark.loc[0],lng:c.landmark.loc[1],zoom:16},markers:e})}),c.open=function(){c.etherpad=!0},c.close=function(){c.etherpad=!1},c.opts={backdropFade:!0,dialogFade:!0},c.setImage=function(a){c.mainImageUrl=a},c.goBack=function(){window.history.back(),shelfPan("return")},c.edit=function(){e.path("/landmark/"+b.landmarkId+"/edit")}}function LandmarkViewCtrl(a,b,c,d,e,f,g,h,i){function j(a){"event"==a.type&&(l[a.loc_nickname]?(angular.extend(i,{center:{lat:l[a.loc_nickname][0],lng:l[a.loc_nickname][1],zoom:m,autoDiscover:!1},markers:{m:{lat:l[a.loc_nickname][0],lng:l[a.loc_nickname][1],message:"<h4>"+a.loc_nickname+"</h4>",focus:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.mapbox}),k()):(angular.extend(i,{center:{lat:l.NYC[0],lng:l.NYC[1],zoom:m},markers:{m:{lat:l.NYC[0],lng:l.NYC[1],message:"<h4>NYC</h4>",focus:!0,icon:local_icons.yellowIcon}},tiles:tilesDict.mapbox}),k())),"place"==a.type&&("m"==b.option?(angular.extend(i,{center:{lat:a.loc[0],lng:a.loc[1],zoom:19,autoDiscover:!1},tiles:tilesDict.aicp}),k()):(angular.extend(i,{center:{lat:a.loc[0],lng:a.loc[1],zoom:19,autoDiscover:!1},markers:{m:{lat:a.loc[0],lng:a.loc[1],message:'<h4><img style="width:70px;" src="'+a.stats.avatar+'"><a href=#/post/'+a.id+"/m> "+a.name+"</a></h4>",focus:!1,icon:local_icons.yellowIcon}},tiles:tilesDict.aicp}),k()))}function k(){g.getMap().then(function(a){a.invalidateSize()})}i.showSwitch=!1,i.showBackPage=!0,i.showNavIcons=!1,window.scrollTo(0,0);var l={BASECAMP:[40.7215408,-73.9967013],SKIRBALL:[40.7297,-73.9978],MoMA:[40.7615,-73.9777],NYC:[40.7127,-74.0059]},m=16;c.showMapNav=function(){1==i.showMapNav?(i.showMapNav=!1,shelfPan("partial")):i.showMapNav=!0},"m"==b.option?(shelfPan("partial"),i.showSwitch=!1,i.showBackPage=!1,i.showBack=!1,i.showMapNav=!1,i.showBackMark=!0,i.hideIFbar=!1):(shelfPan("partial"),angular.extend(i,{markers:{}})),c.option=b.option,c.landmark=a.get({_id:b.landmarkId},function(a){a.stats.avatar&&"img/tidepools/default.jpg"!==a.stats.avatar&&(c.mainImageUrl=a.stats.avatar),c.people=a.people,c.description=a.description,j(a),c.landmark.tags&&(c.time="all",c.currentTag=c.landmark.tags,c.tweets=d.tweets.query({tag:c.landmark.tags,time:c.time}))}),c.setImage=function(a){c.mainImageUrl=a},c.goBack=function(){window.history.back(),shelfPan("return")},c.edit=function(){e.path("/landmark/"+b.landmarkId+"/edit")}}function AwardsCtrl(a,b,c,d,e,f){function g(){e.getMap().then(function(a){a.invalidateSize()})}function h(a){"noNow"==a?k==n?(b.upcomingLimit=2,b.queryType="events",b.queryFilter="upcoming",b.queryCat=p,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:"upcomingToday"},function(a){0==a.length&&i()})):i():(b.upcomingLimit=1,b.queryType="events",b.queryFilter="upcoming",b.queryCat=p,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(){}))}function i(){b.happenedLimit=10,b.queryType="events",b.queryFilter="all",b.queryCat=p,b.landmarksHappened=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){})}shelfPan("return"),window.scrollTo(0,0);var j=new Date,k=j.getDate(),l=j.getMonth()+1,m=j.getFullYear();10>k&&(k="0"+k),10>l&&(l="0"+l);var j=k+"/"+l+"/"+m,n=10;n==k&&(b.itisToday=!0),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1;var o={BASECAMP:[40.7215408,-73.9967013],SKIRBALL:[40.7297,-73.9978]};angular.extend(f,{markers:{}}),angular.extend(f,{center:{lat:40.725,lng:-73.997,zoom:14},tiles:tilesDict.mapbox,markers:{b:{lat:o.SKIRBALL[0],lng:o.SKIRBALL[1],message:"<h4>SKIRBALL</h4>",focus:!1,icon:local_icons.yellowIcon},a:{lat:o.BASECAMP[0],lng:o.BASECAMP[1],message:"<h4>BASECAMP</h4>",focus:!0,icon:local_icons.yellowIcon}}}),g(),f.showSwitch=!0,f.radioModel="Tuesday",b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showBack=!0):(f.showSwitch=!0,f.showBack=!1)},f.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.refreshMap=function(){e.getMap().then(function(a){a.invalidateSize()})};var p="award";b.queryType="events",b.queryFilter="now",b.queryCat=p,b.landmarksNow=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){h(b.landmarksNow[0]?b.landmarksNow[0].time.end:"noNow")}),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")},b.goVote=function(){a.path("poll")}}function LecturesCtrl(a,b,c,d,e,f){function g(a){"noNow"==a?j==m?(b.upcomingLimit=2,b.queryType="events",b.queryFilter="upcoming",b.queryCat=o,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(a){0==a.length&&h()})):h():(b.upcomingLimit=1,b.queryType="events",b.queryFilter="upcoming",b.queryCat=o,b.landmarksUpcoming=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,nowTimeEnd:a},function(){}))}function h(){b.happenedLimit=10,b.queryType="events",b.queryFilter="all",b.queryCat=o,b.landmarksHappened=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat},function(){})}shelfPan("return"),window.scrollTo(0,0);var i=new Date,j=i.getDate(),k=i.getMonth()+1,l=i.getFullYear();10>j&&(j="0"+j),10>k&&(k="0"+k);var i=j+"/"+k+"/"+l,m=11;m==j&&(b.itisToday=!0),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1,angular.extend(f,{markers:{}});var n={BASECAMP:[40.7215408,-73.9967013],MoMA:[40.7615,-73.9777]};angular.extend(f,{center:{lat:40.7415,lng:-73.985,zoom:12},tiles:tilesDict.mapbox,markers:{b:{lat:n.MoMA[0],lng:n.MoMA[1],message:"<h4>MoMA</h4>",focus:!1,icon:local_icons.yellowIcon},a:{lat:n.BASECAMP[0],lng:n.BASECAMP[1],message:"<h4>BASECAMP</h4>",focus:!0,icon:local_icons.yellowIcon}}}),f.radioModel="Wednesday",f.showSwitch=!0,b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showBack=!0):(f.showSwitch=!0,f.showBack=!1)},f.goBack=function(){window.history.back()},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a};var o="lecture";b.queryType="events",b.queryFilter="now",b.queryCat=o,b.landmarksNow=c.landmarks.query({queryType:b.queryType,queryFilter:b.queryFilter,queryCat:b.queryCat,userTime:new Date},function(){g(b.landmarksNow[0]?b.landmarksNow[0].time.end:"noNow")}),b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")}}function ShowCtrl(a,b,c,d,e,f){shelfPan("return"),window.scrollTo(0,0),f.hideIFbar=!1,f.showNavIcons=!1,f.showMapNav=!1;var g=new Date,h=new Date("Jun 12 2014 15:59:59 GMT-0400 (EDT)");g>h?(b.showBootCamp=!1,b.showMoMA=!0):(b.showBootCamp=!0,b.showMoMA=!1),f.showBack=!1,f.showBackPage=!1,f.showBackMark=!1,f.showSwitch=!0,f.radioModel="Thursday",b.tweets=c.tweets.query({limit:1}),b.instagrams=c.instagrams.query({limit:1}),angular.extend(f,{center:{lat:40.76147,lng:-73.9778,zoom:19},tiles:tilesDict.aicp}),b.hideSwitch=function(){1==f.showSwitch?(f.showSwitch=!1,f.showMapNav=!0,f.showBack=!0,f.showNavIcons=!0,f.hideIFbar=!0):(f.showSwitch=!0,f.showMapNav=!1,f.showBack=!1,f.showNavIcons=!1,f.hideIFbar=!1)};var i={"1F":[40.7618,-73.978],"2F":[40.7612,-73.978],"5F":[40.7607,-73.978],GARDEN:[40.7619,-73.9771],EDUCATION:[40.761999,-73.9764]};f.mapPan=function(a){angular.extend(f,{center:{lat:i[a][0],lng:i[a][1],zoom:20},tiles:tilesDict.aicp})},f.goBack=function(){f.hideIFbar=!1,window.history.back()},b.goNow=function(){a.path("landmark/Kathryn_Gordon_Show")},b.shelfUpdate=function(a){b.shelfUpdate=b.shelfUpdate==a?"default":a},b.filter=function(a,d){b.landmarks=c.landmarks.query({queryType:a,queryFilter:d})},b.goTalk=function(b){a.path("talk/"+b)},b.goTalkList=function(){a.path("talk")};var j="'partial'";b.queryMap=function(a,b){window.scrollTo(0,0),f.singleModel=1,f.iconModel=b,c.landmarks.query({queryType:a,queryFilter:b},function(a){for(var b={},c=0;c<a.length;c++)"img/tidepools/default.jpg"==a[c].stats.avatar&&("bars"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/bar.png"),"exhibits"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/coolsculpt.png"),"food"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/food.png"),"smoking"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/smoking.png"),"washrooms"==a[c].subType&&(a[c].stats.avatar="img/AICP/icons/washrooms.png")),b[a[c].id]={lat:a[c].loc[0],lng:a[c].loc[1],message:"<a href=#/post/"+a[c].id+'/m><h4 onclick="shelfPan('+j+');"><img style="width:70px;" src="'+a[c].stats.avatar+'"> '+a[c].name+"</h4></a>",focus:!0,icon:local_icons.yellowIcon};angular.extend(f,{center:{lat:a[0].loc[0],lng:a[0].loc[1],zoom:18},markers:b,tiles:tilesDict.aicp})},function(){})},angular.extend(f,{markers:{}})}function floorSelector(a){function b(b){function c(a){var b=a.filter(function(a){return a[0].floor_num>0});return b.length?b.slice(-1)[0][0]:a[0][0]}function d(c){a.removeOverlays(),setTimeout(function(){var d=b.floors[c];d.forEach(function(b){a.addOverlay(b.localMapID,b.localMapName,b.localMapOptions)})},100)}function e(){b.loadLandmarks(),setTimeout(function(){var c=_.chain(b.landmarks).filter(function(a){return a.loc_info}).filter(function(a){return a.loc_info.floor_num!==b.currentFloor.floor_num}).value();c.forEach(function(b){a.removeMarker(b._id)})},500)}b.showFloors=!1,b.floors=_.chain(b.world.style.maps.localMapArray).filter(function(a){return a.floor_num}).groupBy(function(a){return a.floor_num}).sortBy(function(a){return-a.floor_num}).value().reverse(),b.currentFloor=b.floors.slice(-1)[0][0]>0?b.floors.slice(-1)[0][0]:c(b.floors),b.selectFloor=function(a){b.currentFloor=b.floors[a][0],d(a),e(a)},b.openFloorMenu=function(){b.showFloors=!b.showFloors}}return{restrict:"E",scope:{world:"=world",style:"=style",landmarks:"=landmarks",loadLandmarks:"&"},templateUrl:"components/floor_selector/floor.selector.html",link:b}}function floorNumberFilter(){return function(a){return a?a.floor_num<=1?a.floor_name[0]:a.floor_num:void 0}}function CategoryController(a,b,c,d,e,f,g,h,i,j,k){function l(){m.removeAllMarkers(),e.landmarks=[],b.landmarks.query({queryType:"all",queryFilter:"all",parentID:e.world._id},function(a){angular.forEach(a,function(a){a.category==e.category&&(e.landmarks.push(a),m.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:a.name}))})})}var m=j;e.worldURL=d.worldURL,e.category=d.category,e.aperture=i,e.aperture.set("full"),e.landmarks=[];var n=c.current;e.$on("$locationChangeSuccess",function(){n.$$route.originalPath===c.current.$$route.originalPath&&(e.category=c.current.params.category,c.current=n,l())}),a.get({id:e.worldURL},function(a){e.world=a.world,e.style=a.style,m.setMaxBoundsFromPoint([e.world.loc.coordinates[1],e.world.loc.coordinates[0]],.05),m.setCenter(e.world.loc.coordinates,17),l()})}LandmarkNewCtrl.$inject=["$location","$scope","$routeParams","db","$rootScope"],LandmarkEditCtrl.$inject=["Landmark","$location","$scope","$routeParams","db","$timeout","$rootScope"],WorldEditCtrl.$inject=["$location","$scope","db"],UserViewCtrl.$inject=["$location","$scope","db"],function(){"use strict";angular.module("leaflet-directive",[]).directive("leaflet",["$q","leafletData","leafletMapDefaults","leafletHelpers","leafletEvents",function(a,b,c,d,e){var f;return{restrict:"EA",replace:!0,scope:{center:"=center",defaults:"=defaults",maxbounds:"=maxbounds",bounds:"=bounds",markers:"=markers",legend:"=legend",geojson:"=geojson",paths:"=paths",tiles:"=tiles",layers:"=layers",controls:"=controls",decorations:"=decorations",eventBroadcast:"=eventBroadcast"},transclude:!0,template:'<div class="angular-leaflet-map"><div ng-transclude></div></div>',controller:["$scope",function(b){f=a.defer(),this.getMap=function(){return f.promise},this.getLeafletScope=function(){return b}}],link:function(a,g,h){function i(){isNaN(h.width)?g.css("width",h.width):g.css("width",h.width+"px")}function j(){isNaN(h.height)?g.css("height",h.height):g.css("height",h.height+"px")}var k=d.isDefined,l=c.setDefaults(a.defaults,h.id),m=e.genDispatchMapEvent,n=e.getAvailableMapEvents();k(h.width)&&(i(),a.$watch(function(){return g[0].getAttribute("width")},function(){i(),o.invalidateSize()})),k(h.height)&&(j(),a.$watch(function(){return g[0].getAttribute("height")},function(){j(),o.invalidateSize()}));var o=new L.Map(g[0],c.getMapCreationDefaults(h.id));if(f.resolve(o),k(h.center)||o.setView([l.center.lat,l.center.lng],l.center.zoom),!k(h.tiles)&&!k(h.layers)){var p=L.tileLayer(l.tileLayer,l.tileLayerOptions);p.addTo(o),b.setTiles(p,h.id)}if(k(o.zoomControl)&&k(l.zoomControlPosition)&&o.zoomControl.setPosition(l.zoomControlPosition),k(o.zoomControl)&&l.zoomControl===!1&&o.zoomControl.removeFrom(o),k(o.zoomsliderControl)&&k(l.zoomsliderControl)&&l.zoomsliderControl===!1&&o.zoomsliderControl.removeFrom(o),!k(h.eventBroadcast))for(var q="broadcast",r=0;r<n.length;r++){var s=n[r];o.on(s,m(a,s,q),{eventName:s})}o.whenReady(function(){b.setMap(o,h.id)}),a.$on("$destroy",function(){o.remove(),b.unresolveMap(h.id)}),a.$on("invalidateSize",function(){o.invalidateSize()})}}}]),angular.module("leaflet-directive").directive("center",["$log","$q","$location","$timeout","leafletMapDefaults","leafletHelpers","leafletBoundsHelpers","leafletEvents",function(a,b,c,d,e,f,g,h){var i,j=f.isDefined,k=f.isNumber,l=f.isSameCenterOnMap,m=f.safeApply,n=f.isValidCenter,o=f.isEmpty,p=f.isUndefinedOrEmpty,q=function(a,b){return j(a)&&!o(a)&&p(b)};return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:function(){i=b.defer(),this.getCenter=function(){return i.promise}},link:function(b,f,o,p){var r=p.getLeafletScope(),s=r.center;p.getMap().then(function(f){var p=e.getDefaults(o.id);if(-1!==o.center.search("-"))return a.error('The "center" variable can\'t use a "-" on his key name: "'+o.center+'".'),void f.setView([p.center.lat,p.center.lng],p.center.zoom);if(q(r.bounds,s))f.fitBounds(g.createLeafletBounds(r.bounds)),s=f.getCenter(),m(r,function(a){a.center={lat:f.getCenter().lat,lng:f.getCenter().lng,zoom:f.getZoom(),autoDiscover:!1}}),m(r,function(a){var b=f.getBounds(),c={northEast:{lat:b._northEast.lat,lng:b._northEast.lng},southWest:{lat:b._southWest.lat,lng:b._southWest.lng}};a.bounds=c});else{if(!j(s))return a.error('The "center" property is not defined in the main scope'),void f.setView([p.center.lat,p.center.lng],p.center.zoom);j(s.lat)&&j(s.lng)||j(s.autoDiscover)||angular.copy(p.center,s)}var t,u;if("yes"===o.urlHashCenter){var v=function(){var a,b=c.search();if(j(b.c)){var d=b.c.split(":");3===d.length&&(a={lat:parseFloat(d[0]),lng:parseFloat(d[1]),zoom:parseInt(d[2],10)})}return a};t=v(),r.$on("$locationChangeSuccess",function(a){var b=a.currentScope,c=v();j(c)&&!l(c,f)&&(b.center={lat:c.lat,lng:c.lng,zoom:c.zoom})})}r.$watch("center",function(b){return j(t)&&(angular.copy(t,b),t=void 0),n(b)||b.autoDiscover===!0?b.autoDiscover===!0?(k(b.zoom)||f.setView([p.center.lat,p.center.lng],p.center.zoom),void f.locate(k(b.zoom)&&b.zoom>p.center.zoom?{setView:!0,maxZoom:b.zoom}:j(p.maxZoom)?{setView:!0,maxZoom:p.maxZoom}:{setView:!0})):void(u&&l(b,f)||(r.settingCenterFromScope=!0,f.setView([b.lat,b.lng],b.zoom),h.notifyCenterChangedToBounds(r,f),d(function(){r.settingCenterFromScope=!1}))):void a.warn("[AngularJS - Leaflet] invalid 'center'")},!0),f.whenReady(function(){u=!0}),f.on("moveend",function(){i.resolve(),h.notifyCenterUrlHashChanged(r,f,o,c.search()),l(s,f)||b.settingCenterFromScope||m(r,function(a){r.settingCenterFromScope||(a.center={lat:f.getCenter().lat,lng:f.getCenter().lng,zoom:f.getZoom(),autoDiscover:!1}),h.notifyCenterChangedToBounds(r,f)})}),s.autoDiscover===!0&&f.on("locationerror",function(){a.warn("[AngularJS - Leaflet] The Geolocation API is unauthorized on this page."),n(s)?(f.setView([s.lat,s.lng],s.zoom),h.notifyCenterChangedToBounds(r,f)):(f.setView([p.center.lat,p.center.lng],p.center.zoom),h.notifyCenterChangedToBounds(r,f))})})}}}]),angular.module("leaflet-directive").directive("tiles",["$log","leafletData","leafletMapDefaults","leafletHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(e,f,g,h){var i=d.isDefined,j=h.getLeafletScope(),k=j.tiles;
return i(k)||i(k.url)?void h.getMap().then(function(a){var d,e=c.getDefaults(g.id);j.$watch("tiles",function(c){var f=e.tileLayerOptions,h=e.tileLayer;return!i(c.url)&&i(d)?void a.removeLayer(d):i(d)?i(c.url)&&i(c.options)&&!angular.equals(c.options,f)?(a.removeLayer(d),f=e.tileLayerOptions,angular.copy(c.options,f),h=c.url,d=L.tileLayer(h,f),d.addTo(a),void b.setTiles(d,g.id)):void(i(c.url)&&d.setUrl(c.url)):(i(c.options)&&angular.copy(c.options,f),i(c.url)&&(h=c.url),d=L.tileLayer(h,f),d.addTo(a),void b.setTiles(d,g.id))},!0)}):void a.warn("[AngularJS - Leaflet] The 'tiles' definition doesn't have the 'url' property.")}}}]),angular.module("leaflet-directive").directive("legend",["$log","$http","leafletHelpers","leafletLegendHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(e,f,g,h){var i,j=c.isArray,k=c.isDefined,l=c.isFunction,m=h.getLeafletScope(),n=m.legend,o=n.legendClass?n.legendClass:"legend",p=n.position||"bottomright";h.getMap().then(function(c){m.$watch("legend",function(b){k(b.url)||j(b.colors)&&j(b.labels)&&b.colors.length===b.labels.length?k(b.url)?a.info("[AngularJS - Leaflet] loading arcgis legend service."):(k(i)&&i.removeFrom(c),i=L.control({position:p}),i.onAdd=d.getOnAddArrayLegend(b,o),i.addTo(c)):a.warn("[AngularJS - Leaflet] legend.colors and legend.labels must be set.")}),m.$watch("legend.url",function(e){k(e)&&b.get(e).success(function(a){k(i)?d.updateArcGISLegend(i.getContainer(),a):(i=L.control({position:p}),i.onAdd=d.getOnAddArcGISLegend(a,o),i.addTo(c)),k(n.loadedData)&&l(n.loadedData)&&n.loadedData()}).error(function(){a.warn("[AngularJS - Leaflet] legend.url not loaded.")})})})}}}]),angular.module("leaflet-directive").directive("geojson",["$log","$rootScope","leafletData","leafletHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(a,e,f,g){var h=d.safeApply,i=d.isDefined,j=g.getLeafletScope(),k={};g.getMap().then(function(a){j.$watch("geojson",function(e){if(i(k)&&a.hasLayer(k)&&a.removeLayer(k),i(e)&&i(e.data)){var g=e.resetStyleOnMouseout,l=e.onEachFeature;e.options={style:e.style,filter:e.filter,onEachFeature:l,pointToLayer:e.pointToLayer},k=L.geoJson(e.data,e.options),c.setGeoJSON(k,f.id),k.addTo(a),l||(l=function(a,c){d.LabelPlugin.isLoaded()&&i(e.label)&&c.bindLabel(a.properties.description),c.on({mouseover:function(c){h(j,function(){e.selected=a,b.$broadcast("leafletDirectiveMap.geojsonMouseover",c)})},mouseout:function(a){g&&k.resetStyle(a.target),h(j,function(){e.selected=void 0,b.$broadcast("leafletDirectiveMap.geojsonMouseout",a)})},click:function(c){h(j,function(){e.selected=a,b.$broadcast("leafletDirectiveMap.geojsonClick",e.selected,c)})}})})}},!0)})}}}]),angular.module("leaflet-directive").directive("layers",["$log","$q","leafletData","leafletHelpers","leafletLayerHelpers","leafletControlHelpers",function(a,b,c,d,e,f){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",controller:["$scope",function(a){a._leafletLayers=b.defer(),this.getLayers=function(){return a._leafletLayers.promise}}],link:function(b,g,h,i){var j=d.isDefined,k={},l=i.getLeafletScope(),m=l.layers,n=e.createLayer,o=f.updateLayersControl,p=!1;i.getMap().then(function(d){if(!j(m)||!j(m.baselayers)||0===Object.keys(m.baselayers).length)return void a.error("[AngularJS - Leaflet] At least one baselayer has to be defined");b._leafletLayers.resolve(k),c.setLayers(k,h.id),k.baselayers={},k.overlays={};var e=h.id,f=!1;for(var g in m.baselayers){var i=n(m.baselayers[g]);j(i)?(k.baselayers[g]=i,m.baselayers[g].top===!0&&(d.addLayer(k.baselayers[g]),f=!0)):delete m.baselayers[g]}!f&&Object.keys(k.baselayers).length>0&&d.addLayer(k.baselayers[Object.keys(m.baselayers)[0]]);for(g in m.overlays){"cartodb"===m.overlays[g].type;var q=n(m.overlays[g]);j(q)?(k.overlays[g]=q,m.overlays[g].visible===!0&&d.addLayer(k.overlays[g])):delete m.overlays[g]}l.$watch("layers.baselayers",function(b){for(var c in k.baselayers)j(b[c])||(d.hasLayer(k.baselayers[c])&&d.removeLayer(k.baselayers[c]),delete k.baselayers[c]);for(var f in b)if(!j(k.baselayers[f])){var g=n(b[f]);j(g)&&(k.baselayers[f]=g,b[f].top===!0&&d.addLayer(k.baselayers[f]))}if(0===Object.keys(k.baselayers).length)return void a.error("[AngularJS - Leaflet] At least one baselayer has to be defined");var h=!1;for(var i in k.baselayers)if(d.hasLayer(k.baselayers[i])){h=!0;break}h||d.addLayer(k.baselayers[Object.keys(m.baselayers)[0]]),p=o(d,e,p,b,m.overlays,k)},!0),l.$watch("layers.overlays",function(a){for(var b in k.overlays)j(a[b])||(d.hasLayer(k.overlays[b])&&d.removeLayer(k.overlays[b]),delete k.overlays[b]);for(var c in a){if(!j(k.overlays[c])){var f=n(a[c]);j(f)&&(k.overlays[c]=f,a[c].visible===!0&&d.addLayer(k.overlays[c]))}a[c].visible&&!d.hasLayer(k.overlays[c])?d.addLayer(k.overlays[c]):a[c].visible===!1&&d.hasLayer(k.overlays[c])&&d.removeLayer(k.overlays[c])}p=o(d,e,p,m.baselayers,a,k)},!0)})}}}]),angular.module("leaflet-directive").directive("bounds",["$log","$timeout","leafletHelpers","leafletBoundsHelpers",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","center"],link:function(e,f,g,h){var i=c.isDefined,j=d.createLeafletBounds,k=h[0].getLeafletScope(),l=h[0],m=function(a){return 0===a._southWest.lat&&0===a._southWest.lng&&0===a._northEast.lat&&0===a._northEast.lng?!0:!1};l.getMap().then(function(c){k.$on("boundsChanged",function(a){var b=a.currentScope,d=c.getBounds();if(!m(d)&&!b.settingBoundsFromScope){var e={northEast:{lat:d._northEast.lat,lng:d._northEast.lng},southWest:{lat:d._southWest.lat,lng:d._southWest.lng}};angular.equals(b.bounds,e)||(b.bounds=e)}}),k.$watch("bounds",function(d){if(!i(d))return void a.error("[AngularJS - Leaflet] Invalid bounds");var f=j(d);f&&!c.getBounds().equals(f)&&(e.settingBoundsFromScope=!0,c.fitBounds(f),b(function(){e.settingBoundsFromScope=!1}))},!0)})}}}]),angular.module("leaflet-directive").directive("markers",["$log","$rootScope","$q","leafletData","leafletHelpers","leafletMapDefaults","leafletMarkersHelpers","leafletEvents",function(a,b,c,d,e,f,g,h){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","?layers"],link:function(b,f,i,j){var k=j[0],l=e,m=e.isDefined,n=e.isString,o=k.getLeafletScope(),p=g.deleteMarker,q=g.addMarkerWatcher,r=g.listenMarkerEvents,s=g.addMarkerToGroup,t=h.bindMarkerEvents,u=g.createMarker;k.getMap().then(function(b){var e,f={};e=m(j[1])?j[1].getLayers:function(){var a=c.defer();return a.resolve(),a.promise},e().then(function(c){d.setMarkers(f,i.id),o.$watch("markers",function(d){for(var e in f)m(d)&&m(d[e])||(p(f[e],b,c),delete f[e]);for(var g in d)if(-1===g.search("-")){if(!m(f[g])){var h=d[g],j=u(h);if(!m(j)){a.error("[AngularJS - Leaflet] Received invalid data on the marker "+g+".");continue}if(f[g]=j,m(h.message)&&j.bindPopup(h.message,h.popupOptions),m(h.group)){var k=m(h.groupOption)?h.groupOption:null;s(j,h.group,k,b)}if(l.LabelPlugin.isLoaded()&&m(h.label)&&m(h.label.message)&&j.bindLabel(h.label.message,h.label.options),m(h)&&m(h.layer)){if(!n(h.layer)){a.error("[AngularJS - Leaflet] A layername must be a string");continue}if(!m(c)){a.error("[AngularJS - Leaflet] You must add layers to the directive if the markers are going to use this functionality.");continue}if(!m(c.overlays)||!m(c.overlays[h.layer])){a.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group"');continue}var v=c.overlays[h.layer];if(!(v instanceof L.LayerGroup||v instanceof L.FeatureGroup)){a.error('[AngularJS - Leaflet] Adding a marker to an overlay needs a overlay of the type "group" or "featureGroup"');continue}v.addLayer(j),b.hasLayer(j)&&h.focus===!0&&j.openPopup()}else m(h.group)||(b.addLayer(j),h.focus===!0&&j.openPopup(),l.LabelPlugin.isLoaded()&&m(h.label)&&m(h.label.options)&&h.label.options.noHide===!0&&j.showLabel());var w=!m(i.watchMarkers)||"true"===i.watchMarkers;w&&(q(j,g,o,c,b),r(j,h,o)),t(j,g,h,o)}}else a.error('The marker can\'t use a "-" on his key name: "'+g+'".')},!0)})})}}}]),angular.module("leaflet-directive").directive("paths",["$log","$q","leafletData","leafletMapDefaults","leafletHelpers","leafletPathsHelpers","leafletEvents",function(a,b,c,d,e,f,g){return{restrict:"A",scope:!1,replace:!1,require:["leaflet","?layers"],link:function(h,i,j,k){var l=k[0],m=e.isDefined,n=e.isString,o=l.getLeafletScope(),p=o.paths,q=f.createPath,r=g.bindPathEvents,s=f.setPathOptions;l.getMap().then(function(f){var g,h=d.getDefaults(j.id);g=m(k[1])?k[1].getLayers:function(){var a=b.defer();return a.resolve(),a.promise},m(p)&&g().then(function(b){var d={};c.setPaths(d,j.id);var g=function(a,b){var c=o.$watch("paths."+b,function(b){return m(b)?void s(a,b.type,b):(f.removeLayer(a),void c())},!0)};o.$watch("paths",function(c){for(var i in c)if(0!==i.search("\\$"))if(-1===i.search("-")){if(!m(d[i])){var j=c[i],k=q(i,c[i],h);if(m(k)&&m(j.message)&&k.bindPopup(j.message),e.LabelPlugin.isLoaded()&&m(j.label)&&m(j.label.message)&&k.bindLabel(j.label.message,j.label.options),m(j)&&m(j.layer)){if(!n(j.layer)){a.error("[AngularJS - Leaflet] A layername must be a string");continue}if(!m(b)){a.error("[AngularJS - Leaflet] You must add layers to the directive if the markers are going to use this functionality.");continue}if(!m(b.overlays)||!m(b.overlays[j.layer])){a.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group"');continue}var l=b.overlays[j.layer];if(!(l instanceof L.LayerGroup||l instanceof L.FeatureGroup)){a.error('[AngularJS - Leaflet] Adding a marker to an overlay needs a overlay of the type "group" or "featureGroup"');continue}d[i]=k,l.addLayer(k),g(k,i)}else m(k)&&(d[i]=k,f.addLayer(k),g(k,i));r(k,i,j,o)}}else a.error('[AngularJS - Leaflet] The path name "'+i+'" is not valid. It must not include "-" and a number.');for(var p in d)m(c[p])||delete d[p]},!0)})})}}}]),angular.module("leaflet-directive").directive("controls",["$log","leafletHelpers",function(a,b){return{restrict:"A",scope:!1,replace:!1,require:"?^leaflet",link:function(a,c,d,e){if(e){var f=b.isDefined,g=e.getLeafletScope(),h=g.controls;e.getMap().then(function(a){if(f(L.Control.Draw)&&f(h.draw)){var b=new L.FeatureGroup,c={edit:{featureGroup:b}};angular.extend(c,h.draw),h.draw=c,a.addLayer(c.edit.featureGroup);var d=new L.Control.Draw(c);a.addControl(d)}if(f(h.custom))for(var e in h.custom)a.addControl(h.custom[e])})}}}}]),angular.module("leaflet-directive").directive("eventBroadcast",["$log","$rootScope","leafletHelpers","leafletEvents",function(a,b,c,d){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(b,e,f,g){var h=c.isObject,i=g.getLeafletScope(),j=i.eventBroadcast,k=d.getAvailableMapEvents(),l=d.genDispatchMapEvent;g.getMap().then(function(b){var c,d,e=[],f="broadcast";if(h(j)){if(void 0===j.map||null===j.map)e=k;else if("object"!=typeof j.map)a.warn("[AngularJS - Leaflet] event-broadcast.map must be an object check your model.");else{void 0!==j.map.logic&&null!==j.map.logic&&("emit"!==j.map.logic&&"broadcast"!==j.map.logic?a.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):"emit"===j.map.logic&&(f="emit"));var g=!1,m=!1;if(void 0!==j.map.enable&&null!==j.map.enable&&"object"==typeof j.map.enable&&(g=!0),void 0!==j.map.disable&&null!==j.map.disable&&"object"==typeof j.map.disable&&(m=!0),g&&m)a.warn("[AngularJS - Leaflet] can not enable and disable events at the time");else if(g||m)if(g)for(c=0;c<j.map.enable.length;c++)d=j.map.enable[c],-1!==e.indexOf(d)?a.warn("[AngularJS - Leaflet] This event "+d+" is already enabled"):-1===k.indexOf(d)?a.warn("[AngularJS - Leaflet] This event "+d+" does not exist"):e.push(d);else for(e=k,c=0;c<j.map.disable.length;c++){d=j.map.disable[c];var n=e.indexOf(d);-1===n?a.warn("[AngularJS - Leaflet] This event "+d+" does not exist or has been already disabled"):e.splice(n,1)}else a.warn("[AngularJS - Leaflet] must enable or disable events")}for(c=0;c<e.length;c++)d=e[c],b.on(d,l(i,d,f),{eventName:d})}else a.warn("[AngularJS - Leaflet] event-broadcast must be an object, check your model.")})}}}]),angular.module("leaflet-directive").directive("maxbounds",["$log","leafletMapDefaults","leafletBoundsHelpers",function(a,b,c){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(a,b,d,e){var f=e.getLeafletScope(),g=c.isValidBounds;e.getMap().then(function(a){f.$watch("maxbounds",function(b){if(!g(b))return void a.setMaxBounds();var c=[[b.southWest.lat,b.southWest.lng],[b.northEast.lat,b.northEast.lng]];a.setMaxBounds(c),d.center||a.fitBounds(c)})})}}}]),angular.module("leaflet-directive").directive("decorations",["$log","leafletHelpers",function(a,b){return{restrict:"A",scope:!1,replace:!1,require:"leaflet",link:function(c,d,e,f){function g(b){return k(b)&&k(b.coordinates)&&(j.isLoaded()||a.error("[AngularJS - Leaflet] The PolylineDecorator Plugin is not loaded.")),L.polylineDecorator(b.coordinates)}function h(a,b){return k(a)&&k(b)&&k(b.coordinates)&&k(b.patterns)?(a.setPaths(b.coordinates),a.setPatterns(b.patterns),a):void 0}var i=f.getLeafletScope(),j=b.PolylineDecoratorPlugin,k=b.isDefined,l={};f.getMap().then(function(a){i.$watch("decorations",function(b){for(var c in l)k(b)&&k(b[c])||delete l[c],a.removeLayer(l[c]);for(var d in b){var e=b[d],f=g(e);k(f)&&(l[d]=f,a.addLayer(f),h(f,e))}},!0)})}}}]),angular.module("leaflet-directive").directive("layercontrol",["$log","leafletData","leafletHelpers",function(a,b,c){return{restrict:"E",scope:{},replace:!0,transclude:!1,require:"^leaflet",controller:["$scope","$element","$sce",function(d,e,f){a.debug("[Angular Directive - Layers] layers",d,e);var g=c.safeApply,h=c.isDefined;angular.extend(d,{baselayer:"",icons:{uncheck:"fa fa-check-square-o",check:"fa fa-square-o",radio:"fa fa-dot-circle-o",unradio:"fa fa-circle-o",up:"fa fa-angle-up",down:"fa fa-angle-down",open:"fa fa-angle-double-down",close:"fa fa-angle-double-up"},changeBaseLayer:function(a,e){c.safeApply(d,function(c){c.baselayer=a,b.getMap().then(function(e){b.getLayers().then(function(b){if(!e.hasLayer(b.baselayers[a])){for(var f in c.layers.baselayers)c.layers.baselayers[f].icon=c.icons.unradio,e.hasLayer(b.baselayers[f])&&e.removeLayer(b.baselayers[f]);e.addLayer(b.baselayers[a]),c.layers.baselayers[a].icon=d.icons.radio}})})}),e.preventDefault()},moveLayer:function(a,b,c){var e=Object.keys(d.layers.baselayers).length;if(b>=1+e&&b<=d.overlaysArray.length+e){var f;for(var h in d.layers.overlays)if(d.layers.overlays[h].index===b){f=d.layers.overlays[h];break}f&&g(d,function(){f.index=a.index,a.index=b})}c.stopPropagation(),c.preventDefault()},initIndex:function(a,b){var c=Object.keys(d.layers.baselayers).length;a.index=h(a.index)?a.index:b+c+1},toggleOpacity:function(b,c){if(a.debug("Event",b),c.visible){var e=angular.element(b.currentTarget);e.toggleClass(d.icons.close+" "+d.icons.open),e=e.parents(".lf-row").find(".lf-opacity"),e.toggle("fast",function(){g(d,function(){c.opacityControl=!c.opacityControl})})}b.stopPropagation(),b.preventDefault()},unsafeHTML:function(a){return f.trustAsHtml(a)}});var i=e.get(0);L.Browser.touch?L.DomEvent.on(i,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(i),L.DomEvent.on(i,"mousewheel",L.DomEvent.stopPropagation))}],template:'<div class="angular-leaflet-control-layers" ng-show="overlaysArray.length"><div class="lf-baselayers"><div class="lf-row" ng-repeat="(key, layer) in layers.baselayers"><label class="lf-icon-bl" ng-click="changeBaseLayer(key, $event)"><input class="leaflet-control-layers-selector" type="radio" name="lf-radio" ng-show="false" ng-checked="baselayer === key" ng-value="key" /> <i class="lf-icon lf-icon-radio" ng-class="layer.icon"></i><div class="lf-text">{{layer.name}}</div></label></div></div><div class="lf-overlays"><div class="lf-container"><div class="lf-row" ng-repeat="layer in overlaysArray | orderBy:\'index\':order" ng-init="initIndex(layer, $index)"><label class="lf-icon-ol"><input class="lf-control-layers-selector" type="checkbox" ng-show="false" ng-model="layer.visible"/> <i class="lf-icon lf-icon-check" ng-class="layer.icon"></i><div class="lf-text">{{layer.name}}</div><div class="lf-icons"><i class="lf-icon lf-up" ng-class="icons.up" ng-click="moveLayer(layer, layer.index - orderNumber, $event)"></i> <i class="lf-icon lf-down" ng-class="icons.down" ng-click="moveLayer(layer, layer.index + orderNumber, $event)"></i> <i class="lf-icon lf-open" ng-class="layer.opacityControl? icons.close:icons.open" ng-click="toggleOpacity($event, layer)"></i></div></label><div class="lf-legend" ng-if="layer.legend" ng-bind-html="unsafeHTML(layer.legend)"></div><div class="lf-opacity" ng-show="layer.visible &amp;&amp; layer.opacityControl"><input type="text" class="lf-opacity-control" name="lf-opacity-control" data-key="{{layer.index}}" /></div></div></div></div></div>',link:function(d,e,f,g){var h=c.isDefined,i=g.getLeafletScope(),j=i.layers;f.order=!h(f.order)||"normal"!==f.order&&"reverse"!==f.order?"normal":f.order,d.order="normal"===f.order,d.orderNumber="normal"===f.order?-1:1,d.layers=j,g.getMap().then(function(c){return h(j)&&h(j.baselayers)&&0!==Object.keys(j.baselayers).length?(i.$watch("layers.baselayers",function(a){b.getLayers().then(function(b){var e;for(e in a)a[e].icon=c.hasLayer(b.baselayers[e])?d.icons.radio:d.icons.unradio})}),void i.$watch("layers.overlays",function(f){var g=[];b.getLayers().then(function(a){for(var b in f)f[b].icon=d.icons[f[b].visible?"uncheck":"check"],g.push(f[b]),h(f[b].index)&&a.overlays[b].setZIndex&&a.overlays[b].setZIndex(f[b].index)});var i=d.$watch(function(){return e.children().size()>1?(e.find(".lf-overlays").trigger("resize"),e.find(".lf-opacity").size()===Object.keys(j.overlays).length):void 0},function(f){f===!0&&(h(e.find(".lf-opacity-control").ionRangeSlider)?e.find(".lf-opacity-control").each(function(a,e){var f,g=Object.keys(j.baselayers).length;for(var i in d.overlaysArray)d.overlaysArray[i].index===a+g+1&&(f=d.overlaysArray[i]);var k=angular.element(e),l=h(f)&&h(f.layerOptions)?f.layerOptions.opacity:void 0;k.ionRangeSlider({min:0,from:h(l)?Math.ceil(100*l):100,step:1,max:100,prettify:!1,hasGrid:!1,hideMinMax:!0,onChange:function(a){b.getLayers().then(function(b){var d,e,f=a.input.data().key;for(var g in j.overlays)if(j.overlays[g].index===f){d=b.overlays[g],e=j.overlays[g];break}c.hasLayer(d)&&(e.layerOptions=h(e.layerOptions)?e.layerOptions:{},e.layerOptions.opacity=a.input.val()/100,d.setOpacity&&d.setOpacity(a.input.val()/100),d.getLayers&&d.eachLayer&&d.eachLayer(function(b){b.setOpacity&&b.setOpacity(a.input.val()/100)}))})}})}):a.warn("[AngularJS - Leaflet] Ion Slide Range Plugin is not loaded"),i())});d.overlaysArray=g},!0)):void a.error("[AngularJS - Leaflet] At least one baselayer has to be defined")})}}}]),angular.module("leaflet-directive").service("leafletData",["$log","$q","leafletHelpers",function(a,b,c){var d=c.getDefer,e=c.getUnresolvedDefer,f=c.setResolvedDefer,g={},h={},i={},j={},k={},l={},m={},n={};this.setMap=function(a,b){var c=e(g,b);c.resolve(a),f(g,b)},this.getMap=function(a){var b=d(g,a);return b.promise},this.unresolveMap=function(a){var b=c.obtainEffectiveMapId(g,a);g[b]=void 0},this.getPaths=function(a){var b=d(j,a);return b.promise},this.setPaths=function(a,b){var c=e(j,b);c.resolve(a),f(j,b)},this.getMarkers=function(a){var b=d(k,a);return b.promise},this.setMarkers=function(a,b){var c=e(k,b);c.resolve(a),f(k,b)},this.getLayers=function(a){var b=d(i,a);return b.promise},this.setLayers=function(a,b){var c=e(i,b);c.resolve(a),f(i,b)},this.getUTFGrid=function(a){var b=d(m,a);return b.promise},this.setUTFGrid=function(a,b){var c=e(m,b);c.resolve(a),f(m,b)},this.setTiles=function(a,b){var c=e(h,b);c.resolve(a),f(h,b)},this.getTiles=function(a){var b=d(h,a);return b.promise},this.setGeoJSON=function(a,b){var c=e(l,b);c.resolve(a),f(l,b)},this.getGeoJSON=function(a){var b=d(l,a);return b.promise},this.setDecorations=function(a,b){var c=e(n,b);c.resolve(a),f(n,b)},this.getDecorations=function(a){var b=d(n,a);return b.promise}}]),angular.module("leaflet-directive").factory("leafletMapDefaults",["$q","leafletHelpers",function(a,b){function c(){return{keyboard:!0,dragging:!0,worldCopyJump:!1,doubleClickZoom:!0,scrollWheelZoom:!0,touchZoom:!0,zoomControl:!0,zoomsliderControl:!1,zoomControlPosition:"topleft",attributionControl:!0,controls:{layers:{visible:!0,position:"topright",collapsed:!0}},crs:L.CRS.EPSG3857,tileLayer:"//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",tileLayerOptions:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'},path:{weight:10,opacity:1,color:"#0000ff"},center:{lat:0,lng:0,zoom:1}}}var d=b.isDefined,e=b.isObject,f=b.obtainEffectiveMapId,g={};return{getDefaults:function(a){var b=f(g,a);return g[b]},getMapCreationDefaults:function(a){var b=f(g,a),c=g[b],e={maxZoom:c.maxZoom,keyboard:c.keyboard,dragging:c.dragging,zoomControl:c.zoomControl,doubleClickZoom:c.doubleClickZoom,scrollWheelZoom:c.scrollWheelZoom,touchZoom:c.touchZoom,attributionControl:c.attributionControl,worldCopyJump:c.worldCopyJump,crs:c.crs};if(d(c.minZoom)&&(e.minZoom=c.minZoom),d(c.zoomAnimation)&&(e.zoomAnimation=c.zoomAnimation),d(c.fadeAnimation)&&(e.fadeAnimation=c.fadeAnimation),d(c.markerZoomAnimation)&&(e.markerZoomAnimation=c.markerZoomAnimation),c.map)for(var h in c.map)e[h]=c.map[h];return e},setDefaults:function(a,b){var h=c();d(a)&&(h.doubleClickZoom=d(a.doubleClickZoom)?a.doubleClickZoom:h.doubleClickZoom,h.scrollWheelZoom=d(a.scrollWheelZoom)?a.scrollWheelZoom:h.doubleClickZoom,h.touchZoom=d(a.touchZoom)?a.touchZoom:h.doubleClickZoom,h.zoomControl=d(a.zoomControl)?a.zoomControl:h.zoomControl,h.zoomsliderControl=d(a.zoomsliderControl)?a.zoomsliderControl:h.zoomsliderControl,h.attributionControl=d(a.attributionControl)?a.attributionControl:h.attributionControl,h.tileLayer=d(a.tileLayer)?a.tileLayer:h.tileLayer,h.zoomControlPosition=d(a.zoomControlPosition)?a.zoomControlPosition:h.zoomControlPosition,h.keyboard=d(a.keyboard)?a.keyboard:h.keyboard,h.dragging=d(a.dragging)?a.dragging:h.dragging,d(a.controls)&&angular.extend(h.controls,a.controls),e(a.crs)?h.crs=a.crs:d(L.CRS[a.crs])&&(h.crs=L.CRS[a.crs]),d(a.center)&&angular.copy(a.center,h.center),d(a.tileLayerOptions)&&angular.copy(a.tileLayerOptions,h.tileLayerOptions),d(a.maxZoom)&&(h.maxZoom=a.maxZoom),d(a.minZoom)&&(h.minZoom=a.minZoom),d(a.zoomAnimation)&&(h.zoomAnimation=a.zoomAnimation),d(a.fadeAnimation)&&(h.fadeAnimation=a.fadeAnimation),d(a.markerZoomAnimation)&&(h.markerZoomAnimation=a.markerZoomAnimation),d(a.worldCopyJump)&&(h.worldCopyJump=a.worldCopyJump),d(a.map)&&(h.map=a.map));var i=f(g,b);return g[i]=h,h}}}]),angular.module("leaflet-directive").factory("leafletEvents",["$rootScope","$q","$log","leafletHelpers",function(a,b,c,d){var e=d.safeApply,f=d.isDefined,g=d.isObject,h=d,i=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu"]},j=function(a,b,c,d){for(var e=i(),f="markers."+d,g=0;g<e.length;g++){var h=e[g];c.label.on(h,m(a,h,b,c.label,f))}},k=function(b,c,d,f,g,h){return function(i){var j="leafletDirectiveMarker."+b;"click"===b?e(d,function(){a.$broadcast("leafletDirectiveMarkersClick",g)}):"dragend"===b&&(e(d,function(){h.lat=f.getLatLng().lat,h.lng=f.getLatLng().lng}),h.message&&h.focus===!0&&f.openPopup()),e(d,function(b){"emit"===c?b.$emit(j,{markerName:g,leafletEvent:i}):a.$broadcast(j,{markerName:g,leafletEvent:i})})}},l=function(b,c,d,f,g){return function(f){var h="leafletDirectivePath."+b;e(d,function(b){"emit"===c?b.$emit(h,{pathName:g,leafletEvent:f}):a.$broadcast(h,{pathName:g,leafletEvent:f})})}},m=function(b,c,d,f,g){return function(h){var i="leafletDirectiveLabel."+c,j=g.replace("markers.","");e(b,function(b){"emit"===d?b.$emit(i,{leafletEvent:h,label:f,markerName:j}):"broadcast"===d&&a.$broadcast(i,{leafletEvent:h,label:f,markerName:j})})}},n=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu","dragstart","drag","dragend","move","remove","popupopen","popupclose"]},o=function(){return["click","dblclick","mousedown","mouseover","mouseout","contextmenu","add","remove","popupopen","popupclose"]};return{getAvailableMapEvents:function(){return["click","dblclick","mousedown","mouseup","mouseover","mouseout","mousemove","contextmenu","focus","blur","preclick","load","unload","viewreset","movestart","move","moveend","dragstart","drag","dragend","zoomstart","zoomend","zoomlevelschange","resize","autopanstart","layeradd","layerremove","baselayerchange","overlayadd","overlayremove","locationfound","locationerror","popupopen","popupclose","draw:created","draw:edited","draw:deleted","draw:drawstart","draw:drawstop","draw:editstart","draw:editstop","draw:deletestart","draw:deletestop"]},genDispatchMapEvent:function(b,c,d){return function(f){var g="leafletDirectiveMap."+c;e(b,function(b){"emit"===d?b.$emit(g,{leafletEvent:f}):"broadcast"===d&&a.$broadcast(g,{leafletEvent:f})})}},getAvailableMarkerEvents:n,getAvailablePathEvents:o,notifyCenterChangedToBounds:function(a){a.$broadcast("boundsChanged")},notifyCenterUrlHashChanged:function(a,b,c,d){if(f(c.urlHashCenter)){var e=b.getCenter(),g=e.lat.toFixed(4)+":"+e.lng.toFixed(4)+":"+b.getZoom();f(d.c)&&d.c===g||a.$emit("centerUrlHash",g)}},bindMarkerEvents:function(a,b,d,e){var i,l,m=[],o="broadcast";if(f(e.eventBroadcast))if(g(e.eventBroadcast))if(f(e.eventBroadcast.marker))if(g(e.eventBroadcast.marker)){void 0!==e.eventBroadcast.marker.logic&&null!==e.eventBroadcast.marker.logic&&("emit"!==e.eventBroadcast.marker.logic&&"broadcast"!==e.eventBroadcast.marker.logic?c.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):"emit"===e.eventBroadcast.marker.logic&&(o="emit"));var p=!1,q=!1;if(void 0!==e.eventBroadcast.marker.enable&&null!==e.eventBroadcast.marker.enable&&"object"==typeof e.eventBroadcast.marker.enable&&(p=!0),void 0!==e.eventBroadcast.marker.disable&&null!==e.eventBroadcast.marker.disable&&"object"==typeof e.eventBroadcast.marker.disable&&(q=!0),p&&q)c.warn("[AngularJS - Leaflet] can not enable and disable events at the same time");else if(p||q)if(p)for(i=0;i<e.eventBroadcast.marker.enable.length;i++)l=e.eventBroadcast.marker.enable[i],-1!==m.indexOf(l)?c.warn("[AngularJS - Leaflet] This event "+l+" is already enabled"):-1===n().indexOf(l)?c.warn("[AngularJS - Leaflet] This event "+l+" does not exist"):m.push(l);else for(m=n(),i=0;i<e.eventBroadcast.marker.disable.length;i++){l=e.eventBroadcast.marker.disable[i];var r=m.indexOf(l);-1===r?c.warn("[AngularJS - Leaflet] This event "+l+" does not exist or has been already disabled"):m.splice(r,1)}else c.warn("[AngularJS - Leaflet] must enable or disable events")}else c.warn("[AngularJS - Leaflet] event-broadcast.marker must be an object check your model.");else m=n();else c.error("[AngularJS - Leaflet] event-broadcast must be an object check your model.");else m=n();for(i=0;i<m.length;i++)l=m[i],a.on(l,k(l,o,e,a,b,d));h.LabelPlugin.isLoaded()&&f(a.label)&&j(e,o,a,b)},bindPathEvents:function(a,b,d,e){var i,k,m=[],n="broadcast";if(f(e.eventBroadcast))if(g(e.eventBroadcast))if(f(e.eventBroadcast.path))if(g(e.eventBroadcast.paths))c.warn("[AngularJS - Leaflet] event-broadcast.path must be an object check your model.");else{void 0!==e.eventBroadcast.path.logic&&null!==e.eventBroadcast.path.logic&&("emit"!==e.eventBroadcast.path.logic&&"broadcast"!==e.eventBroadcast.path.logic?c.warn("[AngularJS - Leaflet] Available event propagation logic are: 'emit' or 'broadcast'."):"emit"===e.eventBroadcast.path.logic&&(n="emit"));var p=!1,q=!1;if(void 0!==e.eventBroadcast.path.enable&&null!==e.eventBroadcast.path.enable&&"object"==typeof e.eventBroadcast.path.enable&&(p=!0),void 0!==e.eventBroadcast.path.disable&&null!==e.eventBroadcast.path.disable&&"object"==typeof e.eventBroadcast.path.disable&&(q=!0),p&&q)c.warn("[AngularJS - Leaflet] can not enable and disable events at the same time");else if(p||q)if(p)for(i=0;i<e.eventBroadcast.path.enable.length;i++)k=e.eventBroadcast.path.enable[i],-1!==m.indexOf(k)?c.warn("[AngularJS - Leaflet] This event "+k+" is already enabled"):-1===o().indexOf(k)?c.warn("[AngularJS - Leaflet] This event "+k+" does not exist"):m.push(k);else for(m=o(),i=0;i<e.eventBroadcast.path.disable.length;i++){k=e.eventBroadcast.path.disable[i];var r=m.indexOf(k);-1===r?c.warn("[AngularJS - Leaflet] This event "+k+" does not exist or has been already disabled"):m.splice(r,1)}else c.warn("[AngularJS - Leaflet] must enable or disable events")}else m=o();else c.error("[AngularJS - Leaflet] event-broadcast must be an object check your model.");else m=o();for(i=0;i<m.length;i++)k=m[i],a.on(k,l(k,n,e,m,b));h.LabelPlugin.isLoaded()&&f(a.label)&&j(e,n,a,b)}}}]),angular.module("leaflet-directive").factory("leafletLayerHelpers",["$rootScope","$log","leafletHelpers",function($rootScope,$log,leafletHelpers){function isValidLayerType(a){return isString(a.type)?-1===Object.keys(layerTypes).indexOf(a.type)?($log.error("[AngularJS - Leaflet] A layer must have a valid type: "+Object.keys(layerTypes)),!1):layerTypes[a.type].mustHaveUrl&&!isString(a.url)?($log.error("[AngularJS - Leaflet] A base layer must have an url"),!1):layerTypes[a.type].mustHaveData&&!isDefined(a.data)?($log.error('[AngularJS - Leaflet] The base layer must have a "data" array attribute'),!1):layerTypes[a.type].mustHaveLayer&&!isDefined(a.layer)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have an layer defined"),!1):layerTypes[a.type].mustHaveBounds&&!isDefined(a.bounds)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have bounds defined"),!1):layerTypes[a.type].mustHaveKey&&!isDefined(a.key)?($log.error("[AngularJS - Leaflet] The type of layer "+a.type+" must have key defined"),!1):!0:($log.error("[AngularJS - Leaflet] A layer must have a valid type defined."),!1)}var Helpers=leafletHelpers,isString=leafletHelpers.isString,isObject=leafletHelpers.isObject,isDefined=leafletHelpers.isDefined,utfGridCreateLayer=function(a){if(!Helpers.UTFGridPlugin.isLoaded())return void $log.error("[AngularJS - Leaflet] The UTFGrid plugin is not loaded.");var b=new L.UtfGrid(a.url,a.pluginOptions);return b.on("mouseover",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridMouseover",a)}),b.on("mouseout",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridMouseout",a)}),b.on("click",function(a){$rootScope.$broadcast("leafletDirectiveMap.utfgridClick",a)}),b},layerTypes={xyz:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer(a.url,a.options)}},mapbox:{mustHaveKey:!0,createLayer:function(a){var b="//{s}.tiles.mapbox.com/v3/"+a.key+"/{z}/{x}/{y}.png";return L.tileLayer(b,a.options)}},geoJSON:{mustHaveUrl:!0,createLayer:function(a){return Helpers.GeoJSONPlugin.isLoaded()?new L.TileLayer.GeoJSON(a.url,a.pluginOptions,a.options):void 0}},utfGrid:{mustHaveUrl:!0,createLayer:utfGridCreateLayer},cartodbTiles:{mustHaveKey:!0,createLayer:function(a){var b="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/{z}/{x}/{y}.png";return L.tileLayer(b,a.options)}},cartodbUTFGrid:{mustHaveKey:!0,mustHaveLayer:!0,createLayer:function(a){return a.url="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/"+a.layer+"/{z}/{x}/{y}.grid.json",utfGridCreateLayer(a)}},cartodbInteractive:{mustHaveKey:!0,mustHaveLayer:!0,createLayer:function(a){var b="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/{z}/{x}/{y}.png",c=L.tileLayer(b,a.options);a.url="//"+a.user+".cartodb.com/api/v1/map/"+a.key+"/"+a.layer+"/{z}/{x}/{y}.grid.json";var d=utfGridCreateLayer(a);return L.layerGroup([c,d])}},wms:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer.wms(a.url,a.options)}},wmts:{mustHaveUrl:!0,createLayer:function(a){return L.tileLayer.wmts(a.url,a.options)}},wfs:{mustHaveUrl:!0,mustHaveLayer:!0,createLayer:function(params){if(Helpers.WFSLayerPlugin.isLoaded()){var options=angular.copy(params.options);return options.crs&&"string"==typeof options.crs&&(options.crs=eval(options.crs)),new L.GeoJSON.WFS(params.url,params.layer,options)
}}},group:{mustHaveUrl:!1,createLayer:function(){return L.layerGroup()}},featureGroup:{mustHaveUrl:!1,createLayer:function(){return L.featureGroup()}},google:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"SATELLITE";if(Helpers.GoogleLayerPlugin.isLoaded())return new L.Google(b,a.options)}},china:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"";if(Helpers.ChinaLayerPlugin.isLoaded())return L.tileLayer.chinaProvider(b,a.options)}},ags:{mustHaveUrl:!0,createLayer:function(a){if(Helpers.AGSLayerPlugin.isLoaded()){var b=angular.copy(a.options);angular.extend(b,{url:a.url});var c=new lvector.AGS(b);return c.onAdd=function(a){this.setMap(a)},c.onRemove=function(){this.setMap(null)},c}}},dynamic:{mustHaveUrl:!0,createLayer:function(a){return Helpers.DynamicMapLayerPlugin.isLoaded()?L.esri.dynamicMapLayer(a.url,a.options):void 0}},markercluster:{mustHaveUrl:!1,createLayer:function(a){return Helpers.MarkerClusterPlugin.isLoaded()?new L.MarkerClusterGroup(a.options):void $log.error("[AngularJS - Leaflet] The markercluster plugin is not loaded.")}},bing:{mustHaveUrl:!1,createLayer:function(a){return Helpers.BingLayerPlugin.isLoaded()?new L.BingLayer(a.key,a.options):void 0}},heatmap:{mustHaveUrl:!1,mustHaveData:!0,createLayer:function(a){if(Helpers.HeatMapLayerPlugin.isLoaded()){var b=new L.TileLayer.WebGLHeatMap(a.options);return isDefined(a.data)&&b.setData(a.data),b}}},yandex:{mustHaveUrl:!1,createLayer:function(a){var b=a.type||"map";if(Helpers.YandexLayerPlugin.isLoaded())return new L.Yandex(b,a.options)}},imageOverlay:{mustHaveUrl:!0,mustHaveBounds:!0,createLayer:function(a){return L.imageOverlay(a.url,a.bounds,a.options)}},custom:{createLayer:function(a){return a.layer instanceof L.Class?angular.copy(a.layer):void $log.error("[AngularJS - Leaflet] A custom layer must be a leaflet Class")}},cartodb:{mustHaveUrl:!0,createLayer:function(a){return cartodb.createLayer(a.map,a.url)}}};return{createLayer:function(a){if(isValidLayerType(a)){if(!isString(a.name))return void $log.error("[AngularJS - Leaflet] A base layer must have a name");isObject(a.layerParams)||(a.layerParams={}),isObject(a.layerOptions)||(a.layerOptions={});for(var b in a.layerParams)a.layerOptions[b]=a.layerParams[b];var c={url:a.url,data:a.data,options:a.layerOptions,layer:a.layer,type:a.layerType,bounds:a.bounds,key:a.key,pluginOptions:a.pluginOptions,user:a.user};return layerTypes[a.type].createLayer(c)}}}}]),angular.module("leaflet-directive").factory("leafletControlHelpers",["$rootScope","$log","leafletHelpers","leafletMapDefaults",function(a,b,c,d){var e,f=c.isObject,g=c.isDefined,h=function(a,b,c){var e=d.getDefaults(c);if(!e.controls.layers.visible)return!1;var g=0;return f(a)&&(g+=Object.keys(a).length),f(b)&&(g+=Object.keys(b).length),g>1},i=function(a){var b=d.getDefaults(a),c={collapsed:b.controls.layers.collapsed,position:b.controls.layers.position};angular.extend(c,b.controls.layers.options);var e;return e=b.controls.layers&&g(b.controls.layers.control)?b.controls.layers.control.apply(this,[[],[],c]):new L.control.layers([],[],c)};return{layersControlMustBeVisible:h,updateLayersControl:function(a,b,c,d,f,j){var k,l=h(d,f,b);if(g(e)&&c){for(k in j.baselayers)e.removeLayer(j.baselayers[k]);for(k in j.overlays)e.removeLayer(j.overlays[k]);e.removeFrom(a)}if(l){e=i(b);for(k in d)g(j.baselayers[k])&&e.addBaseLayer(j.baselayers[k],d[k].name);for(k in f)g(j.overlays[k])&&e.addOverlay(j.overlays[k],f[k].name);e.addTo(a)}return l}}}]),angular.module("leaflet-directive").factory("leafletLegendHelpers",function(){var a=function(a,b){if(a.innerHTML="",b.error)a.innerHTML+='<div class="info-title alert alert-danger">'+b.error.message+"</div>";else for(var c=0;c<b.layers.length;c++){var d=b.layers[c];a.innerHTML+='<div class="info-title" data-layerid="'+d.layerId+'">'+d.layerName+"</div>";for(var e=0;e<d.legend.length;e++){var f=d.legend[e];a.innerHTML+='<div class="inline" data-layerid="'+d.layerId+'"><img src="data:'+f.contentType+";base64,"+f.imageData+'" /></div><div class="info-label" data-layerid="'+d.layerId+'">'+f.label+"</div>"}}},b=function(b,c){return function(){var d=L.DomUtil.create("div",c);return L.Browser.touch?L.DomEvent.on(d,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(d),L.DomEvent.on(d,"mousewheel",L.DomEvent.stopPropagation)),a(d,b),d}},c=function(a,b){return function(){for(var c=L.DomUtil.create("div",b),d=0;d<a.colors.length;d++)c.innerHTML+='<div class="outline"><i style="background:'+a.colors[d]+'"></i></div><div class="info-label">'+a.labels[d]+"</div>";return L.Browser.touch?L.DomEvent.on(c,"click",L.DomEvent.stopPropagation):(L.DomEvent.disableClickPropagation(c),L.DomEvent.on(c,"mousewheel",L.DomEvent.stopPropagation)),c}};return{getOnAddArcGISLegend:b,getOnAddArrayLegend:c,updateArcGISLegend:a}}),angular.module("leaflet-directive").factory("leafletPathsHelpers",["$rootScope","$log","leafletHelpers",function(a,b,c){function d(a){return a.filter(function(a){return k(a)}).map(function(a){return e(a)})}function e(a){return i(a)?new L.LatLng(a[0],a[1]):new L.LatLng(a.lat,a.lng)}function f(a){return a.map(function(a){return d(a)})}function g(a,b){for(var c={},d=0;d<l.length;d++){var e=l[d];h(a[e])?c[e]=a[e]:h(b.path[e])&&(c[e]=b.path[e])}return c}var h=c.isDefined,i=c.isArray,j=c.isNumber,k=c.isValidPoint,l=["stroke","weight","color","opacity","fill","fillColor","fillOpacity","dashArray","lineCap","lineJoin","clickable","pointerEvents","className","smoothFactor","noClip"],m=function(a,b){for(var c={},d=0;d<l.length;d++){var e=l[d];h(b[e])&&(c[e]=b[e])}a.setStyle(b)},n=function(a){if(!i(a))return!1;for(var b=0;b<a.length;b++){var c=a[b];if(!k(c))return!1}return!0},o={polyline:{isValid:function(a){var b=a.latlngs;return n(b)},createPath:function(a){return new L.Polyline([],a)},setPath:function(a,b){a.setLatLngs(d(b.latlngs)),m(a,b)}},multiPolyline:{isValid:function(a){var b=a.latlngs;if(!i(b))return!1;for(var c in b){var d=b[c];if(!n(d))return!1}return!0},createPath:function(a){return new L.multiPolyline([[[0,0],[1,1]]],a)},setPath:function(a,b){a.setLatLngs(f(b.latlngs)),m(a,b)}},polygon:{isValid:function(a){var b=a.latlngs;return n(b)},createPath:function(a){return new L.Polygon([],a)},setPath:function(a,b){a.setLatLngs(d(b.latlngs)),m(a,b)}},multiPolygon:{isValid:function(a){var b=a.latlngs;if(!i(b))return!1;for(var c in b){var d=b[c];if(!n(d))return!1}return!0},createPath:function(a){return new L.MultiPolygon([[[0,0],[1,1],[0,1]]],a)},setPath:function(a,b){a.setLatLngs(f(b.latlngs)),m(a,b)}},rectangle:{isValid:function(a){var b=a.latlngs;if(!i(b)||2!==b.length)return!1;for(var c in b){var d=b[c];if(!k(d))return!1}return!0},createPath:function(a){return new L.Rectangle([[0,0],[1,1]],a)},setPath:function(a,b){a.setBounds(new L.LatLngBounds(d(b.latlngs))),m(a,b)}},circle:{isValid:function(a){var b=a.latlngs;return k(b)&&j(a.radius)},createPath:function(a){return new L.Circle([0,0],1,a)},setPath:function(a,b){a.setLatLng(e(b.latlngs)),h(b.radius)&&a.setRadius(b.radius),m(a,b)}},circleMarker:{isValid:function(a){var b=a.latlngs;return k(b)&&j(a.radius)},createPath:function(a){return new L.CircleMarker([0,0],a)},setPath:function(a,b){a.setLatLng(e(b.latlngs)),h(b.radius)&&a.setRadius(b.radius),m(a,b)}}},p=function(a){var b={};return a.latlngs&&(b.latlngs=a.latlngs),a.radius&&(b.radius=a.radius),b};return{setPathOptions:function(a,b,c){h(b)||(b="polyline"),o[b].setPath(a,c)},createPath:function(a,c,d){h(c.type)||(c.type="polyline");var e=g(c,d),f=p(c);return o[c.type].isValid(f)?o[c.type].createPath(e):void b.error("[AngularJS - Leaflet] Invalid data passed to the "+c.type+" path")}}}]),angular.module("leaflet-directive").factory("leafletBoundsHelpers",["$log","leafletHelpers",function(a,b){function c(a){return angular.isDefined(a)&&angular.isDefined(a.southWest)&&angular.isDefined(a.northEast)&&angular.isNumber(a.southWest.lat)&&angular.isNumber(a.southWest.lng)&&angular.isNumber(a.northEast.lat)&&angular.isNumber(a.northEast.lng)}var d=b.isArray,e=b.isNumber;return{createLeafletBounds:function(a){return c(a)?L.latLngBounds([a.southWest.lat,a.southWest.lng],[a.northEast.lat,a.northEast.lng]):void 0},isValidBounds:c,createBoundsFromArray:function(b){return d(b)&&2===b.length&&d(b[0])&&d(b[1])&&2===b[0].length&&2===b[1].length&&e(b[0][0])&&e(b[0][1])&&e(b[1][0])&&e(b[1][1])?{northEast:{lat:b[0][0],lng:b[0][1]},southWest:{lat:b[1][0],lng:b[1][1]}}:void a.error("[AngularJS - Leaflet] The bounds array is not valid.")}}}]),angular.module("leaflet-directive").factory("leafletMarkersHelpers",["$rootScope","leafletHelpers","$log","$compile",function(a,b,c,d){var e=b.isDefined,f=b.MarkerClusterPlugin,g=b.AwesomeMarkersPlugin,h=b.MakiMarkersPlugin,i=b.safeApply,j=b,k=b.isString,l=b.isNumber,m=b.isObject,n={},o=function(a){if(e(a)&&e(a.type)&&"awesomeMarker"===a.type)return g.isLoaded()||c.error("[AngularJS - Leaflet] The AwesomeMarkers Plugin is not loaded."),new L.AwesomeMarkers.icon(a);if(e(a)&&e(a.type)&&"makiMarker"===a.type)return h.isLoaded()||c.error("[AngularJS - Leaflet] The MakiMarkers Plugin is not loaded."),new L.MakiMarkers.icon(a);if(e(a)&&e(a.type)&&"div"===a.type)return new L.divIcon(a);var b="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAApCAYAAADAk4LOAAAGmklEQVRYw7VXeUyTZxjvNnfELFuyIzOabermMZEeQC/OclkO49CpOHXOLJl/CAURuYbQi3KLgEhbrhZ1aDwmaoGqKII6odATmH/scDFbdC7LvFqOCc+e95s2VG50X/LLm/f4/Z7neY/ne18aANCmAr5E/xZf1uDOkTcGcWR6hl9247tT5U7Y6SNvWsKT63P58qbfeLJG8M5qcgTknrvvrdDbsT7Ml+tv82X6vVxJE33aRmgSyYtcWVMqX97Yv2JvW39UhRE2HuyBL+t+gK1116ly06EeWFNlAmHxlQE0OMiV6mQCScusKRlhS3QLeVJdl1+23h5dY4FNB3thrbYboqptEFlphTC1hSpJnbRvxP4NWgsE5Jyz86QNNi/5qSUTGuFk1gu54tN9wuK2wc3o+Wc13RCmsoBwEqzGcZsxsvCSy/9wJKf7UWf1mEY8JWfewc67UUoDbDjQC+FqK4QqLVMGGR9d2wurKzqBk3nqIT/9zLxRRjgZ9bqQgub+DdoeCC03Q8j+0QhFhBHR/eP3U/zCln7Uu+hihJ1+bBNffLIvmkyP0gpBZWYXhKussK6mBz5HT6M1Nqpcp+mBCPXosYQfrekGvrjewd59/GvKCE7TbK/04/ZV5QZYVWmDwH1mF3xa2Q3ra3DBC5vBT1oP7PTj4C0+CcL8c7C2CtejqhuCnuIQHaKHzvcRfZpnylFfXsYJx3pNLwhKzRAwAhEqG0SpusBHfAKkxw3w4627MPhoCH798z7s0ZnBJ/MEJbZSbXPhER2ih7p2ok/zSj2cEJDd4CAe+5WYnBCgR2uruyEw6zRoW6/DWJ/OeAP8pd/BGtzOZKpG8oke0SX6GMmRk6GFlyAc59K32OTEinILRJRchah8HQwND8N435Z9Z0FY1EqtxUg+0SO6RJ/mmXz4VuS+DpxXC3gXmZwIL7dBSH4zKE50wESf8qwVgrP1EIlTO5JP9Igu0aexdh28F1lmAEGJGfh7jE6ElyM5Rw/FDcYJjWhbeiBYoYNIpc2FT/SILivp0F1ipDWk4BIEo2VuodEJUifhbiltnNBIXPUFCMpthtAyqws/BPlEF/VbaIxErdxPphsU7rcCp8DohC+GvBIPJS/tW2jtvTmmAeuNO8BNOYQeG8G/2OzCJ3q+soYB5i6NhMaKr17FSal7GIHheuV3uSCY8qYVuEm1cOzqdWr7ku/R0BDoTT+DT+ohCM6/CCvKLKO4RI+dXPeAuaMqksaKrZ7L3FE5FIFbkIceeOZ2OcHO6wIhTkNo0ffgjRGxEqogXHYUPHfWAC/lADpwGcLRY3aeK4/oRGCKYcZXPVoeX/kelVYY8dUGf8V5EBRbgJXT5QIPhP9ePJi428JKOiEYhYXFBqou2Guh+p/mEB1/RfMw6rY7cxcjTrneI1FrDyuzUSRm9miwEJx8E/gUmqlyvHGkneiwErR21F3tNOK5Tf0yXaT+O7DgCvALTUBXdM4YhC/IawPU+2PduqMvuaR6eoxSwUk75ggqsYJ7VicsnwGIkZBSXKOUww73WGXyqP+J2/b9c+gi1YAg/xpwck3gJuucNrh5JvDPvQr0WFXf0piyt8f8/WI0hV4pRxxkQZdJDfDJNOAmM0Ag8jyT6hz0WGXWuP94Yh2jcfjmXAGvHCMslRimDHYuHuDsy2QtHuIavznhbYURq5R57KpzBBRZKPJi8eQg48h4j8SDdowifdIrEVdU+gbO6QNvRRt4ZBthUaZhUnjlYObNagV3keoeru3rU7rcuceqU1mJBxy+BWZYlNEBH+0eH4vRiB+OYybU2hnblYlTvkHinM4m54YnxSyaZYSF6R3jwgP7udKLGIX6r/lbNa9N6y5MFynjWDtrHd75ZvTYAPO/6RgF0k76mQla3FGq7dO+cH8sKn0Vo7nDllwAhqwLPkxrHwWmHJOo+AKJ4rab5OgrM7rVu8eWb2Pu0Dh4eDgXoOfvp7Y7QeqknRmvcTBEyq9m/HQQSCSz6LHq3z0yzsNySRfMS253wl2KyRDbcZPcfJKjZmSEOjcxyi+Y8dUOtsIEH6R2wNykdqrkYJ0RV92H0W58pkfQk7cKevsLK10Py8SdMGfXNXATY+pPbyJR/ET6n9nIfztNtZYRV9XniQu9IA2vOVgy4ir7GCLVmmd+zjkH0eAF9Po6K61pmCXHxU5rHMYd1ftc3owjwRSVRzLjKvqZEty6cRUD7jGqiOdu5HG6MdHjNcNYGqfDm5YRzLBBCCDl/2bk8a8gdbqcfwECu62Fg/HrggAAAABJRU5ErkJggg==",d="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACkAAAApCAYAAACoYAD2AAAC5ElEQVRYw+2YW4/TMBCF45S0S1luXZCABy5CgLQgwf//S4BYBLTdJLax0fFqmB07nnQfEGqkIydpVH85M+NLjPe++dcPc4Q8Qh4hj5D/AaQJx6H/4TMwB0PeBNwU7EGQAmAtsNfAzoZkgIa0ZgLMa4Aj6CxIAsjhjOCoL5z7Glg1JAOkaicgvQBXuncwJAWjksLtBTWZe04CnYRktUGdilALppZBOgHGZcBzL6OClABvMSVIzyBjazOgrvACf1ydC5mguqAVg6RhdkSWQFj2uxfaq/BrIZOLEWgZdALIDvcMcZLD8ZbLC9de4yR1sYMi4G20S4Q/PWeJYxTOZn5zJXANZHIxAd4JWhPIloTJZhzMQduM89WQ3MUVAE/RnhAXpTycqys3NZALOBbB7kFrgLesQl2h45Fcj8L1tTSohUwuxhy8H/Qg6K7gIs+3kkaigQCOcyEXCHN07wyQazhrmIulvKMQAwMcmLNqyCVyMAI+BuxSMeTk3OPikLY2J1uE+VHQk6ANrhds+tNARqBeaGc72cK550FP4WhXmFmcMGhTwAR1ifOe3EvPqIegFmF+C8gVy0OfAaWQPMR7gF1OQKqGoBjq90HPMP01BUjPOqGFksC4emE48tWQAH0YmvOgF3DST6xieJgHAWxPAHMuNhrImIdvoNOKNWIOcE+UXE0pYAnkX6uhWsgVXDxHdTfCmrEEmMB2zMFimLVOtiiajxiGWrbU52EeCdyOwPEQD8LqyPH9Ti2kgYMf4OhSKB7qYILbBv3CuVTJ11Y80oaseiMWOONc/Y7kJYe0xL2f0BaiFTxknHO5HaMGMublKwxFGzYdWsBF174H/QDknhTHmHHN39iWFnkZx8lPyM8WHfYELmlLKtgWNmFNzQcC1b47gJ4hL19i7o65dhH0Negbca8vONZoP7doIeOC9zXm8RjuL0Gf4d4OYaU5ljo3GYiqzrWQHfJxA6ALhDpVKv9qYeZA8eM3EhfPSCmpuD0AAAAASUVORK5CYII=";return e(a)?(e(a.iconUrl)||(a.iconUrl=b,a.shadowUrl=d),new L.Icon(a)):new L.Icon.Default({iconUrl:b,shadowUrl:d})},p=function(a){e(n[a])&&n.splice(a,1)},q=function(){n={}},r=function(a,b,c){if(a.closePopup(),e(c)&&e(c.overlays))for(var d in c.overlays)if((c.overlays[d]instanceof L.LayerGroup||c.overlays[d]instanceof L.FeatureGroup)&&c.overlays[d].hasLayer(a))return void c.overlays[d].removeLayer(a);if(e(n))for(var f in n)n[f].hasLayer(a)&&n[f].removeLayer(a);b.hasLayer(a)&&b.removeLayer(a)};return{resetMarkerGroup:p,resetMarkerGroups:q,deleteMarker:r,createMarker:function(a){if(!e(a))return void c.error("[AngularJS - Leaflet] The marker definition is not valid.");var b={icon:o(a.icon),title:e(a.title)?a.title:"",draggable:e(a.draggable)?a.draggable:!1,clickable:e(a.clickable)?a.clickable:!0,riseOnHover:e(a.riseOnHover)?a.riseOnHover:!1,zIndexOffset:e(a.zIndexOffset)?a.zIndexOffset:0,iconAngle:e(a.iconAngle)?a.iconAngle:0};for(var d in a)a.hasOwnProperty(d)&&!b.hasOwnProperty(d)&&(b[d]=a[d]);var f=new L.marker(a,b);return k(a.message)||f.unbindPopup(),f},addMarkerToGroup:function(a,b,d,g){return k(b)?f.isLoaded()?(e(n[b])||(n[b]=new L.MarkerClusterGroup(d),g.addLayer(n[b])),void n[b].addLayer(a)):void c.error("[AngularJS - Leaflet] The MarkerCluster plugin is not loaded."):void c.error("[AngularJS - Leaflet] The marker group you have specified is invalid.")},listenMarkerEvents:function(b,c,e){b.on("popupopen",function(){d(b.getPopup()._contentNode)(a),i(e,function(){c.focus=!0})}),b.on("popupclose",function(){i(e,function(){c.focus=!1})})},addMarkerWatcher:function(a,b,d,f,g){var h=d.$watch('markers["'+b+'"]',function(b,d){if(!e(b))return r(a,g,f),void h();if(e(d)){if(!l(b.lat)||!l(b.lng))return c.warn("There are problems with lat-lng data, please verify your marker model"),void r(a,g,f);if(k(b.layer)||k(d.layer)&&(e(f.overlays[d.layer])&&f.overlays[d.layer].hasLayer(a)&&(f.overlays[d.layer].removeLayer(a),a.closePopup()),g.hasLayer(a)||g.addLayer(a)),k(b.layer)&&d.layer!==b.layer){if(k(d.layer)&&e(f.overlays[d.layer])&&f.overlays[d.layer].hasLayer(a)&&f.overlays[d.layer].removeLayer(a),a.closePopup(),g.hasLayer(a)&&g.removeLayer(a),!e(f.overlays[b.layer]))return void c.error("[AngularJS - Leaflet] You must use a name of an existing layer");var i=f.overlays[b.layer];if(!(i instanceof L.LayerGroup||i instanceof L.FeatureGroup))return void c.error('[AngularJS - Leaflet] A marker can only be added to a layer of type "group" or "featureGroup"');i.addLayer(a),g.hasLayer(a)&&b.focus===!0&&a.openPopup()}if(b.draggable!==!0&&d.draggable===!0&&e(a.dragging)&&a.dragging.disable(),b.draggable===!0&&d.draggable!==!0&&(a.dragging?a.dragging.enable():L.Handler.MarkerDrag&&(a.dragging=new L.Handler.MarkerDrag(a),a.options.draggable=!0,a.dragging.enable())),m(b.icon)||m(d.icon)&&(a.setIcon(o()),a.closePopup(),a.unbindPopup(),k(b.message)&&a.bindPopup(b.message,b.popupOptions)),m(b.icon)&&m(d.icon)&&!angular.equals(b.icon,d.icon)){var n=!1;a.dragging&&(n=a.dragging.enabled()),a.setIcon(o(b.icon)),n&&a.dragging.enable(),a.closePopup(),a.unbindPopup(),k(b.message)&&a.bindPopup(b.message,b.popupOptions)}!k(b.message)&&k(d.message)&&(a.closePopup(),a.unbindPopup()),j.LabelPlugin.isLoaded()&&e(b.label)&&e(b.label.message)&&!angular.equals(b.label.message,d.label.message)&&a.updateLabelContent(b.label.message),k(b.message)&&!k(d.message)&&(a.bindPopup(b.message,b.popupOptions),b.focus===!0&&a.openPopup()),k(b.message)&&k(d.message)&&b.message!==d.message&&a.setPopupContent(b.message);var p=!1;b.focus!==!0&&d.focus===!0&&(a.closePopup(),p=!0),b.focus===!0&&d.focus!==!0&&(a.openPopup(),p=!0),d.focus===!0&&b.focus===!0&&(a.openPopup(),p=!0),d.zIndexOffset!==b.zIndexOffset&&a.setZIndexOffset(b.zIndexOffset);var q=a.getLatLng(),s=k(b.layer)&&j.MarkerClusterPlugin.is(f.overlays[b.layer]);s?p?(b.lat!==d.lat||b.lng!==d.lng)&&(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):q.lat!==b.lat||q.lng!==b.lng?(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):b.lat!==d.lat||b.lng!==d.lng?(f.overlays[b.layer].removeLayer(a),a.setLatLng([b.lat,b.lng]),f.overlays[b.layer].addLayer(a)):m(b.icon)&&m(d.icon)&&!angular.equals(b.icon,d.icon)&&(f.overlays[b.layer].removeLayer(a),f.overlays[b.layer].addLayer(a)):(q.lat!==b.lat||q.lng!==b.lng)&&a.setLatLng([b.lat,b.lng])}},!0)}}}]),angular.module("leaflet-directive").factory("leafletHelpers",["$q","$log",function(a,b){function c(a,c){var d,e;if(angular.isDefined(c))d=c;else if(0===Object.keys(a).length)d="main";else if(Object.keys(a).length>=1)for(e in a)a.hasOwnProperty(e)&&(d=e);else 0===Object.keys(a).length?d="main":b.error("[AngularJS - Leaflet] - You have more than 1 map on the DOM, you must provide the map ID to the leafletData.getXXX call");return d}function d(b,d){var e,f=c(b,d);return angular.isDefined(b[f])&&b[f].resolvedDefer!==!0?e=b[f].defer:(e=a.defer(),b[f]={defer:e,resolvedDefer:!1}),e}return{isEmpty:function(a){return 0===Object.keys(a).length},isUndefinedOrEmpty:function(a){return angular.isUndefined(a)||null===a||0===Object.keys(a).length},isDefined:function(a){return angular.isDefined(a)&&null!==a},isNumber:function(a){return angular.isNumber(a)},isString:function(a){return angular.isString(a)},isArray:function(a){return angular.isArray(a)},isObject:function(a){return angular.isObject(a)},isFunction:function(a){return angular.isFunction(a)},equals:function(a,b){return angular.equals(a,b)},isValidCenter:function(a){return angular.isDefined(a)&&angular.isNumber(a.lat)&&angular.isNumber(a.lng)&&angular.isNumber(a.zoom)},isValidPoint:function(a){return angular.isDefined(a)?angular.isArray(a)?2===a.length&&angular.isNumber(a[0])&&angular.isNumber(a[1]):angular.isNumber(a.lat)&&angular.isNumber(a.lng):!1},isSameCenterOnMap:function(a,b){var c=b.getCenter(),d=b.getZoom();return a.lat&&a.lng&&c.lat.toFixed(4)===a.lat.toFixed(4)&&c.lng.toFixed(4)===a.lng.toFixed(4)&&d===a.zoom?!0:!1},safeApply:function(a,b){var c=a.$root.$$phase;"$apply"===c||"$digest"===c?a.$eval(b):a.$apply(b)},obtainEffectiveMapId:c,getDefer:function(a,b){var e,f=c(a,b);return e=angular.isDefined(a[f])&&a[f].resolvedDefer!==!1?a[f].defer:d(a,b)},getUnresolvedDefer:d,setResolvedDefer:function(a,b){var d=c(a,b);a[d].resolvedDefer=!0},AwesomeMarkersPlugin:{isLoaded:function(){return angular.isDefined(L.AwesomeMarkers)&&angular.isDefined(L.AwesomeMarkers.Icon)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.AwesomeMarkers.Icon:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},PolylineDecoratorPlugin:{isLoaded:function(){return angular.isDefined(L.PolylineDecorator)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.PolylineDecorator:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},MakiMarkersPlugin:{isLoaded:function(){return angular.isDefined(L.MakiMarkers)&&angular.isDefined(L.MakiMarkers.Icon)?!0:!1},is:function(a){return this.isLoaded()?a instanceof L.MakiMarkers.Icon:!1},equal:function(a,b){return this.isLoaded()&&this.is(a)?angular.equals(a,b):!1}},LabelPlugin:{isLoaded:function(){return angular.isDefined(L.Label)},is:function(a){return this.isLoaded()?a instanceof L.MarkerClusterGroup:!1}},MarkerClusterPlugin:{isLoaded:function(){return angular.isDefined(L.MarkerClusterGroup)},is:function(a){return this.isLoaded()?a instanceof L.MarkerClusterGroup:!1}},GoogleLayerPlugin:{isLoaded:function(){return angular.isDefined(L.Google)},is:function(a){return this.isLoaded()?a instanceof L.Google:!1}},ChinaLayerPlugin:{isLoaded:function(){return angular.isDefined(L.tileLayer.chinaProvider)}},HeatMapLayerPlugin:{isLoaded:function(){return angular.isDefined(L.TileLayer.WebGLHeatMap)}},BingLayerPlugin:{isLoaded:function(){return angular.isDefined(L.BingLayer)},is:function(a){return this.isLoaded()?a instanceof L.BingLayer:!1}},WFSLayerPlugin:{isLoaded:function(){return void 0!==L.GeoJSON.WFS},is:function(a){return this.isLoaded()?a instanceof L.GeoJSON.WFS:!1}},AGSLayerPlugin:{isLoaded:function(){return void 0!==lvector&&void 0!==lvector.AGS},is:function(a){return this.isLoaded()?a instanceof lvector.AGS:!1}},YandexLayerPlugin:{isLoaded:function(){return angular.isDefined(L.Yandex)},is:function(a){return this.isLoaded()?a instanceof L.Yandex:!1}},DynamicMapLayerPlugin:{isLoaded:function(){return void 0!==L.esri&&void 0!==L.esri.dynamicMapLayer},is:function(a){return this.isLoaded()?a instanceof L.esri.dynamicMapLayer:!1}},GeoJSONPlugin:{isLoaded:function(){return angular.isDefined(L.TileLayer.GeoJSON)},is:function(a){return this.isLoaded()?a instanceof L.TileLayer.GeoJSON:!1}},UTFGridPlugin:{isLoaded:function(){return angular.isDefined(L.UtfGrid)},is:function(a){return this.isLoaded()?a instanceof L.UtfGrid:(b.error("[AngularJS - Leaflet] No UtfGrid plugin found."),!1)}},CartoDB:{isLoaded:function(){return cartodb},is:function(){return!0}},Leaflet:{DivIcon:{is:function(a){return a instanceof L.DivIcon},equal:function(a,b){return this.is(a)?angular.equals(a,b):!1}},Icon:{is:function(a){return a instanceof L.Icon},equal:function(a,b){return this.is(a)?angular.equals(a,b):!1}}}}}])}();var app=angular.module("IF",["ngRoute","ngSanitize","ngAnimate","ngTouch","ngMessages","tidepoolsFilters","tidepoolsServices","leaflet-directive","angularFileUpload","IF-directives","mgcrea.ngStrap","angularSpectrumColorpicker","ui.slider","swipe","monospaced.elastic","ui.calendar","textAngular"]).config(function(a,b,c,d,e){var f=(d.classNameFilter(/if-animate/i),function(a){return a.checkLogin()});c.interceptors.push(function(a){return{request:function(a){return a},response:function(a){return a},responseError:function(b){return 401===b.status,a.reject(b)}}}),a.when("/",{templateUrl:"components/home/home.html",controller:"HomeController"}).when("/nearby",{templateUrl:"components/nearby/nearby.html",controller:"NearbyCtrl"}).when("home",{templateUrl:"components/home/home.html",controller:"HomeController"}).when("/nearby",{templateUrl:"components/nearby/nearby.html",controller:"WorldRouteCtrl"}).when("/login",{templateUrl:"components/user/login.html",controller:"LoginCtrl"}).when("/forgot",{templateUrl:"components/user/forgot.html",controller:"ForgotCtrl"}).when("/reset/:token",{templateUrl:"components/user/change-password.html",controller:"ResetCtrl"}).when("/signup",{templateUrl:"components/user/signup.html",controller:"SignupCtrl"}).when("/signup/:incoming",{templateUrl:"components/user/signup.html",controller:"SignupCtrl"}).when("/auth/:type",{templateUrl:"components/user/loading.html",controller:"resolveAuth"}).when("/auth/:type/:callback",{templateUrl:"components/user/loading.html",controller:"resolveAuth"}).when("/profile",{redirectTo:"/profile/worlds"}).when("/profile/:tab",{templateUrl:"components/user/user.html",controller:"UserController"}).when("/profile/:tab/:incoming",{templateUrl:"components/user/user.html",controller:"UserController"}).when("/w/:worldURL",{templateUrl:"components/world/world.html",controller:"WorldController"}).when("/w/:worldURL/upcoming",{templateUrl:"components/world/upcoming.html",controller:"WorldController"}).when("/w/:worldURL/messages",{templateUrl:"components/world/messages/messages.html",controller:"MessagesController"}).when("/w/:worldURL/schedule",{templateUrl:"components/world/subviews/schedule.html",controller:"ScheduleController"}).when("/w/:worldURL/instagram",{templateUrl:"components/world/subviews/instagram.html",controller:"InstagramListController"}).when("/w/:worldURL/twitter",{templateUrl:"components/world/subviews/twitter.html",controller:"TwitterListController"}).when("/w/:worldURL/contest/:hashTag",{templateUrl:"components/world/subviews/contest.html",controller:"ContestController"}).when("/w/:worldURL/:landmarkURL",{templateUrl:"components/world/landmark.html",controller:"LandmarkController"}).when("/w/:worldURL/category/:category",{templateUrl:"components/world/category.html",controller:"CategoryController"}).when("/edit/w/:worldURL/landmarks",{templateUrl:"components/edit/landmark-editor.html",controller:"LandmarkEditorController",resolve:{loggedin:f}}).when("/edit/w/:worldURL/",{templateUrl:"components/edit/edit_world.html",controller:"EditController",resolve:{loggedin:f}}).when("/edit/w/:worldURL/:view",{templateUrl:"components/edit/edit_world.html",controller:"EditController",resolve:{loggedin:f}}).when("/edit/walkthrough/:_id",{templateUrl:"components/edit/walkthrough/walkthrough.html",controller:"WalkthroughController",resolve:{loggedin:f}}).when("/meetup",{templateUrl:"components/tour/meetup.html",controller:"MeetupController"}).when("/welcome",{templateUrl:"components/tour/welcome.html",controller:"WelcomeController"}).when("/search/:searchQuery",{templateUrl:"components/search/search.html",controller:"SearchController"}).when("/twitter/:hashTag",{templateUrl:"partials/tweet-list.html",controller:"TweetlistCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode({enabled:!0}),angular.extend(e.defaults,{animation:"am-fade",placement:"right",delay:{show:"0",hide:"250"}})}).run(function(a,b,c,d){d.checkLogin()});angular.element(document).ready(function(){angular.bootstrap(document,["IF"])}),angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$timeout","$locale",function(a,b,c){var d=1,e=1,f=a.eventSources,g=a.calendarWatchEvent?a.calendarWatchEvent:angular.noop,h=function(a){var c;return a&&(c=function(){var c=arguments,d=this;b(function(){a.apply(d,c)})}),c};this.eventsFingerprint=function(a){return a._id||(a._id=e++),""+a._id+(a.id||"")+(a.title||"")+(a.url||"")+(+a.start||"")+(+a.end||"")+(a.allDay||"")+(a.className||"")+g(a)||""},this.sourcesFingerprint=function(a){return a.__id||(a.__id=d++)},this.allEvents=function(){for(var a=[],b=0,c=f.length;c>b;b++){var d=f[b];if(angular.isArray(d))a.push(d);else if(angular.isObject(d)&&angular.isArray(d.events)){var e={};for(var g in d)"_uiCalId"!==g&&"events"!==g&&(e[g]=d[g]);for(var h=0;h<d.events.length;h++)angular.extend(d.events[h],e);a.push(d.events)}}return Array.prototype.concat.apply([],a)},this.changeWatcher=function(a,b){var c,d=function(){for(var c,d,e=angular.isFunction(a)?a():a,g=[],h=0,i=e.length;i>h;h++)d=e[h],c=b(d),f[c]=d,g.push(c);return g},e=function(a,b){var c,d,e=[],f={};for(c=0,d=b.length;d>c;c++)f[b[c]]=!0;for(c=0,d=a.length;d>c;c++)f[a[c]]||e.push(a[c]);return e},f={},g=function(a,d){var g,h,i,j,k={},l=e(d,a);for(g=0,h=l.length;h>g;g++){var m=l[g];i=f[m],delete f[m];var n=b(i);n===m?c.onRemoved(i):(k[n]=m,c.onChanged(i))}var o=e(a,d);for(g=0,h=o.length;h>g;g++)j=o[g],i=f[j],k[j]||c.onAdded(i)};return c={subscribe:function(a,b){a.$watch(d,function(a,c){b&&b(a,c)===!1||g(a,c)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(a,b){var c={};return angular.extend(c,b),angular.extend(c,a),angular.forEach(c,function(a,b){"function"==typeof a&&(c[b]=h(c[b]))}),c},this.getLocaleConfig=function(a){if(!a.lang||a.useNgLocale){var b=function(a){var b,c;b=[];for(c in a)b[c]=a[c];return b},d=c.DATETIME_FORMATS;return{monthNames:b(d.MONTH),monthNamesShort:b(d.SHORTMONTH),dayNames:b(d.DAY),dayNamesShort:b(d.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(a){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(b,c,d,e){function f(){var c,f=d.uiCalendar?b.$parent.$eval(d.uiCalendar):{};c=e.getFullCalendarConfig(f,a);var g=e.getLocaleConfig(c);angular.extend(g,c),l={eventSources:h},angular.extend(l,g),l.calendars=null;var i={};for(var j in l)"eventSources"!==j&&(i[j]=l[j]);return JSON.stringify(i)}var g,h=b.eventSources,i=!1,j=e.changeWatcher(h,e.sourcesFingerprint),k=e.changeWatcher(e.allEvents,e.eventsFingerprint),l=null;b.destroy=function(){g&&g.fullCalendar&&g.fullCalendar("destroy"),g=d.calendar?a.calendars[d.calendar]=$(c).html(""):$(c).html("")},b.init=function(){g.fullCalendar(l)},j.onAdded=function(a){g.fullCalendar("addEventSource",a),i=!0},j.onRemoved=function(a){g.fullCalendar("removeEventSource",a),i=!0},k.onAdded=function(a){g.fullCalendar("renderEvent",a)},k.onRemoved=function(a){g.fullCalendar("removeEvents",function(b){return b._id===a._id})},k.onChanged=function(a){a._start=$.fullCalendar.moment(a.start),a._end=$.fullCalendar.moment(a.end),g.fullCalendar("updateEvent",a)},j.subscribe(b),k.subscribe(b,function(){return i===!0?(i=!1,!1):void 0}),b.$watch(f,function(){b.destroy(),b.init()})}}}]),angular.module("IF-directives",[]).directive("myPostRepeatDirective",function(){return function(a){if(a.$last){var b=$("#card-container");b.isotope({itemSelector:".iso-card"})}}}).directive("ngEnter",function(){return function(a,b,c){b.bind("keydown keypress",function(b){13===b.which&&(a.$apply(function(){a.$eval(c.ngEnter)}),b.preventDefault())})}}),app.directive("bubbleBody",function(a){return{restrict:"A",scope:!0,link:function(b,c){var d=_.throttle(function(){var b=c.scrollTop();0===b&&"aperture-third"!=a.state?a.set("third"):"aperture-off"!=a.state&&a.set("off")},100);c.on("scroll",d),b.$on("$destroy",function(){c.off("scroll")})}}}),app.directive("compassButton",function(a,b,c,d,e){return{restrict:"EA",scope:!0,link:function(f,g){function h(){if(1==f.compassState){var a=g.offset(),b=4,c={top:b,left:a.left-i.width()+40};i.offset(c)}}var i;b("templates/compassButton.html").then(function(a){c(a)(f,function(a){i=$(a).appendTo(document.body),h(),f.$watch(function(){return d.getDisplayName()},function(){h()}),$(window).resize(_.debounce(h,200))})}),f.compassOn=function(a,b){void 0!=b&&(f.compassState=b),1==b&&e(h,0),a&&(a.stopPropagation(),$(document.body).on("click",function(){f.compassState=!1,f.$digest(),$(document.body).off("click")}))},a.getNearby().then(function(a){f.nearbyBubbles=a["150m"]},function(a){})}}}),angular.module("monospaced.elastic",[]).constant("msdElasticConfig",{append:""}).directive("msdElastic",["$timeout","$window","msdElasticConfig",function(a,b,c){"use strict";return{require:"ngModel",restrict:"A, C",link:function(d,e,f,g){function h(){var a=r;n=k,u=getComputedStyle(k),angular.forEach(C,function(b){a+=b+":"+u.getPropertyValue(b)+";"}),t.setAttribute("style",a)}function i(){var b,c,e,f,g;n!==k&&h(),o||(o=!0,t.value=k.value+p,t.style.overflowY=k.style.overflowY,b=""===k.style.height?"auto":parseInt(k.style.height,10),c=getComputedStyle(k).getPropertyValue("width"),"px"===c.substr(c.length-2,2)&&(f=parseInt(c,10)-x.width,t.style.width=f+"px"),e=t.scrollHeight,e>B?(e=B,g="scroll"):A>e&&(e=A),e+=x.height,k.style.overflowY=g||"hidden",b!==e&&(k.style.height=e+"px",d.$emit("elastic:resize",l)),a(function(){o=!1},1))}function j(){o=!1,i()}var k=e[0],l=e;if("TEXTAREA"===k.nodeName&&b.getComputedStyle){l.css({overflow:"hidden","overflow-y":"hidden","word-wrap":"break-word"});var m=k.value;k.value="",k.value=m;var n,o,p=f.msdElastic?f.msdElastic.replace(/\\n/g,"\n"):c.append,q=angular.element(b),r="position: absolute; top: -999px; right: auto; bottom: auto;left: 0; overflow: hidden; -webkit-box-sizing: content-box;-moz-box-sizing: content-box; box-sizing: content-box;min-height: 0 !important; height: 0 !important; padding: 0;word-wrap: break-word; border: 0;",s=angular.element('<textarea tabindex="-1" style="'+r+'"/>').data("elastic",!0),t=s[0],u=getComputedStyle(k),v=u.getPropertyValue("resize"),w="border-box"===u.getPropertyValue("box-sizing")||"border-box"===u.getPropertyValue("-moz-box-sizing")||"border-box"===u.getPropertyValue("-webkit-box-sizing"),x=w?{width:parseInt(u.getPropertyValue("border-right-width"),10)+parseInt(u.getPropertyValue("padding-right"),10)+parseInt(u.getPropertyValue("padding-left"),10)+parseInt(u.getPropertyValue("border-left-width"),10),height:parseInt(u.getPropertyValue("border-top-width"),10)+parseInt(u.getPropertyValue("padding-top"),10)+parseInt(u.getPropertyValue("padding-bottom"),10)+parseInt(u.getPropertyValue("border-bottom-width"),10)}:{width:0,height:0},y=parseInt(u.getPropertyValue("min-height"),10),z=parseInt(u.getPropertyValue("height"),10),A=Math.max(y,z)-x.height,B=parseInt(u.getPropertyValue("max-height"),10),C=["font-family","font-size","font-weight","font-style","letter-spacing","line-height","text-transform","word-spacing","text-indent"];
l.data("elastic")||(B=B&&B>0?B:9e4,t.parentNode!==document.body&&angular.element(document.body).append(t),l.css({resize:"none"===v||"vertical"===v?"none":"horizontal"}).data("elastic",!0),k.oninput="onpropertychange"in k&&"oninput"in k?k.onkeyup=i:i,q.bind("resize",j),d.$watch(function(){return g.$modelValue},function(){j()}),d.$on("elastic:adjust",function(){h(),j()}),a(i),d.$on("$destroy",function(){s.remove(),q.unbind("resize",j)}))}}}}]),app.directive("fitFont",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(a){return a.offsetHeight<a.scrollHeight||a.offsetWidth<a.scrollWidth?!0:!1}function d(){for(;c(h)&&g>12;)g--,b.css("font-size",g+"px")}function e(){for(;!c(h)&&40>g;)g++,b.css("font-size",g+"px");d()}function f(a,b){b>a?d():e()}var g=parseInt(b.css("font-size")),h=b[0],i=[];i.push(a.$watch(function(){return h.clientWidth},function(a,b){a!=b&&f(a,b)})),i.push(a.$watch(function(){return h.innerText},function(){e()})),a.$on("$destroy",function(){for(var a=0,b=i.length;b>a;a++)i[a]()})}}}),app.directive("ifHref",function(){return{restrict:"A",priority:99,link:function(a,b,c){c.$observe("ifHref",function(a){if(!a)return void c.$set("href",null);var b=a.indexOf("#");b>-1&&(a=a.slice(0,b)+a.slice(b+1)),c.$set("href",a)})}}}),app.directive("ifSrc",function(){return{restrict:"A",priority:99,link:function(a,b,c){c.$observe("ifSrc",function(a){return a?void c.$set("src",a):void c.$set("src",null)})}}}),app.directive("progressCircle",function(){return{restrict:"EA",scope:{top:"=",left:"=",fullWidth:"=",spinLeft:"=",spinLeftLong:"="},templateUrl:"templates/progressCircle.html",controller:function(a){a.style=function(){return{top:a.top+"px",left:a.left+"px",width:a.fullWidth+"px",height:a.fullWidth+"px",clip:b(a.spinLeft,a.spinLeftLong,a.fullWidth)}},a.styleClip={clip:"rect(0px,"+a.fullWidth/2+"px,"+a.fullWidth+"px,0px)"};var b=function(a,b,c){var d="rect(auto, auto, auto, auto)",e="rect(0px, 0px, 0px, 0px)",f="rect(0px,"+c+"px,"+c+"px,"+c/2+"px)";return a&&b?d:a||b?f:e}}}}),app.directive("ryFocus",function(){return{restrict:"A",scope:{shouldFocus:"=ryFocus"},link:function(a,b){a.$watch("shouldFocus",function(a,c){1!=a||c?0==a&&c&&b[0].blur():b[0].focus()})}}}),app.directive("stickers",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(a,b){return/touch/.test(a.type)?(a.originalEvent||a).changedTouches[0]["page"+b]:a["page"+b]}function d(a){n=c(a,"X"),o=c(a,"Y"),g=0,h=0,m=setTimeout(function(){l=!0},200)}function e(a){i=c(a,"X"),j=c(a,"Y"),g=i-n,h=j-o,l||Math.abs(h)>10&&(k=!0),l&&(a.preventDefault(),p.style.top=j+"px",p.style.left=i+"px"),(Math.abs(g)>5||Math.abs(h)>5)&&clearTimeout(m)}function f(a){l||!k&Math.abs(g)<5&&Math.abs(h)<5&&"touchend"===a.type&&a.preventDefault(),swipe=!1,l=!1,k=!1,clearTimeout(m)}var g,h,i,j,k,l,m,n,o,p=document.createElement("div");p.className="floating-sticker",document.body.appendChild(p),b.on("touchstart",d).on("touchmove",e).on("touchend",f)}}}),app.directive("stickerCrosshair",["$window",function(){return{restrict:"A",scope:!0,link:function(a,b){function c(){var a=Math.max(document.documentElement.clientHeight,window.innerHeight||0),c=Math.max(document.documentElement.clientWidth,window.innerWidth||0),d=0,e=0,f=c/2-d,g=(a-220-48)/2+48-e;b[0].style.left=f+"px",b[0].style.top=g+"px"}$(window).on("resize",c),c()}}}]),angular.module("IF-directives",[]).directive("ifTooltip",function(){return{restrict:"A",link:function(a,b){new Drop({target:b[0],content:"testing 123",position:"bottom right",openOn:"click"})}}}),angular.module("IF-directives",[]).directive("userChip",["dialogs",function(a){return{restrict:"A",scope:!0,link:function(b){b.openDrawer=function(){b.$emit("toggleDrawer")},b.login=function(){a.showDialog("authDialog.html")}},templateUrl:"templates/userChip.html"}}]),app.directive("worldShelf",["$document","apertureService","$rootScope","$location",function(){return{restrict:"A",link:function(){}}}]),angular.module("tidepoolsFilters",[]).filter("hashtag",function(){return function(a){return a.replace(/[#]+[A-Za-z0-9-_]+/g,function(a){var b=a.replace("#","");return a.link("#/talk/"+b)})}}).filter("youtubestrip",function(){return function(a){if(a){var b=a.replace(/^[^_]*=/,"");return b}}}).filter("url",function(){return function(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return a.replace(b,function(a){return'<a href="'+a+'">'+a+"</a>"})}}).filter("unsafe",function(a){return function(b){return a.trustAsHtml(b)}}).filter("httpsify",function(){return function(a){return a.replace(/^http:\/\//i,"https://")}}).filter("userName",function(){return function(a){var b;return"string"==typeof a?(b=a.indexOf("@"),-1!=b?a.substr(0,b):a):a}}).filter("datetime",function(a){return function(b){if(null==b)return"";var c=a("date")(new Date(b),"hh:mm a - MMM dd, yyyy");return c.toUpperCase()}}),function(a){"function"==typeof define&&define.amd?define(["jquery","moment"],a):a(jQuery,moment)}(function(a,b){function c(a,b){return b.longDateFormat("LT").replace(":mm","(:mm)").replace(/(\Wmm)$/,"($1)").replace(/\s*a$/i,"t")}function d(a,b){var c=b.longDateFormat("L");return c=c.replace(/^Y+[^\w\s]*|[^\w\s]*Y+$/g,""),a.isRTL?c+=" ddd":c="ddd "+c,c}function e(a){f(Gb,a)}function f(b){function c(c,d){a.isPlainObject(d)&&a.isPlainObject(b[c])&&!g(c)?b[c]=f({},b[c],d):void 0!==d&&(b[c]=d)}for(var d=1;d<arguments.length;d++)a.each(arguments[d],c);return b}function g(a){return/(Time|Duration)$/.test(a)}function h(c,d){function e(a){var c=b.localeData||b.langData;return c.call(b,a)||c.call(b,"en")}function g(a){cb?l()&&(p(),n(a)):h()}function h(){db=Z.theme?"ui":"fc",c.addClass("fc"),c.addClass(Z.isRTL?"fc-rtl":"fc-ltr"),c.addClass(Z.theme?"ui-widget":"fc-unthemed"),cb=a("<div class='fc-view-container'/>").prependTo(c),ab=new i(X,Z),bb=ab.render(),bb&&c.prepend(bb),m(Z.defaultView),Z.handleWindowResize&&(gb=J(r,Z.windowResizeDelay),a(window).resize(gb))}function k(){eb&&eb.destroy(),ab.destroy(),cb.remove(),c.removeClass("fc fc-ltr fc-rtl fc-unthemed ui-widget"),a(window).unbind("resize",gb)}function l(){return c.is(":visible")}function m(a){n(0,a)}function n(b,c){lb++,eb&&c&&eb.name!==c&&(ab.deactivateButton(eb.name),Q(),eb.start&&eb.destroy(),eb.el.remove(),eb=null),!eb&&c&&(eb=new Kb[c](X),eb.el=a("<div class='fc-view fc-"+c+"-view' />").appendTo(cb),ab.activateButton(c)),eb&&(b&&(hb=eb.incrementDate(hb,b)),eb.start&&!b&&hb.isWithin(eb.intervalStart,eb.intervalEnd)||l()&&(Q(),eb.start&&eb.destroy(),eb.render(hb),R(),z(),A(),v())),R(),lb--}function o(a){return l()?(a&&q(),lb++,eb.updateSize(!0),lb--,!0):void 0}function p(){l()&&q()}function q(){fb="number"==typeof Z.contentHeight?Z.contentHeight:"number"==typeof Z.height?Z.height-(bb?bb.outerHeight(!0):0):Math.round(cb.width()/Math.max(Z.aspectRatio,.5))}function r(a){!lb&&a.target===window&&eb.start&&o(!0)&&eb.trigger("windowResize",kb)}function s(){u(),w()}function t(){l()&&(Q(),eb.destroyEvents(),eb.renderEvents(mb),R())}function u(){Q(),eb.destroyEvents(),R()}function v(){!Z.lazyFetching||ib(eb.start,eb.end)?w():t()}function w(){jb(eb.start,eb.end)}function x(a){mb=a,t()}function y(){t()}function z(){ab.updateTitle(eb.title)}function A(){var a=X.getNow();a.isWithin(eb.intervalStart,eb.intervalEnd)?ab.disableButton("today"):ab.enableButton("today")}function B(a,b){a=X.moment(a),b=b?X.moment(b):a.clone().add(a.hasTime()?X.defaultTimedEventDuration:X.defaultAllDayEventDuration),eb.select(a,b)}function C(){eb&&eb.unselect()}function E(){n(-1)}function F(){n(1)}function G(){hb.add(-1,"years"),n()}function H(){hb.add(1,"years"),n()}function K(){hb=X.getNow(),n()}function L(a){hb=X.moment(a),n()}function M(a){hb.add(b.duration(a)),n()}function N(a,b){var c,d;b&&void 0!==Kb[b]||(b=b||"day",c=ab.getViewsWithButtons().join(" "),d=c.match(new RegExp("\\w+"+I(b))),d||(d=c.match(/\w+Day/)),b=d?d[0]:"agendaDay"),hb=a,m(b)}function O(){return hb.clone()}function Q(){cb.css({width:"100%",height:cb.height(),overflow:"hidden"})}function R(){cb.css({width:"",height:"",overflow:""})}function T(){return X}function U(){return eb}function V(a,b){return void 0===b?Z[a]:void(("height"==a||"contentHeight"==a||"aspectRatio"==a)&&(Z[a]=b,o(!0)))}function W(a,b){return Z[a]?Z[a].apply(b||kb,Array.prototype.slice.call(arguments,2)):void 0}var X=this;d=d||{};var Y,Z=f({},Gb,d);Y=Z.lang in Hb?Hb[Z.lang]:Hb[Gb.lang],Y&&(Z=f({},Gb,Y,d)),Z.isRTL&&(Z=f({},Gb,Ib,Y||{},d)),X.options=Z,X.render=g,X.destroy=k,X.refetchEvents=s,X.reportEvents=x,X.reportEventChange=y,X.rerenderEvents=t,X.changeView=m,X.select=B,X.unselect=C,X.prev=E,X.next=F,X.prevYear=G,X.nextYear=H,X.today=K,X.gotoDate=L,X.incrementDate=M,X.zoomTo=N,X.getDate=O,X.getCalendar=T,X.getView=U,X.option=V,X.trigger=W;var $=D(e(Z.lang));if(Z.monthNames&&($._months=Z.monthNames),Z.monthNamesShort&&($._monthsShort=Z.monthNamesShort),Z.dayNames&&($._weekdays=Z.dayNames),Z.dayNamesShort&&($._weekdaysShort=Z.dayNamesShort),null!=Z.firstDay){var _=D($._week);_.dow=Z.firstDay,$._week=_}X.defaultAllDayEventDuration=b.duration(Z.defaultAllDayEventDuration),X.defaultTimedEventDuration=b.duration(Z.defaultTimedEventDuration),X.moment=function(){var a;return"local"===Z.timezone?(a=Jb.moment.apply(null,arguments),a.hasTime()&&a.local()):a="UTC"===Z.timezone?Jb.moment.utc.apply(null,arguments):Jb.moment.parseZone.apply(null,arguments),"_locale"in a?a._locale=$:a._lang=$,a},X.getIsAmbigTimezone=function(){return"local"!==Z.timezone&&"UTC"!==Z.timezone},X.rezoneDate=function(a){return X.moment(a.toArray())},X.getNow=function(){var a=Z.now;return"function"==typeof a&&(a=a()),X.moment(a)},X.calculateWeekNumber=function(a){var b=Z.weekNumberCalculation;return"function"==typeof b?b(a):"local"===b?a.week():"ISO"===b.toUpperCase()?a.isoWeek():void 0},X.getEventEnd=function(a){return a.end?a.end.clone():X.getDefaultEventEnd(a.allDay,a.start)},X.getDefaultEventEnd=function(a,b){var c=b.clone();return a?c.stripTime().add(X.defaultAllDayEventDuration):c.add(X.defaultTimedEventDuration),X.getIsAmbigTimezone()&&c.stripZone(),c},X.formatRange=function(a,b,c){return"function"==typeof c&&(c=c.call(X,Z,$)),S(a,b,c,null,Z.isRTL)},X.formatDate=function(a,b){return"function"==typeof b&&(b=b.call(X,Z,$)),P(a,b)},j.call(X,Z);var ab,bb,cb,db,eb,fb,gb,hb,ib=X.isFetchNeeded,jb=X.fetchEvents,kb=c[0],lb=0,mb=[];hb=null!=Z.defaultDate?X.moment(Z.defaultDate):X.getNow(),X.getSuggestedViewHeight=function(){return void 0===fb&&p(),fb},X.isHeightAuto=function(){return"auto"===Z.contentHeight||"auto"===Z.height}}function i(b,c){function d(){var b=c.header;return n=c.theme?"ui":"fc",b?o=a("<div class='fc-toolbar'/>").append(f("left")).append(f("right")).append(f("center")).append('<div class="fc-clear"/>'):void 0}function e(){o.remove()}function f(d){var e=a('<div class="fc-'+d+'"/>'),f=c.header[d];return f&&a.each(f.split(" "),function(){var d,f=a(),g=!0;a.each(this.split(","),function(d,e){var h,i,j,k,l,m,o,q;"title"==e?(f=f.add(a("<h2>&nbsp;</h2>")),g=!1):(b[e]?h=function(){b[e]()}:Kb[e]&&(h=function(){b.changeView(e)},p.push(e)),h&&(i=y(c.themeButtonIcons,e),j=y(c.buttonIcons,e),k=y(c.defaultButtonText,e),l=y(c.buttonText,e),m=l?G(l):i&&c.theme?"<span class='ui-icon ui-icon-"+i+"'></span>":j&&!c.theme?"<span class='fc-icon fc-icon-"+j+"'></span>":G(k||e),o=["fc-"+e+"-button",n+"-button",n+"-state-default"],q=a('<button type="button" class="'+o.join(" ")+'">'+m+"</button>").click(function(){q.hasClass(n+"-state-disabled")||(h(),(q.hasClass(n+"-state-active")||q.hasClass(n+"-state-disabled"))&&q.removeClass(n+"-state-hover"))}).mousedown(function(){q.not("."+n+"-state-active").not("."+n+"-state-disabled").addClass(n+"-state-down")}).mouseup(function(){q.removeClass(n+"-state-down")}).hover(function(){q.not("."+n+"-state-active").not("."+n+"-state-disabled").addClass(n+"-state-hover")},function(){q.removeClass(n+"-state-hover").removeClass(n+"-state-down")}),f=f.add(q)))}),g&&f.first().addClass(n+"-corner-left").end().last().addClass(n+"-corner-right").end(),f.length>1?(d=a("<div/>"),g&&d.addClass("fc-button-group"),d.append(f),e.append(d)):e.append(f)}),e}function g(a){o.find("h2").text(a)}function h(a){o.find(".fc-"+a+"-button").addClass(n+"-state-active")}function i(a){o.find(".fc-"+a+"-button").removeClass(n+"-state-active")}function j(a){o.find(".fc-"+a+"-button").attr("disabled","disabled").addClass(n+"-state-disabled")}function k(a){o.find(".fc-"+a+"-button").removeAttr("disabled").removeClass(n+"-state-disabled")}function l(){return p}var m=this;m.render=d,m.destroy=e,m.updateTitle=g,m.activateButton=h,m.deactivateButton=i,m.disableButton=j,m.enableButton=k,m.getViewsWithButtons=l;var n,o=a(),p=[]}function j(c){function d(a,b){return!M||a.clone().stripZone()<M.clone().stripZone()||b.clone().stripZone()>N.clone().stripZone()}function e(a,b){M=a,N=b,X=[];var c=++U,d=T.length;V=d;for(var e=0;d>e;e++)f(T[e],c)}function f(b,c){g(b,function(d){var e,f,g,h=a.isArray(b.events);if(c==U){if(d)for(e=0;e<d.length;e++)f=d[e],g=h?f:u(f,b),g&&X.push.apply(X,w(g));V--,V||Q(X)}})}function g(b,d){var e,f,h=Jb.sourceFetchers;for(e=0;e<h.length;e++){if(f=h[e].call(L,b,M.clone(),N.clone(),c.timezone,d),f===!0)return;if("object"==typeof f)return void g(f,d)}var i=b.events;if(i)a.isFunction(i)?(s(),i.call(L,M.clone(),N.clone(),c.timezone,function(a){d(a),t()})):a.isArray(i)?d(i):d();else{var j=b.url;if(j){var k,l=b.success,m=b.error,n=b.complete;k=a.isFunction(b.data)?b.data():b.data;var o=a.extend({},k||{}),p=F(b.startParam,c.startParam),q=F(b.endParam,c.endParam),r=F(b.timezoneParam,c.timezoneParam);p&&(o[p]=M.format()),q&&(o[q]=N.format()),c.timezone&&"local"!=c.timezone&&(o[r]=c.timezone),s(),a.ajax(a.extend({},Lb,b,{data:o,success:function(b){b=b||[];var c=E(l,this,arguments);a.isArray(c)&&(b=c),d(b)},error:function(){E(m,this,arguments),d()},complete:function(){E(n,this,arguments),t()}}))}else d()}}function h(a){var b=i(a);b&&(T.push(b),V++,f(b,U))}function i(b){var c,d,e=Jb.sourceNormalizers;if(a.isFunction(b)||a.isArray(b)?c={events:b}:"string"==typeof b?c={url:b}:"object"==typeof b&&(c=a.extend({},b)),c){for(c.className?"string"==typeof c.className&&(c.className=c.className.split(/\s+/)):c.className=[],a.isArray(c.events)&&(c.origArray=c.events,c.events=a.map(c.events,function(a){return u(a,c)})),d=0;d<e.length;d++)e[d].call(L,c);return c}}function j(b){T=a.grep(T,function(a){return!l(a,b)}),X=a.grep(X,function(a){return!l(a.source,b)}),Q(X)}function l(a,b){return a&&b&&m(a)==m(b)}function m(a){return("object"==typeof a?a.origArray||a.url||a.events:null)||a}function n(a){a.start=L.moment(a.start),a.end&&(a.end=L.moment(a.end)),x(a),o(a),Q(X)}function o(a){var b,c,d,e;for(b=0;b<X.length;b++)if(c=X[b],c._id==a._id&&c!==a)for(d=0;d<Y.length;d++)e=Y[d],void 0!==a[e]&&(c[e]=a[e])}function p(a,b){var c,d,e,f=u(a);if(f){for(c=w(f),d=0;d<c.length;d++)e=c[d],e.source||(b&&(S.events.push(e),e.source=S),X.push(e));return Q(X),c}return[]}function q(b){var c,d;for(null==b?b=function(){return!0}:a.isFunction(b)||(c=b+"",b=function(a){return a._id==c}),X=a.grep(X,b,!0),d=0;d<T.length;d++)a.isArray(T[d].events)&&(T[d].events=a.grep(T[d].events,b,!0));Q(X)}function r(b){return a.isFunction(b)?a.grep(X,b):null!=b?(b+="",a.grep(X,function(a){return a._id==b})):X}function s(){W++||O("loading",null,!0,P())}function t(){--W||O("loading",null,!1,P())}function u(d,e){var f,g,h,i,j={};if(c.eventDataTransform&&(d=c.eventDataTransform(d)),e&&e.eventDataTransform&&(d=e.eventDataTransform(d)),a.extend(j,d),e&&(j.source=e),j._id=d._id||(void 0===d.id?"_fc"+Mb++:d.id+""),j.className=d.className?"string"==typeof d.className?d.className.split(/\s+/):d.className:[],f=d.start||d.date,g=d.end,C(f)&&(f=b.duration(f)),C(g)&&(g=b.duration(g)),d.dow||b.isDuration(f)||b.isDuration(g))j.start=f?b.duration(f):null,j.end=g?b.duration(g):null,j._recurring=!0;else{if(f&&(f=L.moment(f),!f.isValid()))return!1;if(g&&(g=L.moment(g),!g.isValid()))return!1;h=d.allDay,void 0===h&&(i=F(e?e.allDayDefault:void 0,c.allDayDefault),h=void 0!==i?i:!(f.hasTime()||g&&g.hasTime())),v(f,g,h,j)}return j}function v(a,b,d,e){d?(a.hasTime()&&a.stripTime(),b&&b.hasTime()&&b.stripTime()):(a.hasTime()||(a=L.rezoneDate(a)),b&&!b.hasTime()&&(b=L.rezoneDate(b))),e.allDay=d,e.start=a,e.end=b||null,c.forceEventDuration&&!e.end&&(e.end=R(e)),k(e)}function w(b){var c,d,e,f,g,h,i,j,k,l,m=[],n=M,o=N;if(n&&o||(c=L.getView(),n=c.start,o=c.end),b)if(b._recurring){if(e=b.dow)for(d={},f=0;f<e.length;f++)d[e[f]]=!0;for(g=n.clone().stripTime();g.isBefore(o);)(!d||d[g.day()])&&(h=b.start,i=b.end,j=g.clone(),k=null,h&&(j=j.time(h)),i&&(k=g.clone().time(i)),l=a.extend({},b),v(j,k,!h&&!i,l),m.push(l)),g.add(1,"days")}else m.push(b);return m}function x(a,b,c){var d,e,f,g,h=a._allDay,i=a._start,j=a._end,k=!1;return b||c||(b=a.start,c=a.end),d=a.allDay!=h?a.allDay:!(b||c).hasTime(),d&&(b&&(b=b.clone().stripTime()),c&&(c=c.clone().stripTime())),b&&(e=d?z(b,i.clone().stripTime()):z(b,i)),d!=h?k=!0:c&&(f=z(c||L.getDefaultEventEnd(d,b||i),b||i).subtract(z(j||L.getDefaultEventEnd(h,i),i))),g=y(r(a._id),k,d,e,f),{dateDelta:e,durationDelta:f,undo:g}}function y(b,d,e,f,g){var h=L.getIsAmbigTimezone(),i=[];return a.each(b,function(a,b){var j=b._allDay,l=b._start,m=b._end,n=null!=e?e:j,o=l.clone(),p=!d&&m?m.clone():null;n?(o.stripTime(),p&&p.stripTime()):(o.hasTime()||(o=L.rezoneDate(o)),p&&!p.hasTime()&&(p=L.rezoneDate(p))),p||!c.forceEventDuration&&!+g||(p=L.getDefaultEventEnd(n,o)),o.add(f),p&&p.add(f).add(g),h&&(+f||+g)&&(o.stripZone(),p&&p.stripZone()),b.allDay=n,b.start=o,b.end=p,k(b),i.push(function(){b.allDay=j,b.start=l,b.end=m,k(b)})}),function(){for(var a=0;a<i.length;a++)i[a]()}}function A(){var b,d=c.businessHours,e={className:"fc-nonbusiness",start:"09:00",end:"17:00",dow:[1,2,3,4,5],rendering:"inverse-background"};return d&&(b="object"==typeof d?a.extend({},e,d):e),b?w(u(b)):[]}function B(a,b,d){var e=a.source||{},f=F(a.constraint,e.constraint,c.eventConstraint),g=F(a.overlap,e.overlap,c.eventOverlap);return H(b,d,f,g,a)}function D(a,b){return H(a,b,c.selectConstraint,c.selectOverlap)}function G(a,b,c){var d;return c&&(d=w(u(c))[0])?B(d,a,b):D(a,b)}function H(a,b,c,d,e){var f,g,h,i,j;if(a=a.clone().stripZone(),b=b.clone().stripZone(),null!=c){for(f=I(c),g=!1,h=0;h<f.length;h++)if(J(f[h],a,b)){g=!0;break}if(!g)return!1}for(h=0;h<X.length;h++)if(i=X[h],(!e||e._id!==i._id)&&K(i,a,b)){if(d===!1)return!1;if("function"==typeof d&&!d(i,e))return!1;if(e){if(j=F(i.overlap,(i.source||{}).overlap),j===!1)return!1;if("function"==typeof j&&!j(e,i))return!1}}return!0}function I(a){return"businessHours"===a?A():"object"==typeof a?w(u(a)):r(a)}function J(a,b,c){var d=a.start.clone().stripZone(),e=L.getEventEnd(a).stripZone();return b>=d&&e>=c}function K(a,b,c){var d=a.start.clone().stripZone(),e=L.getEventEnd(a).stripZone();return e>b&&c>d}var L=this;L.isFetchNeeded=d,L.fetchEvents=e,L.addEventSource=h,L.removeEventSource=j,L.updateEvent=n,L.renderEvent=p,L.removeEvents=q,L.clientEvents=r,L.mutateEvent=x;var M,N,O=L.trigger,P=L.getView,Q=L.reportEvents,R=L.getEventEnd,S={events:[]},T=[S],U=0,V=0,W=0,X=[];a.each((c.events?[c.events]:[]).concat(c.eventSources||[]),function(a,b){var c=i(b);c&&T.push(c)});var Y=["title","url","allDay","className","editable","color","backgroundColor","borderColor","textColor"];L.getBusinessHoursEvents=A,L.isEventAllowedInRange=B,L.isSelectionAllowedInRange=D,L.isExternalDragAllowedInRange=G}function k(a){a._allDay=a.allDay,a._start=a.start.clone(),a._end=a.end?a.end.clone():null}function l(a,b){b.left&&a.css({"border-left-width":1,"margin-left":b.left-1}),b.right&&a.css({"border-right-width":1,"margin-right":b.right-1})}function m(a){a.css({"margin-left":"","margin-right":"","border-left-width":"","border-right-width":""})}function n(){a("body").addClass("fc-not-allowed")}function o(){a("body").removeClass("fc-not-allowed")}function p(b,c,d){var e=Math.floor(c/b.length),f=Math.floor(c-e*(b.length-1)),g=[],h=[],i=[],j=0;q(b),b.each(function(c,d){var k=c===b.length-1?f:e,l=a(d).outerHeight(!0);k>l?(g.push(d),h.push(l),i.push(a(d).height())):j+=l}),d&&(c-=j,e=Math.floor(c/g.length),f=Math.floor(c-e*(g.length-1))),a(g).each(function(b,c){var d=b===g.length-1?f:e,j=h[b],k=i[b],l=d-(j-k);d>j&&a(c).height(l)})}function q(a){a.height("")}function r(b){var c=0;return b.find("> *").each(function(b,d){var e=a(d).outerWidth();e>c&&(c=e)}),c++,b.width(c),c}function s(a,b){return a.height(b).addClass("fc-scroller"),a[0].scrollHeight-1>a[0].clientHeight?!0:(t(a),!1)}function t(a){a.height("").removeClass("fc-scroller")}function u(b){var c=b.css("position"),d=b.parents().filter(function(){var b=a(this);return/(auto|scroll)/.test(b.css("overflow")+b.css("overflow-y")+b.css("overflow-x"))}).eq(0);return"fixed"!==c&&d.length?d:a(b[0].ownerDocument||document)}function v(a){var b=a.offset().left,c=b+a.width(),d=a.children(),e=d.offset().left,f=e+d.outerWidth();return{left:e-b,right:c-f}}function w(a){return 1==a.which&&!a.ctrlKey}function x(a,b,c,d){var e,f,g,h;return b>c&&d>a?(a>=c?(e=a.clone(),g=!0):(e=c.clone(),g=!1),d>=b?(f=b.clone(),h=!0):(f=d.clone(),h=!1),{start:e,end:f,isStart:g,isEnd:h}):void 0}function y(a,b){if(a=a||{},void 0!==a[b])return a[b];for(var c,d=b.split(/(?=[A-Z])/),e=d.length-1;e>=0;e--)if(c=a[d[e].toLowerCase()],void 0!==c)return c;return a["default"]}function z(a,c){return b.duration({days:a.clone().stripTime().diff(c.clone().stripTime(),"days"),ms:a.time()-c.time()})}function A(a){return"[object Date]"===Object.prototype.toString.call(a)||a instanceof Date}function B(a,b){return a-b}function C(a){return/^\d+\:\d+(?:\:\d+\.?(?:\d{3})?)?$/.test(a)}function D(a){var b=function(){};return b.prototype=a,new b}function E(b,c,d){if(a.isFunction(b)&&(b=[b]),b){var e,f;for(e=0;e<b.length;e++)f=b[e].apply(c,d)||f;return f}}function F(){for(var a=0;a<arguments.length;a++)if(void 0!==arguments[a])return arguments[a]}function G(a){return(a+"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;").replace(/\n/g,"<br />")}function H(a){return a.replace(/&.*?;/g,"")}function I(a){return a.charAt(0).toUpperCase()+a.slice(1)}function J(a,b){var c,d,e,f,g=function(){var h=+new Date-f;b>h&&h>0?c=setTimeout(g,b-h):(c=null,a.apply(e,d),c||(e=d=null))};return function(){e=this,d=arguments,f=+new Date,c||(c=setTimeout(g,b))}}function K(c,d,e){var f,g,h,i,j=c[0],k=1==c.length&&"string"==typeof j;return b.isMoment(j)?(i=b.apply(null,c),M(j,i)):A(j)||void 0===j?i=b.apply(null,c):(f=!1,g=!1,k?Rb.test(j)?(j+="-01",c=[j],f=!0,g=!0):(h=Sb.exec(j))&&(f=!h[5],g=!0):a.isArray(j)&&(g=!0),i=d?b.utc.apply(b,c):b.apply(null,c),f?(i._ambigTime=!0,i._ambigZone=!0):e&&(g?i._ambigZone=!0:k&&i.zone(j))),i._fullCalendar=!0,i}function L(a,b){var c,d=[],e=!1,f=!1;for(c=0;c<a.length;c++)d.push(Jb.moment.parseZone(a[c])),e=e||d[c]._ambigTime,f=f||d[c]._ambigZone;for(c=0;c<d.length;c++)e&&!b?d[c].stripTime():f&&d[c].stripZone();return d}function M(a,b){a._ambigTime?b._ambigTime=!0:b._ambigTime&&(b._ambigTime=!1),a._ambigZone?b._ambigZone=!0:b._ambigZone&&(b._ambigZone=!1)}function N(a,b){a.year(b[0]||0).month(b[1]||0).date(b[2]||0).hours(b[3]||0).minutes(b[4]||0).seconds(b[5]||0).milliseconds(b[6]||0)}function O(a,b){return Ub.format.call(a,b)}function P(a,b){return Q(a,V(b))}function Q(a,b){var c,d="";for(c=0;c<b.length;c++)d+=R(a,b[c]);return d}function R(a,b){var c,d;return"string"==typeof b?b:(c=b.token)?Vb[c]?Vb[c](a):O(a,c):b.maybe&&(d=Q(a,b.maybe),d.match(/[1-9]/))?d:""}function S(a,b,c,d,e){var f;return a=Jb.moment.parseZone(a),b=Jb.moment.parseZone(b),f=(a.localeData||a.lang).call(a),c=f.longDateFormat(c)||c,d=d||" - ",T(a,b,V(c),d,e)}function T(a,b,c,d,e){var f,g,h,i,j="",k="",l="",m="",n="";for(g=0;g<c.length&&(f=U(a,b,c[g]),f!==!1);g++)j+=f;for(h=c.length-1;h>g&&(f=U(a,b,c[h]),f!==!1);h--)k=f+k;for(i=g;h>=i;i++)l+=R(a,c[i]),m+=R(b,c[i]);return(l||m)&&(n=e?m+d+l:l+d+m),j+n+k}function U(a,b,c){var d,e;return"string"==typeof c?c:(d=c.token)&&(e=Wb[d.charAt(0)],e&&a.isSame(b,e))?O(a,d):!1}function V(a){return a in Xb?Xb[a]:Xb[a]=W(a)}function W(a){for(var b,c=[],d=/\[([^\]]*)\]|\(([^\)]*)\)|(LT|(\w)\4*o?)|([^\w\[\(]+)/g;b=d.exec(a);)b[1]?c.push(b[1]):b[2]?c.push({maybe:W(b[2])}):b[3]?c.push({token:b[3]}):b[5]&&c.push(b[5]);return c}function X(a){this.options=a||{}}function Y(a){this.grid=a}function Z(a){this.coordMaps=a}function $(a,b){this.coordMap=a,this.options=b||{}}function _(a,b){return a||b?a&&b?a.grid===b.grid&&a.row===b.row&&a.col===b.col:!1:!0}function ab(b,c){this.options=c=c||{},this.sourceEl=b,this.parentEl=c.parentEl?a(c.parentEl):b.parent()}function bb(a){this.view=a}function cb(a){bb.call(this,a),this.coordMap=new Y(this),this.elsByFill={}}function db(a){var b=fb(a);return"background"===b||"inverse-background"===b}function eb(a){return"inverse-background"===fb(a)}function fb(a){return F((a.source||{}).rendering,a.rendering)}function gb(a){var b,c,d={};for(b=0;b<a.length;b++)c=a[b],(d[c._id]||(d[c._id]=[])).push(c);return d}function hb(a,b){return a.eventStartMS-b.eventStartMS}function ib(a,b){return a.eventStartMS-b.eventStartMS||b.eventDurationMS-a.eventDurationMS||b.event.allDay-a.event.allDay||(a.event.title||"").localeCompare(b.event.title)}function jb(a){cb.call(this,a)}function kb(a,b){var c,d;for(c=0;c<b.length;c++)if(d=b[c],d.leftCol<=a.rightCol&&d.rightCol>=a.leftCol)return!0;return!1}function lb(a,b){return a.leftCol-b.leftCol}function mb(a){cb.call(this,a)}function nb(a){var b,c,d;if(a.sort(ib),b=ob(a),pb(b),c=b[0]){for(d=0;d<c.length;d++)qb(c[d]);for(d=0;d<c.length;d++)rb(c[d],0,0)}}function ob(a){var b,c,d,e=[];for(b=0;b<a.length;b++){for(c=a[b],d=0;d<e.length&&sb(c,e[d]).length;d++);c.level=d,(e[d]||(e[d]=[])).push(c)}return e}function pb(a){var b,c,d,e,f;for(b=0;b<a.length;b++)for(c=a[b],d=0;d<c.length;d++)for(e=c[d],e.forwardSegs=[],f=b+1;f<a.length;f++)sb(e,a[f],e.forwardSegs)}function qb(a){var b,c,d=a.forwardSegs,e=0;if(void 0===a.forwardPressure){for(b=0;b<d.length;b++)c=d[b],qb(c),e=Math.max(e,1+c.forwardPressure);a.forwardPressure=e}}function rb(a,b,c){var d,e=a.forwardSegs;if(void 0===a.forwardCoord)for(e.length?(e.sort(ub),rb(e[0],b+1,c),a.forwardCoord=e[0].backwardCoord):a.forwardCoord=1,a.backwardCoord=a.forwardCoord-(a.forwardCoord-c)/(b+1),d=0;d<e.length;d++)rb(e[d],0,a.forwardCoord)}function sb(a,b,c){c=c||[];for(var d=0;d<b.length;d++)tb(a,b[d])&&c.push(b[d]);return c}function tb(a,b){return a.bottom>b.top&&a.top<b.bottom}function ub(a,b){return b.forwardPressure-a.forwardPressure||(a.backwardCoord||0)-(b.backwardCoord||0)||ib(a,b)}function vb(c){function d(b){var c=B[b];return a.isPlainObject(c)&&!g(b)?y(c,z.name):c}function e(a,b){return c.trigger.apply(c,[a,b||z].concat(Array.prototype.slice.call(arguments,2),[z]))}function f(a){var b=a.source||{};return F(a.startEditable,b.startEditable,d("eventStartEditable"),a.editable,b.editable,d("editable"))}function h(a){var b=a.source||{};return F(a.durationEditable,b.durationEditable,d("eventDurationEditable"),a.editable,b.editable,d("editable"))}function i(a,b,d,f){var g=c.mutateEvent(b,d,null);e("eventDrop",a,b,g.dateDelta,function(){g.undo(),A()},f,{}),A()}function j(a,b,d,f){var g=c.mutateEvent(b,null,d);e("eventResize",a,b,g.durationDelta,function(){g.undo(),A()},f,{}),A()}function k(a){return b.isMoment(a)&&(a=a.day()),G[a]}function l(){return D}function m(a,b,c){var d=a.clone();for(b=b||1;G[(d.day()+(c?b:0)+7)%7];)d.add(b,"days");return d}function n(){var a=o.apply(null,arguments),b=p(a),c=q(b);return c}function o(a,b){var c=z.colCnt,d=J?-1:1,e=J?c-1:0;"object"==typeof a&&(b=a.col,a=a.row);var f=a*c+(b*d+e);return f}function p(a){var b=z.start.day();return a+=H[b],7*Math.floor(a/D)+I[(a%D+D)%D]-b}function q(a){return z.start.clone().add(a,"days")}function r(a){var b=s(a),c=t(b),d=u(c);return d}function s(a){return a.clone().stripTime().diff(z.start,"days")}function t(a){var b=z.start.day();return a+=b,Math.floor(a/7)*D+H[(a%7+7)%7]-H[b]}function u(a){var b=z.colCnt,c=J?-1:1,d=J?b-1:0,e=Math.floor(a/b),f=(a%b+b)%b*c+d;return{row:e,col:f}}function v(a,b){for(var c=z.rowCnt,d=z.colCnt,e=[],f=w(a,b),g=s(f.start),h=s(f.end),i=t(g),j=t(h)-1,k=0;c>k;k++){var l=k*d,m=l+d-1,n=Math.max(i,l),o=Math.min(j,m);if(o>=n){var q=u(n),r=u(o),v=[q.col,r.col].sort(),x=p(n)==g,y=p(o)+1==h;e.push({row:k,leftCol:v[0],rightCol:v[1],isStart:x,isEnd:y})}}return e}function w(a,b){var c,d,e=a.clone().stripTime();return b&&(c=b.clone().stripTime(),d=+b.time(),d&&d>=C&&c.add(1,"days")),(!b||e>=c)&&(c=e.clone().add(1,"days")),{start:e,end:c}}function x(a){var b=w(a.start,a.end);return b.end.diff(b.start,"days")>1}var z=this;z.calendar=c,z.opt=d,z.trigger=e,z.isEventDraggable=f,z.isEventResizable=h,z.eventDrop=i,z.eventResize=j;var A=c.reportEventChange,B=c.options,C=b.duration(B.nextDayThreshold);z.init(),z.getEventTimeText=function(a,b){var e,f;return"object"==typeof a&&"object"==typeof b?(e=a,f=b,b=arguments[2]):(e=a.start,f=a.end),b=b||d("timeFormat"),f&&d("displayEventEnd")?c.formatRange(e,f,b):c.formatDate(e,b)},z.isHiddenDay=k,z.skipHiddenDays=m,z.getCellsPerWeek=l,z.dateToCell=r,z.dateToDayOffset=s,z.dayOffsetToCellOffset=t,z.cellOffsetToCell=u,z.cellToDate=n,z.cellToCellOffset=o,z.cellOffsetToDayOffset=p,z.dayOffsetToDate=q,z.rangeToSegments=v,z.isMultiDayEvent=x;var D,E=d("hiddenDays")||[],G=[],H=[],I=[],J=d("isRTL");!function(){d("weekends")===!1&&E.push(0,6);for(var b=0,c=0;7>b;b++)H[b]=c,G[b]=-1!=a.inArray(b,E),G[b]||(I[c]=b,c++);if(D=c,!D)throw"invalid hiddenDays"}()}function wb(c){var d,e,f,g,h=Jb.dataAttrPrefix;return h&&(h+="-"),d=c.data(h+"event")||null,d&&(d="object"==typeof d?a.extend({},d):{},e=d.start,null==e&&(e=d.time),f=d.duration,g=d.stick,delete d.start,delete d.time,delete d.duration,delete d.stick),null==e&&(e=c.data(h+"start")),null==e&&(e=c.data(h+"time")),null==f&&(f=c.data(h+"duration")),null==g&&(g=c.data(h+"stick")),e=null!=e?b.duration(e):null,f=null!=f?b.duration(f):null,g=Boolean(g),{eventProps:d,startTime:e,duration:f,stick:g}}function xb(a){vb.call(this,a),this.dayGrid=new jb(this),this.coordMap=this.dayGrid.coordMap}function yb(a){xb.call(this,a)}function zb(a){xb.call(this,a)}function Ab(a){xb.call(this,a)}function Bb(a,b){return b.longDateFormat("LT").replace(":mm","(:mm)").replace(/(\Wmm)$/,"($1)").replace(/\s*a$/i,"a")}function Cb(a,b){return b.longDateFormat("LT").replace(/\s*a$/i,"")}function Db(a){vb.call(this,a),this.timeGrid=new mb(this),this.opt("allDaySlot")?(this.dayGrid=new jb(this),this.coordMap=new Z([this.dayGrid.coordMap,this.timeGrid.coordMap])):this.coordMap=this.timeGrid.coordMap}function Eb(a){Db.call(this,a)}function Fb(a){Db.call(this,a)}var Gb={lang:"en",defaultTimedEventDuration:"02:00:00",defaultAllDayEventDuration:{days:1},forceEventDuration:!1,nextDayThreshold:"09:00:00",defaultView:"month",aspectRatio:1.35,header:{left:"title",center:"",right:"today prev,next"},weekends:!0,weekNumbers:!1,weekNumberTitle:"W",weekNumberCalculation:"local",lazyFetching:!0,startParam:"start",endParam:"end",timezoneParam:"timezone",timezone:!1,titleFormat:{month:"MMMM YYYY",week:"ll",day:"LL"},columnFormat:{month:"ddd",week:d,day:"dddd"},timeFormat:{"default":c},displayEventEnd:{month:!1,basicWeek:!1,"default":!0},isRTL:!1,defaultButtonText:{prev:"prev",next:"next",prevYear:"prev year",nextYear:"next year",today:"today",month:"month",week:"week",day:"day"},buttonIcons:{prev:"left-single-arrow",next:"right-single-arrow",prevYear:"left-double-arrow",nextYear:"right-double-arrow"},theme:!1,themeButtonIcons:{prev:"circle-triangle-w",next:"circle-triangle-e",prevYear:"seek-prev",nextYear:"seek-next"},dragOpacity:.75,dragRevertDuration:500,dragScroll:!0,unselectAuto:!0,dropAccept:"*",eventLimit:!1,eventLimitText:"more",eventLimitClick:"popover",dayPopoverFormat:"LL",handleWindowResize:!0,windowResizeDelay:200},Hb={en:{columnFormat:{week:"ddd M/D"},dayPopoverFormat:"dddd, MMMM D"}},Ib={header:{left:"next,prev today",center:"",right:"title"},buttonIcons:{prev:"right-single-arrow",next:"left-single-arrow",prevYear:"right-double-arrow",nextYear:"left-double-arrow"},themeButtonIcons:{prev:"circle-triangle-e",next:"circle-triangle-w",nextYear:"seek-prev",prevYear:"seek-next"}},Jb=a.fullCalendar={version:"2.2.2"},Kb=Jb.views={};
a.fn.fullCalendar=function(b){var c=Array.prototype.slice.call(arguments,1),d=this;return this.each(function(e,f){var g,i=a(f),j=i.data("fullCalendar");"string"==typeof b?j&&a.isFunction(j[b])&&(g=j[b].apply(j,c),e||(d=g),"destroy"===b&&i.removeData("fullCalendar")):j||(j=new h(i,b),i.data("fullCalendar",j),j.render())}),d},Jb.langs=Hb,Jb.datepickerLang=function(b,c,d){var e=Hb[b];e||(e=Hb[b]={}),f(e,{isRTL:d.isRTL,weekNumberTitle:d.weekHeader,titleFormat:{month:d.showMonthAfterYear?"YYYY["+d.yearSuffix+"] MMMM":"MMMM YYYY["+d.yearSuffix+"]"},defaultButtonText:{prev:H(d.prevText),next:H(d.nextText),today:H(d.currentText)}}),a.datepicker&&(a.datepicker.regional[c]=a.datepicker.regional[b]=d,a.datepicker.regional.en=a.datepicker.regional[""],a.datepicker.setDefaults(d))},Jb.lang=function(a,b){var c;b&&(c=Hb[a],c||(c=Hb[a]={}),f(c,b||{})),Gb.lang=a},Jb.sourceNormalizers=[],Jb.sourceFetchers=[];var Lb={dataType:"json",cache:!1},Mb=1,Nb=["sun","mon","tue","wed","thu","fri","sat"];Jb.applyAll=E;var Ob,Pb,Qb,Rb=/^\s*\d{4}-\d\d$/,Sb=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?)?$/,Tb=b.fn,Ub=a.extend({},Tb);Jb.moment=function(){return K(arguments)},Jb.moment.utc=function(){var a=K(arguments,!0);return a.hasTime()&&a.utc(),a},Jb.moment.parseZone=function(){return K(arguments,!0,!0)},Tb.clone=function(){var a=Ub.clone.apply(this,arguments);return M(this,a),this._fullCalendar&&(a._fullCalendar=!0),a},Tb.time=function(a){if(!this._fullCalendar)return Ub.time.apply(this,arguments);if(null==a)return b.duration({hours:this.hours(),minutes:this.minutes(),seconds:this.seconds(),milliseconds:this.milliseconds()});this._ambigTime=!1,b.isDuration(a)||b.isMoment(a)||(a=b.duration(a));var c=0;return b.isDuration(a)&&(c=24*Math.floor(a.asDays())),this.hours(c+a.hours()).minutes(a.minutes()).seconds(a.seconds()).milliseconds(a.milliseconds())},Tb.stripTime=function(){var a=this.toArray();return this.utc(),Pb(this,a.slice(0,3)),this._ambigTime=!0,this._ambigZone=!0,this},Tb.hasTime=function(){return!this._ambigTime},Tb.stripZone=function(){var a=this.toArray(),b=this._ambigTime;return this.utc(),Pb(this,a),b&&(this._ambigTime=!0),this._ambigZone=!0,this},Tb.hasZone=function(){return!this._ambigZone},Tb.zone=function(a){return null!=a&&(this._ambigTime=!1,this._ambigZone=!1),Ub.zone.apply(this,arguments)},Tb.local=function(){var a=this.toArray(),b=this._ambigZone;return Ub.local.apply(this,arguments),b&&Qb(this,a),this},Tb.format=function(){return this._fullCalendar&&arguments[0]?P(this,arguments[0]):this._ambigTime?O(this,"YYYY-MM-DD"):this._ambigZone?O(this,"YYYY-MM-DD[T]HH:mm:ss"):Ub.format.apply(this,arguments)},Tb.toISOString=function(){return this._ambigTime?O(this,"YYYY-MM-DD"):this._ambigZone?O(this,"YYYY-MM-DD[T]HH:mm:ss"):Ub.toISOString.apply(this,arguments)},Tb.isWithin=function(a,b){var c=L([this,a,b]);return c[0]>=c[1]&&c[0]<c[2]},Tb.isSame=function(a,b){var c;return this._fullCalendar?b?(c=L([this,a],!0),Ub.isSame.call(c[0],c[1],b)):(a=Jb.moment.parseZone(a),Ub.isSame.call(this,a)&&Boolean(this._ambigTime)===Boolean(a._ambigTime)&&Boolean(this._ambigZone)===Boolean(a._ambigZone)):Ub.isSame.apply(this,arguments)},a.each(["isBefore","isAfter"],function(a,b){Tb[b]=function(a,c){var d;return this._fullCalendar?(d=L([this,a]),Ub[b].call(d[0],d[1],c)):Ub[b].apply(this,arguments)}}),Ob="_d"in b()&&"updateOffset"in b,Pb=Ob?function(a,c){a._d.setTime(Date.UTC.apply(Date,c)),b.updateOffset(a,!1)}:N,Qb=Ob?function(a,c){a._d.setTime(+new Date(c[0]||0,c[1]||0,c[2]||0,c[3]||0,c[4]||0,c[5]||0,c[6]||0)),b.updateOffset(a,!1)}:N;var Vb={t:function(a){return O(a,"a").charAt(0)},T:function(a){return O(a,"A").charAt(0)}};Jb.formatRange=S;var Wb={Y:"year",M:"month",D:"day",d:"day",A:"second",a:"second",T:"second",t:"second",H:"second",h:"second",m:"second",s:"second"},Xb={};X.prototype={isHidden:!0,options:null,el:null,documentMousedownProxy:null,margin:10,show:function(){this.isHidden&&(this.el||this.render(),this.el.show(),this.position(),this.isHidden=!1,this.trigger("show"))},hide:function(){this.isHidden||(this.el.hide(),this.isHidden=!0,this.trigger("hide"))},render:function(){var b=this,c=this.options;this.el=a('<div class="fc-popover"/>').addClass(c.className||"").css({top:0,left:0}).append(c.content).appendTo(c.parentEl),this.el.on("click",".fc-close",function(){b.hide()}),c.autoHide&&a(document).on("mousedown",this.documentMousedownProxy=a.proxy(this,"documentMousedown"))},documentMousedown:function(b){this.el&&!a(b.target).closest(this.el).length&&this.hide()},destroy:function(){this.hide(),this.el&&(this.el.remove(),this.el=null),a(document).off("mousedown",this.documentMousedownProxy)},position:function(){var b,c,d,e,f,g=this.options,h=this.el.offsetParent().offset(),i=this.el.outerWidth(),j=this.el.outerHeight(),k=a(window),l=u(this.el);e=g.top||0,f=void 0!==g.left?g.left:void 0!==g.right?g.right-i:0,l.is(window)||l.is(document)?(l=k,b=0,c=0):(d=l.offset(),b=d.top,c=d.left),b+=k.scrollTop(),c+=k.scrollLeft(),g.viewportConstrain!==!1&&(e=Math.min(e,b+l.outerHeight()-j-this.margin),e=Math.max(e,b+this.margin),f=Math.min(f,c+l.outerWidth()-i-this.margin),f=Math.max(f,c+this.margin)),this.el.css({top:e-h.top,left:f-h.left})},trigger:function(a){this.options[a]&&this.options[a].apply(this,Array.prototype.slice.call(arguments,1))}},Y.prototype={grid:null,rows:null,cols:null,containerEl:null,minX:null,maxX:null,minY:null,maxY:null,build:function(){this.grid.buildCoords(this.rows=[],this.cols=[]),this.computeBounds()},getCell:function(a,b){var c,d=null,e=this.rows,f=this.cols,g=-1,h=-1;if(this.inBounds(a,b)){for(c=0;c<e.length;c++)if(b>=e[c][0]&&b<e[c][1]){g=c;break}for(c=0;c<f.length;c++)if(a>=f[c][0]&&a<f[c][1]){h=c;break}g>=0&&h>=0&&(d={row:g,col:h},d.grid=this.grid,d.date=this.grid.getCellDate(d))}return d},computeBounds:function(){var a;this.containerEl&&(a=this.containerEl.offset(),this.minX=a.left,this.maxX=a.left+this.containerEl.outerWidth(),this.minY=a.top,this.maxY=a.top+this.containerEl.outerHeight())},inBounds:function(a,b){return this.containerEl?a>=this.minX&&a<this.maxX&&b>=this.minY&&b<this.maxY:!0}},Z.prototype={coordMaps:null,build:function(){var a,b=this.coordMaps;for(a=0;a<b.length;a++)b[a].build()},getCell:function(a,b){var c,d=this.coordMaps,e=null;for(c=0;c<d.length&&!e;c++)e=d[c].getCell(a,b);return e}},$.prototype={coordMap:null,options:null,isListening:!1,isDragging:!1,origCell:null,origDate:null,cell:null,date:null,mouseX0:null,mouseY0:null,mousemoveProxy:null,mouseupProxy:null,scrollEl:null,scrollBounds:null,scrollTopVel:null,scrollLeftVel:null,scrollIntervalId:null,scrollHandlerProxy:null,scrollSensitivity:30,scrollSpeed:200,scrollIntervalMs:50,mousedown:function(a){w(a)&&(a.preventDefault(),this.startListening(a),this.options.distance||this.startDrag(a))},startListening:function(b){var c,d;this.isListening||(b&&this.options.scroll&&(c=u(a(b.target)),c.is(window)||c.is(document)||(this.scrollEl=c,this.scrollHandlerProxy=J(a.proxy(this,"scrollHandler"),100),this.scrollEl.on("scroll",this.scrollHandlerProxy))),this.computeCoords(),b&&(d=this.getCell(b),this.origCell=d,this.origDate=d?d.date:null,this.mouseX0=b.pageX,this.mouseY0=b.pageY),a(document).on("mousemove",this.mousemoveProxy=a.proxy(this,"mousemove")).on("mouseup",this.mouseupProxy=a.proxy(this,"mouseup")).on("selectstart",this.preventDefault),this.isListening=!0,this.trigger("listenStart",b))},computeCoords:function(){this.coordMap.build(),this.computeScrollBounds()},mousemove:function(a){var b,c;this.isDragging||(b=this.options.distance||1,c=Math.pow(a.pageX-this.mouseX0,2)+Math.pow(a.pageY-this.mouseY0,2),c>=b*b&&this.startDrag(a)),this.isDragging&&this.drag(a)},startDrag:function(a){var b;this.isListening||this.startListening(),this.isDragging||(this.isDragging=!0,this.trigger("dragStart",a),b=this.getCell(a),b&&this.cellOver(b,!0))},drag:function(a){var b;this.isDragging&&(b=this.getCell(a),_(b,this.cell)||(this.cell&&this.cellOut(),b&&this.cellOver(b)),this.dragScroll(a))},cellOver:function(a){this.cell=a,this.date=a.date,this.trigger("cellOver",a,a.date)},cellOut:function(){this.cell&&(this.trigger("cellOut",this.cell),this.cell=null,this.date=null)},mouseup:function(a){this.stopDrag(a),this.stopListening(a)},stopDrag:function(a){this.isDragging&&(this.stopScrolling(),this.trigger("dragStop",a),this.isDragging=!1)},stopListening:function(b){this.isListening&&(this.scrollEl&&(this.scrollEl.off("scroll",this.scrollHandlerProxy),this.scrollHandlerProxy=null),a(document).off("mousemove",this.mousemoveProxy).off("mouseup",this.mouseupProxy).off("selectstart",this.preventDefault),this.mousemoveProxy=null,this.mouseupProxy=null,this.isListening=!1,this.trigger("listenStop",b),this.origCell=this.cell=null,this.origDate=this.date=null)},getCell:function(a){return this.coordMap.getCell(a.pageX,a.pageY)},trigger:function(a){this.options[a]&&this.options[a].apply(this,Array.prototype.slice.call(arguments,1))},preventDefault:function(a){a.preventDefault()},computeScrollBounds:function(){var a,b=this.scrollEl;b&&(a=b.offset(),this.scrollBounds={top:a.top,left:a.left,bottom:a.top+b.outerHeight(),right:a.left+b.outerWidth()})},dragScroll:function(a){var b,c,d,e,f=this.scrollSensitivity,g=this.scrollBounds,h=0,i=0;g&&(b=(f-(a.pageY-g.top))/f,c=(f-(g.bottom-a.pageY))/f,d=(f-(a.pageX-g.left))/f,e=(f-(g.right-a.pageX))/f,b>=0&&1>=b?h=b*this.scrollSpeed*-1:c>=0&&1>=c&&(h=c*this.scrollSpeed),d>=0&&1>=d?i=d*this.scrollSpeed*-1:e>=0&&1>=e&&(i=e*this.scrollSpeed)),this.setScrollVel(h,i)},setScrollVel:function(b,c){this.scrollTopVel=b,this.scrollLeftVel=c,this.constrainScrollVel(),!this.scrollTopVel&&!this.scrollLeftVel||this.scrollIntervalId||(this.scrollIntervalId=setInterval(a.proxy(this,"scrollIntervalFunc"),this.scrollIntervalMs))},constrainScrollVel:function(){var a=this.scrollEl;this.scrollTopVel<0?a.scrollTop()<=0&&(this.scrollTopVel=0):this.scrollTopVel>0&&a.scrollTop()+a[0].clientHeight>=a[0].scrollHeight&&(this.scrollTopVel=0),this.scrollLeftVel<0?a.scrollLeft()<=0&&(this.scrollLeftVel=0):this.scrollLeftVel>0&&a.scrollLeft()+a[0].clientWidth>=a[0].scrollWidth&&(this.scrollLeftVel=0)},scrollIntervalFunc:function(){var a=this.scrollEl,b=this.scrollIntervalMs/1e3;this.scrollTopVel&&a.scrollTop(a.scrollTop()+this.scrollTopVel*b),this.scrollLeftVel&&a.scrollLeft(a.scrollLeft()+this.scrollLeftVel*b),this.constrainScrollVel(),this.scrollTopVel||this.scrollLeftVel||this.stopScrolling()},stopScrolling:function(){this.scrollIntervalId&&(clearInterval(this.scrollIntervalId),this.scrollIntervalId=null,this.computeCoords())},scrollHandler:function(){this.scrollIntervalId||this.computeCoords()}},ab.prototype={options:null,sourceEl:null,el:null,parentEl:null,top0:null,left0:null,mouseY0:null,mouseX0:null,topDelta:null,leftDelta:null,mousemoveProxy:null,isFollowing:!1,isHidden:!1,isAnimating:!1,start:function(b){this.isFollowing||(this.isFollowing=!0,this.mouseY0=b.pageY,this.mouseX0=b.pageX,this.topDelta=0,this.leftDelta=0,this.isHidden||this.updatePosition(),a(document).on("mousemove",this.mousemoveProxy=a.proxy(this,"mousemove")))},stop:function(b,c){function d(){this.isAnimating=!1,e.destroyEl(),this.top0=this.left0=null,c&&c()}var e=this,f=this.options.revertDuration;this.isFollowing&&!this.isAnimating&&(this.isFollowing=!1,a(document).off("mousemove",this.mousemoveProxy),b&&f&&!this.isHidden?(this.isAnimating=!0,this.el.animate({top:this.top0,left:this.left0},{duration:f,complete:d})):d())},getEl:function(){var a=this.el;return a||(this.sourceEl.width(),a=this.el=this.sourceEl.clone().css({position:"absolute",visibility:"",display:this.isHidden?"none":"",margin:0,right:"auto",bottom:"auto",width:this.sourceEl.width(),height:this.sourceEl.height(),opacity:this.options.opacity||"",zIndex:this.options.zIndex}).appendTo(this.parentEl)),a},destroyEl:function(){this.el&&(this.el.remove(),this.el=null)},updatePosition:function(){var a,b;this.getEl(),null===this.top0&&(this.sourceEl.width(),a=this.sourceEl.offset(),b=this.el.offsetParent().offset(),this.top0=a.top-b.top,this.left0=a.left-b.left),this.el.css({top:this.top0+this.topDelta,left:this.left0+this.leftDelta})},mousemove:function(a){this.topDelta=a.pageY-this.mouseY0,this.leftDelta=a.pageX-this.mouseX0,this.isHidden||this.updatePosition()},hide:function(){this.isHidden||(this.isHidden=!0,this.el&&this.el.hide())},show:function(){this.isHidden&&(this.isHidden=!1,this.updatePosition(),this.getEl().show())}},bb.prototype={view:null,cellHtml:"<td/>",rowHtml:function(a,b){var c,d,e=this.view,f=this.getHtmlRenderer("cell",a),g="";for(b=b||0,c=0;c<e.colCnt;c++)d=e.cellToDate(b,c),g+=f(b,c,d);return g=this.bookendCells(g,a,b),"<tr>"+g+"</tr>"},bookendCells:function(a,b,c){var d=this.view,e=this.getHtmlRenderer("intro",b)(c||0),f=this.getHtmlRenderer("outro",b)(c||0),g=d.opt("isRTL"),h=g?f:e,i=g?e:f;return"string"==typeof a?h+a+i:a.prepend(h).append(i)},getHtmlRenderer:function(a,b){var c,d,e,f,g=this.view;return c=a+"Html",b&&(d=b+I(a)+"Html"),d&&(f=g[d])?e=g:d&&(f=this[d])?e=this:(f=g[c])?e=g:(f=this[c])&&(e=this),"function"==typeof f?function(){return f.apply(e,arguments)||""}:function(){return f||""}}},cb.prototype=D(bb.prototype),a.extend(cb.prototype,{el:null,coordMap:null,cellDuration:null,elsByFill:null,render:function(){this.bindHandlers()},destroy:function(){},buildCoords:function(){},getCellDate:function(){},getCellDayEl:function(){},rangeToSegs:function(){},bindHandlers:function(){var b=this;this.el.on("mousedown",function(c){a(c.target).is(".fc-event-container *, .fc-more")||a(c.target).closest(".fc-popover").length||b.dayMousedown(c)}),this.bindSegHandlers()},dayMousedown:function(a){var b,c,d,e=this,f=this.view,g=f.calendar,h=f.opt("selectable"),i=null,j=new $(this.coordMap,{scroll:f.opt("dragScroll"),dragStart:function(){f.unselect()},cellOver:function(a,f){j.origDate&&(d=e.getCellDayEl(a),i=[f,j.origDate].sort(B),b=i[0],c=i[1].clone().add(e.cellDuration),h&&(g.isSelectionAllowedInRange(b,c)?e.renderSelection(b,c):(i=null,n())))},cellOut:function(){i=null,e.destroySelection(),o()},listenStop:function(a){i&&(i[0].isSame(i[1])&&f.trigger("dayClick",d[0],b,a),h&&f.reportSelection(b,c,a)),o()}});j.mousedown(a)},renderDrag:function(){},destroyDrag:function(){},renderResize:function(){},destroyResize:function(){},renderRangeHelper:function(a,b,c){var d,e=this.view;!b&&e.opt("forceEventDuration")&&(b=e.calendar.getDefaultEventEnd(!a.hasTime(),a)),d=c?D(c.event):{},d.start=a,d.end=b,d.allDay=!(a.hasTime()||b&&b.hasTime()),d.className=(d.className||[]).concat("fc-helper"),c||(d.editable=!1),this.renderHelper(d,c)},renderHelper:function(){},destroyHelper:function(){},renderSelection:function(a,b){this.renderHighlight(a,b)},destroySelection:function(){this.destroyHighlight()},renderHighlight:function(a,b){this.renderFill("highlight",this.rangeToSegs(a,b))},destroyHighlight:function(){this.destroyFill("highlight")},highlightSegClasses:function(){return["fc-highlight"]},renderFill:function(){},destroyFill:function(a){var b=this.elsByFill[a];b&&(b.remove(),delete this.elsByFill[a])},renderFillSegEls:function(b,c){var d,e=this,f=this[b+"SegEl"],g="",h=[];if(c.length){for(d=0;d<c.length;d++)g+=this.fillSegHtml(b,c[d]);a(g).each(function(b,d){var g=c[b],i=a(d);f&&(i=f.call(e,g,i)),i&&(i=a(i),i.is(e.fillSegTag)&&(g.el=i,h.push(g)))})}return h},fillSegTag:"div",fillSegHtml:function(a,b){var c=this[a+"SegClasses"],d=this[a+"SegStyles"],e=c?c.call(this,b):[],f=d?d.call(this,b):"";return"<"+this.fillSegTag+(e.length?' class="'+e.join(" ")+'"':"")+(f?' style="'+f+'"':"")+" />"},headHtml:function(){return'<div class="fc-row '+this.view.widgetHeaderClass+'"><table><thead>'+this.rowHtml("head")+"</thead></table></div>"},headCellHtml:function(a,b,c){var d=this.view,e=d.calendar,f=d.opt("columnFormat");return'<th class="fc-day-header '+d.widgetHeaderClass+" fc-"+Nb[c.day()]+'">'+G(e.formatDate(c,f))+"</th>"},bgCellHtml:function(a,b,c){var d=this.view,e=this.getDayClasses(c);return e.unshift("fc-day",d.widgetContentClass),'<td class="'+e.join(" ")+'" data-date="'+c.format()+'"></td>'},getDayClasses:function(a){var b=this.view,c=b.calendar.getNow().stripTime(),d=["fc-"+Nb[a.day()]];return"month"===b.name&&a.month()!=b.intervalStart.month()&&d.push("fc-other-month"),a.isSame(c,"day")?d.push("fc-today",b.highlightStateClass):d.push(c>a?"fc-past":"fc-future"),d}}),a.extend(cb.prototype,{mousedOverSeg:null,isDraggingSeg:!1,isResizingSeg:!1,segs:null,renderEvents:function(a){var b,c,d=this.eventsToSegs(a),e=[],f=[];for(b=0;b<d.length;b++)c=d[b],db(c.event)?e.push(c):f.push(c);e=this.renderBgSegs(e)||e,f=this.renderFgSegs(f)||f,this.segs=e.concat(f)},destroyEvents:function(){this.triggerSegMouseout(),this.destroyFgSegs(),this.destroyBgSegs(),this.segs=null},getSegs:function(){return this.segs||[]},renderFgSegs:function(){},destroyFgSegs:function(){},renderFgSegEls:function(b,c){var d,e=this.view,f="",g=[];if(b.length){for(d=0;d<b.length;d++)f+=this.fgSegHtml(b[d],c);a(f).each(function(c,d){var f=b[c],h=e.resolveEventEl(f.event,a(d));h&&(h.data("fc-seg",f),f.el=h,g.push(f))})}return g},fgSegHtml:function(){},renderBgSegs:function(a){return this.renderFill("bgEvent",a)},destroyBgSegs:function(){this.destroyFill("bgEvent")},bgEventSegEl:function(a,b){return this.view.resolveEventEl(a.event,b)},bgEventSegClasses:function(a){var b=a.event,c=b.source||{};return["fc-bgevent"].concat(b.className,c.className||[])},bgEventSegStyles:function(a){var b=this.view,c=a.event,d=c.source||{},e=c.color,f=d.color,g=b.opt("eventColor"),h=c.backgroundColor||e||d.backgroundColor||f||b.opt("eventBackgroundColor")||g;return h?"background-color:"+h:""},businessHoursSegClasses:function(){return["fc-nonbusiness","fc-bgevent"]},bindSegHandlers:function(){var b=this,c=this.view;a.each({mouseenter:function(a,c){b.triggerSegMouseover(a,c)},mouseleave:function(a,c){b.triggerSegMouseout(a,c)},click:function(a,b){return c.trigger("eventClick",this,a.event,b)},mousedown:function(d,e){a(e.target).is(".fc-resizer")&&c.isEventResizable(d.event)?b.segResizeMousedown(d,e):c.isEventDraggable(d.event)&&b.segDragMousedown(d,e)}},function(c,d){b.el.on(c,".fc-event-container > *",function(c){var e=a(this).data("fc-seg");return!e||b.isDraggingSeg||b.isResizingSeg?void 0:d.call(this,e,c)})})},triggerSegMouseover:function(a,b){this.mousedOverSeg||(this.mousedOverSeg=a,this.view.trigger("eventMouseover",a.el[0],a.event,b))},triggerSegMouseout:function(a,b){b=b||{},this.mousedOverSeg&&(a=a||this.mousedOverSeg,this.mousedOverSeg=null,this.view.trigger("eventMouseout",a.el[0],a.event,b))},segDragMousedown:function(a,b){var c,d,e=this,f=this.view,g=f.calendar,h=a.el,i=a.event,j=new ab(a.el,{parentEl:f.el,opacity:f.opt("dragOpacity"),revertDuration:f.opt("dragRevertDuration"),zIndex:2}),k=new $(f.coordMap,{distance:5,scroll:f.opt("dragScroll"),listenStart:function(a){j.hide(),j.start(a)},dragStart:function(b){e.triggerSegMouseout(a,b),e.isDraggingSeg=!0,f.hideEvent(i),f.trigger("eventDragStart",h[0],i,b,{})},cellOver:function(b,h){var l=a.cellDate||k.origDate,m=e.computeDraggedEventDates(a,l,h);c=m.start,d=m.end,g.isEventAllowedInRange(i,c,m.visibleEnd)?f.renderDrag(c,d,a)?j.hide():j.show():(c=null,j.show(),n())},cellOut:function(){c=null,f.destroyDrag(),j.show(),o()},dragStop:function(a){var b=c&&!c.isSame(i.start);j.stop(!b,function(){e.isDraggingSeg=!1,f.destroyDrag(),f.showEvent(i),f.trigger("eventDragStop",h[0],i,a,{}),b&&f.eventDrop(h[0],i,c,a)}),o()},listenStop:function(){j.stop()}});k.mousedown(b)},computeDraggedEventDates:function(a,b,c){var d,e,f,g,h,i=this.view,j=a.event,k=j.start,l=i.calendar.getEventEnd(j);return c.hasTime()===b.hasTime()?(d=z(c,b),e=k.clone().add(d),f=null===j.end?null:l.clone().add(d),g=j.allDay):(e=c,f=null,g=!c.hasTime()),h=f||i.calendar.getDefaultEventEnd(g,e),{start:e,end:f,visibleEnd:h}},segResizeMousedown:function(a,b){function c(){e.destroyResize(),f.showEvent(i)}var d,e=this,f=this.view,g=f.calendar,h=a.el,i=a.event,j=i.start,k=f.calendar.getEventEnd(i),l=null;d=new $(this.coordMap,{distance:5,scroll:f.opt("dragScroll"),dragStart:function(b){e.triggerSegMouseout(a,b),e.isResizingSeg=!0,f.trigger("eventResizeStart",h[0],i,b,{})},cellOver:function(b,d){d.isBefore(j)&&(d=j),l=d.clone().add(e.cellDuration),g.isEventAllowedInRange(i,j,l)?l.isSame(k)?(l=null,c()):(e.renderResize(j,l,a),f.hideEvent(i)):(l=null,c(),n())},cellOut:function(){l=null,c(),o()},dragStop:function(a){e.isResizingSeg=!1,c(),o(),f.trigger("eventResizeStop",h[0],i,a,{}),l&&f.eventResize(h[0],i,l,a)}}),d.mousedown(b)},getSegClasses:function(a,b,c){var d=a.event,e=["fc-event",a.isStart?"fc-start":"fc-not-start",a.isEnd?"fc-end":"fc-not-end"].concat(d.className,d.source?d.source.className:[]);return b&&e.push("fc-draggable"),c&&e.push("fc-resizable"),e},getEventSkinCss:function(a){var b=this.view,c=a.source||{},d=a.color,e=c.color,f=b.opt("eventColor"),g=a.backgroundColor||d||c.backgroundColor||e||b.opt("eventBackgroundColor")||f,h=a.borderColor||d||c.borderColor||e||b.opt("eventBorderColor")||f,i=a.textColor||c.textColor||b.opt("eventTextColor"),j=[];return g&&j.push("background-color:"+g),h&&j.push("border-color:"+h),i&&j.push("color:"+i),j.join(";")},eventsToSegs:function(a,b){var c,d=this.eventsToRanges(a),e=[];for(c=0;c<d.length;c++)e.push.apply(e,this.eventRangeToSegs(d[c],b));return e},eventsToRanges:function(b){var c=this,d=gb(b),e=[];return a.each(d,function(a,b){b.length&&e.push.apply(e,eb(b[0])?c.eventsToInverseRanges(b):c.eventsToNormalRanges(b))}),e},eventsToNormalRanges:function(a){var b,c,d,e,f=this.view.calendar,g=[];for(b=0;b<a.length;b++)c=a[b],d=c.start.clone().stripZone(),e=f.getEventEnd(c).stripZone(),g.push({event:c,start:d,end:e,eventStartMS:+d,eventDurationMS:e-d});return g},eventsToInverseRanges:function(a){var b,c,d=this.view,e=d.start.clone().stripZone(),f=d.end.clone().stripZone(),g=this.eventsToNormalRanges(a),h=[],i=a[0],j=e;for(g.sort(hb),b=0;b<g.length;b++)c=g[b],c.start>j&&h.push({event:i,start:j,end:c.start}),j=c.end;return f>j&&h.push({event:i,start:j,end:f}),h},eventRangeToSegs:function(a,b){var c,d,e;for(c=b?b(a.start,a.end):this.rangeToSegs(a.start,a.end),d=0;d<c.length;d++)e=c[d],e.event=a.event,e.eventStartMS=a.eventStartMS,e.eventDurationMS=a.eventDurationMS;return c}}),jb.prototype=D(cb.prototype),a.extend(jb.prototype,{numbersVisible:!1,cellDuration:b.duration({days:1}),bottomCoordPadding:0,rowEls:null,dayEls:null,helperEls:null,render:function(b){var c,d=this.view,e="";for(c=0;c<d.rowCnt;c++)e+=this.dayRowHtml(c,b);this.el.html(e),this.rowEls=this.el.find(".fc-row"),this.dayEls=this.el.find(".fc-day"),this.dayEls.each(function(b,c){var e=d.cellToDate(Math.floor(b/d.colCnt),b%d.colCnt);d.trigger("dayRender",null,e,a(c))}),cb.prototype.render.call(this)},destroy:function(){this.destroySegPopover()},dayRowHtml:function(a,b){var c=this.view,d=["fc-row","fc-week",c.widgetContentClass];return b&&d.push("fc-rigid"),'<div class="'+d.join(" ")+'"><div class="fc-bg"><table>'+this.rowHtml("day",a)+'</table></div><div class="fc-content-skeleton"><table>'+(this.numbersVisible?"<thead>"+this.rowHtml("number",a)+"</thead>":"")+"</table></div></div>"},dayCellHtml:function(a,b,c){return this.bgCellHtml(a,b,c)},buildCoords:function(b,c){var d,e,f,g=this.view.colCnt;this.dayEls.slice(0,g).each(function(b,g){d=a(g),e=d.offset().left,b&&(f[1]=e),f=[e],c[b]=f}),f[1]=e+d.outerWidth(),this.rowEls.each(function(c,g){d=a(g),e=d.offset().top,c&&(f[1]=e),f=[e],b[c]=f}),f[1]=e+d.outerHeight()+this.bottomCoordPadding},getCellDate:function(a){return this.view.cellToDate(a)},getCellDayEl:function(a){return this.dayEls.eq(a.row*this.view.colCnt+a.col)},rangeToSegs:function(a,b){return this.view.rangeToSegments(a,b)},renderDrag:function(a,b,c){var d;return this.renderHighlight(a,b||this.view.calendar.getDefaultEventEnd(!0,a)),c&&!c.el.closest(this.el).length?(this.renderRangeHelper(a,b,c),d=this.view.opt("dragOpacity"),void 0!==d&&this.helperEls.css("opacity",d),!0):void 0},destroyDrag:function(){this.destroyHighlight(),this.destroyHelper()},renderResize:function(a,b,c){this.renderHighlight(a,b),this.renderRangeHelper(a,b,c)},destroyResize:function(){this.destroyHighlight(),this.destroyHelper()},renderHelper:function(b,c){var d,e=[],f=this.eventsToSegs([b]);f=this.renderFgSegEls(f),d=this.renderSegRows(f),this.rowEls.each(function(b,f){var g,h=a(f),i=a('<div class="fc-helper-skeleton"><table/></div>');g=c&&c.row===b?c.el.position().top:h.find(".fc-content-skeleton tbody").position().top,i.css("top",g).find("table").append(d[b].tbodyEl),h.append(i),e.push(i[0])}),this.helperEls=a(e)},destroyHelper:function(){this.helperEls&&(this.helperEls.remove(),this.helperEls=null)},fillSegTag:"td",renderFill:function(b,c){var d,e,f,g=[];for(c=this.renderFillSegEls(b,c),d=0;d<c.length;d++)e=c[d],f=this.renderFillRow(b,e),this.rowEls.eq(e.row).append(f),g.push(f[0]);return this.elsByFill[b]=a(g),c},renderFillRow:function(b,c){var d,e,f=this.view.colCnt,g=c.leftCol,h=c.rightCol+1;return d=a('<div class="fc-'+b.toLowerCase()+'-skeleton"><table><tr/></table></div>'),e=d.find("tr"),g>0&&e.append('<td colspan="'+g+'"/>'),e.append(c.el.attr("colspan",h-g)),f>h&&e.append('<td colspan="'+(f-h)+'"/>'),this.bookendCells(e,b),d}}),a.extend(jb.prototype,{rowStructs:null,destroyEvents:function(){this.destroySegPopover(),cb.prototype.destroyEvents.apply(this,arguments)},getSegs:function(){return cb.prototype.getSegs.call(this).concat(this.popoverSegs||[])},renderBgSegs:function(b){var c=a.grep(b,function(a){return a.event.allDay});return cb.prototype.renderBgSegs.call(this,c)},renderFgSegs:function(b){var c;return b=this.renderFgSegEls(b),c=this.rowStructs=this.renderSegRows(b),this.rowEls.each(function(b,d){a(d).find(".fc-content-skeleton > table").append(c[b].tbodyEl)}),b},destroyFgSegs:function(){for(var a,b=this.rowStructs||[];a=b.pop();)a.tbodyEl.remove();this.rowStructs=null},renderSegRows:function(a){var b,c,d=[];for(b=this.groupSegRows(a),c=0;c<b.length;c++)d.push(this.renderSegRow(c,b[c]));return d},fgSegHtml:function(a,b){var c,d=this.view,e=d.opt("isRTL"),f=a.event,g=d.isEventDraggable(f),h=!b&&f.allDay&&a.isEnd&&d.isEventResizable(f),i=this.getSegClasses(a,g,h),j=this.getEventSkinCss(f),k="";return i.unshift("fc-day-grid-event"),!f.allDay&&a.isStart&&(k='<span class="fc-time">'+G(d.getEventTimeText(f))+"</span>"),c='<span class="fc-title">'+(G(f.title||"")||"&nbsp;")+"</span>",'<a class="'+i.join(" ")+'"'+(f.url?' href="'+G(f.url)+'"':"")+(j?' style="'+j+'"':"")+'><div class="fc-content">'+(e?c+" "+k:k+" "+c)+"</div>"+(h?'<div class="fc-resizer"/>':"")+"</a>"},renderSegRow:function(b,c){function d(b){for(;b>g;)k=(s[e-1]||[])[g],k?k.attr("rowspan",parseInt(k.attr("rowspan")||1,10)+1):(k=a("<td/>"),h.append(k)),r[e][g]=k,s[e][g]=k,g++}var e,f,g,h,i,j,k,l=this.view,m=l.colCnt,n=this.buildSegLevels(c),o=Math.max(1,n.length),p=a("<tbody/>"),q=[],r=[],s=[];for(e=0;o>e;e++){if(f=n[e],g=0,h=a("<tr/>"),q.push([]),r.push([]),s.push([]),f)for(i=0;i<f.length;i++){for(j=f[i],d(j.leftCol),k=a('<td class="fc-event-container"/>').append(j.el),j.leftCol!=j.rightCol?k.attr("colspan",j.rightCol-j.leftCol+1):s[e][g]=k;g<=j.rightCol;)r[e][g]=k,q[e][g]=j,g++;h.append(k)}d(m),this.bookendCells(h,"eventSkeleton"),p.append(h)}return{row:b,tbodyEl:p,cellMatrix:r,segMatrix:q,segLevels:n,segs:c}},buildSegLevels:function(a){var b,c,d,e=[];for(a.sort(ib),b=0;b<a.length;b++){for(c=a[b],d=0;d<e.length&&kb(c,e[d]);d++);c.level=d,(e[d]||(e[d]=[])).push(c)}for(d=0;d<e.length;d++)e[d].sort(lb);return e},groupSegRows:function(a){var b,c=this.view,d=[];for(b=0;b<c.rowCnt;b++)d.push([]);for(b=0;b<a.length;b++)d[a[b].row].push(a[b]);return d}}),a.extend(jb.prototype,{segPopover:null,popoverSegs:null,destroySegPopover:function(){this.segPopover&&this.segPopover.hide()},limitRows:function(a){var b,c,d=this.rowStructs||[];for(b=0;b<d.length;b++)this.unlimitRow(b),c=a?"number"==typeof a?a:this.computeRowLevelLimit(b):!1,c!==!1&&this.limitRow(b,c)},computeRowLevelLimit:function(a){var b,c,d=this.rowEls.eq(a),e=d.height(),f=this.rowStructs[a].tbodyEl.children();for(b=0;b<f.length;b++)if(c=f.eq(b).removeClass("fc-limited"),c.position().top+c.outerHeight()>e)return b;return!1},limitRow:function(b,c){function d(d){for(;d>y;)e={row:b,col:y},k=u.getCellSegs(e,c),k.length&&(n=g[c-1][y],t=u.renderMoreLink(e,k),s=a("<div/>").append(t),n.append(s),x.push(s[0])),y++}var e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=this,v=this.view,w=this.rowStructs[b],x=[],y=0;if(c&&c<w.segLevels.length){for(f=w.segLevels[c-1],g=w.cellMatrix,h=w.tbodyEl.children().slice(c).addClass("fc-limited").get(),i=0;i<f.length;i++){for(j=f[i],d(j.leftCol),m=[],l=0;y<=j.rightCol;)e={row:b,col:y},k=this.getCellSegs(e,c),m.push(k),l+=k.length,y++;if(l){for(n=g[c-1][j.leftCol],o=n.attr("rowspan")||1,p=[],q=0;q<m.length;q++)r=a('<td class="fc-more-cell"/>').attr("rowspan",o),k=m[q],e={row:b,col:j.leftCol+q},t=this.renderMoreLink(e,[j].concat(k)),s=a("<div/>").append(t),r.append(s),p.push(r[0]),x.push(r[0]);n.addClass("fc-limited").after(a(p)),h.push(n[0])}}d(v.colCnt),w.moreEls=a(x),w.limitedEls=a(h)}},unlimitRow:function(a){var b=this.rowStructs[a];b.moreEls&&(b.moreEls.remove(),b.moreEls=null),b.limitedEls&&(b.limitedEls.removeClass("fc-limited"),b.limitedEls=null)},renderMoreLink:function(b,c){var d=this,e=this.view;return a('<a class="fc-more"/>').text(this.getMoreLinkText(c.length)).on("click",function(f){var g=e.opt("eventLimitClick"),h=e.cellToDate(b),i=a(this),j=d.getCellDayEl(b),k=d.getCellSegs(b),l=d.resliceDaySegs(k,h),m=d.resliceDaySegs(c,h);"function"==typeof g&&(g=e.trigger("eventLimitClick",null,{date:h,dayEl:j,moreEl:i,segs:l,hiddenSegs:m},f)),"popover"===g?d.showSegPopover(h,b,i,l):"string"==typeof g&&e.calendar.zoomTo(h,g)})},showSegPopover:function(a,b,c,d){var e,f,g=this,h=this.view,i=c.parent();e=1==h.rowCnt?this.view.el:this.rowEls.eq(b.row),f={className:"fc-more-popover",content:this.renderSegPopoverContent(a,d),parentEl:this.el,top:e.offset().top,autoHide:!0,viewportConstrain:h.opt("popoverViewportConstrain"),hide:function(){g.segPopover.destroy(),g.segPopover=null,g.popoverSegs=null}},h.opt("isRTL")?f.right=i.offset().left+i.outerWidth()+1:f.left=i.offset().left-1,this.segPopover=new X(f),this.segPopover.show()},renderSegPopoverContent:function(b,c){var d,e=this.view,f=e.opt("theme"),g=b.format(e.opt("dayPopoverFormat")),h=a('<div class="fc-header '+e.widgetHeaderClass+'"><span class="fc-close '+(f?"ui-icon ui-icon-closethick":"fc-icon fc-icon-x")+'"></span><span class="fc-title">'+G(g)+'</span><div class="fc-clear"/></div><div class="fc-body '+e.widgetContentClass+'"><div class="fc-event-container"></div></div>'),i=h.find(".fc-event-container");for(c=this.renderFgSegEls(c,!0),this.popoverSegs=c,d=0;d<c.length;d++)c[d].cellDate=b,i.append(c[d].el);return h},resliceDaySegs:function(b,c){var d=a.map(b,function(a){return a.event}),e=c.clone().stripTime(),f=e.clone().add(1,"days");return this.eventsToSegs(d,function(a,b){var c=x(a,b,e,f);return c?[c]:[]})},getMoreLinkText:function(a){var b=this.view,c=b.opt("eventLimitText");return"function"==typeof c?c(a):"+"+a+" "+c},getCellSegs:function(a,b){for(var c,d=this.rowStructs[a.row].segMatrix,e=b||0,f=[];e<d.length;)c=d[e][a.col],c&&f.push(c),e++;return f}}),mb.prototype=D(cb.prototype),a.extend(mb.prototype,{slotDuration:null,snapDuration:null,minTime:null,maxTime:null,dayEls:null,slatEls:null,slatTops:null,helperEl:null,businessHourSegs:null,render:function(){this.processOptions(),this.el.html(this.renderHtml()),this.dayEls=this.el.find(".fc-day"),this.slatEls=this.el.find(".fc-slats tr"),this.computeSlatTops(),this.renderBusinessHours(),cb.prototype.render.call(this)},renderBusinessHours:function(){var a=this.view.calendar.getBusinessHoursEvents();this.businessHourSegs=this.renderFill("businessHours",this.eventsToSegs(a),"bgevent")},renderHtml:function(){return'<div class="fc-bg"><table>'+this.rowHtml("slotBg")+'</table></div><div class="fc-slats"><table>'+this.slatRowHtml()+"</table></div>"
},slotBgCellHtml:function(a,b,c){return this.bgCellHtml(a,b,c)},slatRowHtml:function(){for(var a,c,d,e=this.view,f=e.calendar,g=e.opt("isRTL"),h="",i=this.slotDuration.asMinutes()%15===0,j=b.duration(+this.minTime);j<this.maxTime;)a=e.start.clone().time(j),c=a.minutes(),d='<td class="fc-axis fc-time '+e.widgetContentClass+'" '+e.axisStyleAttr()+">"+(i&&c?"":"<span>"+G(f.formatDate(a,e.opt("axisFormat")))+"</span>")+"</td>",h+="<tr "+(c?'class="fc-minor"':"")+">"+(g?"":d)+'<td class="'+e.widgetContentClass+'"/>'+(g?d:"")+"</tr>",j.add(this.slotDuration);return h},processOptions:function(){var a=this.view,c=a.opt("slotDuration"),d=a.opt("snapDuration");c=b.duration(c),d=d?b.duration(d):c,this.slotDuration=c,this.snapDuration=d,this.cellDuration=d,this.minTime=b.duration(a.opt("minTime")),this.maxTime=b.duration(a.opt("maxTime"))},rangeToSegs:function(a,b){var c,d,e,f,g,h=this.view,i=[];for(a=a.clone().stripZone(),b=b.clone().stripZone(),d=0;d<h.colCnt;d++)e=h.cellToDate(0,d),f=e.clone().time(this.minTime),g=e.clone().time(this.maxTime),c=x(a,b,f,g),c&&(c.col=d,i.push(c));return i},resize:function(){this.computeSlatTops(),this.updateSegVerticals()},buildCoords:function(c,d){var e,f,g=this.view.colCnt,h=this.el.offset().top,i=b.duration(+this.minTime),j=null;for(this.dayEls.slice(0,g).each(function(b,c){e=a(c),f=e.offset().left,j&&(j[1]=f),j=[f],d[b]=j}),j[1]=f+e.outerWidth(),j=null;i<this.maxTime;)f=h+this.computeTimeTop(i),j&&(j[1]=f),j=[f],c.push(j),i.add(this.snapDuration);j[1]=h+this.computeTimeTop(i)},getCellDate:function(a){var b=this.view,c=b.calendar;return c.rezoneDate(b.cellToDate(0,a.col).time(this.minTime+this.snapDuration*a.row))},getCellDayEl:function(a){return this.dayEls.eq(a.col)},computeDateTop:function(a,c){return this.computeTimeTop(b.duration(a.clone().stripZone()-c.clone().stripTime()))},computeTimeTop:function(a){var b,c,d,e,f=(a-this.minTime)/this.slotDuration;return f=Math.max(0,f),f=Math.min(this.slatEls.length,f),b=Math.floor(f),c=f-b,d=this.slatTops[b],c?(e=this.slatTops[b+1],d+(e-d)*c):d},computeSlatTops:function(){var b,c=[];this.slatEls.each(function(d,e){b=a(e).position().top,c.push(b)}),c.push(b+this.slatEls.last().outerHeight()),this.slatTops=c},renderDrag:function(a,b,c){var d;return c?(this.renderRangeHelper(a,b,c),d=this.view.opt("dragOpacity"),void 0!==d&&this.helperEl.css("opacity",d),!0):void this.renderHighlight(a,b||this.view.calendar.getDefaultEventEnd(!1,a))},destroyDrag:function(){this.destroyHelper(),this.destroyHighlight()},renderResize:function(a,b,c){this.renderRangeHelper(a,b,c)},destroyResize:function(){this.destroyHelper()},renderHelper:function(b,c){var d,e,f,g,h=this.eventsToSegs([b]);for(h=this.renderFgSegEls(h),d=this.renderSegTable(h),e=0;e<h.length;e++)f=h[e],c&&c.col===f.col&&(g=c.el,f.el.css({left:g.css("left"),right:g.css("right"),"margin-left":g.css("margin-left"),"margin-right":g.css("margin-right")}));this.helperEl=a('<div class="fc-helper-skeleton"/>').append(d).appendTo(this.el)},destroyHelper:function(){this.helperEl&&(this.helperEl.remove(),this.helperEl=null)},renderSelection:function(a,b){this.view.opt("selectHelper")?this.renderRangeHelper(a,b):this.renderHighlight(a,b)},destroySelection:function(){this.destroyHelper(),this.destroyHighlight()},renderFill:function(b,c,d){var e,f,g,h,i,j,k,l,m,n,o=this.view;if(c.length){for(c=this.renderFillSegEls(b,c),e=this.groupSegCols(c),d=d||b.toLowerCase(),f=a('<div class="fc-'+d+'-skeleton"><table><tr/></table></div>'),g=f.find("tr"),h=0;h<e.length;h++)if(i=e[h],j=a("<td/>").appendTo(g),i.length)for(k=a('<div class="fc-'+d+'-container"/>').appendTo(j),l=o.cellToDate(0,h),m=0;m<i.length;m++)n=i[m],k.append(n.el.css({top:this.computeDateTop(n.start,l),bottom:-this.computeDateTop(n.end,l)}));this.bookendCells(g,b),this.el.append(f),this.elsByFill[b]=f}return c}}),a.extend(mb.prototype,{eventSkeletonEl:null,renderFgSegs:function(b){return b=this.renderFgSegEls(b),this.el.append(this.eventSkeletonEl=a('<div class="fc-content-skeleton"/>').append(this.renderSegTable(b))),b},destroyFgSegs:function(){this.eventSkeletonEl&&(this.eventSkeletonEl.remove(),this.eventSkeletonEl=null)},renderSegTable:function(b){var c,d,e,f,g,h,i=a("<table><tr/></table>"),j=i.find("tr");for(c=this.groupSegCols(b),this.computeSegVerticals(b),f=0;f<c.length;f++){for(g=c[f],nb(g),h=a('<div class="fc-event-container"/>'),d=0;d<g.length;d++)e=g[d],e.el.css(this.generateSegPositionCss(e)),e.bottom-e.top<30&&e.el.addClass("fc-short"),h.append(e.el);j.append(a("<td/>").append(h))}return this.bookendCells(j,"eventSkeleton"),i},updateSegVerticals:function(){var a,b=(this.segs||[]).concat(this.businessHourSegs||[]);for(this.computeSegVerticals(b),a=0;a<b.length;a++)b[a].el.css(this.generateSegVerticalCss(b[a]))},computeSegVerticals:function(a){var b,c;for(b=0;b<a.length;b++)c=a[b],c.top=this.computeDateTop(c.start,c.start),c.bottom=this.computeDateTop(c.end,c.start)},fgSegHtml:function(a,b){var c,d,e,f=this.view,g=a.event,h=f.isEventDraggable(g),i=!b&&a.isEnd&&f.isEventResizable(g),j=this.getSegClasses(a,h,i),k=this.getEventSkinCss(g);return j.unshift("fc-time-grid-event"),f.isMultiDayEvent(g)?(a.isStart||a.isEnd)&&(c=f.getEventTimeText(a.start,a.end),d=f.getEventTimeText(a.start,a.end,"LT"),e=f.getEventTimeText(a.start,null)):(c=f.getEventTimeText(g),d=f.getEventTimeText(g,"LT"),e=f.getEventTimeText(g.start,null)),'<a class="'+j.join(" ")+'"'+(g.url?' href="'+G(g.url)+'"':"")+(k?' style="'+k+'"':"")+'><div class="fc-content">'+(c?'<div class="fc-time" data-start="'+G(e)+'" data-full="'+G(d)+'"><span>'+G(c)+"</span></div>":"")+(g.title?'<div class="fc-title">'+G(g.title)+"</div>":"")+'</div><div class="fc-bg"/>'+(i?'<div class="fc-resizer"/>':"")+"</a>"},generateSegPositionCss:function(a){var b,c,d=this.view,e=d.opt("isRTL"),f=d.opt("slotEventOverlap"),g=a.backwardCoord,h=a.forwardCoord,i=this.generateSegVerticalCss(a);return f&&(h=Math.min(1,g+2*(h-g))),e?(b=1-h,c=g):(b=g,c=1-h),i.zIndex=a.level+1,i.left=100*b+"%",i.right=100*c+"%",f&&a.forwardPressure&&(i[e?"marginLeft":"marginRight"]=20),i},generateSegVerticalCss:function(a){return{top:a.top,bottom:-a.bottom}},groupSegCols:function(a){var b,c=this.view,d=[];for(b=0;b<c.colCnt;b++)d.push([]);for(b=0;b<a.length;b++)d[a[b].col].push(a[b]);return d}}),vb.prototype={calendar:null,coordMap:null,el:null,start:null,end:null,intervalStart:null,intervalEnd:null,rowCnt:null,colCnt:null,isSelected:!1,scrollerEl:null,scrollTop:null,widgetHeaderClass:null,widgetContentClass:null,highlightStateClass:null,documentMousedownProxy:null,documentDragStartProxy:null,init:function(){var b=this.opt("theme")?"ui":"fc";this.widgetHeaderClass=b+"-widget-header",this.widgetContentClass=b+"-widget-content",this.highlightStateClass=b+"-state-highlight",this.documentMousedownProxy=a.proxy(this,"documentMousedown"),this.documentDragStartProxy=a.proxy(this,"documentDragStart")},render:function(){this.updateSize(),this.trigger("viewRender",this,this,this.el),a(document).on("mousedown",this.documentMousedownProxy).on("dragstart",this.documentDragStartProxy)},destroy:function(){this.unselect(),this.trigger("viewDestroy",this,this,this.el),this.destroyEvents(),this.el.empty(),a(document).off("mousedown",this.documentMousedownProxy).off("dragstart",this.documentDragStartProxy)},incrementDate:function(){},updateSize:function(a){a&&this.recordScroll(),this.updateHeight(),this.updateWidth()},updateWidth:function(){},updateHeight:function(){var a=this.calendar;this.setHeight(a.getSuggestedViewHeight(),a.isHeightAuto())},setHeight:function(){},computeScrollerHeight:function(a){var b,c=this.el.add(this.scrollerEl);return c.css({position:"relative",left:-1}),b=this.el.outerHeight()-this.scrollerEl.height(),c.css({position:"",left:""}),a-b},recordScroll:function(){this.scrollerEl&&(this.scrollTop=this.scrollerEl.scrollTop())},restoreScroll:function(){null!==this.scrollTop&&this.scrollerEl.scrollTop(this.scrollTop)},renderEvents:function(){this.segEach(function(a){this.trigger("eventAfterRender",a.event,a.event,a.el)}),this.trigger("eventAfterAllRender")},destroyEvents:function(){this.segEach(function(a){this.trigger("eventDestroy",a.event,a.event,a.el)})},resolveEventEl:function(b,c){var d=this.trigger("eventRender",b,b,c);return d===!1?c=null:d&&d!==!0&&(c=a(d)),c},showEvent:function(a){this.segEach(function(a){a.el.css("visibility","")},a)},hideEvent:function(a){this.segEach(function(a){a.el.css("visibility","hidden")},a)},segEach:function(a,b){var c,d=this.getSegs();for(c=0;c<d.length;c++)b&&d[c].event._id!==b._id||a.call(this,d[c])},getSegs:function(){},renderDrag:function(){},destroyDrag:function(){},documentDragStart:function(b){var c,d,e,f,g,h=this,i=this.calendar,j=null,k=null,l=null;this.opt("droppable")&&(c=a(b.target),d=this.opt("dropAccept"),(a.isFunction(d)?d.call(c[0],c):c.is(d))&&(e=wb(c),f=e.eventProps,g=new $(this.coordMap,{cellOver:function(b,c){j=c,k=e.duration?j.clone().add(e.duration):null,l=k||i.getDefaultEventEnd(!j.hasTime(),j),f&&a.extend(f,{start:j,end:k}),i.isExternalDragAllowedInRange(j,l,f)?h.renderDrag(j,l):(j=null,n())},cellOut:function(){j=null,h.destroyDrag(),o()}}),a(document).one("dragstop",function(a,b){var d;h.destroyDrag(),o(),j&&(e.startTime&&!j.hasTime()&&j.time(e.startTime),h.trigger("drop",c[0],j,a,b),f&&(d=i.renderEvent(f,e.stick),h.trigger("eventReceive",null,d[0])))}),g.startDrag(b)))},select:function(a,b,c){this.unselect(c),this.renderSelection(a,b),this.reportSelection(a,b,c)},renderSelection:function(){},reportSelection:function(a,b,c){this.isSelected=!0,this.trigger("select",null,a,b,c)},unselect:function(a){this.isSelected&&(this.isSelected=!1,this.destroySelection(),this.trigger("unselect",null,a))},destroySelection:function(){},documentMousedown:function(b){var c;this.isSelected&&this.opt("unselectAuto")&&w(b)&&(c=this.opt("unselectCancel"),c&&a(b.target).closest(c).length||this.unselect(b))}},Jb.dataAttrPrefix="",xb.prototype=D(vb.prototype),a.extend(xb.prototype,{dayGrid:null,dayNumbersVisible:!1,weekNumbersVisible:!1,weekNumberWidth:null,headRowEl:null,render:function(a,b,c){this.rowCnt=a,this.colCnt=b,this.dayNumbersVisible=c,this.weekNumbersVisible=this.opt("weekNumbers"),this.dayGrid.numbersVisible=this.dayNumbersVisible||this.weekNumbersVisible,this.el.addClass("fc-basic-view").html(this.renderHtml()),this.headRowEl=this.el.find("thead .fc-row"),this.scrollerEl=this.el.find(".fc-day-grid-container"),this.dayGrid.coordMap.containerEl=this.scrollerEl,this.dayGrid.el=this.el.find(".fc-day-grid"),this.dayGrid.render(this.hasRigidRows()),vb.prototype.render.call(this)},destroy:function(){this.dayGrid.destroy(),vb.prototype.destroy.call(this)},renderHtml:function(){return'<table><thead><tr><td class="'+this.widgetHeaderClass+'">'+this.dayGrid.headHtml()+'</td></tr></thead><tbody><tr><td class="'+this.widgetContentClass+'"><div class="fc-day-grid-container"><div class="fc-day-grid"/></div></td></tr></tbody></table>'},headIntroHtml:function(){return this.weekNumbersVisible?'<th class="fc-week-number '+this.widgetHeaderClass+'" '+this.weekNumberStyleAttr()+"><span>"+G(this.opt("weekNumberTitle"))+"</span></th>":void 0},numberIntroHtml:function(a){return this.weekNumbersVisible?'<td class="fc-week-number" '+this.weekNumberStyleAttr()+"><span>"+this.calendar.calculateWeekNumber(this.cellToDate(a,0))+"</span></td>":void 0},dayIntroHtml:function(){return this.weekNumbersVisible?'<td class="fc-week-number '+this.widgetContentClass+'" '+this.weekNumberStyleAttr()+"></td>":void 0},introHtml:function(){return this.weekNumbersVisible?'<td class="fc-week-number" '+this.weekNumberStyleAttr()+"></td>":void 0},numberCellHtml:function(a,b,c){var d;return this.dayNumbersVisible?(d=this.dayGrid.getDayClasses(c),d.unshift("fc-day-number"),'<td class="'+d.join(" ")+'" data-date="'+c.format()+'">'+c.date()+"</td>"):"<td/>"},weekNumberStyleAttr:function(){return null!==this.weekNumberWidth?'style="width:'+this.weekNumberWidth+'px"':""},hasRigidRows:function(){var a=this.opt("eventLimit");return a&&"number"!=typeof a},updateWidth:function(){this.weekNumbersVisible&&(this.weekNumberWidth=r(this.el.find(".fc-week-number")))},setHeight:function(a,b){var c,d=this.opt("eventLimit");t(this.scrollerEl),m(this.headRowEl),this.dayGrid.destroySegPopover(),d&&"number"==typeof d&&this.dayGrid.limitRows(d),c=this.computeScrollerHeight(a),this.setGridHeight(c,b),d&&"number"!=typeof d&&this.dayGrid.limitRows(d),!b&&s(this.scrollerEl,c)&&(l(this.headRowEl,v(this.scrollerEl)),c=this.computeScrollerHeight(a),this.scrollerEl.height(c),this.restoreScroll())},setGridHeight:function(a,b){b?q(this.dayGrid.rowEls):p(this.dayGrid.rowEls,a,!0)},renderEvents:function(a){this.dayGrid.renderEvents(a),this.updateHeight(),vb.prototype.renderEvents.call(this,a)},getSegs:function(){return this.dayGrid.getSegs()},destroyEvents:function(){vb.prototype.destroyEvents.call(this),this.recordScroll(),this.dayGrid.destroyEvents()},renderDrag:function(a,b,c){return this.dayGrid.renderDrag(a,b,c)},destroyDrag:function(){this.dayGrid.destroyDrag()},renderSelection:function(a,b){this.dayGrid.renderSelection(a,b)},destroySelection:function(){this.dayGrid.destroySelection()}}),e({fixedWeekCount:!0}),Kb.month=yb,yb.prototype=D(xb.prototype),a.extend(yb.prototype,{name:"month",incrementDate:function(a,b){return a.clone().stripTime().add(b,"months").startOf("month")},render:function(a){var b;this.intervalStart=a.clone().stripTime().startOf("month"),this.intervalEnd=this.intervalStart.clone().add(1,"months"),this.start=this.intervalStart.clone(),this.start=this.skipHiddenDays(this.start),this.start.startOf("week"),this.start=this.skipHiddenDays(this.start),this.end=this.intervalEnd.clone(),this.end=this.skipHiddenDays(this.end,-1,!0),this.end.add((7-this.end.weekday())%7,"days"),this.end=this.skipHiddenDays(this.end,-1,!0),b=Math.ceil(this.end.diff(this.start,"weeks",!0)),this.isFixedWeeks()&&(this.end.add(6-b,"weeks"),b=6),this.title=this.calendar.formatDate(this.intervalStart,this.opt("titleFormat")),xb.prototype.render.call(this,b,this.getCellsPerWeek(),!0)},setGridHeight:function(a,b){b=b||"variable"===this.opt("weekMode"),b&&(a*=this.rowCnt/6),p(this.dayGrid.rowEls,a,!b)},isFixedWeeks:function(){var a=this.opt("weekMode");return a?"fixed"===a:this.opt("fixedWeekCount")}}),Kb.basicWeek=zb,zb.prototype=D(xb.prototype),a.extend(zb.prototype,{name:"basicWeek",incrementDate:function(a,b){return a.clone().stripTime().add(b,"weeks").startOf("week")},render:function(a){this.intervalStart=a.clone().stripTime().startOf("week"),this.intervalEnd=this.intervalStart.clone().add(1,"weeks"),this.start=this.skipHiddenDays(this.intervalStart),this.end=this.skipHiddenDays(this.intervalEnd,-1,!0),this.title=this.calendar.formatRange(this.start,this.end.clone().subtract(1),this.opt("titleFormat")," — "),xb.prototype.render.call(this,1,this.getCellsPerWeek(),!1)}}),Kb.basicDay=Ab,Ab.prototype=D(xb.prototype),a.extend(Ab.prototype,{name:"basicDay",incrementDate:function(a,b){var c=a.clone().stripTime().add(b,"days");return c=this.skipHiddenDays(c,0>b?-1:1)},render:function(a){this.start=this.intervalStart=a.clone().stripTime(),this.end=this.intervalEnd=this.start.clone().add(1,"days"),this.title=this.calendar.formatDate(this.start,this.opt("titleFormat")),xb.prototype.render.call(this,1,1,!1)}}),e({allDaySlot:!0,allDayText:"all-day",scrollTime:"06:00:00",slotDuration:"00:30:00",axisFormat:Bb,timeFormat:{agenda:Cb},minTime:"00:00:00",maxTime:"24:00:00",slotEventOverlap:!0});var Yb=5;Db.prototype=D(vb.prototype),a.extend(Db.prototype,{timeGrid:null,dayGrid:null,axisWidth:null,noScrollRowEls:null,bottomRuleEl:null,bottomRuleHeight:null,render:function(b){this.rowCnt=1,this.colCnt=b,this.el.addClass("fc-agenda-view").html(this.renderHtml()),this.scrollerEl=this.el.find(".fc-time-grid-container"),this.timeGrid.coordMap.containerEl=this.scrollerEl,this.timeGrid.el=this.el.find(".fc-time-grid"),this.timeGrid.render(),this.bottomRuleEl=a('<hr class="'+this.widgetHeaderClass+'"/>').appendTo(this.timeGrid.el),this.dayGrid&&(this.dayGrid.el=this.el.find(".fc-day-grid"),this.dayGrid.render(),this.dayGrid.bottomCoordPadding=this.dayGrid.el.next("hr").outerHeight()),this.noScrollRowEls=this.el.find(".fc-row:not(.fc-scroller *)"),vb.prototype.render.call(this),this.resetScroll()},destroy:function(){this.timeGrid.destroy(),this.dayGrid&&this.dayGrid.destroy(),vb.prototype.destroy.call(this)},renderHtml:function(){return'<table><thead><tr><td class="'+this.widgetHeaderClass+'">'+this.timeGrid.headHtml()+'</td></tr></thead><tbody><tr><td class="'+this.widgetContentClass+'">'+(this.dayGrid?'<div class="fc-day-grid"/><hr class="'+this.widgetHeaderClass+'"/>':"")+'<div class="fc-time-grid-container"><div class="fc-time-grid"/></div></td></tr></tbody></table>'},headIntroHtml:function(){var a,b,c,d;return this.opt("weekNumbers")?(a=this.cellToDate(0,0),b=this.calendar.calculateWeekNumber(a),c=this.opt("weekNumberTitle"),d=this.opt("isRTL")?b+c:c+b,'<th class="fc-axis fc-week-number '+this.widgetHeaderClass+'" '+this.axisStyleAttr()+"><span>"+G(d)+"</span></th>"):'<th class="fc-axis '+this.widgetHeaderClass+'" '+this.axisStyleAttr()+"></th>"},dayIntroHtml:function(){return'<td class="fc-axis '+this.widgetContentClass+'" '+this.axisStyleAttr()+"><span>"+(this.opt("allDayHtml")||G(this.opt("allDayText")))+"</span></td>"},slotBgIntroHtml:function(){return'<td class="fc-axis '+this.widgetContentClass+'" '+this.axisStyleAttr()+"></td>"},introHtml:function(){return'<td class="fc-axis" '+this.axisStyleAttr()+"></td>"},axisStyleAttr:function(){return null!==this.axisWidth?'style="width:'+this.axisWidth+'px"':""},updateSize:function(a){a&&this.timeGrid.resize(),vb.prototype.updateSize.call(this,a)},updateWidth:function(){this.axisWidth=r(this.el.find(".fc-axis"))},setHeight:function(a,b){var c,d;null===this.bottomRuleHeight&&(this.bottomRuleHeight=this.bottomRuleEl.outerHeight()),this.bottomRuleEl.hide(),this.scrollerEl.css("overflow",""),t(this.scrollerEl),m(this.noScrollRowEls),this.dayGrid&&(this.dayGrid.destroySegPopover(),c=this.opt("eventLimit"),c&&"number"!=typeof c&&(c=Yb),c&&this.dayGrid.limitRows(c)),b||(d=this.computeScrollerHeight(a),s(this.scrollerEl,d)?(l(this.noScrollRowEls,v(this.scrollerEl)),d=this.computeScrollerHeight(a),this.scrollerEl.height(d),this.restoreScroll()):(this.scrollerEl.height(d).css("overflow","hidden"),this.bottomRuleEl.show()))},resetScroll:function(){function a(){c.scrollerEl.scrollTop(e)}var c=this,d=b.duration(this.opt("scrollTime")),e=this.timeGrid.computeTimeTop(d);e=Math.ceil(e),e&&e++,a(),setTimeout(a,0)},renderEvents:function(a){var b,c,d=[],e=[],f=[];for(c=0;c<a.length;c++)a[c].allDay?d.push(a[c]):e.push(a[c]);b=this.timeGrid.renderEvents(e),this.dayGrid&&(f=this.dayGrid.renderEvents(d)),this.updateHeight(),vb.prototype.renderEvents.call(this,a)},getSegs:function(){return this.timeGrid.getSegs().concat(this.dayGrid?this.dayGrid.getSegs():[])},destroyEvents:function(){vb.prototype.destroyEvents.call(this),this.recordScroll(),this.timeGrid.destroyEvents(),this.dayGrid&&this.dayGrid.destroyEvents()},renderDrag:function(a,b,c){return a.hasTime()?this.timeGrid.renderDrag(a,b,c):this.dayGrid?this.dayGrid.renderDrag(a,b,c):void 0},destroyDrag:function(){this.timeGrid.destroyDrag(),this.dayGrid&&this.dayGrid.destroyDrag()},renderSelection:function(a,b){a.hasTime()||b.hasTime()?this.timeGrid.renderSelection(a,b):this.dayGrid&&this.dayGrid.renderSelection(a,b)},destroySelection:function(){this.timeGrid.destroySelection(),this.dayGrid&&this.dayGrid.destroySelection()}}),Kb.agendaWeek=Eb,Eb.prototype=D(Db.prototype),a.extend(Eb.prototype,{name:"agendaWeek",incrementDate:function(a,b){return a.clone().stripTime().add(b,"weeks").startOf("week")},render:function(a){this.intervalStart=a.clone().stripTime().startOf("week"),this.intervalEnd=this.intervalStart.clone().add(1,"weeks"),this.start=this.skipHiddenDays(this.intervalStart),this.end=this.skipHiddenDays(this.intervalEnd,-1,!0),this.title=this.calendar.formatRange(this.start,this.end.clone().subtract(1),this.opt("titleFormat")," — "),Db.prototype.render.call(this,this.getCellsPerWeek())}}),Kb.agendaDay=Fb,Fb.prototype=D(Db.prototype),a.extend(Fb.prototype,{name:"agendaDay",incrementDate:function(a,b){var c=a.clone().stripTime().add(b,"days");return c=this.skipHiddenDays(c,0>b?-1:1)},render:function(a){this.start=this.intervalStart=a.clone().stripTime(),this.end=this.intervalEnd=this.start.clone().add(1,"days"),this.title=this.calendar.formatDate(this.start,this.opt("titleFormat")),Db.prototype.render.call(this,1)}})});var userLat,userLon,global_mapCenter,local_icons={defaultIcon:{},yellowIcon:{iconUrl:"img/marker-icon.png",shadowUrl:"img/marker-shadow.png",iconSize:[25,41],shadowSize:[41,41],iconAnchor:[12,40],shadowAnchor:[12,40],popupAnchor:[0,-40]},leafIcon:{iconUrl:"img/leaf-green.png",shadowUrl:"img/leaf-shadow.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},orangeLeafIcon:{iconUrl:"img/leaf-orange.png",shadowUrl:"img/leaf-shadow.png",iconSize:[38,95],shadowSize:[50,64],iconAnchor:[22,94],shadowAnchor:[4,62],popupAnchor:[-3,-76]},divIcon:{type:"div",iconSize:[200,0],popupAnchor:[0,0],html:"Using <strong>Bold text as an icon</strong>:"}},tilesDict={openstreetmap:{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",options:{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}},mapbox:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig1oichl/{z}/{x}/{y}.png",options:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},aicp:{url:"1.0.0/aicpweek/{z}/{x}/{y}.png",options:{minZoom:16,maxZoom:23,reuseTiles:!0}},urban:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6a7dkn/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:19,reuseTiles:!0}},fairy:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig9jd86b/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},sunset:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6f6j6e/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}},arabesque:{url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig67e7eb/{z}/{x}/{y}.png",option:{attribution:"IF",minZoom:1,maxZoom:23,reuseTiles:!0}}},mapSelect="cloud",global_hashtag="#HappyHourShowcase",eventCategories=["lecture","show","award"],placeCategories=["food","bars","sponsors","washrooms","exhibits","smoking"],globalEditLoc={};"undefined"!=typeof module&&"undefined"!=typeof module.exports&&(module.exports.hashtag=global_hashtag);var mainWindow,he;app.controller("WorldRouteCtrl",["$location","$scope","$routeParams","db","$rootScope","styleManager","mapManager","alertManager",function(a,b,c,d,e,f,g,h){function i(c,f){b.worlds=d.worlds.query({localTime:new Date,userCoordinate:[f,c]},function(b){e.altBubbles=b[0].liveAndInside,e.nearbyBubbles=b[0].live,null!=b[0].liveAndInside[0]?b[0].liveAndInside[0].id?(a.path("w/"+b[0].liveAndInside[0].id),m.addAlert("success","You found a bubble! Explore it below",!0)):j(c,f):(j(c,f),m.addAlert("info","No Bubbles here, but there are some nearby!",!0))})}function j(a,c){k.setCenter([c,a+.012],14,b.aperture.state),b.showCreateNew=!0,angular.forEach(e.nearbyBubbles,function(a){a.lat&&a.lng&&k.addMarker(a._id,{lat:a.lat,lng:a.lng,draggable:!1,message:'<a href="#/w/'+a.id+'">'+a.name+"</a>",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[13,10]}})})}var k=g;angular.extend(e,{loading:!0});var l=f;l.resetNavBG();var m=h;b.aperture=apertureService,b.aperture.set("off"),b.initGeo=function(){function a(a){var b=a.coords.latitude,c=a.coords.longitude;i(b,c)}function b(){}navigator.geolocation?navigator.geolocation.getCurrentPosition(a,b,{timeout:15e3,enableHighAccuracy:!0}):m("Your browser does not support geolocation :(")},b.initGeo(),b.addWorld=function(){a.path("/profile")}}]),L.AreaSelect=L.Class.extend({includes:L.Mixin.Events,options:{width:200,height:300,keepAspectRatio:!1},initialize:function(a){L.Util.setOptions(this,a),this.options.width>1e3||this.options.height>1e3?(this._width=this.options.width/8,this._height=this.options.height/8):(this._width=this.options.width,this._height=this.options.height)},addTo:function(a){return this.map=a,this._createElements(),this._render(),this},getBounds:function(){var a=this.map.getSize(),b=new L.Point,c=new L.Point;c.x=Math.round((a.x-this._width)/2),b.y=Math.round((a.y-this._height)/2),b.x=a.x-c.x,c.y=a.y-b.y;var d=this.map.containerPointToLatLng(c),e=this.map.containerPointToLatLng(b);return new L.LatLngBounds(d,e)},remove:function(){this.map.off("moveend",this._onMapChange),this.map.off("zoomend",this._onMapChange),this.map.off("resize",this._onMapResize),this._container.remove()},_createElements:function(){this._container||(this._container=L.DomUtil.create("div","leaflet-areaselect-container",this.map._controlContainer),this._topShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._bottomShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._leftShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._rightShade=L.DomUtil.create("div","leaflet-areaselect-shade",this._container),this._nwHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._swHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._neHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._seHandle=L.DomUtil.create("div","leaflet-areaselect-handle",this._container),this._setUpHandlerEvents(this._nwHandle),this._setUpHandlerEvents(this._neHandle,-1,1),this._setUpHandlerEvents(this._swHandle,1,-1),this._setUpHandlerEvents(this._seHandle,-1,-1),this.map.on("moveend",this._onMapChange,this),this.map.on("zoomend",this._onMapChange,this),this.map.on("resize",this._onMapResize,this),this.fire("change"))},_setUpHandlerEvents:function(a,b,c){function d(f){function g(a){if(e.options.keepAspectRatio){var d=(e._height>=e._width?l.y:l.y*(1/k))-30;e._height+=2*(j-a.originalEvent.y)*c,e._height=Math.max(30,e._height),e._height=Math.min(d,e._height),e._width=e._height*k}else e._width+=2*(i-a.originalEvent.x)*b,e._height+=2*(j-a.originalEvent.y)*c,e._width=Math.max(30,e._width),e._height=Math.max(30,e._height),e._width=Math.min(l.x-30,e._width),e._height=Math.min(l.y-30,e._height);i=a.originalEvent.x,j=a.originalEvent.y,e._render()}function h(){L.DomEvent.removeListener(e.map,"mouseup",h),L.DomEvent.removeListener(e.map,"mousemove",g),L.DomEvent.addListener(a,"mousedown",d),e.fire("change")}f.stopPropagation(),L.DomEvent.removeListener(this,"mousedown",d);var i=f.x,j=f.y,k=e._width/e._height,l=e.map.getSize();L.DomEvent.addListener(e.map,"mousemove",g),L.DomEvent.addListener(e.map,"mouseup",h)}b=b||1,c=c||1;var e=this;L.DomEvent.addListener(a,"mousedown",d)},_onMapResize:function(){this._render()},_onMapChange:function(){this.fire("change")},_render:function(){function a(a,b){a.style.width=b.width+"px",a.style.height=b.height+"px",a.style.top=b.top+"px",a.style.left=b.left+"px",a.style.bottom=b.bottom+"px",a.style.right=b.right+"px"}var b=this.map.getSize(),c=Math.round(this._nwHandle.offsetWidth/2),d=Math.round((b.y-this._height)/2),e=Math.round((b.x-this._width)/2);a(this._topShade,{width:b.x,height:d,top:0,left:0}),a(this._bottomShade,{width:b.x,height:d,bottom:0,left:0}),a(this._leftShade,{width:e,height:b.y-2*d,top:d,left:0}),a(this._rightShade,{width:e,height:b.y-2*d,top:d,right:0}),a(this._nwHandle,{left:e-c,top:d-7}),a(this._neHandle,{right:e-c,top:d-7}),a(this._swHandle,{left:e-c,bottom:d-7}),a(this._seHandle,{right:e-c,bottom:d-7})}}),L.areaSelect=function(a){return new L.AreaSelect(a)};var res;angular.module("tidepoolsServices",["ngResource"]).factory("Landmark",["$resource","$http",function(a){var b={count:{method:"PUT",params:{_id:"count"},server:!0},distinct:{method:"PUT",params:{_id:"distinct"},server:!0},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},del:{method:"DELETE",params:{_id:"del"},isArray:!1,server:!0},get:{method:"GET",server:!0}};return res=a("/api/landmarks/:_id:id",{},b)}]).factory("World",["$resource","$http","leafletData",function(a){var b={count:{method:"PUT",params:{_id:"count"},server:!0},distinct:{method:"PUT",params:{_id:"distinct"},server:!0},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},del:{method:"DELETE",params:{_id:"del"},isArray:!0,server:!0},get:{method:"GET",server:!0}};return res=a("/api/worlds/:_id:id",{},b)}]).factory("db",["$resource","$http",function(a){var b={count:{method:"PUT",params:{_id:"count",server:!0}},distinct:{method:"PUT",params:{_id:"distinct",server:!0}},find:{method:"PUT",params:{_id:"find"},isArray:!0,server:!0},group:{method:"PUT",params:{_id:"group"},isArray:!0,server:!0},mapReduce:{method:"PUT",params:{_id:"mapReduce"},isArray:!0,server:!0},aggregate:{method:"PUT",params:{_id:"aggregate"},isArray:!0,server:!0},create:{method:"POST",params:{_id:"create"},isArray:!0,server:!0},locsearch:{method:"GET",params:{_id:"locsearch"},isArray:!0,server:!0},query:{method:"GET",isArray:!0,server:!0}},c={};return c.worlds=a("/api/worlds/:_id",{},b),c.landmarks=a("/api/landmarks/:_id:id",{},b),c.styles=a("/api/styles/:_id",{},b),c.projects=a("/api/projects/:_id",{},b),c.tweets=a("/api/tweets/:_id",{},b),c.instagrams=a("/api/instagrams/:_id",{},b),c.messages=a("/api/worldchat/:_id",{},b),c.visit=a("/api/visit/:_id",{},b),c}]).factory("apertureService",["leafletData","mapManager",function(a,b){var c={off:!0,state:"aperture-off",navfix:"navfix"},d=b;return c.toggle=function(a){"aperture-full"!=c.state?(c.off=!1,c.navfix="","half"==a&&c.set("half"),"full"==a&&c.set("full")):(c.off=!0,c.state="aperture-off",c.navfix="navfix")},c.set=function(a){switch(a){case"off":"aperture-off"!=c.state&&(c.off=!0,c.state="aperture-off",c.navfix="navfix",d.apertureUpdate("aperture-off"));break;case"third":"aperture-third"!=c.state&&(c.off=!1,c.state="aperture-third",c.navfix="",d.apertureUpdate("aperture-third"));break;case"half":"aperture-half"!=c.state&&(c.off=!1,c.state="aperture-half",c.navfix="",d.apertureUpdate("aperture-half"));break;case"full":"aperture-full"!=c.state&&(c.off=!1,c.state="aperture-full",c.navfix="",d.apertureUpdate("aperture-full"))}},c}]).factory("socket",function(a){var b=io.connect();return{on:function(c,d){b.on(c,function(){var c=arguments;a.$apply(function(){d.apply(b,c)})})},emit:function(c,d,e){b.emit(c,d,function(){var c=arguments;a.$apply(function(){e&&e.apply(b,c)})})}}}),app.factory("alertManager",["$timeout",function(a){var b={list:[]};return b.addAlert=function(c,d,e){var f;switch(c){case"success":f="alert-success";break;case"info":f="alert-info";break;case"warning":f="alert-warning";break;case"danger":f="alert-danger"}var g=b.list.push({"class":f,msg:d,id:d});e&&a(function(){b.list.splice(g-1,1)},1500)},b.closeAlert=function(a){b.list.splice(a,1)},b.notify=function(a){b.list.push(a)},b}]),app.factory("bubbleTypeService",[function(){function a(a){c=a}function b(){return c}var c;return{set:a,get:b}}]),angular.module("tidepoolsServices").factory("dialogs",["$rootScope","$compile",function(){var a={dialogTemplate:null};return a.showDialog=function(b){a.template="templates/"+b,a.show=!0},a.close=function(b){(b.target.className.indexOf("dialog-bg")>-1||b.target.className.indexOf("closeElement")>-1)&&(a.show=!1)},a}]),angular.module("tidepoolsServices").factory("geoService",["$q","alertManager",function(a){var b={location:{},inProgress:!1,requestQueue:[]};
return b.getLocation=function(){function c(a){b.location.lat=a.coords.latitude,b.location.lng=a.coords.longitude,b.location.timestamp=Date.now(),b.resolveQueue({lat:a.coords.latitude,lng:a.coords.longitude})}function d(a){b.resolveQueue({err:a.code})}var e=a.defer();return b.requestQueue.push(e),b.inProgress||(navigator.geolocation?(b.inProgress=!0,navigator.geolocation.getCurrentPosition(c,d)):alerts.addAlert("warning","Your browser does not support location services.")),e.promise},b.resolveQueue=function(a){for(;b.requestQueue.length>0;){var c=b.requestQueue.pop();a.err?c.reject(a.err):c.resolve(a)}b.inProgress=!1},b}]),angular.module("tidepoolsServices").factory("ifGlobals",[function(){var a={kinds:{Convention:{name:"Convention",hasTime:!0,img:"convention.png",icon:"convention.svg"},Event:{name:"Event",hasTime:!0,img:"event.png",icon:"event.svg"},Neighborhood:{name:"Neighborhood",hasTime:!1,img:"neighborhood.png",icon:"neighborhood.svg"},Venue:{name:"Venue",hasTime:!1,img:"venue.png",icon:"venue.svg"},Park:{name:"Park",hasTime:!1,img:"park.png",icon:"park.svg"},Retail:{name:"Retail",hasTime:!1,img:"retail.png",icon:"retail.svg"},Campus:{name:"Campus",hasTime:!1,img:"campus.png",icon:"campus.svg"},Home:{name:"Home",hasTime:!1,img:"home.png",icon:"home.svg"},Other:{name:"Other",hasTime:!0,img:"other.png"}},stickers:{Favorite:{name:"Favorite",img:"img/stickers/favorite.png",iconInfo:{iconUrl:"img/stickers/favorite.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},FixThis:{name:"Fix This",img:"img/stickers/fixthis.png",iconInfo:{iconUrl:"img/stickers/fixthis.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},Food:{name:"Food",img:"img/stickers/food.png",iconInfo:{iconUrl:"img/stickers/food.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},ImHere:{name:"I'm Here",img:"img/stickers/im_here.png",iconInfo:{iconUrl:"img/stickers/im_here.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},Interesting:{name:"Interesting",img:"img/stickers/interesting.png",iconInfo:{iconUrl:"img/stickers/interesting.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}},WereHere:{name:"We're Here",img:"img/stickers/were_here.png",iconInfo:{iconUrl:"img/stickers/were_here.png",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]}}},mapThemes:{arabesque:{name:"Arabesque",cloudMapName:"arabesque",cloudMapID:"interfacefoundry.ig67e7eb",img:"img/mapbox/arabesque_small.png"},fairy:{name:"Fairy",cloudMapName:"fairy",cloudMapID:"interfacefoundry.ig9jd86b",img:"img/mapbox/fairy_small.png"},sunset:{name:"Sunset",cloudMapName:"sunset",cloudMapID:"interfacefoundry.ig6f6j6e",img:"img/mapbox/sunset_small.png"},urban:{name:"Urban",cloudMapName:"urban",cloudMapID:"interfacefoundry.ig6a7dkn",img:"img/mapbox/urban_small.png"},haze:{name:"Haze",cloudMapName:"purple haze",cloudMapID:"interfacefoundry.ig1oichl",img:"img/mapbox/haze_small.png"},mimis:{name:"Mimis",cloudMapName:"mimis",cloudMapID:"interfacefoundry.b28f1c55",img:"img/mapbox/mimis_small.png"}}};return a.getBasicHeader=function(){var b=a.username+":"+a.password,c=window.btoa(b);return"Basic "+c},a}]),angular.module("tidepoolsServices").factory("mapManager",["leafletData","$rootScope","bubbleTypeService",function(a,b,c){function d(){a.getMap().then(function(a){setTimeout(function(){a.invalidateSize()},400)})}var e={center:{lat:42,lng:-83,zoom:14},markers:{},layers:{baselayers:{baseMap:{name:"Urban",url:"https://{s}.tiles.mapbox.com/v3/interfacefoundry.ig6a7dkn/{z}/{x}/{y}.png",type:"xyz",top:!0,maxZoom:23,maxNativeZoom:23}},overlays:{}},paths:{},maxbounds:{},defaults:{controls:{layers:{visible:!1,position:"bottomright",collapsed:!0}},zoomControlPosition:"bottomleft"}};return e.setCenter=function(a,b,c){switch(e._actualCenter=a,e._z=b,c){case"aperture-half":e.setCenterWithAperture(a,b,0,.25);break;case"aperture-third":e.setCenterWithAperture(a,b,0,.35);break;case"editor":e.setCenterWithAperture(a,b,-.2,0);break;default:angular.extend(e.center,{lat:a[1],lng:a[0],zoom:b}),e.refresh()}},e.setCenterWithAperture=function(b,c,d,f){var g,h,i=Math.max(document.documentElement.clientHeight,window.innerHeight||0),j=Math.max(document.documentElement.clientWidth,window.innerWidth||0);a.getMap().then(function(a){g=a.project([b[1],b[0]],c).add([j*d,i*f-34]),h=a.unproject(g,c),angular.extend(e.center,{lat:h.lat,lng:h.lng,zoom:c}),e.refresh()})},e.setCenterWithFixedAperture=function(b,c,d,f){var g,h,i,j,k=Math.max(document.documentElement.clientHeight,window.innerHeight||0),l=Math.max(document.documentElement.clientWidth,window.innerWidth||0);i=d?l/2-d/2:0,j=f?k/2-f/2-30:-30,a.getMap().then(function(a){g=a.project([b[1],b[0]],c).add([i,j]),h=a.unproject(g,c),angular.extend(e.center,{lat:h.lat,lng:h.lng,zoom:c}),e.refresh()})},e.apertureUpdate=function(a){e._actualCenter&&e._z&&e.setCenter(e._actualCenter,e._z,a)},e.setCenterFromMarkers=function(b){function c(a){return[a.lat,a.lng]}a.getMap().then(function(a){a.fitBounds(L.latLngBounds(b.map(c)),{maxZoom:20})})},e.resetMap=function(){e.removeAllMarkers(),e.removeAllPaths(),e.removeOverlays(),e.removeCircleMask(),e.removePlaceImage(),e.refresh()},e.addMarker=function(a,b,c){if(e.markers.hasOwnProperty(a)){if(1==c)return!1;e.markers[a]=b}else e.markers[a]=b;return!0},e.addMarkers=function(a){_.isArray(a)?angular.extend(e.markers,_.indexBy(a,function(a){return a._id})):angular.extend(e.markers,a)},e.getMarker=function(a){return e.markers.hasOwnProperty(a)?e.markers[a]:!1},e.removeMarker=function(a){return e.markers.hasOwnProperty(a)?(delete e.markers[a],!0):!1},e.removeAllMarkers=function(){e.markers={}},e.setMarkers=function(a){e.markers=_.isArray(a)?_.indexBy(a,function(a){return a._id}):a},e.setMarkerMessage=function(a,b){return e.markers.hasOwnProperty(a)?(angular.extend(e.markers[a],{message:b}),!0):!1},e.setMarkerFocus=function(a){return e.markers.hasOwnProperty(a)?(angular.forEach(e.markers,function(a){a.focus=!1}),e.markers[a].focus=!0,!0):!1},e.setMarkerSelected=function(a){return angular.forEach(e.markers,function(a){"Retail"!==c.get()&&(a.icon.iconUrl="img/marker/bubble-marker-50.png")}),e.markers.hasOwnProperty(a)?(("Retail"!==c.get()||"img/marker/bubble-marker-50.png"===e.markers[a].icon.iconUrl)&&(e.markers[a].icon.iconUrl="img/marker/bubble-marker-50_selected.png"),!0):!1},e.setNewIcon=function(a){e.markers[a._id].icon.iconUrl=a.avatar,e.markers[a._id].icon.iconAnchor=[25,25],e.markers[a._id].icon.iconSize=[50,50]},e.bringMarkerToFront=function(a){return angular.forEach(e.markers,function(a){a.zIndexOffset=0}),e.markers.hasOwnProperty(a)?(e.markers[a].zIndexOffset=1e3,!0):!1},e.addPath=function(a,b,c){return e.paths.hasOwnProperty(a)&&1==c?!1:(e.paths[a]=b,e.paths[a])},e.removeAllPaths=function(){e.paths={}},e.setTiles=function(a){angular.extend(e.tiles,tilesDict[a]),d()},e.setMaxBounds=function(b,c){a.getMap().then(function(a){a.setMaxBounds([[b[0],b[1]],[c[0],c[1]]]),e.refresh()})},e.setMaxBoundsFromPoint=function(b,c){return a.getMap().then(function(a){setTimeout(function(){a.setMaxBounds([[b[0]-c,b[1]-c],[b[0]+c,b[1]+c]])},400),e.refresh()}),!0},e.refresh=function(){d()},e.setBaseLayer=function(a){e.layers.baselayers={},e.layers.baselayers[a]={name:"newBaseMap",url:a,type:"xyz",layerParams:{},layerOptions:{minZoom:1,maxZoom:23}}},e.findZoomLevel=function(a){if(a){var b=_.chain(a).map(function(a){return a.localMapOptions?a.localMapOptions.minZoom:void 0}).filter(function(a){return a}).value(),c=_.isEmpty(b)?null:_.min(b);return c}},e.setBaseLayerFromID=function(a){e.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+a+"/{z}/{x}/{y}.png")},e.findMapFromArray=function(a){var b=_.chain(a).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).value();return b=b.filter(function(a){return a.floor_num===b[0].floor_num})},e.addOverlay=function(a,b,c){c.zIndex=10,e.layers.overlays[b]={name:b,type:"xyz",url:"https://bubbl.io/maps/"+a+"/{z}/{x}/{y}.png",layerOptions:c,visible:!0,opacity:.8}},e.removeOverlays=function(){e.layers.overlays={},e.refresh()},e.addCircleMaskToMarker=function(c,d,f){e.circleMaskLayer=new L.IFCircleMask(e.markers[c],120,f),a.getMap().then(function(a){a.addLayer(e.circleMaskLayer),e._cMLdereg=b.$on("leafletDirectiveMarker.dragend",function(){e.circleMaskLayer._draw()})})},e.localMapArrayExists=function(a){return a&&a.style&&a.style.maps&&a.style.maps.localMapArray&&a.style.maps.localMapArray.length>0},e.filterToCurrentFloor=function(a,b){return a.filter(function(a){return a.floor_num===b})},e.sortFloors=function(a){return _.chain(a).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).value()},e.setCircleMaskState=function(a){e.circleMaskLayer&&e.circleMaskLayer._setState(a)},e.setCircleMaskMarker=function(a){e.circleMaskLayer&&e.circleMaskLayer._setMarker(e.markers[a])},e.removeCircleMask=function(){var b=e.circleMaskLayer;e.circleMaskLayer&&a.getMap().then(function(a){a.removeLayer(b),e._cMLdereg()})},e.placeImage=function(b,c){return e.placeImageLayer=new L.IFPlaceImage(c,e.markers[b]),a.getMap().then(function(a){a.addLayer(e.placeImageLayer)}),function(a){e.placeImageLayer.setScale(a)}},e.setPlaceImageScale=function(a){e.placeImageLayer.setScale(a)},e.removePlaceImage=function(){e.placeImageLayer&&a.getMap().then(function(a){a.removeLayer(e.placeImageLayer)})},e.getPlaceImageBounds=function(){return e.placeImageLayer?e.placeImageLayer.getBounds():void 0},e.fadeMarkers=function(b){a.getMap().then(function(a){var c=a.getContainer();b===!0?c.classList.add("fadeMarkers"):c.classList.remove("fadeMarkers")})},e.hasMarker=function(a){return e.markers.hasOwnProperty(a)},e.loadBubble=function(a,b){var c=18,b=b||{};a.hasOwnProperty("loc")&&a.loc.hasOwnProperty("coordinates")&&(b.center&&e.setCenter([a.loc.coordinates[0],a.loc.coordinates[1]],c,apertureService.state),b.marker&&e.addMarker("c",{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+a.id+'/">'+a.name+"</a>"})),a.style.hasOwnProperty("maps")&&(a.style.maps.localMapID&&e.addOverlay(a.style.maps.localMapID,a.style.maps.localMapName,a.style.maps.localMapOptions),a.style.maps.hasOwnProperty("localMapOptions")&&(c=a.style.maps.localMapOptions.maxZoom||19),e.setBaseLayer(tilesDict.hasOwnProperty(a.style.maps.cloudMapName)?tilesDict[a.style.maps.cloudMapName].url:a.style.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+a.style.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"))},e}]),angular.module("tidepoolsServices").factory("beaconManager",["alertManager","$interval","$timeout","beaconData",function(){var a={supported:!1};return a}]),angular.module("tidepoolsServices").factory("beaconData",[function(){var a={beaconTree:{"E3CA511F-B1F1-4AA6-A0F4-32081FBDD40D":{28040:{title:"Main Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Body"},28041:{title:"Main Room B",href:"w/Creative_Technologies_2014/BubblBot_s_Antenna"},28042:{title:"Workshop Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Legs/"},28043:{title:"Workshop Room B",href:"w/Creative_Technologies_2014/BubblBot_s_Arms/"},14163:{title:"Main Room A",href:"w/Creative_Technologies_2014/BubblBot_s_Body/"}},"B9407F30-F5F8-466E-AFF9-25556B57FE6D":{62861:{title:"Ross's Random Beacon"}}}};return a.fromBeacon=function(b){return a.beaconTree[b.proximityUUID][b.major]},a}]),angular.module("tidepoolsServices").factory("lockerManager",["$q",function(){var a={supported:!1};return a}]),app.factory("stickerManager",["$http","$q",function(a,b){var c={};return c.postSticker=function(c){var d=b.defer();return a.post("/api/stickers/create",c,{server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c.getStickers=function(c){var d=b.defer();return a.get("/api/stickers/",{params:{worldID:c._id},server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c.getSticker=function(c){var d=b.defer();return a.get("/api/stickers/"+c,{server:!0}).success(function(a){d.resolve(a)}).error(function(a){d.reject(a)}),d.promise},c}]),angular.module("tidepoolsServices").factory("styleManager",[function(){var a={navBG_color:"rgba(62, 82, 181, 0.96)"};return a.resetNavBG=function(){a.navBG_color="rgba(62, 82, 181, 0.96)"},a}]),angular.module("tidepoolsServices").factory("userGrouping",[function(){var a={};return a.groupByTime=function(a){for(var b,c={places:{label:"Places",bubbles:[],order:10},today:{label:"Today",bubbles:[],order:6},thisWeek:{label:"This Week",bubbles:[],order:5},thisMonth:{label:"This Month",bubbles:[],order:4},nextMonths:{label:"Next Few Months",bubbles:[],order:3},thisYear:{label:"This Year",bubbles:[],order:2},future:{label:"Future",bubbles:[],order:1},lastWeek:{label:"Last Week",bubbles:[],order:7},lastMonth:{label:"Last Month",bubbles:[],order:8},past:{label:"Past",bubbles:[],order:9}},d=moment(),e=0;e<a.length;e++){var f,b=a[e];if(b.time.start)var f=moment(b.time.start);else f=void 0;f?f.isSame(d,"day")?c.today.bubbles.push(b):f.isAfter(d)?f.isSame(d,"week")?c.thisWeek.bubbles.push(b):f.isSame(d,"month")?c.thisMonth.bubbles.push(b):f.isBefore(d.add(3,"months"))?c.nextMonths.bubbles.push(b):f.isSame(d,"year")?c.thisYear.bubbles.push(b):c.future.bubbles.push(b):f.isBefore(d)&&(f.isAfter(d.subtract(1,"week"))?c.lastWeek.bubbles.push(b):f.isAfter(d.subtract(1,"month"))?c.lastMonth.bubbles.push(b):c.past.bubbles.push(b)):c.places.bubbles.push(b)}angular.forEach(c,function(a,b){"places"==b||a.bubbles.length>1&&a.bubbles.sort(function(a,b){return moment(a.time.start).isBefore(b.time.start)?-1:1})});var g=Object.keys(c).map(function(a){return c[a]}).filter(function(a){return a.bubbles.length>0}).sort(function(a,b){return a.order-b.order});return g},a.groupForCalendar=function(a){return a.filter(function(a){return a.time.start}).map(function(a){return{id:a._id,title:a.name,start:a.time.start,end:a.time.end,bubble:a}})},a}]),angular.module("tidepoolsServices").factory("userManager",["$rootScope","$http","$resource","$q","$location","dialogs","alertManager","lockerManager","ifGlobals","worldTree",function(a,b,c,d,e,f,g,h,i,j){var k=g,l={userRes:c("/api/updateuser"),loginStatus:!1,login:{},signup:{}};return l.getUser=function(){var a=d.defer(),c=l._user;return c?a.resolve(c):b.get("/api/user/loggedin",{server:!0}).success(function(b){b&&0!=b?(l._user=b,a.resolve(b)):a.reject(0)}).error(function(b){a.reject(b)}),a.promise},l.saveUser=function(a){l.userRes.save(a,function(){l._user=a})},l.getDisplayName=function(){if(l._user){var a=l._user;displayName=a.name?a.name:a.facebook&&a.facebook.name?a.facebook.name:a.twitter&&a.twitter.displayName?a.twitter.displayName:a.meetup&&a.meetup.displayName?a.meetup.displayName:a.local&&a.local.email?a.local.email.substring(0,a.local.email.indexOf("@")):"Me";var b=displayName.indexOf(" ");if(b>-1)var c=displayName.substring(0,b);else var c=displayName;return c}return void 0},l.checkLogin=function(){var b=d.defer();return l.getUser().then(function(c){l.loginStatus=!0,a.user=c,c._id&&(a.userID=c._id,l._user=c),j.getUserWorlds(),b.resolve(1)},function(a){l.loginStatus=!1,b.reject(0)}),a.$broadcast("loginSuccess"),b.promise},l.signin=function(a,c){var e=d.defer(),f={email:a,password:c};return b.post("/api/user/login",f,{server:!0}).success(function(a){l.loginStatus=!0,e.resolve(a)}).error(function(a,b,c,d){e.reject(a)}),e.promise},l.fbLogin=function(){var a=d.defer();return facebookConnectPlugin.login(["public_profile","email"],function(c){var d=c.authResponse.accessToken,e="Bearer "+d;b.get("/auth/bearer",{server:!0,headers:{Authorization:e}}).then(function(b){h.saveFBToken(d),i.fbToken=d,a.resolve(b)},function(b){a.reject(b)})},function(b){k.addAlert("warning","Please allow access to Facebook!",!0),a.reject(b)}),a.promise},l.logout=function(){b.get("/api/user/logout",{server:!0}),l.loginStatus=!1,e.path("/"),k.addAlert("success","You're signed out!",!0)},l.login.login=function(){var a={email:l.login.email,password:l.login.password};l.signin(a.email,a.password).then(function(a){l.checkLogin(),k.addAlert("success","You're signed in!",!0),l.login.error=!1,f.show=!1},function(a){l.login.error=!0})},l.signup.signup=function(){var a={email:l.signup.email,password:l.signup.password};b.post("/api/user/signup",a,{server:!0}).success(function(){f.show=!1,l.checkLogin(),g.addAlert("success","You're logged in!",!0),l.signup.error=void 0}).error(function(a){a&&(l.signup.error="Error signing up!",g.addAlert("danger",a,!0))})},l.saveToKeychain=function(){h.saveCredentials(l.login.email,l.login.password)},l}]),angular.module("tidepoolsServices").factory("worldTree",["$cacheFactory","$q","World","db","geoService","$http","$location","alertManager","bubbleTypeService",function(a,b,c,d,e,f,g,h,i){var j={worldCache:a("worlds"),styleCache:a("styles"),landmarkCache:a("landmarks")};return j.getWorld=function(a){function d(){c.get({id:a},function(a){a.err?e.reject(a.err):(j.worldCache.put(a.world.id,a.world),j.styleCache.put(a.style._id,a.style),e.resolve(a),i.set(a.world.category))})}var e=b.defer(),f=j.worldCache.get(a);if(f&&f.style){i.set(f.category);var g=j.styleCache.get(f.style.styleID);g?e.resolve({world:f,style:g}):d()}else d();return e.promise},j.getLandmarks=function(a){var c=b.defer(),d=j.landmarkCache.get(a);return d?c.resolve(d):f.get("/api/landmarks",{params:{parentID:a},server:!0}).success(function(a){c.resolve(a.landmarks)}).error(function(a){c.resolve(a)}),c.promise},j.getLandmark=function(a,c){var d,e=b.defer();return j.getLandmarks(a).then(function(a){d=a.find(function(a){return a.id===c}),d?e.resolve(d):e.reject("Landmark not found")}),e.promise},j.getUpcoming=function(a){var c=new Date,e={},f=b.defer();return d.landmarks.query({queryFilter:"upcoming",parentID:a,userTime:c},function(b){e.upcomingIDs=b,d.landmarks.query({queryFilter:"now",parentID:a,userTime:c},function(a){e.nowID=a[0],f.resolve(e)},function(a){f.reject(a)})},function(a){f.reject(a)}),f.promise},j.getNearby=function(){var a=b.defer(),c=Date.now()/1e3;return j._nearby&&j._nearby.timestamp+30>c?a.resolve(j._nearby):e.getLocation().then(function(b){d.worlds.query({localTime:new Date,userCoordinate:[b.lng,b.lat]},function(b){j._nearby=b[0],j._nearby.timestamp=c,a.resolve(b[0]),j.cacheWorlds(b[0]["150m"]),j.cacheWorlds(b[0]["2.5km"])})},function(b){a.reject(b)}),a.promise},j.cacheWorlds=function(a){a&&a.forEach(function(a){j.worldCache.put(a.id,a)})},j.getUserWorlds=function(a){var c=Date.now()/1e3;return a?void 0:j._userWorlds&&j._userWorlds.timestamp+60>c?b.when(j._userWorlds):f.get("/api/user/profile",{server:!0}).success(function(a){j._userWorlds=a,j._userWorlds.timestamp=c,j.cacheWorlds(a)})},j.createWorld=function(){var a={newStatus:!0};d.worlds.create(a,function(a){g.path("/edit/walkthrough/"+a[0].worldID)})},j}]);var themeDict={urban:{name:"urban",bodyBG_color:"#80DEEA",cardBG_color:"#FFFFFF",titleBG_color:"#00BCD4",navBG_color:"rgba(0, 172, 193, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#304FFE",categoryTitle_color:"#536DFE"},sunset:{name:"sunset",bodyBG_color:"#FFE0B2",cardBG_color:"#FFFFFF",titleBG_color:"#FF9800",navBG_color:"rgba(245, 124, 0, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF4081",categoryTitle_color:"#F48FB1"},fairy:{name:"fairy",bodyBG_color:"#7E57C2",cardBG_color:"#FFFFFF",titleBG_color:"#673AB7",navBG_color:"rgba(81, 45, 168, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF5722",categoryTitle_color:"#D1C4E9"},arabesque:{name:"arabesque",bodyBG_color:"#C5CAE9",cardBG_color:"#FFFFFF",titleBG_color:"#3F51B5",navBG_color:"rgba(57, 73, 171, 0.8)",worldTitle_color:"#FFF",landmarkTitle_color:"#FF4081",categoryTitle_color:"#F48FB1"},haze:{name:"haze",bodyBG_color:"#000830",cardBG_color:"#FFFFFF",titleBG_color:"#2c22cf",navBG_color:"#2c22cf",worldTitle_color:"#FFF",landmarkTitle_color:"#6ff4ff",categoryTitle_color:"#6ff4ff"}};app.controller("TweetlistCtrl",["$location","$scope","db","$rootScope","$routeParams","apertureService",function(a,b,c,d,e,f){d.showSwitch=!1;var g=f;g.set("off"),b.currentTag=e.hashTag,b.tweets=c.tweets.query({limit:60,tag:b.currentTag}),b.tagSearch=function(){var a=b.searchText.replace("#","");b.tweets=c.tweets.query({tag:a})},b.goBack=function(){window.history.back()}}]),app.controller("InstalistCtrl",["$location","$scope","db","$rootScope","$routeParams","apertureService",function(a,b,c,d,e,f){var g=f;g.set("off"),d.showSwitch=!1,b.currentTag=e.hashTag,b.instagrams=c.instagrams.query({limit:30,tag:b.currentTag}),b.goBack=function(){window.history.back()}}]),TalktagCtrl.$inject=["$location","$scope","$routeParams","db","$rootScope"],MenuCtrl.$inject=["$location","$scope","db","$routeParams","$rootScope"],ListCtrl.$inject=["$location","$scope","db","$routeParams","$rootScope"],WorldViewCtrl.$inject=["World","$routeParams","$scope","db","$location","$timeout","leafletData","$route","$rootScope"],LandmarkViewCtrl.$inject=["Landmark","$routeParams","$scope","db","$location","$timeout","leafletData","$route","$rootScope","$sce"],AwardsCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],LecturesCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],ShowCtrl.$inject=["$location","$scope","db","$timeout","leafletData","$rootScope"],app.directive("drawer",["worldTree","$rootScope","$routeParams","userManager","dialogs",function(a,b,c,d,e){return{restrict:"EA",scope:!0,link:function(f,g){f._currentBubble=!1,b.$on("toggleDrawer",function(){f.drawerOn=!f.drawerOn}),f.$on("$routeChangeSuccess",function(){f._currentBubble=!1,f.shareAvailable=c.worldURL?!0:!1}),f.$watch("drawerOn",function(a){a===!0?g.addClass("drawer"):g.removeClass("drawer")}),f.currentBubble=function(){return!f._currentBubble&&c.worldURL&&(f._currentBubble=a.worldCache.get(c.worldURL)),f._currentBubble},f.avatar=function(){try{return d._user.avatar}catch(a){return void 0}},f.username=function(){return d.getDisplayName()},f.userBubbles=function(){return a._userWorlds},f.editAvailable=function(){try{return f.currentBubble().permissions.ownerID===d._user._id}catch(a){return!1}},f.closeDrawer=function(){f.drawerOn=!1},f.shareDialog=function(){e.showDialog("shareDialog.html")},f.create=a.createWorld,f.feedback=function(){e.showDialog("feedbackDialog.html")},f.logout=d.logout},templateUrl:"components/drawer/drawer.html"}}]),app.controller("EditController",["$scope","db","World","$rootScope","$route","$routeParams","apertureService","mapManager","styleManager","alertManager","$upload","$http","$timeout","$interval","dialogs","$window","$location","$anchorScroll","ifGlobals",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){function t(){return Math.random().toString(36).replace(/[^a-z]+/g,"").substr(0,12)}function u(b){var c={worldID:a.world._id,map_marker_viewID:b.map_marker_viewID};l.post("/api/delete_map",c).success(function(b){a.world=b}).error(function(){})}function v(a){if(q.hash("scrollToBottom"),a){m(function(){r()},a)}}function w(){navigator.geolocation&&!a.world.hasLoc&&navigator.geolocation.getCurrentPosition(x,y,{timeout:15e3})}function x(b){userLat=b.coords.latitude,userLng=b.coords.longitude,A.setCenter([userLng,userLat],18,"editor"),F=t(),A.removeAllMarkers(),A.addMarker(F,{lat:userLat,lng:userLng,message:"<p style='color:black;'>Drag to Bubble Location</p>",focus:!0,draggable:!0,icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17.5,55],popupAnchor:[0,-40]}});var c;switch(a.view){case"details":c="mask";break;case"maps":c="mask";break;case"styles":c="cover"}A.circleMaskLayer?A.setCircleMaskMarker(F):A.addCircleMaskToMarker(F,100,c)}function y(){}var z=g,A=h,B=i,C=j,D=angular.element(".leaflet-bottom.leaflet-left")[0];D.style.top="50px",D.style.left="40%";var E=e.current;a.worldURL=f.worldURL,z.set("full"),a.mapThemeSelect="arabesque",a.kinds=[{name:"Convention"},{name:"Park"},{name:"Retail"},{name:"Venue"},{name:"Event"},{name:"Venue"},{name:"Campus"},{name:"Home"},{name:"Neighborhood"}],a.mapThemes=s.mapThemes;var F=t();a.temp={scale:1},l.get("/components/edit/edit.locale-en-us.json").success(function(b){a.locale=angular.fromJson(b),a.tooltips=a.locale.tooltips}),a.view=f.view?f.view:"details",a.initView=function(){switch(a.view){case"details":A.setCircleMaskState("mask");break;case"maps":A.setCircleMaskState("mask");break;case"styles":A.setCircleMaskState("cover")}},a.onWorldIconSelect=function(b){var c=b[0];a.upload=k.upload({url:"/api/upload/",file:c}).progress(function(){}).success(function(b){a.world.avatar=b,a.uploadFinished=!0})},a.onLandmarkCategoryIconSelect=function(b){var c=b[0];a.upload=k.upload({url:"/api/upload/",file:c}).progress(function(){}).success(function(b){a.temp.LandmarkCatAvatar=b,a.uploadFinishedLandmark=!0})},a.setUploadFinished=function(b,c){"world"==c&&(b?a.uploadFinished=!0:(a.uploadFinished=!1,a.world.avatar=null)),"landmark"==c&&(b?a.uploadFinishedLandmark=!0:(a.uploadFinishedLandmark=!1,a.temp.LandmarkCatAvatar=null))},a.onLocalMapSelect=function(b,c,d){if(0===c||"0"===c)C.addAlert("info","The floor number can't be 0",!0);else if(""==c)C.addAlert("info","Please enter a floor number",!0);else{var e=b[0];a.upload=k.upload({url:"/api/upload_maps",file:e}).progress(function(b){a.temp||(a.temp={}),a.temp.picProgress=parseInt(100*b.loaded/b.total)+"%"}).success(function(b){a.mapImage=b,A.placeImage(F,b);var e={worldID:a.world._id,map_marker_viewID:F,temp_upload_path:b,floor_num:c,floor_name:d};l.post("/api/temp_map_upload",e).success(function(b){a.world=b,a.selectLastMap()}).error(function(){})}),v(300)}},a.selectMapTheme=function(b){"string"==typeof name&&(a.mapThemeSelect=b,A.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+a.mapThemes[b].cloudMapID+"/{z}/{x}/{y}.png"),a.world.style.maps.cloudMapName=a.mapThemes[b].cloudMapName,a.world.style.maps.cloudMapID=a.mapThemes[b].cloudMapID,0==a.style.hasOwnProperty("navBG_color")&&a.setThemeFromMap())},a.setThemeFromMap=function(){switch(a.world.style.maps.cloudMapName){case"urban":angular.extend(a.style,themeDict.urban);break;case"sunset":angular.extend(a.style,themeDict.sunset);break;case"fairy":angular.extend(a.style,themeDict.fairy);break;case"arabesque":angular.extend(a.style,themeDict.arabesque);break;case"purple haze":angular.extend(a.style,themeDict.haze)}},a.addLandmarkCategory=function(){a.temp&&(a.world.landmarkCategories.unshift({name:a.temp.LandmarkCategory,avatar:a.temp.LandmarkCatAvatar,present:a.temp.landmarkPresent}),delete a.temp.LandmarkCatAvatar,delete a.temp.LandmarkCategory,a.temp.landmarkPresent=!1,a.uploadFinishedLandmark=!1)},a.removeLandmarkCategory=function(b){a.world.landmarkCategories.splice(b,1)},a.removeAllMaps=function(){A.removePlaceImage(),A.removeOverlays()},a.getHighestFloor=function(){var b=a.world.style.maps.localMapArray;return b=$.map(b,function(a){return a.floor_num}),Math.max.apply(this,b)},a.increaseFloor=function(b){a.mapIsUploaded(b)||b.floor_num++},a.decreaseFloor=function(b){a.mapIsUploaded(b)||b.floor_num--},a.mapIsUploaded=function(a){return a.temp_upload_path||a.localMapName},a.mapIsBuilt=function(b){if(b)return b.localMapName;if(a.world&&a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0){var c=a.world.style.maps.localMapArray.length;return a.world.style.maps.localMapArray[c-1].hasOwnProperty("localMapName")}return!0},a.selectMap=function(b){if(a.selectedMap=b,a.removeAllMaps(),""==b.temp_upload_path){m(function(){A.addOverlay(b.localMapID,b.localMapName,b.localMapOptions)},100)}else{m(function(){A.placeImage(b.map_marker_viewID,b.temp_upload_path)},100)}},a.selectLastMap=function(){var b=a.world.style.maps.localMapArray.length;a.selectMap(a.world.style.maps.localMapArray[b-1])},a.addMapPlaceholder=function(){a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0?a.world.style.maps.localMapArray.push({floor_num:a.getHighestFloor()+1,floor_name:"Floor "+(a.getHighestFloor()+1)}):a.world.style.maps.localMapArray=[{floor_num:1,floor_name:"Lobby"}],v(100),a.selectLastMap()},a.removeMap=function(b){window.confirm("Are you sure you want to delete this local map?")&&(a.mapIsUploaded(b)?u(b):a.world.style.maps.localMapArray.pop())},a.loadWorld=function(b){if(a.world=b.world,a.world.style.maps.localMapArray&&a.world.style.maps.localMapArray.length>0){var c=a.world.style.maps.localMapArray.length;""!=a.world.style.maps.localMapArray[c-1].temp_upload_path&&u(a.world.style.maps.localMapArray[c-1])}a.style=b.style,B.navBG_color=a.style.navBG_color,a.world.hasLoc?x({coords:{latitude:a.world.loc.coordinates[1],longitude:a.world.loc.coordinates[0]}}):w(),0==a.world.hasOwnProperty("style")&&(a.world.style={}),0==a.world.style.hasOwnProperty("maps")&&(a.world.style.maps={}),0==a.world.hasOwnProperty("landmarkCategories")&&(a.world.landmarkCategories=[]),a.world.style.maps.cloudMapName?(A.setBaseLayerFromID(a.world.style.maps.cloudMapID),a.mapThemeSelect=a.world.style.maps.cloudMapName):a.selectMapTheme("arabesque");var d=[a.world.style.maps];d[0].localMapArray&&d[0].localMapArray.length>0&&(d=A.findMapFromArray(d[0].localMapArray)),d.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&A.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)}),a.style.bodyBG_color||(a.style.bodyBG_color="#FFFFFF",a.style.cardBG_color="#FFFFFF")},a.saveWorld=function(){a.whenSaving=!0,a.world.newStatus=!1,a.world.hasLoc=!0,tempMarker=A.getMarker(F),a.world.loc.coordinates[0]=tempMarker.lng,a.world.loc.coordinates[1]=tempMarker.lat,void 0==typeof a.world.style.maps&&(a.world.style.maps={}),b.worlds.create(a.world,function(b){a.world.id=b[0].id,a.whenSaving=!1,C.addAlert("success",'Save successful! Go to <a class="alert-link" target="_blank" href="#/w/'+a.world.id+'">'+a.world.name+"</a>",!0),m.cancel(G)}),a.world.resources&&a.world.resources.hashtag&&(a.style.hashtag=a.world.resources.hashtag),a.world._id&&(a.style.world_id=a.world._id),b.styles.create(a.style,function(a){})},a.search=function(){var b=new google.maps.Geocoder;b&&b.geocode({address:a.searchText},function(a,b){b==google.maps.GeocoderStatus.OK&&x({coords:{latitude:a[0].geometry.location.lat(),longitude:a[0].geometry.location.lng()}})})},a.setStartTime=function(){var b=new Date;a.world.time.start=b.toISO8601String()},a.setEndTime=function(){var b=new Date;"string"==typeof a.world.time.start&&b.setISO8601(a.world.time.start),a.world.time.start instanceof Date&&(b=a.world.time.start),b.setUTCHours(b.getUTCHours()+3);var c=b;a.world.time.end=c.toISO8601String()},a.removePlaceImage=function(){a.mapImage=null,A.removePlaceImage()},a.buildLocalMap=function(){a.building=!0;var b=A.getPlaceImageBounds(),c=b.getSouthEast(),d=b.getNorthWest(),f=b.getSouthWest(),g=b.getNorthEast(),h={worldID:a.world._id,localMapID:a.world._id+"_"+F,nw_loc_lng:d.lng,nw_loc_lat:d.lat,sw_loc_lng:f.lng,sw_loc_lat:f.lat,ne_loc_lng:g.lng,ne_loc_lat:g.lat,se_loc_lng:c.lng,se_loc_lat:c.lat},i=JSON.stringify(h),j={mapIMG:a.mapImage,coords:i,map_marker_viewID:F};C.addAlert("warning","Building local map, this may take some time!",!0),l.post("/api/build_map",j).success(function(b){C.addAlert("success","Map built!",!0),a.world.hasOwnProperty("style")||(a.world.style={}),a.world.style.hasOwnProperty("maps")||(a.world.style.maps={}),a.world=b[0]?b[0]:b,a.building=!1,e.reload(),v(1e3)}).error(function(){a.building=!1})},a.$on("$locationChangeSuccess",function(){E.$$route.originalPath===e.current.$$route.originalPath&&(a.view=e.current.params.view,e.current=E),a.initView()}),a.$on("$destroy",function(b){b.targetScope===a&&(A.removeCircleMask(),A.removePlaceImage(),D.style&&(D.style.top="",D.style.left="")),angular.extend(d,{navTitle:"Bubbl.li"})}),a.$watch("style.navBG_color",function(a){B.navBG_color=a}),a.$watch("temp.scale",function(a,b){a!=b&&A.setPlaceImageScale(a)});var G=null;a.$watchCollection("world",function(b,c){void 0!=c&&(G&&m.cancel(G),G=m(a.saveWorld,1500))
}),c.get({id:f.worldURL},function(b){b.err||a.loadWorld(b),A.refresh()})}]),app.controller("LandmarkEditorController",["$scope","$rootScope","$location","$route","$routeParams","db","World","leafletData","apertureService","mapManager","Landmark","alertManager","$upload","$http","$window","dialogs","worldTree","bubbleTypeService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){function s(){var b={name:"Landmark "+(a.landmarks.length+1),_id:0,world:!1,newStatus:!0,parentID:0,loc:{type:"Point",coordinates:[-74.0059,40.7127]},avatar:"img/tidepools/default.jpg",time:{}};return v&&(b.parentID=a.world._id,b.loc.coordinates=a.world.loc.coordinates),b}var t=j,u=angular.element(".leaflet-bottom.leaflet-left")[0];u.style.top="50px",u.style.left="40%";var v=!1,w=!1;a.landmarks=[],a.selectedIndex=0,a.alerts=l,a.addLandmark=function(){if(v&&w){var b=s();f.landmarks.create(b,function(c){b._id=c[0]._id,a.landmarks.unshift(b);var d="img/marker/bubble-marker-50.png",e=[0,-50],f="";t.addMarker(b._id,{lat:b.loc.coordinates[1],lng:b.loc.coordinates[0],icon:{iconUrl:d,shadowUrl:f,iconSize:[50,95],iconAnchor:[25,100],popupAnchor:e},draggable:!0,message:"Drag to location on map",focus:!0})})}else;},a.removeItem=function(b){var c=confirm("Are you sure you want to delete this item?");c&&(t.removeMarker(a.landmarks[b]._id),k.del({_id:a.landmarks[b]._id},function(){a.landmarks.splice(b,1)}))},a.saveItem=function(b){a.landmarks[b].newStatus=!1;var c=t.getMarker(a.landmarks[b]._id);return 0==c?!1:(a.landmarks[b].loc.coordinates=[c.lng,c.lat],f.landmarks.create(a.landmarks[b],function(a){}),void a.alerts.addAlert("success","Landmark Saved",!0))},a.selectItem=function(b){a.selectedIndex!=b&&(a.selectedIndex=b,t.setCenter(a.landmarks[b].loc.coordinates,18),t.setMarkerMessage(a.landmarks[b]._id,a.landmarks[b].name),t.bringMarkerToFront(a.landmarks[b]._id),t.setMarkerSelected(a.landmarks[b]._id),t.setMarkerFocus(a.landmarks[b]._id))},a.addLandmarkMarker=function(a){var b="img/marker/bubble-marker-50.png",c=[0,-40],d="",e=[4,-3],f=[17,67],g=[35,67];"Retail"===r.get()&&"img/tidepools/default.jpg"!==a.avatar&&(b=a.avatar,c=[0,-14],f=[25,25],g=[50,50]),t.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:b,shadowUrl:d,shadowAnchor:e,iconSize:g,iconAnchor:f,popupAnchor:c},draggable:!0,message:a.name||"Drag to location on map",focus:!0})},a.$on("$destroy",function(b){b.targetScope===a&&(t.removeCircleMask(),u.style&&(u.style.top="",u.style.left=""))}),q.getWorld(e.worldURL).then(function(b){a.world=b.world,a.style=b.style,a.worldURL=e.worldURL,t.setCenter(a.world.loc.coordinates,18,"editor"),a.world.style&&a.world.style.maps&&t.setBaseLayerFromID(a.world.style.maps.cloudMapID),t.removeAllMarkers(),t.addMarker("m",{lat:a.world.loc.coordinates[1],lng:a.world.loc.coordinates[0],focus:!1,draggable:!1,icon:{iconUrl:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVQYV2NgYAAAAAMAAWgmWQ0AAAAASUVORK5CYII=",shadowUrl:"",iconSize:[0,0],shadowSize:[0,0],iconAnchor:[0,0],shadowAnchor:[0,0]}}),t.removeCircleMask(),t.addCircleMaskToMarker("m",150,"mask"),t.setMaxBoundsFromPoint([a.world.loc.coordinates[1],a.world.loc.coordinates[0]],.05);var c=[a.world.style.maps];c[0].localMapArray&&c[0].localMapArray.length>0&&(c=t.findMapFromArray(c[0].localMapArray)),c.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&t.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)}),a.world.style.maps.hasOwnProperty("localMapOptions")&&(zoomLevel=a.world.style.maps.localMapOptions.maxZoom||19),t.refresh(),v=!0,q.getLandmarks(b.world._id).then(function(b){a.landmarks=b,angular.forEach(a.landmarks,function(b){a.addLandmarkMarker(b)}),w=!0})})}]),app.controller("LandmarkEditorItemController",["$scope","db","Landmark","mapManager","$upload","bubbleTypeService","worldTree","$q","$log",function(a,b,c,d,e,f,g,h){function i(a){var b={};return b.val=a.floor_num,b.label=a.floor_name,b}function j(){if(d.localMapArrayExists(a.world)){var b=[],c=_.chain(a.world.style.maps.localMapArray).filter(function(a){return a.floor_num}).sortBy(function(a){return a.floor_num}).uniq(function(a){return a.floor_num}).value();c.forEach(function(a){b.push(i(a))}),a.$parent.floors=b}else a.$parent.floors=[{val:-1,label:"-1 Floor"},{val:1,label:"1st Floor"},{val:2,label:"2nd Floor"},{val:3,label:"3rd Floor"},{val:4,label:"4th Floor"},{val:5,label:"5th Floor"},{val:6,label:"6th Floor"},{val:7,label:"7th Floor"},{val:8,label:"8th Floor"},{val:9,label:"9th Floor"},{val:10,label:"10th Floor"}];a.$parent.landmark.loc_info||(a.$parent.landmark.loc_info={floor_num:1})}function k(b){var c=h.defer();return m(l(a.$parent.landmarks,b)).then(function(){c.resolve(!0)}),c.promise}function l(a,b){var c=_.chain(a).filter(function(a){return a.loc_info}).filter(function(a){return a.loc_info.floor_num===b}).value();return 1===b&&(c=c.concat(a.filter(function(a){return!a.loc_info}))),c}function m(b){var c=h.defer();return d.removeAllMarkers(),angular.forEach(b,function(b){a.$parent.addLandmarkMarker(b)}),c.resolve(!0),c.promise}a.time=!1,a.deleteLandmark=function(){a.$parent.removeItem(a.$index)},a.saveLandmark=function(){a.$parent.saveItem(a.$index)},a.selectLandmark=function(b){b!==a.$parent.selectedIndex&&a.updateFloor().then(function(){a.$parent.selectItem(a.$index)})},a.setStartTime=function(){var b=new Date;a.$parent.landmark.time.start=b.toISO8601String()},a.setEndTime=function(){var b=new Date;"string"==typeof a.$parent.landmark.time.start&&b.setISO8601(a.$parent.landmark.time.start),a.$parent.landmark.time.start instanceof Date&&(b=a.$parent.landmark.time.start),b.setUTCHours(b.getUTCHours()+3);var c=b;a.$parent.landmark.time.end=c.toISO8601String()},a.setLocation=function(){a.$parent.landmark.loc_info&&null==a.$parent.landmark.loc_info.floor_num&&(a.$parent.landmark.loc_info.floor_num=1),j()},a.$parent.landmark.loc_info&&j(),a.$on("leafletDirectiveMarker.dragend",function(a,b){d.markers[b.markerName].lat=b.leafletEvent.target._latlng.lat,d.markers[b.markerName].lng=b.leafletEvent.target._latlng.lng}),a.clearLoc=function(){a.$parent.landmark.loc_info.floor_num=null,a.$parent.landmark.loc_info.room_name=null},a.updateFloor=function(){var b=h.defer(),c=a.landmark.loc_info?a.landmark.loc_info.floor_num:1;if(d.localMapArrayExists(a.world)){var e=a.world.style.maps.localMapArray,f=d.filterToCurrentFloor(d.sortFloors(e),c);d.removeOverlays(),setTimeout(function(){f.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length&&d.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)})},100)}return k(c).then(function(){b.resolve(!0)}),b.promise},a.onUploadAvatar=function(b){var c=b[0];a.upload=e.upload({url:"/api/upload/",file:c}).progress(function(a){}).success(function(b){a.$parent.landmark.avatar=b,"Retail"===f.get()&&d.setNewIcon(a.$parent.landmark),a.uploadFinished=!0})},a.$parent.landmark.landmarkTagsRemoved=[],a.tagDetect=function(b){13===b.which&&a.addTag()},a.addTag=function(){""!==a.addTagName&&(a.$parent.landmark.tags||(a.$parent.landmark.tags=[]),a.addTagName=a.addTagName.replace(/[^\w\s]/gi,""),a.addTagName=a.addTagName.toLowerCase(),a.$parent.landmark.tags.indexOf(a.addTagName)>-1||a.$parent.landmark.tags.push(a.addTagName),a.addTagName="")},a.closeTag=function(b){a.$parent.landmark.landmarkTagsRemoved.push(a.$parent.landmark.tags[b]),a.$parent.landmark.tags.splice(b,1)}}]),app.controller("WalkthroughController",["$scope","$location","$route","$routeParams","$timeout","ifGlobals","leafletData","$upload","mapManager","World","db","$window","dialogs",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){a.progress=[];var b=0;if(a.walk)for(;b<a.walk.length;)a.progress[b]={status:""},b++;a.progress[a.position].status="active"}a.global=f,a.position=0,a.world={},a.world.time={},a.world.time.start=new Date,a.world.time.end=new Date,a.world.style={},a.world.style.maps={},a.temp={};var n=i,o=angular.element(".leaflet-bottom.leaflet-left")[0];o.style.display="none",a.world.name="bubble",n.setCenter([-83,42],15),a.next=function(){a.position<a.walk.length-1&&(a.position++,a.walk[a.position].hasOwnProperty("jump")&&a.walk[a.position].jump()&&a.next()),a.save()},a.prev=function(){a.position>0&&(a.position--,a.walk[a.position].hasOwnProperty("jump")&&a.walk[a.position].jump()&&a.prev()),a.save()},a.slowNext=function(){e(function(){a.next()},200),a.save()},a.pictureSelect=function(b){var c=b[0];a.upload=h.upload({url:"/api/upload/",file:c}).progress(function(b){a.picProgress=parseInt(100*b.loaded/b.total)+"%"}).success(function(b){a.world.avatar=b})},a.selectMapTheme=function(b){var c=a.global.mapThemes;"string"==typeof b&&(a.mapThemeSelect=b,n.setBaseLayer("https://{s}.tiles.mapbox.com/v3/"+c[b].cloudMapID+"/{z}/{x}/{y}.png"),a.world.style.maps.cloudMapName=c[b].cloudMapName,a.world.style.maps.cloudMapID=c[b].cloudMapID,a.setThemeFromMap(b))},a.setThemeFromMap=function(b){switch(b){case"urban":angular.extend(a.style,themeDict.urban);break;case"sunset":angular.extend(a.style,themeDict.sunset);break;case"fairy":angular.extend(a.style,themeDict.fairy);break;case"arabesque":angular.extend(a.style,themeDict.arabesque);break;case"haze":angular.extend(a.style,themeDict.haze);break;case"mimis":angular.extend(a.style,themeDict.mimis)}k.styles.create(a.style,function(a){})},a.saveAndExit=function(){a.world.name||(a.world.name="bubble"),a.save(),a.world.id&&(b.path("/w/"+a.world.id),l.location.reload(),n.refresh())},a.save=function(){a.world.newStatus=!1,k.worlds.create(a.world,function(b){a.world.id=b[0].id}),a.style&&(a.world.resources&&a.world.resources.hashtag&&(a.style.hashtag=a.world.resources.hashtag),a.world._id&&(a.style.world_id=a.world._id),k.styles.create(a.style,function(a){}))};var p=[{title:"Need a hand?",caption:"If you haven’t built a bubble before, we can walk you through it.",height:0,view:"0.html",valid:function(){return!0},skip:!1},{title:"Kind",caption:"What kind of bubble is it?",view:"kind.html",height:220,valid:function(){return"string"==typeof a.world.category},skip:!0},{title:"Location",caption:"Find its location",view:"location.html",height:290,valid:function(){return a.world.hasLoc},skip:!1},{title:"Name",caption:"What's your bubble named?",view:"name.html",height:62,valid:function(){return a.form.worldName.$valid},skip:!1},{title:"Time",caption:"Give it a start and end time",view:"time.html",height:288,valid:function(){return a.form.time.$valid},jump:function(){return!a.global.kinds[a.world.category].hasTime},skip:!0},{title:"Picture",caption:"Upload a picture for your bubble",view:"picture.html",height:194,valid:function(){return!0},skip:!0},{title:"Maps",caption:"Choose a map",view:"maptheme.html",height:426,valid:function(){return!0},skip:!0},{title:"Hashtag",caption:"Connect your bubble's social media",view:"hashtag.html",height:132,valid:function(){return!0},skip:!0},{title:"Done!",caption:"Now spread the word :)",view:"done.html",height:200,skip:!1}],q=[{title:"Claim your Meetup",caption:"We'll use your Meetup group to create a bubble.",view:"0.html",height:0,valid:function(){return!0},skip:!1},{title:"Confirm",caption:"Make sure this information from Meetup.com is correct",view:"meetup_confirm.html",height:300,valid:function(){return!0},skip:!1},{title:"Kind",caption:"What kind of bubble is it?",view:"kind.html",height:220,valid:function(){return"string"==typeof a.world.category},skip:!1},{title:"Hashtag",caption:"Connect your bubble's social media",view:"hashtag.html",height:132,valid:function(){return!0},skip:!0},{title:"Picture",caption:"Upload a picture",view:"picture.html",height:194,valid:function(){return!0},skip:!0},{title:"Maps",caption:"Choose a map",view:"maptheme.html",height:426,valid:function(){return!0},skip:!0},{title:"Done!",caption:"Now spread the word :)",view:"done_meetup.html",height:200,skip:!1}];a.walk=p,a.getProgress=function(){return{width:100*a.position/(a.walk.length-1)+"%"}},j.get({id:d._id,m:!0},function(b){b.err||(angular.extend(a.world,b.world),angular.extend(a.style,b.style),a.world.source_meetup&&a.world.source_meetup.id&&(a.walk=q),n.setBaseLayer("https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"),m())})}]),app.controller("WalkLocationController",["$scope","$rootScope","$timeout","leafletData",function(a,b,c,d){angular.extend(a,{tiles:tilesDict.arabesque}),angular.extend(a,{center:{lat:42,lng:-83,zoom:15}}),angular.extend(a,{markers:{}}),a.$watch("temp.MapActive",function(a,b){1==a&&d.getMap("locMap").then(function(a){a.invalidateSize()})}),a.showPosition=function(b,c){var e=b.valueOf(),f=c.valueOf();angular.extend(a,{markers:{m:{lat:e,lng:f,icon:{iconUrl:"img/marker/bubble-marker-50.png",iconSize:[35,67]},draggable:!0}}}),a.center.lat=e,a.center.lng=f,a.world.loc={coordinates:[f,e]},a.world.hasLoc=!0,a.$apply(function(){a.locLoading=!1}),d.getMap("locMap").then(function(a){a.invalidateSize()})},a.searchByAddress=function(){var b=new google.maps.Geocoder;b&&(a.locLoading=!0,b.geocode({address:a.temp.address},function(b,c){c==google.maps.GeocoderStatus.OK&&a.showPosition(b[0].geometry.location.lat(),b[0].geometry.location.lng())}))},a.searchByLocation=function(){navigator.geolocation&&(a.locLoading=!0,navigator.geolocation.getCurrentPosition(function(b){a.showPosition(b.coords.latitude,b.coords.longitude)},function(){},{timeout:5e3}))}}]),app.directive("floorSelector",floorSelector),floorSelector.$inject=["mapManager"],app.filter("floorNumberFilter",floorNumberFilter),app.controller("HomeController",["$scope","$rootScope","$location","worldTree","styleManager","mapManager","geoService","ifGlobals",function(a,b,c,d,e,f,g,h){function i(){var b=a.bubbles;b.forEach(function(a){a&&j.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:'<a if-href="#w/'+a.id+'">'+a.name+"</a>",enable:"leafletDirectiveMarker.click",icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-30]},_id:a._id})}),j.setCenterWithFixedAperture([g.location.lng,g.location.lat],18,0,240)}var j=f,k=e;k.resetNavBG(),j.resetMap(),a.temp={},a.loadState="loading",a.kinds=h.kinds,a.select=function(b){a.temp.mapOn?a.selected==b?c.path("w/"+b.id):(a.selected=b,j.setMarkerFocus(b._id),j.setCenterWithFixedAperture(b.loc.coordinates,18,0,240)):c.path("w/"+b.id)},a.$watch("temp.mapOn",function(a){switch(a){case!0:k.navBG_color="rgba(245, 67, 54, 0.96)";break;case!1:k.resetNavBG()}}),b.$on("leafletDirectiveMarker.click",function(b,c){var d=a.bubbles.find(function(a){return a._id==c.markerName?!0:!1});a.select(d)}),d.getNearby().then(function(b){a.$evalAsync(function(a){a.homeBubbles=b["150m"]||[],a.nearbyBubbles=b["2.5km"]||[],a.bubbles=a.nearbyBubbles.length>0&&a.homeBubbles.length>0?a.homeBubbles.concat(a.nearbyBubbles):a.nearbyBubbles.length>0?a.nearbyBubbles:a.homeBubbles.length>0?a.homeBubbles:[],a.loadState="success",i()})},function(b){a.loadState="failure"})}]),app.controller("indexIF",["$location","$scope","db","leafletData","$rootScope","apertureService","mapManager","styleManager","alertManager","userManager","$route","$routeParams","$location","$timeout","$http","$q","$sanitize","$anchorScroll","$window","dialogs","worldTree","beaconManager","lockerManager",function(a,b,c,d,e,f,g,h,i,j,k,l,a,m,n,o,p,q,r,s,t){b.aperture=f,b.map=g,b.style=h,b.alerts=i,b.userManager=j,b.dialog=s,angular.extend(e,{globalTitle:"Bubbl.li"}),e.hideBack=!0;var u=b.$on("$routeChangeSuccess",_.after(2,function(){e.hideBack=!1,u()}));b.$on("viewTabSwitch",function(a,c){b.viewTab=c}),b.newWorld=function(){b.world={},b.world.newStatus=!0,c.worlds.create(b.world,function(b){a.path("/edit/walkthrough/"+b[0].worldID)})},b.search=function(){1==b.searchOn?(a.path("/search/"+b.searchText),b.searchOn=!1):b.searchOn=!0},b.go=function(b){a.path(b)},b.goBack=function(){r.history.back(),b.$emit("viewTabSwitch","home")},b.logout=function(){n.get("/api/user/logout",{server:!0}),j.loginStatus=!1},b.sendFeedback=function(a){var b={emailText:"FEEDBACK:\n"+p(a)+"\n===\n===\n"+e.userName};n.post("feedback",b).success(function(){alert("Feedback sent, thanks!")}).error(function(){})},b.getNearby=function(a){b.nearbyLoading=!0,t.getNearby().then(function(a){b.altBubbles=a["150m"],b.nearbyBubbles=a["2.5km"],b.nearbyLoading=!1},function(a){b.nearbyLoading=!1}),a.stopPropagation()},b.share=function(b){var c,d=450,e=560,f=(screen.width-e)/2,g=(screen.height-d)/2;"facebook"==b?c="https://www.facebook.com/sharer/sharer.php?u=https://bubbl.li"+a.url():"twitter"==b&&(c="https://twitter.com/intent/tweet?url=https://bubbl.li"+a.url()),window.open(c,"Bubbl.li","height=450,width=558,top="+g+",left="+f+"scrollbars")}}]),app.directive("exploreView",["worldTree","$rootScope","ifGlobals",function(a,b,c){return{restrict:"EA",scope:!0,link:function(d){d.loadState="loading",d.kinds=c.kinds,b.$on("viewTabSwitch",function(b,c){"explore"===c&&(d.loadState="loading",a.getNearby().then(function(a){d.homeBubbles=a["150m"]||[],d.nearbyBubbles=a["2.5km"]||[],d.loadState="success"},function(){d.loadState="failure"}))})},templateUrl:"components/nav/exploreView.html"}}]),app.directive("navTabs",["$rootScope","$routeParams","$location","worldTree","$document",function(a,b,c,d){return{restrict:"EA",scope:!0,link:function(e){e.selected="home",e.select=function(a){if(e.selected===a&&"home"===a)if(b.worldURL){var d="/w/"+b.worldURL;c.path(c.path()===d?"/":d)}else c.path("/");e.$emit("viewTabSwitch",a)},e.$on("$locationChangeSuccess",function(){e.$emit("viewTabSwitch","home")}),a.$on("viewTabSwitch",function(a,b){e.selected=b}),e.nearbiesLength=function(){return d._nearby?_.reduce(d._nearby,function(a,b){return a+_.size(b)},0):0}},template:'<button class="view-tab home-tab" ng-class="{selected: selected==\'home\'}" ng-click="select(\'home\')"></button><button class="view-tab explore-tab" ng-class="{selected: selected==\'explore\'}" ng-click="select(\'explore\')"><span ng-show="nearbiesLength()>0" class="compass-badge badge" ng-cloak>{{nearbiesLength()}}</span></button><button class="view-tab search-tab" ng-class="{selected: selected==\'search\'}" ng-click="select(\'search\')"></button>'}}]),app.directive("searchView",["$http","geoService",function(a,b){return{restrict:"EA",scope:!0,link:function(c){c.search=function(d){c.lastSearch=d,b.getLocation().then(function(b){c.searching=a.get("/api/textsearch",{server:!0,params:{textQuery:d,userLat:b.lat,userLng:b.lng,localTime:new Date}}).success(function(a){c.searchResult=a.err?[]:a}).error(function(a){})})},c.searchOnEnter=function(a,b){13===a.keyCode&&c.search(b)}},templateUrl:"components/nav/searchView.html"}}]),app.controller("MeetupController",["$scope","$window","$location","styleManager","$rootScope","dialogs",function(a,b,c,d,e,f){var g=d;g.navBG_color="#3d66ca",angular.element("#view").bind("scroll",function(){}),angular.element("#wrap").scroll(_.debounce(function(){a.scroll=this.scrollTop,a.$apply()},20)),a.openSignup=function(){f.showDialog("authDialog.html")}}]),app.controller("WelcomeController",["$scope","$window","$location","styleManager","$rootScope","dialogs",function(a,b,c,d,e,f){var g=d;g.navBG_color="#3d66ca",angular.element("#view").bind("scroll",function(){}),angular.element("#wrap").scroll(_.debounce(function(){a.scroll=this.scrollTop,a.$apply()},20)),a.openSignup=function(){f.showDialog("authDialog.html")}}]),app.controller("LoginCtrl",["$scope","$rootScope","$http","$location","apertureService","alertManager",function(a,b,c,d,e,f){b.showLogout&&d.url("/profile"),a.alerts=f,a.aperture=e,a.aperture.set("off"),a.user={},a.socialLogin=function(b){d.url("/auth/"+b),c.post("/auth/"+b).success(function(){}).error(function(b){b&&a.alerts.addAlert("danger",b)})},a.login=function(){var b={email:a.user.email,password:a.user.password};c.post("/api/user/login",b).success(function(a){a&&d.url("/profile")}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("SignupCtrl",["$scope","$rootScope","$http","$location","apertureService","alertManager",function(a,b,c,d,e,f){a.alerts=f,a.aperture=e,a.aperture.set("off"),a.user={},"messages"==$routeParams.incoming&&(a.showMessages=!0),a.signup=function(){var b={email:a.user.email,password:a.user.password};c.post("/api/user/signup",b).success(function(a){a&&("messages"==$routeParams.incoming?window.history.back():d.url("/profile"))}).error(function(b){b&&a.alerts.addAlert("danger",b)})},a.goBack=function(){window.history.back()}}]),app.controller("ForgotCtrl",["$scope","$http","$location","apertureService","alertManager",function(a,b,c,d,e){a.alerts=e,a.aperture=d,a.aperture.set("off"),a.user={},a.sendForgot=function(){var c={email:a.user.email};b.post("/forgot",c).success(function(){a.alerts.addAlert("success","Instructions for resetting your password were emailed to you"),a.user.email=""}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("ResetCtrl",["$scope","$http","$location","apertureService","alertManager","$routeParams",function(a,b,c,d,e,f){a.alerts=e,a.aperture=d,a.aperture.set("off"),b.post("/resetConfirm/"+f.token).success(function(){}).error(function(a){a&&c.path("/forgot")}),a.sendUpdatePassword=function(){var d={password:a.user.password};b.post("/reset/"+f.token,d).success(function(){c.path("/profile")}).error(function(b){b&&a.alerts.addAlert("danger",b)})}}]),app.controller("resolveAuth",["$scope","$rootScope",function(a,b){angular.extend(b,{loading:!0}),location.reload(!0)}]),app.controller("UserController",["$scope","$rootScope","$http","$location","$route","$routeParams","userManager","$q","$timeout","$upload","Landmark","db","alertManager","$interval","ifGlobals","userGrouping",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(){a.user&&(g.saveUser(a.user),t.addAlert("success","Your contact info has been successfully saved!",!0))}function r(){function d(){c.get("/api/user/profile",{server:!0}).success(function(b){a.groups=p.groupByTime(b),a.bubbles=b,a.waitingforMeetup=!1})}a.stop=n(d,2e3);var e=b.$on("$locationChangeSuccess",function(){n.cancel(a.stop),e()})}angular.extend(b,{loading:!1}),a.fromMessages=!1,a.state={},a.subnav={profile:["me","contacts","history"],worlds:["worlds","drafts","filter"]},a.files={avatar:void 0},a.kinds=o.kinds,a.spinLeft=!1,a.spinLeftLong=!1;var s=null,t=m;a.$watch("files.avatar",function(c,d){if(void 0!==c){var e=c[0];a.upload=j.upload({url:"/api/upload",method:"POST",file:e,server:!0}).progress(function(b){a.spinLeft=!0}).success(function(c){a.user.avatar=c,b.avatar=c,a.uploadFinished=!0,a.spinLeftLong=!0,i(function(){a.spinLeft=!1,a.spinLeftLong=!1},1e3)})}}),a.update=function(b){a.state.myProfile=a.subnav.profile.indexOf(b)>-1||!b,a.state.myWorlds=a.subnav.worlds.indexOf(b)>-1,a.state.profile="me"==b,a.state.contacts="contacts"==b,a.state.history="history"==b,a.state.worlds="worlds"==b,a.state.drafts="drafts"==b,a.state.template="components/user/templates/"+b+".html",a.state.myProfile&&(a.menuLink="/profile/me"),a.state.myWorlds&&(a.menuLink="/profile/worlds")},a.inspect=function(b){a.selected=b?b:!1},a.inspectEvent=function(b){a.inspect(b.bubble)},a.showCalendar=function(){a.calendarActive?a.calendarActive=!1:a.calendarLoaded?a.calendarActive=!0:(a.calendar={events:p.groupForCalendar(a.bubbles)},a.calendarLoaded=!0,a.calendarActive=!0)},a.calConfig={eventClick:a.inspectEvent};var u=e.current;a.$on("$locationChangeSuccess",function(){u.$$route.originalPath===e.current.$$route.originalPath&&(a.update(e.current.params.tab),e.current=u)}),a.$watchCollection("user",function(a,b){a!=b&&void 0!=b&&(s&&i.cancel(s),s=i(q,1e3))}),a.update(e.current.params.tab),a.waitingforMeetup=!1,"meetup"==f.incoming?(a.fromMeetup=!0,a.waitingforMeetup=!0,c.post("/api/process_meetups").success(function(){r()}).error(function(){angular.extend(b,{loading:!1}),c.get("/api/user/profile",{server:!0}).success(function(b){a.worlds=b,a.waitingforMeetup=!1})})):"messages"==f.incoming?a.fromMessages=!0:c.get("/api/user/profile",{server:!0}).success(function(b){a.groups=p.groupByTime(b),a.bubbles=b}),a.deleteWorld=function(b){var c=confirm("Are you sure you want to delete this?");c&&k.del({_id:a.worlds[b]._id},function(c){a.worlds.splice(b,1)})},a.deleteBubble=function(a){var b=confirm("Are you sure you want to delete this?");b&&k.del({_id:a},function(a){e.reload()})},a.newWorld=function(){a.world={},a.world.newStatus=!0,l.worlds.create(a.world,function(a){d.path("/edit/walkthrough/"+a[0].worldID)})},a.go=function(a){d.path(a)},g.getUser().then(function(b){a.user=b},function(a){d.path("/"),t.addAlert("warning","You're not logged in!",!0)})}]),app.controller("LandmarkController",["World","Landmark","db","$routeParams","$scope","$location","$window","leafletData","$rootScope","apertureService","mapManager","styleManager","userManager","alertManager","$http","worldTree",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(a){u.setCenter(e.landmark.loc.coordinates,a,"aperture-half"),x.set("half"),u.removeAllMarkers(),u.addMarker(e.landmark._id,{lat:e.landmark.loc.coordinates[1],lng:e.landmark.loc.coordinates[0],draggable:!1,message:e.landmark.name,icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17.5,60],popupAnchor:[0,-40]},_id:e.landmark._id}),u.setMarkerFocus(e.landmark._id),u.refresh()}function r(a,b){a.style&&a.style.maps&&a.style.maps.localMapArray&&(u.removeOverlays(),s(a,b).forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&u.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)}))}function s(a,b){if(a.style&&a.style.maps&&a.style.maps.localMapArray){var c,d=e.world.style.maps.localMapArray;b.loc_info&&b.loc_info.floor_num?c=b.loc_info.floor_num:(lowestFloor=_.chain(d).map(function(a){return a.floor_num}).sortBy(function(a){return a}).filter(function(a){return a}).value(),c=lowestFloor[0]||1);var f=d.filter(function(a){return a.floor_num===c});return f}}var t=angular.element(".leaflet-bottom.leaflet-left")[0];t.style.top="100px",t.style.left="1%";var u=k,v=l,w=n,x=j;e.worldURL=d.worldURL,e.landmarkURL=d.landmarkURL,e.collectedPresents=[],p.getWorld(d.worldURL).then(function(a){e.world=a.world,e.style=a.style,v.navBG_color=e.style.navBG_color,u.loadBubble(a.world),p.getLandmark(e.world._id,d.landmarkURL).then(function(a){e.landmark=a;var b=18;s(e.world,a)&&(b=k.findZoomLevel(e.world.style.maps.localMapArray)),q(b),r(e.world,a),e.style.widgets.presents&&e.landmark.category&&e.landmark.category.hiddenPresent&&e.landmark.category.name&&(e.temp={showInitialPresent:!0,presentCollected:!1,presentAlreadyCollected:!1,showPresentCard:!0},o.get("/api/user/loggedin",{server:!0}).success(function(a){"0"!==a?m.getUser().then(function(a){function b(){e.user.presents.collected.unshift({avatar:e.landmark.category.avatar,landmarkID:e.landmark._id,landmarkName:e.landmark.name,worldID:e.world._id,worldName:e.world.name,categoryname:e.landmark.category.name}),m.saveUser(e.user),e.temp.presentCollected=!0,e.temp.showIntialPresent=!1,w.addAlert("success","You found a present!",!0),c()}function c(){var a=e.world.landmarkCategories.filter(function(a){return 1==a.present}).length,b=e.user.presents.collected.filter(function(a){return a.worldID==e.world._id}).length;a==b?(e.temp.finalPresent=!0,e.temp.showInitialPresent=!1,e.temp.presentCollected=!1,e.temp.presentAlreadyCollected=!1):e.presentsLeft=a-b}e.user=a,e.user.presents||(e.user.presents={collected:[]});for(var d=!1,f=0;f<e.user.presents.collected.length;f++)if((e.user.presents.collected[f].landmarkID==e.landmark._id||e.user.presents.collected[f].categoryname==e.landmark.category.name)&&e.user.presents.collected[f].worldID==e.world._id){d=!0,e.temp.presentAlreadyCollected=!0,e.temp.showInitialPresent=!1;break}d?c():b();for(var f=0;f<e.user.presents.collected.length;f++)e.user.presents.collected[f].worldID==e.world._id&&e.collectedPresents.push(e.user.presents.collected[f].categoryname)}):e.temp.signupCollect=!0}))})})}]),app.directive("messageView",function(){return{restrict:"E",link:function(a,b){function c(b){return m("li.message",{key:b._id,"class":b.userID===a.userID?"message-self":"",onclick:function(){a.messageLink(b)}},[m("picture.message-avatar",m("img.small-avatar",{src:e(b.avatar)||"img/icons/profile.png"})),m("h6.message-heading",b.nick||"Visitor"),d(b)])}function d(b){var c,d=b.kind||"text";switch(d){case"text":c=m(".message-body",b.msg);break;case"pic":c=[m("img.img-responsive",{src:b.pic,onload:f}),m(".message-body")];break;case"sticker":c=[m(".message-sticker-background",[m("img.message-sticker-img",{src:b.sticker.img}),m("img.message-sticker-link",{src:"img/icons/ic_map_48px.svg"})]),m(".message-body",b.msg)];break;case"editUser":c=[m(".message-body",b.msg),m("hr.divider"),m("img.msg-chip-img",{src:e(a.user.avatar)}),m(".msg-chip-label",a.nick),m("img.msg-chip-edit",{src:"img/icons/ic_edit_grey600.png"})]}return m(".message-content",c)}function e(a){return void 0===a?"":a.indexOf("http")>-1?a:"https://bubbl.li/"+a}function f(){b[0].scrollTop=b[0].scrollTop+this.offsetHeight}a.$watchCollection("messages",function(a){m.render(b[0],a.map(c))})}}}),app.controller("MessagesController",["$location","$scope","$sce","db","$rootScope","$routeParams","apertureService","$http","$timeout","worldTree","$upload","styleManager","alertManager","dialogs","userManager","mapManager","ifGlobals","leafletData","stickerManager",function(a,b,c,d,e,f,g,h,j,k,l,m,n,o,p,q,r,s,t){function u(){j(function(){J.animate({scrollTop:2*J[0].scrollHeight},300)},0),1==L&&(L=!1,z())}function v(){var a=L;d.messages.query({roomID:b.world._id,sinceID:K},function(c){if(J[0].scrollHeight-J.scrollTop()-J.outerHeight()<50&&(a=!0),c.length>0){for(i=0;i<c.length;i++)-1==b.localMessages.indexOf(c[i]._id)&&c[i]._id&&b.messages.push(c[i]);K=c[c.length-1]._id,v()}else E=j(v,3e3),a&&u()})}function w(a){h.post("/api/worldchat/create",a,{server:!0}).success(function(c){K=c[0]._id,a._id=c[0]._id,b.messages.push(a),b.localMessages.push(c[0]._id),u()}).error(function(){})}function x(){return b.user.avatar||"img/icons/profile.png"}function y(){var a={roomID:b.world._id,nick:"BubblyBot",msg:"Hey there, this is a Bubble chat created just for "+b.world.name+". Chat, share pictures & leave notes with others here!",avatar:b.world.avatar||"img/tidepools/default.png",userID:"chatbot",_id:"welcomeMessage"};b.messages.push(a)}function z(){var a={roomID:b.world._id,nick:"BubblyBot",kind:"editUser",msg:"You are currently using the name "+b.nick+". Click here to edit it.",avatar:b.world.avatar||"img/tidepools/default.png",userID:"chatbot",_id:"profileEditMessage",href:"profile/me/messages"};b.messages.push(a)}function A(){b.world.hasOwnProperty("loc")&&b.world.loc.hasOwnProperty("coordinates")&&(I.setCenter([b.world.loc.coordinates[0],b.world.loc.coordinates[1]],18,b.aperture.state),I.addMarker("c",{lat:b.world.loc.coordinates[1],lng:b.world.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+b.world.id+'/">'+b.world.name+"</a>"})),b.world.style.hasOwnProperty("maps")&&(b.world.style.maps.localMapID&&I.addOverlay(b.world.style.maps.localMapID,b.world.style.maps.localMapName,b.world.style.maps.localMapOptions),b.world.style.maps.hasOwnProperty("localMapOptions")&&(zoomLevel=b.world.style.maps.localMapOptions.maxZoom||19),I.setBaseLayer(tilesDict.hasOwnProperty(b.world.style.maps.cloudMapName)?tilesDict[b.world.style.maps.cloudMapName].url:b.world.style.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+b.world.style.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png"))}function B(){t.getStickers({_id:b.world._id}).then(function(a){C(a)})}function C(a){a.forEach(function(a){D(a)})}function D(a){q.addMarker(a._id,{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],icon:{iconUrl:a.iconInfo.iconUrl,shadowUrl:"",iconSize:[100,100],iconAnchor:[50,100],popupAnchor:[0,-80]},message:'<div class="avatarWrapper"><img class="user-chip-img user-map-img" src="'+x()+'"/><strong>'+b.nick+'</strong></div><p class="user-map-text">'+a.message+"</p>"})
}var E,F=n,G=m,H=g,I=q;H.set("off");var J=$(".message-list");b.loggedIn=!1,b.nick="Visitor",b.msg={},b.messages=[],b.localMessages=[],b.stickers=r.stickers,b.editing=!1;var K="none",L=!0;b.toggleMap=function(){b.editing&&(b.editing=!1),H.toggle("full")},b.sendMsg=function(a){if(b.editing)return void b.pinSticker();if(a&&a.preventDefault(),null!=b.msg.text&&p.loginStatus){var c={roomID:b.world._id,nick:b.nick,msg:b.msg.text,avatar:b.user.avatar||"img/icons/profile.png",userID:b.userID};w(c),b.msg.text=""}},b.alert=function(a){F.addAlert("warning",a,!0)},b.onImageSelect=function(a){b.uploading=!0,b.uploadProgress=0,b.upload=l.upload({url:"/api/uploadPicture",file:a[0]}).progress(function(a){b.uploadProgress=parseInt(100*a.loaded/a.total)}).success(function(a){w({roomID:b.world._id,userID:b.userID,nick:b.nick,avatar:b.user.avatar||"img/icons/profile.png",msg:"",pic:a,kind:"pic"}),b.uploading=!1})},b.showStickers=function(){b.editing=!0,H.set("full")},b.selectSticker=function(a){b.selected=a,b.stickerChange=!0,b.msg.text=a.name,j(function(){b.stickerChange=!1},500)},b.messageLink=function(c){c.sticker?(H.set("full"),t.getSticker(c.sticker._id).then(function(a){I.setCenter(a.loc.coordinates,18,b.aperture.state),I.hasMarker(a._id)?I.setMarkerFocus(a._id):D(a)})):c.href&&a.path(c.href)},b.pinSticker=function(){var a=angular.copy(b.selected),c=Math.max(document.documentElement.clientHeight,window.innerHeight||0),d=Math.max(document.documentElement.clientWidth,window.innerWidth||0),e=d/2,f=(c-220-40)/2+40;s.getMap().then(function(c){var d=c.containerPointToLatLng([e,f]);a.loc={coordinates:[d.lng,d.lat]},a.time=Date.now(),a.roomID=b.world._id,a.message=b.msg.text||a.name,a.avatar=b.user.avatar,t.postSticker(a).then(function(c){D(c),j(function(){w({roomID:b.world._id,userID:b.userID,nick:b.nick,avatar:b.user.avatar||"img/icons/profile.png",msg:b.msg.text||a.name,sticker:{img:a.img,_id:c._id},kind:"sticker"}),b.msg.text=""},500)},function(a){})}),b.selected=void 0,b.editing=!1,H.set("off")};var M=e.$on("$locationChangeSuccess",function(){j.cancel(E),M()});b.$watch("editing",function(a){a===!0?I.fadeMarkers(!0):a===!1&&I.fadeMarkers(!1)}),k.getWorld(f.worldURL).then(function(a){b.style=a.style,G.navBG_color=b.style.navBG_color,b.world=a.world,A(),y(),B(),v()}),p.getUser().then(function(a){b.user=a,b.nick=p.getDisplayName()},function(){o.showDialog("messageAuthDialog.html")})}]),app.controller("InstagramListController",["$scope","$routeParams","styleManager","worldTree","db",function(a,b,c,d,e){d.getWorld(b.worldURL).then(function(b){a.world=b.world,a.style=b.style,c.navBG_color=a.style.navBG_color,a.instagrams=e.instagrams.query({limit:30,tag:a.world.resources.hashtag})})}]),app.directive("scheduleView",function(){return{restrict:"E",link:function(a,b){function c(a){a?(m.render(b[0],d(a)),l=a):l&&m.render(b[0],d(l))}function d(a){var b=_.map(a,e);return b}function e(a){var b=_.pairs(a)[0],c=b[0],d=b[1];return _.isEmpty(d)?void 0:m("section.bubble-supergroup",{className:n[c]?"closed":""},[m("button.bubble-supergroup-label",{onclick:f.bind(void 0,c)},c)].concat(_.map(d,g)))}function f(a){n[a]=!n[a],c()}function g(a){var b=_.pairs(a)[0],c=b[0],d=b[1];return m("div.bubble-group",[m("header.bubble-group-label",c),m("ul.bubble-list",_.map(d,h))])}function h(b){return m("li.bubble-list-item",m("a.bubble-list-item-link",{href:k("#w/"+a.world.id+"/"+b.id)},[m("img.bubble-list-item-img",{src:b.avatar}),m("span.bubble-list-item-label",[b.name,m("small",b.category)]),m("footer.bubble-list-item-detail",i(b)),m("footer.bubble-list-item-room-info",j(b))]))}function i(a){return[m("span",a.time.start&&"Starts "+moment(a.time.start).format("ddd, MMM Do, hA")),m("span",a.time.end&&"Ends "+moment(a.time.end).format("ddd, MMM Do, hA"))]}function j(a){return a.loc_info?[m("span","Floor: "+a.loc_info.floor_num),m("span","Room: "+a.loc_info.room_name)]:[]}function k(a){var b=a.indexOf("#");return b>-1?a.slice(0,b)+a.slice(b+1):a}a.$watchCollection("schedule",function(a){c(a)});var l,n={Upcoming:!0,Places:!0,Previous:!0}}}}),app.controller("ScheduleController",["$scope","worldTree","$routeParams","styleManager","$window","$location",function(a,b,c,d,e,f){function g(b){a.calendar={events:b.filter(function(a){return a.time.start}).map(function(a){return{id:a._id,title:a.name,start:moment(a.time.start),end:moment(a.time.end),landmark:a}})}}function h(b){function c(a){var b;return a.time.start?(b=moment(a.time.start),b.isBefore(f)?"Previous":b.isSame(f,"day")?"Today":b.isBefore(moment().add(7,"days"))?"This Week":"Upcoming"):"Places"}function d(a,b){var c;switch(b){case"This Week":if(c=moment(a.time.start),c.isSame(f))return 0;if(c.isSame(moment().add(1,"day"),"day"))return 1;if(c.isSame(moment().add(2,"day"),"day"))return 2;if(c.isSame(moment().add(3,"day"),"day"))return 3;if(c.isSame(moment().add(4,"day"),"day"))return 4;if(c.isSame(moment().add(5,"day"),"day"))return 5;if(c.isSame(moment().add(6,"day"),"day"))return 6;break;case"Today":return"Today";case"Upcoming":return c=moment(a.time.start),c.isBefore(moment().add(2,"week"))?"Next Week":c.isSame(f,"month")?"This Month":c.isBefore(moment().add(2,"month"))?"Next Month":c.isSame(f,"year")?"This Year":"Upcoming";case"Previous":return c=moment(a.time.start),c.isAfter(moment().subtract(2,"day"))?"Yesterday":c.isAfter(moment().subtract(1,"week"))?"Last Week":c.isAfter(moment().subtract(1,"month"))?"Last Month":c.isAfter(moment().subtract(1,"year"))?"Last Year":"Past";case"Places":return"Places"}}function e(a){return 1==a?"Tomorrow":2==a?moment().add(2,"day").format("dddd, MMMM Do"):3==a?moment().add(3,"day").format("dddd, MMMM Do"):4==a?moment().add(4,"day").format("dddd, MMMM Do"):5==a?moment().add(5,"day").format("dddd, MMMM Do"):6==a?moment().add(6,"day").format("dddd, MMMM Do"):void 0}var f=moment(),g={Upcoming:{},"This Week":{},Today:{},Previous:{},Places:{}},h={Upcoming:0,"This Year":10,"Next Month":20,"This Month":30,"Next Week":40,"This Week":50,6:55,5:56,4:57,3:58,2:59,1:60,Today:70,Yesterday:80,"Last Week":90,"Last Month":100,"Last Year":110,Past:120,Places:130};_.each(b,function(a){var b=c(a),e=d(a,b);g[b][e]?g[b][e].push(a):g[b][e]=[a]}),_.each(g,function(a,b,c){"Places"!==b&&_.each(a,function(a,b,c){c[b]=_.sortBy(a,function(a){moment(a.time.start).unix()})}),c[b]=_.sortBy(_.map(a,function(a,b){var c={};return c[b]=a,c}),function(a){var b=_.keys(a)[0];return h[b]})}),g["This Week"].length>0&&(g["This Week"]=_.map(g["This Week"],function(a){var b=_.pairs(a)[0],c=e(b[0]),a=b[1],d={};return d[c]=a,d})),a.schedule=[{Upcoming:g.Upcoming},{"This Week":g["This Week"]},{Today:g.Today},{Places:g.Places},{Previous:g.Previous}]}a.schedule=[];a.showCalendar=function(){a.calendarActive?a.calendarActive=!1:(a.calendarActive=!0,i())},a.inspectLandmark=function(b){f.path("w/"+a.world.id+"/"+b.landmark.id)},a.calConfig={height:360,eventClick:a.inspectLandmark,defaultView:"agendaWeek"};var i=_.throttle(function(){a.calConfig.height=j.height()-116,a.calConfig.defaultView=j.width()<600?"agendaDay":"agendaWeek"},100),j=$(e);j.on("resize",i),b.getWorld(c.worldURL).then(function(b){return a.world=b.world,a.style=b.style,d.navBG_color=a.style.navBG_color,a.world._id}).then(function(a){return b.getLandmarks(a)}).then(function(b){a.landmarks=b,g(b),h(b)})}]),app.filter("httpsify",function(){return function(a){return a=a||"",a.replace(/^http:\/\//i,"https://")}}),app.controller("TwitterListController",["$scope","$routeParams","styleManager","worldTree","db",function(a,b,c,d,e){d.getWorld(b.worldURL).then(function(b){a.world=b.world,a.style=b.style,c.navBG_color=a.style.navBG_color,a.tweets=e.tweets.query({limit:50,tag:a.world.resources.hashtag})})}]),app.directive("categoryWidget",[function(){return{restrict:"E",link:function(a,b){function c(a){return m(".category-widget",d(a))}function d(a){return a.length<4?e(a):4===a.length?[e(a.slice(0,2)),e(a.slice(2))]:[e(a.slice(0,3)),e(a.slice(3))]}function e(a){return m(".category-btn-group",a.map(f))}function f(b,c,d){return m(".category-btn",{style:{width:100/d.length+"%"},colspan:6/d.length,onclick:g(b.name),"class":a.selectedCategory===b.name?"selected-category":null},[b.avatar?m("img.category-btn-img",{src:b.avatar}):null,b.name])}function g(b){return function(c){c.stopPropagation(),a.$emit("landmarkCategoryChange",b)}}a.$watchGroup(["world.landmarkCategories","selectedCategory"],function(){m.render(b[0],c(a.world.landmarkCategories))})}}}]),app.controller("WorldController",["World","db","$routeParams","$upload","$scope","$location","leafletData","$rootScope","apertureService","mapManager","styleManager","$sce","worldTree","$q","$http","userManager","stickerManager","geoService","bubbleTypeService",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){function t(a,b,c){e.upload=d.upload({url:"/api/uploadPicture/",file:a,data:JSON.stringify(c)}).progress(function(){}).success(function(a){"want"==b?(e.wtgt.images.want=a,e.wtgt.images.wantBuilding=!1):"got"==b&&(e.wtgt.images.got=a,e.wtgt.images.gotBuilding=!1)})}function u(){function a(){e.world.loc&&e.world.loc.coordinates&&e.world.loc.coordinates.length&&(e.streetviewLoc=e.world.loc.coordinates[1]+","+e.world.loc.coordinates[0]+c)}if(e.style.widgets){if(1==e.style.widgets.twitter&&(e.twitter=!0),1==e.style.widgets.instagram&&(e.instagrams=b.instagrams.query({limit:1,tag:e.world.resources.hashtag}),e.instagram=!0),1==e.style.widgets.streetview){var c="&key=AIzaSyDbEMuXZS67cFLAaTtmrKjFNlrdNm1H-KE";if(e.streetview=!0,e.world.source_meetup)if(e.world.source_meetup.venue)if(e.world.source_meetup.venue.address_1){var d=[];typeof e.world.source_meetup.venue.address_1&&d.push(e.world.source_meetup.venue.address_1),typeof e.world.source_meetup.venue.address_2&&d.push(e.world.source_meetup.venue.address_2),typeof e.world.source_meetup.venue.city&&d.push(e.world.source_meetup.venue.city),typeof e.world.source_meetup.venue.state&&d.push(e.world.source_meetup.venue.state),typeof e.world.source_meetup.venue.zip&&d.push(e.world.source_meetup.venue.zip),typeof e.world.source_meetup.venue.country&&d.push(e.world.source_meetup.venue.country),d=d.join("+").replace(/ /g,"+"),e.streetviewLoc=d+c}else a();else a();else if(e.world.source_yelp)if(e.world.source_yelp.locationInfo)if(e.world.source_yelp.locationInfo)if(e.world.source_yelp.locationInfo.address){var d=[];typeof e.world.source_yelp.locationInfo.address&&d.push(e.world.source_yelp.locationInfo.address),typeof e.world.source_yelp.locationInfo.city&&d.push(e.world.source_yelp.locationInfo.city),typeof e.world.source_yelp.locationInfo.state_code&&d.push(e.world.source_yelp.locationInfo.state_code),typeof e.world.source_yelp.locationInfo.postal_code&&d.push(e.world.source_yelp.locationInfo.postal_code),typeof e.world.source_yelp.locationInfo.country_code&&d.push(e.world.source_yelp.locationInfo.country_code),d=d.join("+").replace(/ /g,"+"),e.streetviewLoc=d+c}else a();else a();else a();else a()}e.style.widgets.presents&&e.world.landmarkCategories&&(e.temp={showInitialPresent:!0,presentCollected:!1,presentAlreadyCollected:!1,presents:!0},o.get("/api/user/loggedin",{server:!0}).success(function(a){"0"!==a?p.getUser().then(function(a){function b(){var a=e.world.landmarkCategories.filter(function(a){return 1==a.present}).length,b=e.user.presents.collected.filter(function(a){return a.worldID==e.world._id}).length;a==b?(e.temp.finalPresent=!0,e.temp.showInitialPresent=!1,e.temp.presentCollected=!1,e.temp.presentAlreadyCollected=!1):e.presentsLeft=a-b}if(e.user=a,e.user.presents.collected){for(var c=0;c<e.user.presents.collected.length;c++)e.user.presents.collected[c].worldID==e.world._id&&e.collectedPresents.push(e.user.presents.collected[c].categoryname);b()}}):e.temp.signupCollect=!0})),(1==e.style.widgets.messages||1==e.style.widgets.chat)&&(e.messages=!0,b.messages.query({limit:1,roomID:e.world._id},function(a){a.length>0&&(e.msg=a[0])})),e.style.widgets.category&&(e.category=!0)}e.world.resources&&(e.tweets=b.tweets.query({limit:1,tag:e.world.resources.hashtag})),1==e.style.widgets.nearby&&(e.nearby=!0,e.loadState="loading",m.getNearby().then(function(a){if(a||(e.loadState="failure"),a["150m"].length>0||a["2.5km"].length>0){a["150m"].length>0&&a["2.5km"].length>0?e.nearbyBubbles=a["150m"].concat(a["2.5km"]):a["150m"].length>0&&a["2.5km"].length<0?e.nearbyBubbles=a["150m"]:a["150m"].length<0&&a["2.5km"].length>0?e.nearbyBubbles=a["2.5km"]:e.loadState="failure";for(var b=0;b<e.nearbyBubbles.length;b++)e.nearbyBubbles[b]._id==e.world._id&&e.nearbyBubbles.splice(b,1);e.nearbyBubbles.length>3&&(e.nearbyBubbles.length=3)}e.loadState="success"}),e.findRandom=function(){e.loadState="loading",r.getLocation().then(function(a){o.get("/api/find/random",{params:{userCoordinate:[a.lng,a.lat],localTime:new Date},server:!0}).success(function(a){a.length>0?a[0].id&&f.path("/w/"+a[0].id):e.loadState="success"})})})}function v(a){var b=moment(),c=_.groupBy(a.landmarks,function(a){if(!a.time.start)return"Places";var c=moment(a.time.start),d=moment(a.time.end)||moment(c).add(1,"hour");return b.isAfter(c)&&b.isBefore(d)?"Now":b.isBefore(c)?b.isSame(c,"day")?"Today":"Upcoming":b.isAfter(c)?"Past":void 0});if(e.places=c.Places||[],e.upcoming=_.compact([].concat(c.Upcoming,c.Today)),e.past=c.Past||[],e.now=c.Now||[],e.landmarks=a.landmarks||[],e.today=c.Today||[],e.now.length>0)var d=[].concat(e.places,e.now);else if(e.today.length>0)var d=[].concat(e.places,e.today);else var d=[].concat(e.places);j.addMarkers(d.map(w))}function w(a){var b="img/marker/bubble-marker-50.png",c=[0,-40],d="",f=[4,-3],g=[17,67],h=[35,67];return"Retail"===s.get()&&"img/tidepools/default.jpg"!==a.avatar&&(b=a.avatar,c=[0,-14],g=[25,25],h=[50,50]),{lat:a.loc.coordinates[1],lng:a.loc.coordinates[0],draggable:!1,message:'<a if-href="#w/'+e.world.id+"/"+a.id+'">'+a.name+"</a>",icon:{iconUrl:b,shadowUrl:d,shadowAnchor:f,iconSize:h,iconAnchor:g,popupAnchor:c},_id:a._id}}var x=angular.element(".leaflet-bottom.leaflet-left")[0];x.style.top="60px",x.style.left="1%",x.style.display="none";var y=j;y.resetMap();var z=k;e.worldURL=c.worldURL,e.aperture=i,e.aperture.set("third"),e.world={},e.landmarks=[],e.lookup={},e.wtgt={hashtags:{want:"hashtag1",got:"hashtag2"},images:{}},e.isRetail=!1,e.collectedPresents=[],e.selectedIndex=0;e.zoomOn=function(){x.style.display="block"},e.uploadWTGT=function(a,b){"want"==b?e.wtgt.images.wantBuilding=!0:"got"==b&&(e.wtgt.images.gotBuilding=!0);var c=a[0],d=new Date,f=null;"want"==b?f=e.wtgt.hashtags.want:"got"==b&&(f=e.wtgt.hashtags.got);var g={world_id:e.world._id,worldID:e.world.id,hashtag:f,userTime:d,userLat:null,userLon:null,type:"retail_campaign"};r.getLocation().then(function(a){g.userLat=a.lat,g.userLon=a.lng,t(c,b,g)},function(){t(c,b,g)})},e.loadWorld=function(a){e.world=a.world,e.style=a.style,"Retail"==s.get()&&(e.isRetail=!0),z.navBG_color=e.style.navBG_color,h.userID&&e.world.permissions&&(e.showEdit=h.userID==e.world.permissions.ownerID?!0:!1),e.world.name&&angular.extend(h,{globalTitle:e.world.name}),(e.world.description||e.world.summary)&&(e.description=!0,e.descriptionType=e.world.description?"description":"summary");var b=18;e.world.style.hasOwnProperty("maps")&&e.world.style.maps.hasOwnProperty("localMapOptions")&&(e.world.style.maps.localMapArray?e.world.style.maps.localMapArray.length>0&&(b=j.findZoomLevel(e.world.style.maps.localMapArray)):b=e.world.style.maps.localMapOptions.minZoom||18),e.world.hasOwnProperty("loc")&&e.world.loc.hasOwnProperty("coordinates")&&(y.setCenter([e.world.loc.coordinates[0],e.world.loc.coordinates[1]],b,e.aperture.state),y.addMarker("c",{lat:e.world.loc.coordinates[1],lng:e.world.loc.coordinates[0],icon:{iconUrl:"img/marker/bubble-marker-50.png",shadowUrl:"",iconSize:[35,67],iconAnchor:[17,67],popupAnchor:[0,-40]},message:'<a href="#/w/'+e.world.id+'/">'+e.world.name+"</a>"}));var c=e.world.style;if(c.hasOwnProperty("maps")){var d=[c.maps];c.maps.localMapArray&&c.maps.localMapArray.length>0&&(d=y.findMapFromArray(c.maps.localMapArray)),d.forEach(function(a){void 0!==a.localMapID&&a.localMapID.length>0&&y.addOverlay(a.localMapID,a.localMapName,a.localMapOptions)}),c.maps.hasOwnProperty("localMapOptions")&&(b=c.maps.localMapOptions.maxZoom||22),y.setBaseLayer(tilesDict.hasOwnProperty(c.maps.cloudMapName)?tilesDict[c.maps.cloudMapName].url:c.maps.hasOwnProperty("cloudMapID")?"https://{s}.tiles.mapbox.com/v3/"+c.maps.cloudMapID+"/{z}/{x}/{y}.png":"https://{s}.tiles.mapbox.com/v3/interfacefoundry.jh58g2al/{z}/{x}/{y}.png")}e.loadLandmarks()},e.loadLandmarks=function(){m.getLandmarks(e.world._id).then(function(a){v({landmarks:a}),u()})},e.$on("landmarkCategoryChange",function(a,b){function c(a){return a.category===b}var d=e.landmarks.filter(c).map(w);d.length>0&&(y.setCenterFromMarkers(d),y.setMarkers(d),e.aperture.set("full"),e.selectedCategory=b)}),m.getWorld(c.worldURL).then(function(a){e.loadWorld(a)},function(a){})}]);
>>>>>>> Bubblli
