// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩтЪкЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЭдЁЯОАтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯМЪтЭдЁЯОАЁЯОАЁЯОАЁЯОАтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯОАЁЯОАЁЯОАЁЯСХЁЯОАЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯОАЁЯОАЁЯТЩЁЯТЩЁЯСХЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯСХЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪк
// тЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнЁЯТнЁЯТЩЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪкЁЯМЪтЪктЪктЪктЪктЪкЁЯТнЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪкЁЯТнЁЯТнЁЯТнтЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнтЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯМЪтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯМЪтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪлтЪлтЪлтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪкЁЯМЪтЪлтЪлтЪлтЪктЪктЪктЪктЪктЪктЪкЁЯМЪЁЯМЪтЪктЪктЪктЪктЪктЪлтЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪкЁЯМХтЪлтЪлтЪлтЪктЪктЪктЪкЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪкЁЯМЪтЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪкЁЯМХтЪктЪктЪктЪктЪкЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪкЁЯМХтЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯРЩтЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТ░ЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЫтЪкЁЯТЫтЪкЁЯНКтЪкЁЯТ░тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯРЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯРЩЁЯТЩЁЯТЩтЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩтЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪкЁЯМЪЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
//Cinna 0.7 (Paprika)

var http = require('http');
var request = require('request');
var async = require('async');
var bodyParser = require('body-parser');
var cookieParser = require('cookie-parser');
var busboy = require('connect-busboy'); // for multi-part data from sendgrid
var kip = require('../../../kip');
var db = require('../../../db');
var _ = require('lodash');
var websockets = require('./websockets');

//set env vars
var config = require('../../../config');

// website ЁЯМП
var express = require('express');
var app = express();
var server = require('http').createServer(app);
websockets.init(server);
app.use(cookieParser());

app.use(express.static(__dirname + '/static'))
app.get('/healthcheck', function(req, res) {
  res.send('ЁЯТм ЁЯМП')
})

app.use(function(req, res, next) {
  if (!req.cookies.kip_user) {
    res.cookie('kip_user', parseInt(('' + Math.random()).slice(2)).toString(32));
  }
  next();
})

app.get('/', function(req, res) {
  // redirect to their group if they have a cookie
  if (req.cookies.kip_group) {
    return res.redirect('/group/' + req.cookies.kip_group);
  }

  // or make a new group
  var group = parseInt(('' + Math.random()).slice(2)).toString(32);
  res.cookie('kip_group', group);
  res.redirect('/group/'+ group);
})

app.get('/group/:group', function(req, res) {
  kip.debug('loading group', req.params.group);
  res.sendFile(__dirname + '/chat.html');
})

//parse incoming body
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({
  extended: true
}));

server.listen(8000, '0.0.0.0', function(e) {
  if (e) {
    kip.error(e)
  }
  kip.debug('chat app listening on port 8000 ЁЯМП ЁЯТм')
})
