// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™âšªðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâ¤ðŸŽ€âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸŒšâ¤ðŸŽ€ðŸŽ€ðŸŽ€ðŸŽ€âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸŽ€ðŸŽ€ðŸŽ€ðŸ‘•ðŸŽ€ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸŽ€ðŸŽ€ðŸ’™ðŸ’™ðŸ‘•ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ‘•ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšª
// âšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšª
// âšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’­ðŸ’­ðŸ’™ðŸ’­ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšª
// âšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªðŸŒšâšªâšªâšªâšªâšªðŸ’­ðŸ’­ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªðŸ’­ðŸ’­ðŸ’­âšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšª
// âšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’­âšªâšªâšªâšªâšªâšªâšªðŸ’­ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšª
// âšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸŒšâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’­ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšª
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’­âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸŒšâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’­ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâš«âš«âš«âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâš«âš«âš«âšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªðŸŒšâš«âš«âš«âšªâšªâšªâšªâšªâšªâšªðŸŒšðŸŒšâšªâšªâšªâšªâšªâš«âš«âš«âš«âšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªðŸŒ•âš«âš«âš«âšªâšªâšªâšªðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠâšªâšªâšªðŸŒšâš«âš«âš«âšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªðŸŒ•âšªâšªâšªâšªâšªðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠâšªâšªâšªðŸŒ•âšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ™âšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’°ðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠðŸŠâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’›âšªðŸ’›âšªðŸŠâšªðŸ’°âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™
// âšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™âšª
// âšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™âšª
// âšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™âšªâšª
// âšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ™ðŸ’™ðŸ’™âšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªðŸ’™ðŸ’™ðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªðŸ’™âšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªðŸŒšðŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
//Cinna 0.7 (Paprika)

var http = require('http');
var request = require('request');
var async = require('async');
var bodyParser = require('body-parser');
var busboy = require('connect-busboy'); // for multi-part data from sendgrid
var email = require('./components/email');

//set env vars
var config = require('config');

process.on('uncaughtException', function (err) {
  console.error('uncaught exception', new Date())
  console.error(err.stack);
});

//load kip modules
var ioKip = require("./components/io.js");

// website ðŸŒ
var express = require('express');
var app = express();
var server = require('http').createServer(app);
app.use(express.static(__dirname + '/static'))
app.get('/healthcheck', function (req, res) {
  res.send('ðŸ’¬ ðŸŒ')
})

//parse incoming body
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));


server.listen(8000, function(e) {
  if (e) { console.error(e) }
  console.log('chat app listening on port 8000 ðŸŒ ðŸ’¬')
})

//globals
var messageHistory = {}; //fake database, stores all users and their chat histories

//load incoming chat clients
ioKip.initSlackUsers(app.get('env'));
ioKip.loadSocketIO(server);

//incoming new slack user
app.get('/newslack', function(req, res) {
    ioKip.newSlack();
});

//incoming slack action
app.post('/slackaction', function(req, res) {
    // ioKip.newSlack();
    console.log('incoming Slack action BODY: ',req.body);

    if (req.body && req.body.payload){
      var parsedIn = JSON.parse(req.body.payload);

      /// FOR INITIAL SEARCHES

      //sends back original chat
      if (parsedIn.response_url && parsedIn.original_message){
        var stringOrig = JSON.stringify(parsedIn.original_message);
        request.post(
            parsedIn.response_url,
            { payload: stringOrig },
            function (err, res, body) {
              console.error('post err ',err);
            }
        );
      }else {
        console.error('slack buttons broke, need a response_url');
        return;
      }
    }else {
      console.log('nah');
      res.sendStatus(200);
    }

    // //SEND REQ.BODY: { payload: }
    // ioKip.incomingMsgAction(req.body,'slack');
});


// incoming email from sendgrid
// In development we're currently using peter's sendgrid api key etc
app.post('/sendgrid', busboy({immediate: true}), function(req, res) {
    req.body = {};
    req.busboy.on('field', (k, v) => {
      req.body[k] = v;
    })

    req.busboy.on('finish', () => {
      email.process(req.body);
      res.sendStatus(200);
    })
})

//incoming kik message
app.post('/kikincoming', function(req, res) {
    console.log('incoming Kik BODY: ',req.body);
    res.sendStatus(200);
    ioKip.incomingMsgAction(req.body,'kik');
    res.sendStatus(200);
});
