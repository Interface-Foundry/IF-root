// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙⚪💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙⚪⚪⚪❤🎀⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙🌚❤🎀🎀🎀🎀⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙🎀🎀🎀👕🎀💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙🎀🎀💙💙👕💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙👕💙💙💙💙💙💙💙💙💙⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙⚪⚪⚪⚪
// ⚪⚪⚪⚪💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙⚪⚪⚪
// ⚪⚪⚪💙💙💙💙💙💙💙💙💙💭💭💙💭💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙💙⚪⚪
// ⚪⚪⚪💙💙💙💙💙💙💙⚪🌚⚪⚪⚪⚪⚪💭💭💙💙💙💙💙💙⚪⚪💭💭💭⚪⚪💙💙💙💙💙💙⚪⚪
// ⚪⚪💙💙💙💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💭⚪⚪⚪⚪⚪⚪⚪💭💙💙💙💙💙💙⚪
// ⚪⚪💙💙💙💙💙💙🌚⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💭💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙💙⚪
// ⚪💙💙💙💙💙💙💭⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙🌚⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💭💙💙💙💙💙
// ⚪💙💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙
// ⚪💙💙💙💙💙⚪⚪⚪⚪⚫⚫⚫⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚫⚫⚫⚪⚪⚪⚪⚪💙💙💙💙
// ⚪💙💙💙💙💙⚪⚪⚪🌚⚫⚫⚫⚪⚪⚪⚪⚪⚪⚪🌚🌚⚪⚪⚪⚪⚪⚫⚫⚫⚫⚪⚪⚪⚪⚪💙💙💙💙
// ⚪💙💙💙💙💙⚪⚪⚪🌕⚫⚫⚫⚪⚪⚪⚪🍊🍊🍊🍊🍊🍊🍊⚪⚪⚪🌚⚫⚫⚫⚪⚪⚪⚪⚪💙💙💙💙
// ⚪💙💙💙💙💙⚪⚪⚪⚪🌕⚪⚪⚪⚪⚪🍊🍊🍊🍊🍊🍊🍊🍊🍊⚪⚪⚪🌕⚪⚪⚪⚪⚪⚪⚪💙💙💙💙
// ⚪💙💙💙💙💙🐙⚪⚪⚪⚪⚪⚪⚪⚪⚪💰🍊🍊🍊🍊🍊🍊🍊⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙
// ⚪⚪💙💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💛⚪💛⚪🍊⚪💰⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙
// ⚪⚪💙💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙
// ⚪⚪⚪💙💙💙💙🐙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙⚪
// ⚪⚪⚪💙💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙💙⚪
// ⚪⚪⚪⚪💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙💙💙⚪⚪
// ⚪⚪⚪⚪⚪💙💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪🐙💙💙⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪💙💙💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪💙⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪🌚💙⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
// ⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪⚪
//Cinna 0.7 (Paprika)

var http = require('http');
var request = require('request');
var async = require('async');
var bodyParser = require('body-parser');
var busboy = require('connect-busboy'); // for multi-part data from sendgrid
var email = require('./components/email');
var botkit = require('botkit');

//set env vars
var config = require('config');

process.on('uncaughtException', function (err) {
  console.error('uncaught exception', new Date())
  console.error(err.stack);
});

//load kip modules
var ioKip = require("./components/io.js");

// website 🌏
var express = require('express');
var app = express();
var server = require('http').createServer(app);
app.use(express.static(__dirname + '/static'))
app.get('/healthcheck', function (req, res) {
  res.send('💬 🌏')
})

//parse incoming body
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));


server.listen(8000, function(e) {
  if (e) { console.error(e) }
  console.log('chat app listening on port 8000 🌏 💬')
})

//globals
var messageHistory = {}; //fake database, stores all users and their chat histories

//load incoming chat clients
ioKip.initSlackUsers(app.get('env'));
ioKip.loadSocketIO(server);

//incoming new slack user
app.get('/newslack', function(req, res) {
    ioKip.newSlack();
});

//incoming slack action
app.post('/slackaction', function(req, res) {
    // ioKip.newSlack();
    console.log('incoming Slack action BODY: ',req.body);

    if (req.body && req.body.payload){
      var parsedIn = JSON.parse(req.body.payload);

      /// FOR INITIAL SEARCHES

      //sends back original chat
      if (parsedIn.response_url && parsedIn.original_message){
        var stringOrig = JSON.stringify(parsedIn.original_message);
        request.post(
            parsedIn.response_url,
            { payload: stringOrig },
            function (err, res, body) {
              console.error('post err ',err);
            }
        );
      }else {
        console.error('slack buttons broke, need a response_url');
        return;
      }
    }else {
      console.log('nah');
      res.sendStatus(200);
    }

    // //SEND REQ.BODY: { payload: }
    // ioKip.incomingMsgAction(req.body,'slack');
});


// incoming email from sendgrid
// In development we're currently using peter's sendgrid api key etc
app.post('/emailincoming', busboy({immediate: true}), function(req, res) {
    req.body = {};
    req.busboy.on('field', (k, v) => {
      req.body[k] = v;
    })

    req.busboy.on('finish', () => {
      email.process(req.body).catch((e) => {
        console.log(e.stack);
      })
      res.sendStatus(200);
    })
})

app.get('/facebook', function (req, res) {
  if (req.query['hub.verify_token'] === 'EAAT6cw81jgoBAFtp7OBG0gO100ObFqKsoZAIyrtClnNuUZCpWtzoWhNVZC1OI2jDBKXhjA0qPB58Dld1VrFiUjt9rKMemSbWeZCsbuAECZCQaom2P0BtRyTzpdKhrIh8HAw55skgYbwZCqLBSj6JVqHRB6O3nwGsx72AwpaIovTgZDZD') {
    //bot stuff
    res.send(req.query['hub.challenge']);
  }
  else {res.send('Error, wrong validation token'); }
})


app.post('/facebook', function (req, res) {
  messaging_events = req.body.entry[0].messaging;
  for (i = 0; i < messaging_events.length; i++) {
    event = req.body.entry[0].messaging[i];
    sender = event.sender.id;
    if (event.message && event.message.text) {
      text = event.message.text;
      console.log(JSON.stringify(req.body));
      // {
      //   "object":"page",
      //   "entry":[{"id":976386645706699,
      //           "time":1462290198559,
      //           "messaging":[{"sender":{"id":835675223228683},
      //                         "recipient":{"id":976386645706699},
      //                         "timestamp":1462290198521,
      //                         "message":{"mid":"mid.1462290198517:2bb9b166e3d1bb4d44",
      //                         "seq":61,
      //                         "text":"LELELELE"}}]
      //             }]
      //   }
      var newFb = {
            source: {
                'origin':'facebook',
                'channel': sender.toString(),
                'org': "facebook_" + sender.toString(),
                'id':"facebook_" + sender.toString(),
                'user': sender.toString()
            },
            'msg': text,
            'fb_access_token': ''
        };
        
      ioKip.preProcess(newFb);    

    }
  }
  res.sendStatus(200);
});

/*
{ headers: 'Received: by mx0034p1mdw1.sendgrid.net with SMTP id 24VSB7reOU Thu, 28 Apr 2016 20:35:57 +0000 (UTC)\nReceived: from mail-ig0-f175.google.com (mail-ig0-f175.google.com [209.85.213.175]) by mx0034p1mdw1.sendgrid.net (Postfix) with ESMTPS id B3EBFA829A1 for <inbound@pbrandt1.bymail.in>; Thu, 28 Apr 2016 20:35:57 +0000 (UTC)\nReceived: by mail-ig0-f175.google.com with SMTP id s8so3051194ign.0 for <inbound@pbrandt1.bymail.in>; Thu, 28 Apr 2016 13:35:58 -0700 (PDT)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=8wfyslaXNCPA3okI3xqJXsMmTTxVx2wMGfPELmnVg90=; b=RGUCmhJFF6eHsxOmGya1fxScC53ze6zbYXk71FfuvDZX4CK9yO+kxdVnKj++ZfZ1UR pqMGkzqP/4ykwa1Euqr6X5iCvwco5czElgXGpkPbzNefeKyzNeraYz2+BQBoDxkZb4mg zmJRK1gbmAfe5FPkI4WSKbqA6B1zGUK0KQT47l92Zzs4QMb7eyOKS9ZksFdASI50t6Up vZVE8Wng/8n/FTMkL9GK/In9ZDLQyHivn9ef3N+upaXPdTcwN3YOiosyRLPVvnov9Cpt gKi3nnucKLFcDXWZnCC1Na5Ihh4RAdu7GO72x41JjhPk8aoSJPZrPOAh3EZ7r0AIpzc8 iiEQ==\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20130820; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=8wfyslaXNCPA3okI3xqJXsMmTTxVx2wMGfPELmnVg90=; b=gQJLVNsNk0Ev0HAjEnINoWAjkBKtWtOlM/84rOHPW8oZ/MEcpksyiRSNUs7hiyo00B SqRqooEYyOQR3L4j/iyYLTLShoOTzHWTzYDsdpD+rHJIFF0lI4qjoAE6Rn+ibqoNG95v PlenD1RDZbpwtVHBcJBnGykVhob6iLxwmlaTCO4pIhPi5kTOX49OyPmzNzxlWO0U2m5u Pt1igLhNsh0ofwrFOy237ZqH5PxsrRfYc5OPPI9oDP76yZ3/K/pDAhM/5z6crTEPY5yr tXdY70kDDvOP+Q19XHsXNddHoBvlqh+oPIqhuG+Mc9ymTWiqEP+Mj3k8b6qz4wCv5pjc wXmg==\nX-Gm-Message-State: AOPr4FXc2EgZ5dMv+OWAD//hQVrp6tl8sAaHybxPk1QjvIubZ0vFjq3+ikev8jffNmWKOdE2qbuQK5tjPmYMiw==\nX-Received: by 10.50.36.9 with SMTP id m9mr37668990igj.91.1461875757722; Thu, 28 Apr 2016 13:35:57 -0700 (PDT)\nMIME-Version: 1.0\nReferences: <HpZzykZxSE621eG4FrB-8Q@ismtpd0002p1iad1.sendgrid.net>\nIn-Reply-To: <HpZzykZxSE621eG4FrB-8Q@ismtpd0002p1iad1.sendgrid.net>\nFrom: Peter Brandt <peter.m.brandt@gmail.com>\nDate: Thu, 28 Apr 2016 20:35:48 +0000\nMessage-ID: <CAOs1RBW2GB8L9qcypxfb4SLRJu1oknUK+1QEjYyeogdvJpZ=bg@mail.gmail.com>\nSubject: Re: Last Call for Office Purchase Order\nTo: inbound@pbrandt1.bymail.in\nContent-Type: multipart/alternative; boundary=089e013c69c23ed465053191796c\n',
  dkim: '{@gmail.com : pass}',
  to: 'inbound@pbrandt1.bymail.in',
  html: '<div dir="ltr">ok cool sounds good.<div><br></div><div>bae<br><br><div class="gmail_quote"><div dir="ltr">On Thu, Apr 28, 2016 at 3:56 PM &lt;<a href="mailto:inbound@pbrandt1.bymail.in">inbound@pbrandt1.bymail.in</a>&gt; wrote:<br></div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div>\n<p>Hey bae, just lettin u know that i care about u, so i wanted to say that the last call for office stuff is soon. whisper your dreams in my ear and i will make it so.</p>\n\n<img src="https://u2882667.ct.sendgrid.net/wf/open?upn=iuWMrNMHugUHvUZjLeFMrmZGhtBJYL3coEdOi9pslK07LsttLxR9r7fM3ZPUX-2BZGJSdjksZtXq1sENK6I7srzKiwX1NNTZpig8nRMIY2v8jzSvimIOGxetYqn4Jz1fWtPFlvvvDqpexMHbbJZ9GFEmNbIYoiMNZ03S0-2Fs7lAdr-2BZ5sGMjHCdpxOi4VifbioP7MXFHzuPXxL8ofBtWJ34s5wz76P1Cj1xXR0slJ8i52I-3D" alt="" width="1" height="1" border="0" style="min-height:1px!important;width:1px!important;border-width:0!important;margin-top:0!important;margin-bottom:0!important;margin-right:0!important;margin-left:0!important;padding-top:0!important;padding-bottom:0!important;padding-right:0!important;padding-left:0!important">\n</div>\n</blockquote></div></div></div>\n',
  from: 'Peter Brandt <peter.m.brandt@gmail.com>',
  text: 'ok cool sounds good.\r\n\r\nbae\r\n\r\nOn Thu, Apr 28, 2016 at 3:56 PM <inbound@pbrandt1.bymail.in> wrote:\r\n\r\n> Hey bae, just lettin u know that i care about u, so i wanted to say that\r\n> the last call for office stuff is soon. whisper your dreams in my ear and i\r\n> will make it so.\r\n>\n',
  sender_ip: '209.85.213.175',
  envelope: '{"to":["inbound@pbrandt1.bymail.in"],"from":"peter.m.brandt@gmail.com"}',
  attachments: '0',
  subject: 'Re: Last Call for Office Purchase Order',
  charsets: '{"to":"UTF-8","html":"UTF-8","subject":"UTF-8","from":"UTF-8","text":"UTF-8"}',
  SPF: 'pass' }
*/

//incoming kik message
app.post('/kikincoming', function(req, res) {
    console.log('incoming Kik BODY: ',req.body);
    res.sendStatus(200);
    ioKip.incomingMsgAction(req.body,'kik');
    res.sendStatus(200);
});
