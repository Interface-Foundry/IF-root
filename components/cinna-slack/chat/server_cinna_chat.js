// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™âšªğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâ¤ğŸ€âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸŒšâ¤ğŸ€ğŸ€ğŸ€ğŸ€âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ€ğŸ€ğŸ€ğŸ‘•ğŸ€ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ€ğŸ€ğŸ’™ğŸ’™ğŸ‘•ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ‘•ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšª
// âšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšª
// âšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’­ğŸ’­ğŸ’™ğŸ’­ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšª
// âšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªğŸŒšâšªâšªâšªâšªâšªğŸ’­ğŸ’­ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªğŸ’­ğŸ’­ğŸ’­âšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšª
// âšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’­âšªâšªâšªâšªâšªâšªâšªğŸ’­ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšª
// âšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸŒšâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’­ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšª
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’­âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸŒšâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’­ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâš«âš«âš«âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâš«âš«âš«âšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªğŸŒšâš«âš«âš«âšªâšªâšªâšªâšªâšªâšªğŸŒšğŸŒšâšªâšªâšªâšªâšªâš«âš«âš«âš«âšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªğŸŒ•âš«âš«âš«âšªâšªâšªâšªğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠâšªâšªâšªğŸŒšâš«âš«âš«âšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªğŸŒ•âšªâšªâšªâšªâšªğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠâšªâšªâšªğŸŒ•âšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ™âšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’°ğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠğŸŠâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’›âšªğŸ’›âšªğŸŠâšªğŸ’°âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™
// âšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™âšª
// âšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™âšª
// âšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™âšªâšª
// âšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ™ğŸ’™ğŸ’™âšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªğŸ’™ğŸ’™ğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªğŸ’™âšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªğŸŒšğŸ’™âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
// âšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšªâšª
//Cinna 0.7 (Paprika)

var http = require('http');
var request = require('request');
var async = require('async');
var bodyParser = require('body-parser');
var busboy = require('connect-busboy'); // for multi-part data from sendgrid
var email = require('./components/email');

//set env vars
var config = require('config');

process.on('uncaughtException', function (err) {
  console.error('uncaught exception', new Date())
  console.error(err.stack);
});

//load kip modules
var ioKip = require("./components/io.js");
var processData = require("./components/process.js");
var buttonTemplate = require("./components/button_templates.js");

// website ğŸŒ
var express = require('express');
var app = express();
var server = require('http').createServer(app);
app.use(express.static(__dirname + '/static'))
app.get('/healthcheck', function (req, res) {
  res.send('ğŸ’¬ ğŸŒ')
})

//parse incoming body
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

server.listen(8000, function(e) {
  if (e) { console.error(e) }
  console.log('chat app listening on port 8000 ğŸŒ ğŸ’¬')
})

//globals
var messageHistory = {}; //fake database, stores all users and their chat histories
var navHistory = {}; //keep track of each user in each channel nav history for buttons

//load incoming chat clients
ioKip.initSlackUsers(app.get('env'));
ioKip.loadSocketIO(server);


//incoming new slack user
app.get('/newslack', function(req, res) {
    ioKip.newSlack();
});

//incoming slack action
app.post('/slackaction', function(req, res) { 

    if (req.body && req.body.payload){

      var parsedIn = JSON.parse(req.body.payload);

      //validating real button call  
      if(parsedIn.token !== 'FMdYRIajPq9BdVztkGRpgSEP'){
        console.log('HACKER? ğŸ‘» ',parsedIn.token)
        //return;
      } 

      var navId = parsedIn.team.id + '_' + parsedIn.channel.id + '_' + parsedIn.user.id;


      /// FOR INITIAL SEARCHES

      //IF team cart action, send back modified message with updated quantities

      //call for cart, modded


      //sends back original chat
      if (parsedIn.response_url && parsedIn.original_message){

        console.log('PASSED IN ',parsedIn);
        
        //penguin nav button
        if (parsedIn.actions[0].name == 'home'){

          navHistory[navId] = JSON.stringify(parsedIn.original_message); //saving current nav

          var reformattedArray = parsedIn.original_message.attachments.map(function(obj){ 
            if (obj.actions){

              //DONT SHOW MEMBERS LIST BUTTON TO NON ADMINS
               obj.actions.map(function(obj2){
                  if(obj2.name == 'home'){
                    obj.actions = buttonTemplate.slack_home;
                  }
               })
            }
            return obj;
          });


          var newRes = parsedIn.original_message;

          newRes.attachments = reformattedArray;

          console.log('PARSE OUT ',newRes)

          res.json(newRes);

        }

       
        else if (parsedIn.actions[0].name == 'back'){

          //console.log('090909090909090909090909090909090 ',navHistory[navId]);

          //res.json(navHistory[navId]);

         //var parsed = JSON.parse('{"text":"","username":"Kip","icons":{"image_48":"https://s3-us-west-2.amazonaws.com/slack-files2/bot_icons/2015-12-08/16204337716_48.png"},"bot_id":"B0YTP5GUD","attachments":[{"fallback":"Here are some options you might like","image_url":"https://s3.amazonaws.com/if-kip-chat-images/7UNLH75BPC8FWXN92YHZ0FGP.png","image_width":345,"image_height":120,"image_bytes":19056,"callback_id":"5768bad04bf101a08ae43ceb","text":"*1.* <http://goo.gl/eEQ1GA|*SYMA X5C Explorers 2.4G 4CH 6-Axis Gyro RC Quadcopter With HD Cameraâ€¦*>\n <http://goo.gl/eEQ1GA|View on Amazon>","id":1,"color":"45a5f4","actions":[{"id":"1","name":"addcart","text":"Add to Cart","type":"button","value":"0","style":"primary"},{"id":"2","name":"cheaper","text":"Find Cheaper","type":"button","value":"0","style":"default"},{"id":"3","name":"moreinfo","text":"More Info","type":"button","value":"0","style":"default"}],"mrkdwn_in":["text"]},{"fallback":"Here are some options you might like","image_url":"https://s3.amazonaws.com/if-kip-chat-images/5WYY81SPBQ0TAU7BUOLST9OQ.png","image_width":345,"image_height":120,"image_bytes":18403,"callback_id":"5768bad04bf101a08ae43ceb","text":"*2.* <http://goo.gl/u32Q8m|*Cheerwing Syma X5SW FPV Explorers2 2.4Ghz 4CH 6-Axis Gyro RC Headless â€¦*>\n <http://goo.gl/u32Q8m|View on Amazon>","id":2,"color":"45a5f4","actions":[{"id":"4","name":"addcart","text":"Add to Cart","type":"button","value":"1","style":"primary"},{"id":"5","name":"cheaper","text":"Find Cheaper","type":"button","value":"1","style":"default"},{"id":"6","name":"moreinfo","text":"More Info","type":"button","value":"1","style":"default"}],"mrkdwn_in":["text"]},{"fallback":"Here are some options you might like","image_url":"https://s3.amazonaws.com/if-kip-chat-images/LKXW2QTB6234T5GZQN4UJMN8.png","image_width":345,"image_height":120,"image_bytes":25137,"callback_id":"5768bad04bf101a08ae43ceb","text":"*3.* <http://goo.gl/9xQhxn|*Syma X5SW 4 Channel Remote Controlled Quadcopter with HD Camera for Reâ€¦*>\n <http://goo.gl/9xQhxn|View on Amazon>","id":3,"color":"45a5f4","actions":[{"id":"7","name":"addcart","text":"Add to Cart","type":"button","value":"2","style":"primary"},{"id":"8","name":"cheaper","text":"Find Cheaper","type":"button","value":"2","style":"default"},{"id":"9","name":"moreinfo","text":"More Info","type":"button","value":"2","style":"default"}],"mrkdwn_in":["text"]},{"callback_id":"5768bad04bf101a08ae43ceb","fallback":"More Options","id":4,"color":"53B987","actions":[{"id":"10","name":"more","text":"View More","type":"button","value":"more","style":"default"},{"id":"11","name":"home","text":"ğŸ§","type":"button","value":"home","style":"default"}]}],"type":"message","subtype":"bot_message","ts":"1466481359.000085"}');
          if (navHistory[navId]){
            res.json(JSON.parse(navHistory[navId]));
          }
          
        }

        else {

          //res.json(parsedIn.original_message);

          var stringOrig = JSON.stringify(parsedIn.original_message);

         // res.sendStatus(200);

          console.log('STRING ORG22222 ',stringOrig)
          request.post(
              parsedIn.response_url,
              { payload: stringOrig },
              function (err, res, body) {
                console.error('post err ',err);
              }
          );

          ioKip.incomingMsgAction(req.body,'slack');

        }



        // res.status(200).json({ error: 'message' });

        // res.json({payload: stringOrig});

        //res.sendStatus(200);

      }else {
        console.error('slack buttons broke, need a response_url');
        return;
      }
    }else {
      console.log('nah');
      res.sendStatus(200);
    }

    // //SEND REQ.BODY: { payload: }
   
});


// incoming email from sendgrid
// In development we're currently using peter's sendgrid api key etc
app.post('/emailincoming', busboy({immediate: true}), function(req, res) {
  console.log('hitting /emailincoming')
    req.body = {};
    req.busboy.on('field', (k, v) => {
      req.body[k] = v;
    })

    req.busboy.on('finish', () => {
      email.process(req.body).catch((e) => {
        console.log(e.stack);
      })
      res.sendStatus(200);
    })
})


// - - - - - KIK's special snowflake playpen â„ï¸ â„ï¸ - - - - - //

var Kik = require('@kikinteractive/kik');

const kikConfig = {};

if (process.env.NODE_ENV == 'development_alyx'){
    kikConfig.auth = {
        username: 'kipbot.dev',
        apiKey: '2365ecea-4aa4-421a-a923-253c2e5dcd52',
        baseUrl: 'https://04d3a7ea.ngrok.io/'
    };
}else{
    kikConfig.auth = {
        username: 'kipbot',
        apiKey: '4a181322-48ee-4b63-8b09-7ccec20bf4a5',
        baseUrl: 'https://kipapp.co:8033/'
    };
}

// configure the bot
const kik = new Kik(kikConfig.auth);

// update the config options
kik.updateBotConfiguration();

// / / / / / ONBOARDING MESSAGE NEW KIK USER / / / / / / //
kik.onStartChattingMessage((message) => {
    kik.getUserProfile(message.from)
        .then((user) => {

          var kikRes = [];
          var kikMsg;

          kikMsg = Kik.Message
            .link('http://www.kipthis.com')
            .setPicUrl('http://kipthis.com/kip_modes/mode_welcome.png')
            .setText("Hi "+user.firstName+"!")
            .setTitle('')
            .setAttributionIcon('http://kipthis.com/img/kip-find.png')
            .setAttributionName('Kip');
          
          kikRes.push(kikMsg)

          kikMsg = Kik.Message
            .text("I'm Kip ğŸ˜Š Tell me what you're looking for, I'll try my best to find it!" );

          var keyboardObj = [{
                "type": "suggested",
                "hidden":false,
                "responses": [
                    {
                        "type":"text",
                        "body":"Find headphones" //BACK BUTTON REDISPLAYS PREVIOUS SEARCH RESULTS
                    },
                    {
                        "type":"text",
                        "body":"Find dystopia books"
                    },
                    {
                        "type":"text",
                        "body":"Find LED gloves"
                    },
                    {
                        "type":"text",
                        "body":"ğŸ”® Surprise me!"
                    }
                ]
            }];  
            kikMsg._state.keyboards = keyboardObj;
            kikRes.push(kikMsg)
            message.reply(kikRes);
        });
});

kik.onLinkMessage((message) => {
  message.reply("Sorry, I can't deal with links right now! ğŸ˜…");
});

kik.onPictureMessage((message) => {

  console.log(message.picUrl)
  processData.imageSearch(message.picUrl,'',function(res){

      console.log('ğŸ˜… ',res);
      var kipObj = {
        msg: res,
        source: {
          origin: 'kik',
          channel: message.chatId,
          org: message.chatId,
          id: message.chatId + '_' + message.from,
          user: message.chatId,
          username: message.from
        },
        kikData: message
      };
      kipObj.text = res;
      kipObj.imageTags = res;
      ioKip.preProcess(kipObj);    
  })


});

kik.onVideoMessage((message) => {
 message.reply("Sorry, I can't deal with vids right now! ğŸ˜…");
});

kik.onScanDataMessage((message) => {
 message.reply("Sorry, I can't deal with scans right now! ğŸ˜…");
});

kik.onStickerMessage((message) => {
    kik.getUserProfile(message.from)
        .then((user) => {

        var kikMsg = Kik.Message
          .link('http://www.kipthis.com')
          .setPicUrl('http://kipthis.com/img/kip-find.png')
          .setText("Hi "+user.firstName+"!!")
          .setTitle('')
          .setAttributionIcon('http://kipthis.com/img/kip-icon.png')
          .setAttributionName('ğŸ˜…');

        message.reply(kikMsg);
    });
});


//kik.send('HIIII','alyxmxe')
  // kik.getUserProfile(message.from)
  //     .then((user) => {
  //         message.reply(`Hey ${user.firstName}!`);
  //     });

//incoming message from kik
kik.onTextMessage((message) => {
  //console.log('MESSAGE IN ',message)
  // console.log('REGULAR ID ',message.id)
  // console.log('MESSAGE FROM ',message.from)

  var kipObj = {
    msg: message.body.trim(),
    source: {
      origin: 'kik',
      channel: message.chatId,
      org: message.chatId,
      id: message.chatId + '_' + message.from,
      user: message.chatId,
      username: message.from
    },
    kikData: message
  };
  //console.log('KIPOBJ ',kipObj)
  ioKip.preProcess(kipObj);    

});

var sendToKik = function(data,message,type){

  //console.log('DATA INCOMING SEND TO KIK ',data)

  if(!data.kikData){
    console.error('error io.js: no kikData obj found in data.source')
    return;
  }

  switch(type){
    case 'banter':
      data.kikData.reply(message)
      break;
    case 'search':
      console.log('SEARCH MESSAGE ',message)

      //insert keyboard into message

      data.kikData.reply(message);
      break;
    default: 
      //console.log('DEFAULT????????????????')
      data.kikData.reply(message)
  }
}

//kik is a lil' special snowflake, aren't ch'ya kik hmmmm?? -____-
var kikServer = require('http').createServer(kik.incoming()).listen(8033, function(e){
  if (e) { console.error(e) }
  console.log('lil kik snowflake listening on 8033 â„ï¸ â„ï¸ â„ï¸')
});

// - - - - - - - - - - -  end kik playpen - - - - - - - - - - - - - - - - //


module.exports.sendToKik = sendToKik;

/*
{ headers: 'Received: by mx0034p1mdw1.sendgrid.net with SMTP id 24VSB7reOU Thu, 28 Apr 2016 20:35:57 +0000 (UTC)\nReceived: from mail-ig0-f175.google.com (mail-ig0-f175.google.com [209.85.213.175]) by mx0034p1mdw1.sendgrid.net (Postfix) with ESMTPS id B3EBFA829A1 for <inbound@pbrandt1.bymail.in>; Thu, 28 Apr 2016 20:35:57 +0000 (UTC)\nReceived: by mail-ig0-f175.google.com with SMTP id s8so3051194ign.0 for <inbound@pbrandt1.bymail.in>; Thu, 28 Apr 2016 13:35:58 -0700 (PDT)\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=gmail.com; s=20120113; h=mime-version:references:in-reply-to:from:date:message-id:subject:to; bh=8wfyslaXNCPA3okI3xqJXsMmTTxVx2wMGfPELmnVg90=; b=RGUCmhJFF6eHsxOmGya1fxScC53ze6zbYXk71FfuvDZX4CK9yO+kxdVnKj++ZfZ1UR pqMGkzqP/4ykwa1Euqr6X5iCvwco5czElgXGpkPbzNefeKyzNeraYz2+BQBoDxkZb4mg zmJRK1gbmAfe5FPkI4WSKbqA6B1zGUK0KQT47l92Zzs4QMb7eyOKS9ZksFdASI50t6Up vZVE8Wng/8n/FTMkL9GK/In9ZDLQyHivn9ef3N+upaXPdTcwN3YOiosyRLPVvnov9Cpt gKi3nnucKLFcDXWZnCC1Na5Ihh4RAdu7GO72x41JjhPk8aoSJPZrPOAh3EZ7r0AIpzc8 iiEQ==\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=1e100.net; s=20130820; h=x-gm-message-state:mime-version:references:in-reply-to:from:date :message-id:subject:to; bh=8wfyslaXNCPA3okI3xqJXsMmTTxVx2wMGfPELmnVg90=; b=gQJLVNsNk0Ev0HAjEnINoWAjkBKtWtOlM/84rOHPW8oZ/MEcpksyiRSNUs7hiyo00B SqRqooEYyOQR3L4j/iyYLTLShoOTzHWTzYDsdpD+rHJIFF0lI4qjoAE6Rn+ibqoNG95v PlenD1RDZbpwtVHBcJBnGykVhob6iLxwmlaTCO4pIhPi5kTOX49OyPmzNzxlWO0U2m5u Pt1igLhNsh0ofwrFOy237ZqH5PxsrRfYc5OPPI9oDP76yZ3/K/pDAhM/5z6crTEPY5yr tXdY70kDDvOP+Q19XHsXNddHoBvlqh+oPIqhuG+Mc9ymTWiqEP+Mj3k8b6qz4wCv5pjc wXmg==\nX-Gm-Message-State: AOPr4FXc2EgZ5dMv+OWAD//hQVrp6tl8sAaHybxPk1QjvIubZ0vFjq3+ikev8jffNmWKOdE2qbuQK5tjPmYMiw==\nX-Received: by 10.50.36.9 with SMTP id m9mr37668990igj.91.1461875757722; Thu, 28 Apr 2016 13:35:57 -0700 (PDT)\nMIME-Version: 1.0\nReferences: <HpZzykZxSE621eG4FrB-8Q@ismtpd0002p1iad1.sendgrid.net>\nIn-Reply-To: <HpZzykZxSE621eG4FrB-8Q@ismtpd0002p1iad1.sendgrid.net>\nFrom: Peter Brandt <peter.m.brandt@gmail.com>\nDate: Thu, 28 Apr 2016 20:35:48 +0000\nMessage-ID: <CAOs1RBW2GB8L9qcypxfb4SLRJu1oknUK+1QEjYyeogdvJpZ=bg@mail.gmail.com>\nSubject: Re: Last Call for Office Purchase Order\nTo: inbound@pbrandt1.bymail.in\nContent-Type: multipart/alternative; boundary=089e013c69c23ed465053191796c\n',
  dkim: '{@gmail.com : pass}',
  to: 'inbound@pbrandt1.bymail.in',
  html: '<div dir="ltr">ok cool sounds good.<div><br></div><div>bae<br><br><div class="gmail_quote"><div dir="ltr">On Thu, Apr 28, 2016 at 3:56 PM &lt;<a href="mailto:inbound@pbrandt1.bymail.in">inbound@pbrandt1.bymail.in</a>&gt; wrote:<br></div><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div>\n<p>Hey bae, just lettin u know that i care about u, so i wanted to say that the last call for office stuff is soon. whisper your dreams in my ear and i will make it so.</p>\n\n<img src="https://u2882667.ct.sendgrid.net/wf/open?upn=iuWMrNMHugUHvUZjLeFMrmZGhtBJYL3coEdOi9pslK07LsttLxR9r7fM3ZPUX-2BZGJSdjksZtXq1sENK6I7srzKiwX1NNTZpig8nRMIY2v8jzSvimIOGxetYqn4Jz1fWtPFlvvvDqpexMHbbJZ9GFEmNbIYoiMNZ03S0-2Fs7lAdr-2BZ5sGMjHCdpxOi4VifbioP7MXFHzuPXxL8ofBtWJ34s5wz76P1Cj1xXR0slJ8i52I-3D" alt="" width="1" height="1" border="0" style="min-height:1px!important;width:1px!important;border-width:0!important;margin-top:0!important;margin-bottom:0!important;margin-right:0!important;margin-left:0!important;padding-top:0!important;padding-bottom:0!important;padding-right:0!important;padding-left:0!important">\n</div>\n</blockquote></div></div></div>\n',
  from: 'Peter Brandt <peter.m.brandt@gmail.com>',
  text: 'ok cool sounds good.\r\n\r\nbae\r\n\r\nOn Thu, Apr 28, 2016 at 3:56 PM <inbound@pbrandt1.bymail.in> wrote:\r\n\r\n> Hey bae, just lettin u know that i care about u, so i wanted to say that\r\n> the last call for office stuff is soon. whisper your dreams in my ear and i\r\n> will make it so.\r\n>\n',
  sender_ip: '209.85.213.175',
  envelope: '{"to":["inbound@pbrandt1.bymail.in"],"from":"peter.m.brandt@gmail.com"}',
  attachments: '0',
  subject: 'Re: Last Call for Office Purchase Order',
  charsets: '{"to":"UTF-8","html":"UTF-8","subject":"UTF-8","from":"UTF-8","text":"UTF-8"}',
  SPF: 'pass' }
*/

//incoming kik message
// app.post('/kikincoming', function(req, res) {
//     console.log('incoming Kik BODY: ',req.body);
//     res.sendStatus(200);
//     //ioKip.incomingMsgAction(req.body,'kik');
//     res.sendStatus(200);
// });
