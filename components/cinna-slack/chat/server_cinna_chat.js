// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩтЪкЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЭдЁЯОАтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯМЪтЭдЁЯОАЁЯОАЁЯОАЁЯОАтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯОАЁЯОАЁЯОАЁЯСХЁЯОАЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯОАЁЯОАЁЯТЩЁЯТЩЁЯСХЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯСХЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪк
// тЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнЁЯТнЁЯТЩЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪкЁЯМЪтЪктЪктЪктЪктЪкЁЯТнЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪкЁЯТнЁЯТнЁЯТнтЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнтЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯМЪтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТнтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯМЪтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТнЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪлтЪлтЪлтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪкЁЯМЪтЪлтЪлтЪлтЪктЪктЪктЪктЪктЪктЪкЁЯМЪЁЯМЪтЪктЪктЪктЪктЪктЪлтЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪкЁЯМХтЪлтЪлтЪлтЪктЪктЪктЪкЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪкЁЯМЪтЪлтЪлтЪлтЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪкЁЯМХтЪктЪктЪктЪктЪкЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪкЁЯМХтЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯРЩтЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТ░ЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКЁЯНКтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЫтЪкЁЯТЫтЪкЁЯНКтЪкЁЯТ░тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩ
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯРЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪк
// тЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪктЪк
// тЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯРЩЁЯТЩЁЯТЩтЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪкЁЯТЩЁЯТЩЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪкЁЯТЩтЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪкЁЯМЪЁЯТЩтЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
// тЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪктЪк
//Cinna 0.6 (Cardamom)

var http = require('http');
var request = require('request');
var async = require('async');
var bodyParser = require('body-parser');
var skype = require('./skype-sdk');
var builder = require('botbuilder');
var dialog = require('./components/io').dialog;
var processSkypeSession = require('./components/io').processSkypeSession;
var co = require('co');

//Botconnector
var msRest = require('ms-rest');
// var connector = require('botconnector');

// Initialize the BotService
var botService = new skype.BotService({
    messaging: {
        botId: "28:DbvPeqOxe3ChrhwcMZbLLS7",
        serverUrl : "https://apis.skype.com",
        requestTimeout : 15000,
        appId: '8bd4c38f-10a9-4ebe-a34d-d2f6f57789e6',
        appSecret: 'DbvPeqOxe3ChrhwcMZbLLS7'
    }
});
// Skype Bot
var bot = new builder.SkypeBot(botService);

// Bot Connector Bot
var credentials = new msRest.BasicAuthenticationCredentials('KipTest', '10d5ae7a86204287972c7fc98b21dbe3');
var botConnector = new builder.BotConnectorBot({appId: 'KipTest', appSecret: '10d5ae7a86204287972c7fc98b21dbe3'})

// Install First Run middleware and dialog
bot.use(function (session, next) {
    if (!session.userData.firstRun) {
        // console.log('session: ',session)
        session.userData.firstRun = true;
        session.userData.io = {
            source: {
                'origin':'skype',
                'channel':session.message.from.address.toString(),
                'org':'skype',
                'id':'skype' + "_" + session.message.from.address.toString() //for retrieving chat history in node memory,
            },
            'msg': session.message.text
        }
        session.replaceDialog('/'); 
    } else {
        session.replaceDialog('/'); 
    }
});

bot.add('/', processSkypeSession)

// var passSessionToIo = co.wrap(function* (session) {
//     var result = yield Promise.resolve(session);
//     return result;
// })

//set env vars
var config = require('config');

process.on('uncaughtException', function (err) {
  console.error('uncaught exception', new Date())
  console.error(err.stack);
});

//load kip modules
var ioKip = require("./components/io.js");

// website ЁЯМП
var express = require('express');
var app = express();
var server = require('http').createServer(app);
app.use(express.static(__dirname + '/static'))
app.get('/healthcheck', function (req, res) {
  res.send('ЁЯТм ЁЯМП')
})

//parse incoming body
app.use(bodyParser.json());         
app.use(bodyParser.urlencoded({ extended: true }));              
            

server.listen(8000, function(e) {
  if (e) { console.error(e) }
  console.log('chat app listening on port 8000 ЁЯМП ЁЯТм')
})

//globals
var messageHistory = {}; //fake database, stores all users and their chat histories

//load incoming chat clients
ioKip.initSlackUsers(app.get('env'));
ioKip.loadSocketIO(server);

//incoming new slack user
app.get('/newslack', function(req, res) {
    ioKip.newSlack();
});

//incoming new slack user
app.post('/slackaction', function(req, res) {
    // ioKip.newSlack();
    console.log('incoming Slack action BODY: ',req.body);
    res.sendStatus(200);
    //ioKip.incomingSlackAction(req.body);
}); 

//incoming new slack user
app.post('/kikincoming', function(req, res) {
    console.log('incoming Kik BODY: ',req.body);
    res.sendStatus(200);
    // ioKip.newSlack();
});

//incoming new email
app.post('/emailincoming', function(req, res) {
    console.log('incoming EMAIL BODY: ',req.body);
    // ioKip.newSlack();
});

app.post('/skype', 
    skype.messagingHandler(botService)
    // botConnector.verifyBotFramework(), 
    // botConnector.listen()
    );

module.exports.botService = botService;

