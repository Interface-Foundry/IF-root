function calcDistance(e,t,o,n){var r=Array.prototype.map.call(arguments,function(e){return e/180*Math.PI}),o=r[0],n=r[1],e=r[2],t=r[3],a=6372.8,i=e-o,s=t-n,l=Math.sin(i/2)*Math.sin(i/2)+Math.sin(s/2)*Math.sin(s/2)*Math.cos(o)*Math.cos(e),c=2*Math.asin(Math.sqrt(l));return a*c}function roundFloat(e,t){return"undefined"==typeof t||0===+t?Math.round(e):(e=+e,t=+t,isNaN(e)||"number"!=typeof t||t%1!==0?NaN:(e=e.toString().split("e"),e=Math.round(+(e[0]+"e"+(e[1]?+e[1]+t:t))),e=e.toString().split("e"),+(e[0]+"e"+(e[1]?+e[1]-t:-t))))}var simpleSearchApp=angular.module("simpleSearchApp",["ngHolder","angularMoment","ngRoute","angular-inview","smoothScroll"]).filter("httpsURL",function(){return function(e){if(e.indexOf("https")>-1);else{var t=/http/gi;e=e.replace(t,"https")}return e}}).filter("deCapslock",function(){return function(e){e=e.toLowerCase();var t=/\s((a[lkzr])|(c[aot])|(d[ec])|(fl)|(ga)|(hi)|(i[dlna])|(k[sy])|(la)|(m[edainsot])|(n[evhjmycd])|(o[hkr])|(pa)|(ri)|(s[cd])|(t[nx])|(ut)|(v[ta])|(w[aviy]))$/,o=e.match(t);return null!==o&&(o=o[0].toUpperCase(),e=e.replace(t,o)),e}}).factory("ResCache",["$cacheFactory",function(e){return e("resCache",{capacity:3})}]).factory("location",["$location","$route","$rootScope",function(e,t,o){return e.skipReload=function(){var n=t.current,r=o.$on("$locationChangeSuccess",function(){t.current=n,r()});return e},e}]).factory("storeFactory",function(){return{store:{},setStore:function(e){this.store=e}}}).config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"partials/home.html",controller:"HomeCtrl"}).when("/q/:query/:lat/:lng/:cityName",{templateUrl:"partials/results.html",controller:"HomeCtrl"}).when("/t/:parentId/:mongoId",{templateUrl:"partials/item.html",controller:"HomeCtrl"}).otherwise({redirectTo:"/"}),t.html5Mode({enabled:!0,requireBase:!1})}]);simpleSearchApp.controller("HomeCtrl",["$scope","$http","$location","$document","$timeout","$interval","amMoment","$window","$routeParams","location","$rootScope","$route","ResCache","storeFactory",function(e,t,o,n,r,a,i,s,l,c,d,u,p,m){function g(o){console.log(o),h=o.coords.latitude,f=o.coords.longitude,t.get("https://maps.googleapis.com/maps/api/geocode/json?latlng="+h+","+f+"&sensor=true").then(function(t){for(var o=0;o<t.data.results.length;o++)if("APPROXIMATE"==t.data.results[o].geometry.location_type){t.data.results[o].formatted_address=t.data.results[o].formatted_address.replace(", USA",""),e.userCity=t.data.results[o].formatted_address,y=e.userCity,e.loadingLoc=!1;break}},function(e){})}console.log("Want to API with us? Get in touch: hello@interfacefoundry.com");var h,f,y,I,w=!1,v=null,C=null;e.showGPS=!0,e.searchIndex=0,e.items=[],e.newQuery=null,e.expandedIndex=null,e.isExpanded=!1,e.outerWidth=$(window)[0].outerWidth,e.outerHeight=$(window)[0].outerHeight,e.mobileModalHeight,e.mobileFooterPos,e.mobileScreen=!1,e.mobileScreenIndex,e.showReportModal=null,e.report={},e.mobileImgIndex=0,e.mobileImgCnt=0,e.parent=m.store,e.searchSlider={min:5,ceil:50,floor:.1},/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(e.mobileScreen=!0),d.$on("$locationChangeState",function(e){e.preventDefault()}),e.returnHome=function(e){"home"===e?(o.path("/"),r(function(){console.log("route"),u.reload()},0),u.reload()):e._id&&(o.path("/t/"+e.parent._id+"/"+e._id),m.setStore(e.parent),console.log("storeFactory: ",m,"loc: ",e),r(function(){u.reload()},0))},e.emptyQuery=function(){e.query=""},e.sayHello=function(){w||e.searchQuery()},e.closeMobileWrapper=function(t){if(e.mobileScreen){var o=$(".expandMobileWrapper.mWrapper"+t);o.css({width:""+e.outerWidth+"px",height:"0"}),e.mobileScreenIndex=null}},e.chooseImage=function(t){e.mobileImgIndex=t},e.singleItemMobile=function(e,t,o){},e.expandContent=function(t,o,n){e.mobileScreen?"close"===o?(e.mobileScreenIndex=null,$("body").removeClass("modalOpen"),$("html").removeClass("modalOpen"),$("div.container-fluid").removeClass("modalOpen"),$(window).off(),$(window).off(),e.mobileImgIndex=0,e.mobileModalHeight=0):(e.mobileScreenIndex=t,$("body").addClass("modalOpen"),$("html").addClass("modalOpen"),$("div.container-fluid").addClass("modalOpen"),$(window).on("touchstart",function(e){v=e.originalEvent.targetTouches[0].clientX,C=e.originalEvent.targetTouches[0].clientY})):e.expandedIndex===t?(e.expandedIndex=null,$(".row"+t).removeClass("expand"),e.isExpanded=!1):null!==e.expandedIndex?($(".row"+e.expandedIndex).removeClass("expand"),$(".row"+t).addClass("expand"),e.expandedIndex=t):($(".row"+t).addClass("expand"),e.expandedIndex=t)},$(window).on("click",function(t){"collapsedContent"===t.target.className&&($(".row"+e.expandedIndex).removeClass("expand"),e.expandedIndex=null)}),e.enlargeImage=function(t,o){e.mobileScreen?$(".mobileImg"+t).css({"background-image":"url("+o+")"}):$(".largeImage"+t).css({"background-image":"url("+o+")"})},$("#locInput").geocomplete({details:"form",types:["geocode"]}).bind("geocode:result",function(t,o){e.userCity=o.formatted_address}),e.getGPSLocation=function(){e.loadingLoc=!0,navigator.geolocation?navigator.geolocation.getCurrentPosition(g):console.log("no geolocation support")},document.onclick=function(t){e.itemHighlight="form-grey",e.locationHighlight="form-grey"},e.scrollTop=function(){o.hash("topQueryBar"),$anchorScroll()},e.randomSearch=function(t){var o=["70s","vintage","fur","orange","health goth"];e.query=o[Math.floor(Math.random()*o.length)],e.searchQuery()},e.searchThis=function(t){e.query=t,e.searchQuery()},e.searchQuery=function(o){if("button"===o&&(e.items=[],e.searchIndex=0,$("input").blur()),e.userCity.indexOf("/")>-1){var n=/[^\w\s]/gi;e.userCity=e.userCity.replace(n,"")}if(e.query.indexOf("/")>-1){var n=/[^\w\s]/gi;e.query=e.query.replace(n,"")}if(w=!0,e.userCity!==y){y=e.userCity;var r=encodeURI(y);t.get("https://maps.googleapis.com/maps/api/geocode/json?address="+r+"&key=AIzaSyCABdI8Lpm5XLQZh-O4SpmShqMEKqKteUg").then(function(t){t.data.results[0]&&t.data.results[0].geometry&&(h=t.data.results[0].geometry.location.lat,f=t.data.results[0].geometry.location.lng),e.searchItems()},function(e){})}else e.searchItems()},e.searchItems=function(){var a=null,i=null,a=encodeURI(e.query),i=encodeURI(e.userCity);o.path("/q/"+a+"/"+h+"/"+f+"/"+i),t.post("https://kipapp.co/styles/api/items/search?page="+e.searchIndex,{text:e.query,loc:{lat:h,lon:f},radius:5}).then(function(t){if(c.skipReload().path("/q/"+a+"/"+h+"/"+f+"/"+i).replace(),e.newQuery===!0)e.items=e.items.concat(t.data.results),p.put("user",e.items),p.put("query",a),e.newQuery=!1;else{var o=p.get("user"),s=p.get("query");a!==s?(e.items=e.items.concat(t.data.results),p.put("user",e.items),p.put("query",a),e.newQuery=!1):e.items=o}if(e.items.length<1&&(e.noResults=!0,console.log("no results")),e.items&&e.items.length){e.noResults=!1;for(var l=0;l<e.items.length;l++){if(e.items[l].owner||e.items.splice(l,1),e.items[l].itemImageURL.length>6){var d=(e.items[l].itemImageURL.length-6,e.items[l].itemImageURL),u=d.length/2;d=d.splice(u,2)}if(e.items[l].parent.tel){var m=e.items[l].parent.tel;m=m.replace(/[+-\s]/g,""),11===m.length&&(m=m.replace(/^1/g,"")),e.items[l].parent.tel=m.slice(0,3)+"-"+m.slice(2,5)+"-"+m.slice(6)}if(e.items[l].loc&&!e.items[l].profileID){e.items[l].directionsURL=e.items[l].loc.coordinates[1]+","+e.items[l].loc.coordinates[0];var g=calcDistance(e.items[l].loc.coordinates[1],e.items[l].loc.coordinates[0],h,f);e.items[l].distanceKM=roundFloat(g,1);var y=1e3*g;y=.000621371192*y,e.items[l].distanceMI=roundFloat(y,1)}else l>-1&&e.items.splice(l,1)}}e.showQueryBar=!0,e.windowHeight=n[0].body.scrollHeight,r(function(){$("img.holderPlace").lazyload(),e.searchIndex++,I=$("div.resultsContainer"),I=I[0].clientHeight,w=!1},500),$("#locInput").geocomplete({details:"form",types:["geocode"]}).bind("geocode:result",function(t,o){e.userCity=o.formatted_address})},function(e){})},e.searchOneItem=function(){e.mongoId=e.mongoId.replace(/[^\w\s]/gi,""),e.mongoId=e.mongoId.replace(/\s+/g," ").trim();var r=encodeURI(e.mongoId);e.parentId=e.parentId.replace(/[^\w\s]/gi,""),e.parentId=e.parentId.replace(/\s+/g," ").trim();var a=encodeURI(e.parentId);o.path("/t/"+a+"/"+r),t.get("https://kipapp.co/styles/api/items/"+e.mongoId,{}).then(function(t){if(e.items=e.items.concat(t.data.item),e.items.length<1&&(e.noResults=!0,console.log("no results")),e.items&&e.items.length){e.noResults=!1;for(var o=0;o<e.items.length;o++){if(e.items[o].parent.tel){var r=e.items[o].parent.tel;r=r.replace(/[+-\s]/g,""),11===r.length&&(r=r.replace(/^1/g,"")),e.items[o].parent.tel=r.slice(0,3)+"-"+r.slice(2,5)+"-"+r.slice(6)}if(e.items[o].loc&&!e.items[o].profileID){e.items[o].directionsURL=e.items[o].loc.coordinates[1]+","+e.items[o].loc.coordinates[0];var a=calcDistance(e.items[o].loc.coordinates[1],e.items[o].loc.coordinates[0],h,f);e.items[o].distanceKM=roundFloat(a,1);var i=1e3*a;i=.000621371192*i,e.items[o].distanceMI=roundFloat(i,1)}else o>-1&&e.items.splice(o,1)}}e.showQueryBar=!0,e.windowHeight=n[0].body.scrollHeight,$("#locInput").geocomplete({details:"form",types:["geocode"]}).bind("geocode:result",function(t,o){e.userCity=o.formatted_address})},function(e){})},e.reportItem=function(o,n,a){"open"===o?e.showReportModal=a:"close"===o?e.showReportModal=null:"submit"===o&&t.post("https://kipapp.co/styles/api/items/"+n._id+"/report",{timeReported:new Date,comment:e.report.comment,reason:e.report.reason}).then(function(t){r(function(){e.showReportModal=null},0),t.data.err})},e.closeOverlay=function(t){t.toElement;"modalOverlay"==t.target.classList[0]&&e.reportItem("close")},l.query?(e.query=decodeURI(l.query),e.userCity=decodeURI(l.cityName),h=l.lat,f=l.lng,e.searchItems()):l.mongoId?(e.mongoId=decodeURI(l.mongoId),e.parentId=decodeURI(l.parentId),t.get("https://kipapp.co/styles/api/geolocation").then(function(o){return 38===o.data.lat?void $("#locInput").geocomplete("find","NYC"):(h=o.data.lat,f=o.data.lng,void t.get("https://maps.googleapis.com/maps/api/geocode/json?latlng="+o.data.lat+","+o.data.lng+"&sensor=true").then(function(t){for(var o=0;o<t.data.results.length;o++)if("APPROXIMATE"==t.data.results[o].geometry.location_type){t.data.results[o].formatted_address=t.data.results[o].formatted_address.replace(", USA",""),e.userCity=t.data.results[o].formatted_address,y=e.userCity,e.loadingLoc=!1;break}},function(){}))},function(t){e.getGPSLocation()}),e.searchOneItem()):(t.get("https://kipapp.co/styles/api/geolocation").then(function(o){return 38===o.data.lat?void $("#locInput").geocomplete("find","NYC"):(h=o.data.lat,f=o.data.lng,void t.get("https://maps.googleapis.com/maps/api/geocode/json?latlng="+o.data.lat+","+o.data.lng+"&sensor=true").then(function(t){for(var o=0;o<t.data.results.length;o++)if("APPROXIMATE"==t.data.results[o].geometry.location_type){t.data.results[o].formatted_address=t.data.results[o].formatted_address.replace(", USA",""),e.userCity=t.data.results[o].formatted_address,y=e.userCity,e.loadingLoc=!1;break}},function(){}))},function(t){e.getGPSLocation()}),/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&(e.getGPSLocation(),e.hideGPSIcon=!0)),angular.element(document).ready(function(){e.windowHeight=s.height+"px",e.windowWidth=window.width+"px"})}]),simpleSearchApp.directive("autoFocus",["$timeout",function(e){return{restrict:"AC",link:function(t,o){e(function(){o[0].focus()},0)}}}]),simpleSearchApp.directive("afterResults",["$document",function(e){return{restrict:"E",replace:!0,scope:{windowHeight:"="},link:function(t,o,n){console.log(t.$parent.windowHeight),t.$parent.$last&&(t.windowHeight=e[0].body.clientHeight,console.log(t.windowHeight))}}}]),simpleSearchApp.directive("selectOnClick",["$window",function(e){return{restrict:"A",link:function(t,o,n){o.on("click",function(){e.getSelection().toString()||this.setSelectionRange(0,this.value.length)})}}}]),simpleSearchApp.directive("ngEnter",function(){return function(e,t,o){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(o.ngEnter,{event:t})}),t.preventDefault())})}}),simpleSearchApp.directive("tooltip",function(){return{restrict:"A",link:function(e,t,o){$(t).hover(function(){$(t).tooltip("show")},function(){$(t).tooltip("hide")})}}}),simpleSearchApp.service("searchQuery",function(){var e=[],t=function(t){e=[],e.push(t)},o=function(){return e};return{addSearch:t,getSearch:o}});